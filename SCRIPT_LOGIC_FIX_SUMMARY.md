# 腳本邏輯修正總結

## ❌ 發現的問題

您執行 DRY RUN 後發現修復出來的數字不對：
```
帳戶: 0107支付寶 (ID: 27)
  當前餘額: 145262.02 RMB
  WITHDRAW 記錄總額: 3429239.62 RMB
  調整後餘額: 3574501.64 RMB
```

**問題：**這會導致帳戶餘額錯誤增加超過 340 萬！

## 🔍 根本原因

我理解錯了 LedgerEntry 的作用：

### 錯誤理解 ❌
- 以為 WITHDRAW LedgerEntry 會自動扣款
- 因此要回補被扣款的金額

### 正確理解 ✅
- **LedgerEntry 只是流水記錄**，不會自動修改帳戶餘額
- 真正的扣款發生在代碼中：`account.balance -= amount`
- 當前代碼（第989-998行）已經正確扣款

## ✅ 正確的修復邏輯

### 只有這兩種情況需要調整餘額：

#### 情況1：從錯誤帳戶扣款 ⚠️ 需要調整

如果舊代碼從**錯誤帳戶**扣款（例如從庫存來源帳戶而不是售出扣款戶）：
- ✅ **回補**錯誤帳戶
- ✅ **扣款**正確帳戶

#### 情況2：WITHDRAW 只是流水記錄 ✅ 只刪除

如果 WITHDRAW 只是顯示記錄，沒有實際扣款：
- ✅ **只刪除** WITHDRAW 記錄
- ❌ **不回補**餘額

## 🔧 修正後的腳本邏輯

```
步驟1：分析從錯誤帳戶扣款的情況
  - 如果 WITHDRAW 從錯誤帳戶扣款
  - 則需要調整餘額

步驟2：處理所有 WITHDRAW 記錄
  - 只調整從錯誤帳戶扣款的情況
  - 其他 WITHDRAW 只是流水，不影響餘額

步驟3：刪除所有 WITHDRAW 記錄
```

## 📊 預期結果

修正後，DRY RUN 應該顯示：

```
帳戶: 0107支付寶 (ID: 27)
  WITHDRAW 記錄: 322 筆，總額: 3,429,239.62 RMB
  ⚠️  這些記錄只是流水，不影響餘額

將刪除記錄: 330 筆
將調整帳戶: 0 個（如果沒有從錯誤帳戶扣款的情況）
```

## 🎯 結論

**WITHDRAW LedgerEntry 只是流水記錄，不影響實際餘額！**

正確的清理方式：
1. ✅ 刪除所有售出扣款 WITHDRAW 記錄
2. ⚠️  只調整從錯誤帳戶扣款的情況（如果有）
3. ❌ **不要**盲目回補 WITHDRAW 金額

