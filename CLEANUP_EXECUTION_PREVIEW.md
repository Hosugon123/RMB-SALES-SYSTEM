# 清理 WITHDRAW 記錄 - 執行結果預覽

## 📊 當前狀態

### 0107 支付寶 (ID: 27)
- **當前餘額**：145,262.02 RMB
- **WITHDRAW 記錄**：322 筆，總額 3,429,239.62 RMB
- **從 0107 售出的總額**：3,391,606.62 RMB
- **錯誤扣款（差異）**：37,633.00 RMB

### 7773 支付寶 (ID: 23)
- **當前餘額**：58,423.83 RMB
- **WITHDRAW 記錄**：5 筆，總額 228,658.00 RMB
- **保持不變**：✅

### 6186 支付寶 (ID: 31)
- **當前餘額**：1,067.00 RMB
- **WITHDRAW 記錄**：3 筆，總額 20,000.00 RMB
- **保持不變**：✅

---

## ✅ 執行後的結果（預覽）

### 0107 支付寶
- **調整前餘額**：145,262.02 RMB
- **調整後餘額**：182,895.02 RMB（+37,633.00 RMB）
- **WITHDRAW 記錄**：0 筆（全部刪除）

### 7773 支付寶
- **餘額**：58,423.83 RMB（保持不變）✅
- **WITHDRAW 記錄**：0 筆（全部刪除）

### 6186 支付寶
- **餘額**：1,067.00 RMB（保持不變）✅
- **WITHDRAW 記錄**：0 筆（全部刪除）

### 數據庫變化
- **刪除記錄**：330 筆 WITHDRAW LedgerEntry 記錄
- **調整帳戶**：1 個（0107 支付寶）
- **保持不變**：其他所有帳戶餘額

---

## 📝 執行後的效果

1. **0107 支付寶餘額**：從 145,262.02 調整為 **182,895.02 RMB**
   - 這符合您的預期（當前 + 37,633）

2. **其他帳戶餘額**：完全保持不變
   - 7773：58,423.83 RMB
   - 6186：1,067.00 RMB

3. **WITHDRAW 記錄**：全部刪除
   - 以後不會再顯示這些記錄
   - 以後的售出只從帳戶餘額扣除，不會重複扣款

4. **數據一致性**：✅
   - 帳戶餘額與實際銷售記錄一致
   - 不會有重複扣款的情況

---

## ⚠️ 重要提醒

### 此操作不可逆轉的部分：
- **WITHDRAW 記錄被永久刪除**（無法從資料庫還原）
- **0107 餘額被調整**（可以手動調整回去）

### 可以還原的部分：
- **0107 餘額**：可以手動調整回 145,262.02 RMB
- **其他帳戶**：保持不變，無需還原

---

## 🔄 回滾方案

如果執行後發現數據不對，有以下回滾選項：

### 方案 1：手動回滾 0107 餘額（推薦）

如果只有 0107 的餘額需要回滾：

```python
# 回滾腳本：restore_0107_balance.py
from app import app, db, CashAccount

with app.app_context():
    account_0107 = db.session.execute(
        db.select(CashAccount).filter(CashAccount.id == 27)
    ).scalar_one()
    
    # 還原餘額
    account_0107.balance = 145262.02
    db.session.commit()
    print(f"0107 支付寶餘額已還原為: {account_0107.balance:,.2f} RMB")
```

### 方案 2：從資料庫備份還原（最安全）

如果整個操作都需要回滾：

1. **執行前先備份資料庫**（必須！）
2. 執行清理操作
3. 如果發現問題，從備份還原

### 方案 3：記錄 WITHDRAW 記錄後手動重建

如果以後需要查看被刪除的 WITHDRAW 記錄，可以在執行前先導出：

```python
# 備份腳本：backup_withdraw_records.py
# 將 WITHDRAW 記錄導出為 JSON，以便需要時查看
```

---

## 🎯 建議的執行流程

### 第 1 步：備份資料庫（必須！）

```bash
# 在 Render Shell 中
# 使用 Render 的資料庫備份功能，或手動導出資料
```

### 第 2 步：執行清理

```bash
python cleanup_withdraw_no_change.py
# 輸入 yes 確認
```

### 第 3 步：驗證結果

檢查：
- 0107 餘額是否為 182,895.02 RMB
- 其他帳戶餘額是否保持不變
- WITHDRAW 記錄是否已刪除

### 第 4 步：如果需要回滾

使用方案 1 手動回滾 0107 餘額，或從備份還原。

---

## 💾 執行前備份建議

在執行清理前，建議：

1. **完整資料庫備份**（Render 自動備份或手動導出）
2. **記錄當前帳戶餘額**（作為參考）
3. **導出 WITHDRAW 記錄**（如果需要保留歷史記錄）

---

## ✅ 確認執行

如果確認無誤，可以輸入 `yes` 執行清理。

如果還有疑慮，可以先：
1. 建立資料庫備份
2. 測試回滾腳本
3. 再執行清理操作

