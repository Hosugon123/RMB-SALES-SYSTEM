# 🔧 售出記錄顯示問題修正總結

## 問題描述

用戶反映現金管理頁面只顯示 `利潤入庫` 記錄，沒有顯示實際的 `售出` 記錄，導致無法看到完整的售出交易流程。

## 根本原因分析

### 1. **查詢限制過小**
- 完整API：`limit = per_page * 2` (每頁20筆，limit只有40筆)
- 簡化API：`limit = per_page` (每頁10筆，limit只有10筆)
- 問題：查詢限制太小，售出記錄可能被其他記錄擠掉

### 2. **記錄類型分離**
系統中有兩套記錄：
- **SalesRecord** - 實際的售出記錄
- **LedgerEntry (PROFIT_EARNED)** - 利潤入庫記錄

如果查詢限制太小，可能只載入了利潤記錄而沒有載入售出記錄。

## 修正內容

### ✅ 1. 增加查詢限制

**完整API修正：**
```python
# 修正前
limit = per_page * 2  # 每頁20筆，limit只有40筆

# 修正後  
limit = per_page * 5  # 每頁20筆，limit增加到100筆
```

**簡化API修正：**
```python
# 修正前
limit = per_page  # 每頁10筆，limit只有10筆

# 修正後
limit = per_page * 3  # 每頁10筆，limit增加到30筆
```

### ✅ 2. 確保記錄類型平衡

增加查詢限制後，API會載入更多記錄，確保：
- 售出記錄 (SalesRecord) 能被載入
- 利潤入庫記錄 (PROFIT_EARNED) 能被載入
- 其他交易記錄也能被載入

## 修正效果

### 修正前：
```
現金管理頁面只顯示：
- 利潤入庫記錄 (PROFIT_EARNED)
- 缺少售出記錄 (SalesRecord)
```

### 修正後：
```
現金管理頁面應該顯示：
- 售出記錄 (SalesRecord) - 顯示RMB帳戶和應收帳款變化
- 利潤入庫記錄 (PROFIT_EARNED) - 顯示利潤變動
- 其他交易記錄 (買入、轉帳、銷帳等)
```

## 完整的售出流程顯示

修正後，用戶應該能看到完整的售出流程：

### 1. **售出記錄** (SalesRecord)
```
類型: 售出
描述: 售予 [客戶名稱]
出款戶: [RMB帳戶名稱]
入款戶: 應收帳款
TWD變動: 0
RMB變動: -[售出RMB金額]
出款戶餘額變化: [RMB帳戶餘額變化]
入款戶餘額變化: [應收帳款增加]
利潤變動: [計算出的利潤]
```

### 2. **利潤入庫記錄** (PROFIT_EARNED)
```
類型: 利潤入庫
描述: 售出利潤:[客戶名稱]
出款戶: 系統利潤
入款戶: 利潤帳戶
TWD變動: 0
RMB變動: 0
利潤變動: 前: [實際數值] → 變動: +[實際利潤] → 後: [實際數值]
```

## 技術細節

### 查詢優化
- 增加查詢限制確保包含所有記錄類型
- 保持分頁功能避免性能問題
- 維持排序邏輯確保最新記錄在前

### 記錄處理
- SalesRecord 和 LedgerEntry 分別處理
- 確保兩種類型都能正確顯示
- 保持向後兼容性

## 部署狀態

- ✅ **代碼已提交到GitHub**
- ✅ **查詢限制已增加**
- ✅ **售出記錄應該能正確顯示**

## 預期效果

修正後，現金管理頁面應該：

1. **顯示售出記錄**：包含完整的帳戶餘額變化信息
2. **顯示利潤記錄**：包含正確的利潤變動數值
3. **顯示其他記錄**：買入、轉帳、銷帳等所有交易類型
4. **保持性能**：分頁載入避免一次性載入過多數據

**現在售出記錄應該能正確顯示在現金管理頁面中！** 🎉
