<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小數點輸入詳細測試</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-section {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #f8f9fa;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        
        .input-test {
            border: 2px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            background-color: white;
        }
        
        .input-test.focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }
        
        .test-step {
            margin: 15px 0;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">🔧 小數點輸入詳細測試</h1>
        
        <div class="alert alert-warning">
            <strong>測試重點：</strong> 驗證小數點輸入的各種情況，特別是「沒輸入數字時可以輸入小數點，反之則無法輸入小數點」的問題。
        </div>

        <!-- 基本小數點輸入測試 -->
        <div class="test-section">
            <h3>🔢 基本小數點輸入測試</h3>
            <p>測試各種小數點輸入情況：</p>
            
            <div class="input-test">
                <label for="basicDecimal" class="form-label">基本小數點測試</label>
                <input type="text" class="form-control" id="basicDecimal" 
                       pattern="[0-9]*\.?[0-9]*" placeholder="測試小數點輸入">
                <small class="text-muted">測試步驟：1. 輸入 . → 2. 輸入 4 → 3. 輸入 . → 4. 輸入 5</small>
            </div>

            <div class="test-step">
                <strong>測試步驟 1：</strong> 點擊欄位，輸入 <code>.</code> → 應該顯示 <code>.</code>
            </div>
            <div class="test-step">
                <strong>測試步驟 2：</strong> 繼續輸入 <code>4</code> → 應該顯示 <code>4</code>
            </div>
            <div class="test-step">
                <strong>測試步驟 3：</strong> 繼續輸入 <code>.</code> → 應該顯示 <code>4.</code>
            </div>
            <div class="test-step">
                <strong>測試步驟 4：</strong> 繼續輸入 <code>5</code> → 應該顯示 <code>4.5</code>
            </div>

            <button class="btn btn-primary" onclick="testBasicDecimal()">🧪 執行基本測試</button>
            <div id="basicTestResult" class="test-result d-none"></div>
        </div>

        <!-- 匯率欄位測試 -->
        <div class="test-section">
            <h3>📊 匯率欄位小數點測試</h3>
            <p>測試匯率欄位的特殊小數點處理：</p>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="input-test">
                        <label for="buyRate" class="form-label">買入匯率</label>
                        <input type="text" class="form-control" id="buyRate" 
                               pattern="[0-9]*\.?[0-9]*" placeholder="例如: 4.5000">
                        <small class="text-muted">測試: . → 4 → . → 5 → 0 → 0 → 0</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="input-test">
                        <label for="sellRate" class="form-label">賣出匯率</label>
                        <input type="text" class="form-control" id="sellRate" 
                               pattern="[0-9]*\.?[0-9]*" placeholder="例如: 4.6000">
                        <small class="text-muted">測試: . → 4 → . → 6 → 0 → 0 → 0</small>
                    </div>
                </div>
            </div>

            <button class="btn btn-success" onclick="testRateInputs()">🧪 測試匯率輸入</button>
            <div id="rateTestResult" class="test-result d-none"></div>
        </div>

        <!-- 邊界情況測試 -->
        <div class="test-section">
            <h3>⚠️ 邊界情況測試</h3>
            <p>測試各種邊界情況：</p>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="input-test">
                        <label for="edgeTest1" class="form-label">測試 1: 連續小數點</label>
                        <input type="text" class="form-control" id="edgeTest1" 
                               pattern="[0-9]*\.?[0-9]*" placeholder="輸入 4..5">
                        <small class="text-muted">應該阻止多個小數點</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-test">
                        <label for="edgeTest2" class="form-label">測試 2: 小數點開頭</label>
                        <input type="text" class="form-control" id="edgeTest2" 
                               pattern="[0-9]*\.?[0-9]*" placeholder="輸入 .5">
                        <small class="text-muted">應該允許 .5</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-test">
                        <label for="edgeTest3" class="form-label">測試 3: 小數點結尾</label>
                        <input type="text" class="form-control" id="edgeTest3" 
                               pattern="[0-9]*\.?[0-9]*" placeholder="輸入 4.">
                        <small class="text-muted">應該允許 4.</small>
                    </div>
                </div>
            </div>

            <button class="btn btn-warning" onclick="testEdgeCases()">🧪 測試邊界情況</button>
            <div id="edgeTestResult" class="test-result d-none"></div>
        </div>

        <!-- 實時監控 -->
        <div class="test-section">
            <h3>📊 實時輸入監控</h3>
            <p>監控所有欄位的實時輸入狀態：</p>
            
            <div id="realTimeMonitor" class="alert alert-info">
                <strong>實時狀態：</strong> 請在任意欄位輸入內容，這裡會顯示實時狀態
            </div>
        </div>

        <!-- 測試結果總結 -->
        <div class="test-section">
            <h3>📋 測試結果總結</h3>
            <div id="testSummary"></div>
        </div>
    </div>

    <!-- 引入修復後的腳本 -->
    <script src="static/js/enhanced_number_input.js"></script>
    
    <script>
        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 頁面載入完成，開始初始化...');
            
            // 初始化所有測試欄位
            const testInputs = [
                'basicDecimal', 'buyRate', 'sellRate',
                'edgeTest1', 'edgeTest2', 'edgeTest3'
            ];
            
            testInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    // 為匯率欄位設置特殊選項
                    let options = { minDecimals: 0, maxDecimals: 2 };
                    
                    if (inputId.includes('Rate')) {
                        options.maxDecimals = 4; // 匯率欄位支持4位小數
                    }
                    
                    setupNumberInputFormatting(input, options);
                    console.log(`✅ 已初始化 ${inputId} 欄位`);
                    
                    // 添加焦點事件監聽
                    input.addEventListener('focus', function() {
                        this.parentElement.classList.add('focus');
                    });
                    
                    input.addEventListener('blur', function() {
                        this.parentElement.classList.remove('focus');
                    });
                }
            });
            
            console.log('🎉 所有測試欄位初始化完成！');
        });

        // 基本小數點測試
        function testBasicDecimal() {
            const input = document.getElementById('basicDecimal');
            const resultDiv = document.getElementById('basicTestResult');
            
            if (!input.value) {
                resultDiv.innerHTML = '請先在欄位中輸入一些內容進行測試';
                resultDiv.className = 'test-result info';
                resultDiv.classList.remove('d-none');
                return;
            }
            
            const actualValue = input.getActualValue ? input.getActualValue() : input.value;
            const displayValue = input.value;
            
            let result = `顯示值: ${displayValue}<br>實際值: ${actualValue}<br><br>`;
            
            // 分析輸入內容
            if (displayValue.includes('.')) {
                result += '✅ 包含小數點<br>';
                if (displayValue.endsWith('.')) {
                    result += '✅ 以小數點結尾（正確）<br>';
                } else {
                    result += '✅ 小數點在數字中間（正確）<br>';
                }
            } else {
                result += '❌ 不包含小數點<br>';
            }
            
            if (displayValue.startsWith('.')) {
                result += '✅ 以小數點開頭（正確）<br>';
            }
            
            resultDiv.innerHTML = result;
            resultDiv.className = 'test-result success';
            resultDiv.classList.remove('d-none');
        }

        // 匯率輸入測試
        function testRateInputs() {
            const resultDiv = document.getElementById('rateTestResult');
            let results = [];
            
            const rateInputs = ['buyRate', 'sellRate'];
            rateInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input.value) {
                    const actualValue = input.getActualValue ? input.getActualValue() : input.value;
                    results.push(`${input.placeholder}: ${input.value} → 實際值: ${actualValue}`);
                }
            });
            
            if (results.length > 0) {
                resultDiv.innerHTML = results.join('<br>');
                resultDiv.className = 'test-result success';
                resultDiv.classList.remove('d-none');
            } else {
                resultDiv.innerHTML = '請先在匯率欄位輸入一些數值進行測試';
                resultDiv.className = 'test-result info';
                resultDiv.classList.remove('d-none');
            }
        }

        // 邊界情況測試
        function testEdgeCases() {
            const resultDiv = document.getElementById('edgeTestResult');
            let results = [];
            
            const edgeInputs = ['edgeTest1', 'edgeTest2', 'edgeTest3'];
            edgeInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input.value) {
                    const actualValue = input.getActualValue ? input.getActualValue() : input.value;
                    results.push(`${input.placeholder}: ${input.value} → 實際值: ${actualValue}`);
                }
            });
            
            if (results.length > 0) {
                resultDiv.innerHTML = results.join('<br>');
                resultDiv.className = 'test-result success';
                resultDiv.classList.remove('d-none');
            } else {
                resultDiv.innerHTML = '請先在邊界測試欄位輸入一些數值進行測試';
                resultDiv.className = 'test-result info';
                resultDiv.classList.remove('d-none');
            }
        }

        // 實時監控所有輸入
        function updateRealTimeMonitor() {
            const allInputs = document.querySelectorAll('input[type="text"]');
            let results = [];
            
            allInputs.forEach(input => {
                if (input.value) {
                    const actualValue = input.getActualValue ? input.getActualValue() : input.value;
                    const displayValue = input.value;
                    
                    let status = '';
                    if (displayValue.includes('.')) {
                        if (displayValue.endsWith('.')) {
                            status = '🟡 正在輸入小數點';
                        } else if (displayValue.startsWith('.')) {
                            status = '🟢 小數點開頭';
                        } else {
                            status = '🟢 正常小數';
                        }
                    } else {
                        status = '🔵 整數';
                    }
                    
                    results.push(`${input.placeholder || input.id}: ${displayValue} (${status})`);
                }
            });
            
            if (results.length > 0) {
                document.getElementById('realTimeMonitor').innerHTML = `
                    <strong>實時狀態：</strong><br>
                    ${results.join('<br>')}
                `;
            } else {
                document.getElementById('realTimeMonitor').innerHTML = `
                    <strong>實時狀態：</strong> 請在任意欄位輸入內容，這裡會顯示實時狀態
                `;
            }
        }

        // 為所有輸入欄位添加實時更新
        document.addEventListener('input', function(e) {
            if (e.target.type === 'text' && e.target.pattern) {
                setTimeout(updateRealTimeMonitor, 100);
            }
        });

        // 定期更新監控
        setInterval(updateRealTimeMonitor, 1000);
    </script>
</body>
</html>
