# 銷帳錯誤調試記憶文件

## 問題描述
用戶在執行銷帳操作時遇到500內部伺服器錯誤，錯誤發生在 `/api/settlement` 端點。

## 已實施的解決方案

### 1. 詳細調試日誌
在 `app.py` 的 `api_settlement()` 函數中添加了詳細的調試日誌，包括：
- 請求數據解析
- 參數驗證過程
- 資料庫查詢結果
- 業務邏輯執行步驟
- 記錄創建過程
- 事務提交狀態
- 錯誤詳情和堆疊追蹤

### 2. 本地調試工具
創建了 `debug_settlement_error.py` 工具，可以：
- 模擬完整的銷帳操作流程
- 檢查資料庫結構完整性
- 驗證參數和數據
- 提供詳細的錯誤診斷
- 避免重複部署進行調試

### 3. 快速測試工具
創建了 `test_settlement_quick.py` 工具，可以：
- 快速驗證銷帳功能是否正常
- 檢查資料庫數據完整性
- 模擬實際銷帳操作
- 驗證結果正確性

## 常見錯誤原因

### 1. 資料庫結構問題
- `ledger_entries` 表格缺少必要欄位
- `cash_logs` 表格結構不完整
- 外鍵關聯問題

### 2. 數據問題
- 客戶不存在或應收帳款為0
- 帳戶不存在或已停用
- 幣種不匹配（非TWD帳戶）
- 銷帳金額超過應收帳款

### 3. 權限問題
- 資料庫寫入權限不足
- 事務提交失敗

## 調試步驟

### 1. 使用本地調試工具
```bash
python debug_settlement_error.py
```
按照提示輸入參數，查看詳細的錯誤信息。

### 2. 檢查線上日誌
部署後查看Flask應用的控制台輸出，尋找以 `🔧 銷帳API:` 開頭的調試信息。

### 3. 使用快速測試
```bash
python test_settlement_quick.py
```
驗證本地環境的銷帳功能是否正常。

## 錯誤處理改進

### 1. 更詳細的錯誤信息
- 每個步驟都有詳細的日誌輸出
- 錯誤發生時提供具體的錯誤原因
- 包含完整的堆疊追蹤信息

### 2. 更好的用戶提示
- 區分不同類型的錯誤（參數錯誤、資料庫錯誤、業務邏輯錯誤）
- 提供具體的修復建議

## 預防措施

### 1. 資料庫結構檢查
在創建記錄前檢查必要欄位是否存在。

### 2. 參數驗證
加強輸入參數的驗證和類型檢查。

### 3. 事務管理
確保事務的正確提交和回滾。

## 相關文件

- `app.py` - 主要的銷帳API實現
- `debug_settlement_error.py` - 本地調試工具
- `test_settlement_quick.py` - 快速測試工具
- `templates/cash_management.html` - 前端銷帳界面

## 注意事項

1. 調試日誌會產生大量輸出，生產環境可能需要調整日誌級別
2. 本地調試工具需要與線上環境使用相同的資料庫結構
3. 測試工具會修改資料庫數據，請在測試環境中使用
