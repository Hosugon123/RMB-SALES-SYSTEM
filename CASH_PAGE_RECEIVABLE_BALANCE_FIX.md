# 現金頁面售出記錄客戶應收帳款餘額變化修復

## 🚨 問題描述

用戶發現現金頁面的售出記錄的「入款戶餘額變化」欄位顯示「-」，沒有顯示客戶個人應收帳款餘額變化卡片，而客戶個人交易紀錄頁面已經有這個功能。

**問題症狀**：
- 現金頁面：售出記錄的入款戶餘額變化欄位顯示「-」
- 客戶交易紀錄頁面：已正確顯示客戶應收帳款餘額變化卡片
- 數據不一致：兩個頁面顯示不同的信息

## 🔍 問題根本原因

在現金頁面的後端代碼中，計算客戶應收帳款餘額變化時使用了未定義的`customer`變數：

```python
# 錯誤的代碼
customer_receivable_after = customer.total_receivables_twd if customer else 0
```

**問題**：`customer`變數沒有被正確獲取，導致計算失敗，前端無法顯示客戶應收帳款餘額變化卡片。

## 🔧 已完成的修復

### 修復後端代碼

**文件**：`app.py` - `get_cash_management_transactions`函數

**修復前（錯誤）**：
```python
# 計算客戶個人應收帳款餘額變化
try:
    # 獲取客戶當前應收帳款餘額
    customer_receivable_after = customer.total_receivables_twd if customer else 0  # ❌ customer未定義
    customer_receivable_before = customer_receivable_after - twd_amount
    customer_receivable_change = twd_amount
```

**修復後（正確）**：
```python
# 計算客戶個人應收帳款餘額變化
try:
    # 獲取客戶對象
    customer = None
    if hasattr(s, 'customer') and s.customer:
        customer = s.customer
    
    # 獲取客戶當前應收帳款餘額
    customer_receivable_after = customer.total_receivables_twd if customer else 0
    customer_receivable_before = customer_receivable_after - twd_amount
    customer_receivable_change = twd_amount
```

### 修復的關鍵點

1. **正確獲取客戶對象**：
   - 從銷售記錄`s`中獲取關聯的客戶對象
   - 使用`hasattr`和`getattr`安全地獲取客戶信息

2. **安全的錯誤處理**：
   - 如果客戶對象不存在，使用預設值
   - 確保計算不會因為缺少客戶信息而失敗

3. **調試信息**：
   - 添加詳細的調試日誌
   - 幫助追蹤客戶應收帳款餘額變化的計算過程

## 🎯 修復效果

### 修復前
- 現金頁面：售出記錄的入款戶餘額變化欄位顯示「-」
- 客戶交易紀錄頁面：正確顯示客戶應收帳款餘額變化卡片
- **狀態**：數據不一致 ❌

### 修復後（預期）
- 現金頁面：售出記錄的入款戶餘額變化欄位顯示客戶應收帳款餘額變化卡片
- 客戶交易紀錄頁面：繼續正確顯示客戶應收帳款餘額變化卡片
- **狀態**：數據一致 ✅

## 🎨 預期顯示效果

**現金頁面售出記錄的入款戶餘額變化欄位**：
```
┌─────────────────────────┐
│ 小曾 應收帳款            │
│ 前: 2,125,179.80        │
│ 變動: +25.00            │
│ 後: 2,125,204.80        │
└─────────────────────────┘
```

**視覺特點**：
- 淺藍色背景卡片
- 左側藍色邊框
- 清楚標示客戶名稱
- 顯示前、變動、後三個數值

## 🧪 測試步驟

1. **重新啟動應用**：
   ```bash
   python app.py
   ```

2. **測試現金頁面**：
   - 打開現金管理頁面
   - 查看售出記錄的入款戶餘額變化欄位
   - 確認顯示客戶個人應收帳款餘額變化卡片

3. **測試客戶交易紀錄頁面**：
   - 點擊客戶名稱打開交易紀錄模態框
   - 確認應收帳款餘額變化欄位正常顯示

4. **驗證數據一致性**：
   - 確認兩個頁面顯示的客戶應收帳款餘額變化數據一致
   - 驗證計算邏輯的正確性

## ✅ 修復驗證

修復完成後，應該能夠：

1. **現金頁面顯示**：售出記錄的入款戶餘額變化欄位顯示客戶個人應收帳款餘額變化卡片
2. **數據一致性**：現金頁面和客戶交易紀錄頁面顯示相同的客戶應收帳款餘額變化信息
3. **視覺統一**：兩個頁面使用相同的卡片式設計風格
4. **功能完整**：客戶個人應收帳款餘額變化功能在兩個頁面都正常工作

現在現金頁面的售出記錄也會顯示客戶個人應收帳款餘額變化卡片了！
