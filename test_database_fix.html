<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡æ–™åº«ä¿®å¾©æ¸¬è©¦</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">ğŸ”§ è³‡æ–™åº«ä¿®å¾©æ¸¬è©¦</h1>
                
                <!-- æ¸¬è©¦æŒ‰éˆ• -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>æ¸¬è©¦åŠŸèƒ½</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <button id="testTransactions" class="btn btn-primary mb-2">
                                    <i class="bi bi-list-ul"></i> æ¸¬è©¦äº¤æ˜“è¨˜éŒ„API
                                </button>
                                <button id="testProfitHistory" class="btn btn-success mb-2">
                                    <i class="bi bi-clock-history"></i> æ¸¬è©¦åˆ©æ½¤æ­·å²API
                                </button>
                                <button id="testSimpleAPI" class="btn btn-info mb-2">
                                    <i class="bi bi-lightning"></i> æ¸¬è©¦ç°¡åŒ–API
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button id="clearResults" class="btn btn-outline-secondary mb-2">
                                    <i class="bi bi-trash"></i> æ¸…é™¤çµæœ
                                </button>
                                <button id="runAllTests" class="btn btn-warning mb-2">
                                    <i class="bi bi-play-circle"></i> åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ¸¬è©¦çµæœ -->
                <div class="card">
                    <div class="card-header">
                        <h5>æ¸¬è©¦çµæœ</h5>
                    </div>
                    <div class="card-body">
                        <div id="testResults" class="alert alert-info">
                            é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ¸¬è©¦...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const baseUrl = window.location.origin;
        
        // æ¸¬è©¦äº¤æ˜“è¨˜éŒ„API
        document.getElementById('testTransactions').addEventListener('click', async function() {
            await testAPI('äº¤æ˜“è¨˜éŒ„API', `${baseUrl}/api/cash_management/transactions?page=1&per_page=5`);
        });
        
        // æ¸¬è©¦åˆ©æ½¤æ­·å²API
        document.getElementById('testProfitHistory').addEventListener('click', async function() {
            await testAPI('åˆ©æ½¤æ­·å²API', `${baseUrl}/api/profit/history?page=1&per_page=5`);
        });
        
        // æ¸¬è©¦ç°¡åŒ–API
        document.getElementById('testSimpleAPI').addEventListener('click', async function() {
            await testAPI('ç°¡åŒ–API', `${baseUrl}/api/cash_management/transactions_simple?page=1&per_page=5`);
        });
        
        // åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
        document.getElementById('runAllTests').addEventListener('click', async function() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦ä¸­...';
            
            let allResults = '<h6>ğŸ§ª æ‰€æœ‰æ¸¬è©¦çµæœ</h6>';
            
            // æ¸¬è©¦äº¤æ˜“è¨˜éŒ„API
            allResults += await testAPI('äº¤æ˜“è¨˜éŒ„API', `${baseUrl}/api/cash_management/transactions?page=1&per_page=5`, true);
            
            // æ¸¬è©¦åˆ©æ½¤æ­·å²API
            allResults += await testAPI('åˆ©æ½¤æ­·å²API', `${baseUrl}/api/profit/history?page=1&per_page=5`, true);
            
            // æ¸¬è©¦ç°¡åŒ–API
            allResults += await testAPI('ç°¡åŒ–API', `${baseUrl}/api/cash_management/transactions_simple?page=1&per_page=5`, true);
            
            resultsDiv.innerHTML = allResults;
        });
        
        // æ¸…é™¤çµæœ
        document.getElementById('clearResults').addEventListener('click', function() {
            document.getElementById('testResults').innerHTML = 'é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ¸¬è©¦...';
        });
        
        // é€šç”¨APIæ¸¬è©¦å‡½æ•¸
        async function testAPI(apiName, url, returnResult = false) {
            const resultsDiv = document.getElementById('testResults');
            if (!returnResult) {
                resultsDiv.innerHTML = `<div class="spinner-border spinner-border-sm me-2"></div>æ¸¬è©¦${apiName}ä¸­...`;
            }
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                let html = '';
                if (returnResult) {
                    html = `<div class="mb-3"><h6>ğŸ“Š ${apiName}</h6>`;
                } else {
                    html = `<h6>ğŸ“Š ${apiName}æ¸¬è©¦çµæœ</h6>`;
                }
                
                html += `<p><strong>ç‹€æ…‹ç¢¼:</strong> ${response.status}</p>`;
                html += `<p><strong>APIç‹€æ…‹:</strong> ${data.status}</p>`;
                
                if (data.status === 'success') {
                    const transactions = data.data?.transactions || [];
                    html += `<p><strong>è¨˜éŒ„æ•¸é‡:</strong> ${transactions.length}</p>`;
                    
                    if (transactions.length > 0) {
                        html += '<div class="alert alert-success">âœ… APIæ­£å¸¸é‹ä½œ</div>';
                        
                        // é¡¯ç¤ºå‰3ç­†è¨˜éŒ„çš„æ‘˜è¦
                        html += '<h6>ğŸ“‹ è¨˜éŒ„æ‘˜è¦:</h6>';
                        html += '<div class="table-responsive"><table class="table table-sm">';
                        html += '<thead><tr><th>é¡å‹</th><th>æè¿°</th><th>æ—¥æœŸ</th><th>é‡‘é¡</th></tr></thead><tbody>';
                        
                        transactions.slice(0, 3).forEach(record => {
                            html += `<tr>
                                <td>${record.type || record.transaction_type || '-'}</td>
                                <td>${record.description || '-'}</td>
                                <td>${record.date || record.created_at || '-'}</td>
                                <td>${record.amount || record.tw_change || '-'}</td>
                            </tr>`;
                        });
                        
                        html += '</tbody></table></div>';
                    } else {
                        html += '<div class="alert alert-warning">âš ï¸ æ²’æœ‰æ‰¾åˆ°è¨˜éŒ„</div>';
                    }
                } else {
                    html += `<div class="alert alert-danger">âŒ APIéŒ¯èª¤: ${data.message || 'æœªçŸ¥éŒ¯èª¤'}</div>`;
                }
                
                if (returnResult) {
                    html += '</div>';
                    return html;
                } else {
                    resultsDiv.innerHTML = html;
                }
            } catch (error) {
                const errorHtml = returnResult ? 
                    `<div class="mb-3"><h6>ğŸ“Š ${apiName}</h6><div class="alert alert-danger">âŒ æ¸¬è©¦å¤±æ•—: ${error.message}</div></div>` :
                    `<div class="alert alert-danger">âŒ æ¸¬è©¦å¤±æ•—: ${error.message}</div>`;
                
                if (returnResult) {
                    return errorHtml;
                } else {
                    resultsDiv.innerHTML = errorHtml;
                }
            }
        }
    </script>
</body>
</html>
