# 銷帳功能增強說明

## 概述

本次更新增強了客戶明細中的銷帳收款功能，新增了三個重要欄位，讓用戶能夠清楚看到銷帳前後的應收帳款變化，以及資金入庫的帳戶資訊。

## 新增欄位

### 1. 銷帳前應收總額
- **功能**：顯示客戶在銷帳前的應收帳款總額
- **顯示方式**：只讀欄位，背景為淺灰色
- **格式**：NT$ 50,000.00

### 2. 本次銷帳金額
- **功能**：即時顯示用戶輸入的銷帳金額
- **顯示方式**：只讀欄位，背景為綠色，文字為白色
- **更新機制**：當用戶在銷帳金額輸入框中輸入時，此欄位會即時更新
- **格式**：NT$ 25,000.00

### 3. 銷帳後剩餘應收
- **功能**：即時計算並顯示銷帳後客戶的應收帳款餘額
- **計算公式**：銷帳前應收總額 - 本次銷帳金額
- **顯示方式**：只讀欄位，背景為黃色
- **更新機制**：與本次銷帳金額同步更新
- **格式**：NT$ 25,000.00

### 4. 入庫帳戶（重新命名）
- **功能**：選擇收款後資金將存入的帳戶
- **顯示方式**：下拉選單，只顯示台幣帳戶
- **必填性**：必填欄位（標記為紅色星號）
- **說明**：清楚標示此為資金入庫的目標帳戶

## 技術實現

### 前端增強
1. **即時計算**：使用JavaScript事件監聽器，當銷帳金額變更時即時更新相關顯示欄位
2. **視覺化設計**：使用不同顏色背景區分不同類型的資訊
3. **響應式佈局**：使用Bootstrap網格系統，在不同螢幕尺寸下都能良好顯示

### 後端支援
1. **資料驗證**：銷帳API會驗證銷帳金額不超過應收帳款總額
2. **事務處理**：確保銷帳操作的原子性，避免資料不一致
3. **審計記錄**：記錄所有銷帳操作，包括操作人員、時間和備註

## 使用流程

### 1. 開啟銷帳模態框
- 在客戶明細頁面點擊「銷帳」按鈕
- 系統自動填入客戶資訊和應收帳款總額

### 2. 輸入銷帳資訊
- **銷帳金額**：輸入實際收到的金額
- **入庫帳戶**：選擇收款後資金存入的帳戶
- **備註**：可選，記錄收款相關資訊

### 3. 即時預覽
- 系統即時顯示本次銷帳金額和剩餘應收
- 用戶可以清楚看到銷帳前後的變化

### 4. 確認銷帳
- 點擊「確認銷帳」按鈕
- 系統執行銷帳操作並更新資料庫

## 資料庫影響

### 更新的表格
1. **customers**：更新 `total_receivables_twd` 欄位
2. **cash_accounts**：更新收款帳戶的 `balance` 欄位
3. **ledger_entries**：新增銷帳記錄
4. **cash_logs**：新增現金流水記錄

### 資料完整性
- 銷帳金額不能超過應收帳款總額
- 所有相關操作在同一個資料庫事務中執行
- 操作失敗時自動回滾，確保資料一致性

## 測試驗證

### 測試頁面
創建了 `test_settlement_enhanced.html` 測試頁面，可以：
- 模擬銷帳操作
- 驗證即時計算功能
- 測試表單驗證
- 查看銷帳結果

### 測試步驟
1. 開啟測試頁面
2. 輸入不同的銷帳金額
3. 觀察即時計算結果
4. 選擇入庫帳戶
5. 提交表單查看結果

## 注意事項

### 1. 權限控制
- 只有登入用戶才能執行銷帳操作
- 建議限制只有特定角色（如財務人員）才能銷帳

### 2. 資料備份
- 銷帳操作會影響重要財務資料
- 建議在執行前備份相關資料

### 3. 審計追蹤
- 所有銷帳操作都會記錄操作人員和時間
- 建議定期檢查銷帳記錄，確保操作合規

## 未來改進建議

### 1. 部分銷帳支援
- 支援一次銷帳多筆應收帳款
- 支援按日期範圍銷帳

### 2. 銷帳憑證
- 支援上傳收款憑證
- 記錄收款方式和時間

### 3. 銷帳審批
- 支援銷帳前的審批流程
- 記錄審批人員和意見

### 4. 報表功能
- 銷帳統計報表
- 應收帳款變化趨勢分析

## 技術支援

如有任何問題或需要進一步的技術支援，請聯繫開發團隊或查看相關的API文檔。
