# 數據修復工具使用說明

## 問題背景

您之前刪除了一些售出訂單，但當時的刪除功能還沒有完全修復，導致數據不一致。具體表現為：

- 庫存數據不準確（已出帳數量、剩餘數量）
- 現金帳戶餘額不正確
- 客戶應收帳款計算錯誤
- 整體數據對不上

## 解決方案

我為您創建了兩個數據修復工具：

### 1. 快速修復工具 (`quick_data_fix.py`)

**適用場景**：快速修復基本的數據不一致問題

**功能**：
- 重新計算所有庫存的已出帳數量和剩餘數量
- 重新計算現金帳戶餘額
- 重新計算客戶應收帳款

**使用方法**：
```bash
python quick_data_fix.py
```

### 2. 完整修復工具 (`data_recovery_tool.py`)

**適用場景**：需要更詳細的修復過程和驗證

**功能**：
- 包含快速修復工具的所有功能
- 提供詳細的修復過程日誌
- 執行數據一致性驗證
- 顯示修復前後的數據狀態對比

**使用方法**：
```bash
python data_recovery_tool.py
```

## 修復原理

### 庫存數據修復

1. **重新計算已出帳數量**：
   - 基於現有的 `SalesRecord` 記錄
   - 按 `inventory_batch_id` 分組統計
   - 只計算 `is_active = True` 的記錄

2. **更新剩餘數量**：
   - `remaining_rmb = original_rmb - issued_rmb`
   - 如果剩餘數量 ≤ 0，標記為已出清

### 現金帳戶餘額修復

1. **TWD 帳戶**：
   - 初始餘額 - 買入出款 - 提款/轉出/刷卡 + 存款/轉入/銷帳

2. **RMB 帳戶**：
   - 初始餘額 + 買入入款 - 銷售出款 - 提款/轉出 + 存款/轉入

### 客戶應收帳款修復

1. **總銷售金額**：基於現有的 `SalesRecord` 記錄
2. **已收款金額**：基於 `LedgerEntry` 的銷帳記錄
3. **應收餘額**：`total_sales - received_amount`

## 使用步驟

### 步驟 1：備份數據（可選但建議）

在執行修復之前，建議先備份數據庫：

```bash
# 如果使用 SQLite
cp your_database.db backup_before_fix.db

# 如果使用其他數據庫，請使用相應的備份命令
```

### 步驟 2：執行修復

選擇其中一個工具執行：

```bash
# 快速修復
python quick_data_fix.py

# 或者完整修復
python data_recovery_tool.py
```

### 步驟 3：確認修復結果

工具會顯示：
- 修復過程的詳細日誌
- 修復後的數據狀態
- 數據一致性驗證結果

### 步驟 4：驗證系統

修復完成後，請檢查：
1. 庫存管理頁面的數據是否正確
2. 現金管理頁面的餘額是否準確
3. 客戶應收帳款是否正確

## 注意事項

### ⚠️ 重要提醒

1. **數據不可逆**：修復過程會直接修改數據庫，請確保已備份
2. **系統狀態**：建議在系統閒置時執行修復
3. **權限要求**：確保腳本有讀寫數據庫的權限

### 🔍 修復後檢查

修復完成後，請檢查以下關鍵指標：

1. **庫存一致性**：
   - 原始數量 = 已出帳數量 + 剩餘數量
   - 已出清批次是否正確標記

2. **現金帳戶餘額**：
   - 各帳戶餘額是否合理
   - 總資產是否與預期相符

3. **應收帳款**：
   - 客戶應收餘額是否正確
   - 銷帳記錄是否完整

## 故障排除

### 常見問題

1. **權限錯誤**：
   ```
   解決方案：確保腳本有數據庫讀寫權限
   ```

2. **模塊導入錯誤**：
   ```
   解決方案：確保在正確的目錄下執行腳本
   ```

3. **數據庫連接錯誤**：
   ```
   解決方案：檢查數據庫配置和連接字符串
   ```

### 如果修復失敗

1. **檢查錯誤日誌**：腳本會顯示詳細的錯誤信息
2. **回滾數據庫**：使用備份恢復數據
3. **分段修復**：可以修改腳本，只修復特定部分

## 聯繫支持

如果在使用過程中遇到問題，請提供：

1. 錯誤信息截圖
2. 數據庫類型（SQLite/MySQL/PostgreSQL）
3. 系統環境信息
4. 具體的錯誤描述

## 總結

這個數據修復工具可以幫助您：

- ✅ 修復因刪除售出訂單導致的數據不一致
- ✅ 重新計算庫存、現金帳戶和應收帳款
- ✅ 確保系統數據的準確性和一致性
- ✅ 恢復系統的正常運作

建議先使用快速修復工具，如果問題複雜再使用完整修復工具。修復完成後，您的系統數據應該會重新對上，庫存管理和現金管理功能也會正常工作。
