# 遠程數據修復工具使用說明

## 🌐 適用場景

這個工具專門為**部署在服務器上的系統**設計，當您無法直接訪問服務器終端時，可以通過網頁界面來修復數據庫不一致問題。

## 🚀 快速開始

### 步驟 1：部署修復工具

1. **將修復文件上傳到服務器**：
   - `remote_data_fix_api.py` - 包含修復 API 端點
   - `templates/admin_data_recovery.html` - 管理界面

2. **在服務器上執行**：
   ```bash
   # 進入項目目錄
   cd /path/to/your/RMB-SALES-SYSTEM
   
   # 執行修復 API 腳本
   python remote_data_fix_api.py
   ```

### 步驟 2：訪問修復界面

在瀏覽器中訪問：
```
http://your-server-ip:port/admin_data_recovery
```

或者將修復頁面添加到您的導航菜單中。

## 🔧 功能說明

### 1. 數據狀態檢查
- **庫存狀態**：顯示活躍批次數量、原始總量、已出帳數量、剩餘數量
- **現金帳戶**：顯示 TWD 和 RMB 帳戶數量及總餘額
- **客戶狀態**：顯示活躍客戶數量和應收帳款總額
- **一致性檢查**：自動驗證庫存數據的一致性

### 2. 數據修復操作
- **庫存數據修復**：重新計算已出帳數量和剩餘數量
- **現金帳戶餘額修復**：基於實際交易記錄重新計算帳戶餘額
- **客戶應收帳款修復**：重新統計銷售和收款記錄

### 3. 修復結果查看
- **修復摘要**：顯示修復的項目數量和最終狀態
- **詳細記錄**：可展開查看每個項目的具體修復前後對比
- **報告下載**：下載完整的修復報告（JSON 格式）

## 📱 使用方法

### 1. 檢查當前狀態
- 頁面載入後會自動顯示當前數據狀態
- 點擊「刷新」按鈕可以重新檢查狀態

### 2. 執行數據修復
1. 點擊「執行數據修復」按鈕
2. 在確認對話框中確認操作
3. 等待修復完成（會顯示進度指示器）

### 3. 查看修復結果
- 修復完成後會自動顯示結果摘要
- 點擊詳細記錄的展開按鈕查看具體修復內容
- 可以下載修復報告保存記錄

## 🔒 安全考慮

### 權限控制
- 建議添加管理員權限檢查
- 可以修改 `remote_data_fix_api.py` 中的權限驗證邏輯

### 操作確認
- 執行修復前會顯示警告對話框
- 需要用戶明確確認才能執行

### 日誌記錄
- 所有操作都會記錄在操作日誌中
- 包含時間戳和操作結果

## ⚠️ 重要提醒

### 執行前準備
1. **備份數據庫**：修復過程會直接修改數據庫
2. **系統狀態**：確保沒有其他用戶在使用系統
3. **權限確認**：確保有管理員權限

### 執行過程
1. **不要中斷**：修復過程中請不要關閉頁面或刷新
2. **等待完成**：大型數據庫可能需要較長時間
3. **檢查結果**：修復完成後請驗證數據是否正確

### 執行後驗證
1. **檢查庫存頁面**：確認庫存數據是否正確
2. **檢查現金管理頁面**：確認帳戶餘額是否準確
3. **檢查客戶應收帳款**：確認應收餘額是否正確

## 🚨 故障排除

### 常見問題

1. **API 端點無法訪問**：
   ```
   解決方案：檢查 Flask 應用是否正確啟動，API 路由是否正確註冊
   ```

2. **權限錯誤**：
   ```
   解決方案：檢查用戶是否有管理員權限，或修改權限驗證邏輯
   ```

3. **數據庫連接錯誤**：
   ```
   解決方案：檢查數據庫配置和連接字符串
   ```

4. **修復過程超時**：
   ```
   解決方案：大型數據庫可能需要調整超時設置，或分段執行修復
   ```

### 錯誤處理

- 所有錯誤都會在操作日誌中記錄
- 修復失敗時會自動回滾數據庫更改
- 可以查看詳細的錯誤信息進行診斷

## 📊 修復報告格式

修復完成後可以下載 JSON 格式的報告，包含：

```json
{
  "title": "數據修復報告",
  "timestamp": "2024-01-01T10:00:00",
  "summary": {
    "inventory_batches_fixed": 5,
    "cash_accounts_fixed": 8,
    "customers_fixed": 3
  },
  "final_status": {
    "inventory": {
      "total_original": 1000000,
      "total_issued": 600000,
      "total_remaining": 400000
    },
    "cash_accounts": {
      "total_twd": 500000,
      "total_rmb": 25000
    },
    "receivables": 150000
  },
  "details": {
    "inventory_fixes": [...],
    "account_fixes": [...],
    "customer_fixes": [...]
  }
}
```

## 🔄 定期維護

### 建議的維護週期
- **每日**：檢查數據狀態
- **每週**：執行數據一致性檢查
- **每月**：執行完整數據修復（如果需要）

### 預防措施
1. **定期備份**：建立自動備份機制
2. **監控系統**：設置數據一致性監控
3. **用戶培訓**：培訓用戶正確使用系統功能

## 📞 技術支持

如果在使用過程中遇到問題，請提供：

1. **錯誤信息**：完整的錯誤日誌
2. **系統信息**：服務器環境、數據庫類型
3. **操作步驟**：執行的具體操作
4. **預期結果**：期望達到的效果

## 總結

這個遠程數據修復工具為您提供了：

- ✅ **網頁界面**：無需終端訪問即可修復數據
- ✅ **安全確認**：多重確認機制防止誤操作
- ✅ **詳細記錄**：完整的修復過程和結果記錄
- ✅ **報告下載**：可保存的修復報告
- ✅ **狀態監控**：實時查看數據狀態和一致性

通過這個工具，您可以安全、方便地修復部署服務器上的數據不一致問題，確保系統數據的準確性和完整性。
