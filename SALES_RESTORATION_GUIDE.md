# 🚀 售出數據恢復工具使用指南

## 📋 工具概述

**`restore_deleted_sales.py`** 是一個專門用於恢復被刪除的售出訂單數據的工具。

### 🎯 主要目標
- **恢復被刪除的售出記錄**
- **重新建立庫存分配關係**
- **回到刪除售出訂單之前的完整數據狀態**
- **解決庫存數據不一致問題**

## 🔍 問題分析

### 當前狀況
從您的系統日誌可以看到：
- **庫存數據不一致**: 總原始數量 ¥738,751.95，總剩餘數量 ¥40,773.31
- **已出帳數量**: ¥697,976.64 (這應該是已售出的數量)
- **問題**: 金額對不上，需要回到刪除售出訂單之前的數據

### 問題根源
1. **售出訂單被刪除**: 導致銷售記錄缺失
2. **庫存分配記錄丟失**: 無法追蹤庫存流向
3. **數據不一致**: 庫存剩餘數量與實際銷售情況不匹配

## 🛠️ 使用方法

### 步驟 1: 運行恢復工具
```bash
python restore_deleted_sales.py
```

### 步驟 2: 工具會自動執行以下流程
1. **分析當前數據狀態** - 檢查庫存、銷售記錄、分配記錄
2. **檢查備份文件** - 尋找可用的數據庫備份
3. **選擇備份文件** - 自動選擇最新的備份
4. **執行數據恢復** - 恢復銷售記錄和庫存分配
5. **驗證恢復結果** - 檢查數據一致性

## 📊 恢復流程詳解

### 恢復步驟
1. **清空現有銷售分配記錄** - 重置分配狀態
2. **重置庫存剩餘數量** - 將所有庫存設為原始數量
3. **恢復銷售記錄** - 從備份中恢復被刪除的銷售記錄
4. **重新分配庫存** - 按照 FIFO 原則重新分配庫存給銷售記錄
5. **提交更改** - 保存所有恢復的數據

### 庫存分配原則
- **FIFO (先進先出)**: 先買入的貨物優先賣出
- **按時間順序**: 根據買入日期排序
- **精確分配**: 確保每個銷售記錄都有對應的庫存分配

## 📁 備份文件要求

### 備份位置
- **目錄**: `recovery_backups/`
- **格式**: `.db` 文件
- **要求**: 包含刪除前的完整銷售記錄

### 備份檢查
工具會自動檢查：
- 備份目錄是否存在
- 備份文件數量
- 備份文件大小
- 備份中的銷售記錄數量

## ✅ 預期結果

### 恢復完成後
- **銷售記錄恢復**: 所有被刪除的售出訂單重新出現
- **庫存分配重建**: 每個銷售記錄都有對應的庫存分配
- **數據一致性**: 庫存分配 = 銷售分配 = 銷售記錄
- **庫存狀態正確**: 剩餘數量反映實際庫存狀況

### 驗證指標
- ✅ 庫存分配與銷售分配一致
- ✅ 銷售分配與銷售記錄一致
- ✅ 庫存剩餘數量準確
- ✅ 客戶應收帳款正確

## 🚨 注意事項

### 重要提醒
1. **備份數據**: 執行恢復前請確保有完整的數據庫備份
2. **停止操作**: 恢復過程中請勿進行其他數據操作
3. **驗證結果**: 恢復完成後請仔細驗證數據正確性
4. **測試功能**: 在生產環境使用前請先在測試環境驗證

### 風險控制
- 工具會自動創建事務，失敗時會回滾
- 會檢查現有記錄，避免重複恢復
- 提供詳細的執行日誌和錯誤信息

## 🔧 故障排除

### 常見問題

#### 1. 備份文件不存在
```
❌ 沒有找到 recovery_backups 目錄
```
**解決方案**: 確保備份目錄存在且包含 .db 文件

#### 2. 備份中沒有銷售記錄
```
⚠️ 備份中沒有銷售記錄，無法恢復
```
**解決方案**: 檢查備份文件是否包含完整的銷售數據

#### 3. 恢復過程中出錯
```
❌ 從備份恢復失敗: [錯誤信息]
```
**解決方案**: 檢查錯誤日誌，確保備份文件完整且可讀

### 錯誤處理
- 工具會自動回滾失敗的操作
- 提供詳細的錯誤信息和堆疊追蹤
- 支持重新運行恢復流程

## 📋 使用建議

### 最佳實踐
1. **選擇正確的備份**: 使用刪除售出訂單之前的備份文件
2. **備份當前狀態**: 恢復前先備份當前數據庫
3. **分步驗證**: 恢復完成後逐步驗證各個功能模塊
4. **監控日誌**: 關注恢復過程中的警告和錯誤信息

### 恢復時機
- **系統維護期間**: 避免影響正常業務
- **數據驗證後**: 確認備份數據的完整性
- **備份充足時**: 確保有足夠的備份文件

## 🎯 下一步行動

### 立即行動
1. **運行恢復工具**: `python restore_deleted_sales.py`
2. **檢查恢復結果**: 驗證數據一致性
3. **測試系統功能**: 檢查庫存管理、現金管理等頁面

### 恢復完成後
1. **驗證庫存數據**: 檢查 FIFO 庫存管理頁面
2. **檢查現金管理**: 驗證現金帳戶餘額
3. **測試銷售功能**: 確保新的銷售記錄能正常創建
4. **下載恢復報告**: 獲取詳細的恢復摘要

---

**🎯 目標**: 通過恢復被刪除的售出訂單數據，解決庫存不一致問題，回到刪除前的完整狀態

**📞 支持**: 如果遇到問題，請檢查錯誤日誌並確保備份文件完整
