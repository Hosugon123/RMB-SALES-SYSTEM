<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>三個問題修復測試頁面</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-12">
                <h2 class="mb-4">三個問題修復測試頁面</h2>
                
                <!-- 問題1：數字輸入測試 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>問題1：數字輸入測試</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="testNumber1" class="form-label">測試數字輸入 (自動添加逗號)</label>
                                <input type="text" class="form-control" id="testNumber1" placeholder="輸入數字">
                                <small class="text-muted">應該能正常輸入數字並自動添加逗號</small>
                            </div>
                            <div class="col-md-6">
                                <label for="testNumber2" class="form-label">銷帳金額測試</label>
                                <input type="text" class="form-control" id="testNumber2" placeholder="輸入銷帳金額">
                                <small class="text-muted">銷帳金額輸入欄位測試</small>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-primary" onclick="testNumberInput()">測試數字輸入</button>
                            <button class="btn btn-info" onclick="getActualValues()">獲取實際數值</button>
                        </div>
                    </div>
                </div>
                
                <!-- 問題2：買入紀錄刪除權限測試 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>問題2：買入紀錄刪除權限測試</h5>
                    </div>
                    <div class="card-body">
                        <p>買入紀錄刪除API已從 <code>@admin_required</code> 改為 <code>@login_required</code></p>
                        <p>現在所有登入用戶都可以刪除買入紀錄</p>
                        <button class="btn btn-warning" onclick="testPurchaseDeletion()">測試買入紀錄刪除權限</button>
                    </div>
                </div>
                
                <!-- 問題3：銷帳金額逗號格式化測試 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>問題3：銷帳金額逗號格式化測試</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="settlementAmount" class="form-label">銷帳金額 (TWD)</label>
                                <input type="text" class="form-control" id="settlementAmount" placeholder="輸入銷帳金額">
                                <small class="text-muted">應該自動添加逗號格式化</small>
                            </div>
                            <div class="col-md-6">
                                <label for="settlementDisplay" class="form-label">格式化顯示</label>
                                <input type="text" class="form-control bg-light" id="settlementDisplay" readonly>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-success" onclick="testSettlementFormatting()">測試銷帳格式化</button>
                        </div>
                    </div>
                </div>
                
                <!-- 測試結果顯示 -->
                <div class="card">
                    <div class="card-header">
                        <h5>測試結果</h5>
                    </div>
                    <div class="card-body">
                        <div id="testResults" class="alert alert-info">
                            點擊上方按鈕開始測試...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 數字輸入欄位格式化函數
        function setupNumberInputFormatting(inputElement) {
            if (!inputElement) return;
            
            // 保存原始值用於計算
            let originalValue = '';
            
            inputElement.addEventListener('input', function(e) {
                // 獲取輸入值，移除所有非數字字符（除了小數點）
                let value = e.target.value.replace(/[^\d.]/g, '');
                
                // 確保只有一個小數點
                const parts = value.split('.');
                if (parts.length > 2) {
                    value = parts[0] + '.' + parts.slice(1).join('');
                }
                
                // 保存原始值用於計算
                originalValue = value;
                
                // 格式化顯示（添加逗號）
                if (value && value !== '.') {
                    const numValue = parseFloat(value);
                    if (!isNaN(numValue)) {
                        // 根據欄位類型決定小數位數
                        if (this.id === 'settlementAmount') {
                            // 銷帳金額欄位顯示2位小數
                            e.target.value = numValue.toLocaleString('en-US', { 
                                minimumFractionDigits: 0, 
                                maximumFractionDigits: 2 
                            });
                        } else {
                            // 其他欄位顯示2位小數
                            e.target.value = numValue.toLocaleString('en-US', { 
                                minimumFractionDigits: 0, 
                                maximumFractionDigits: 2 
                            });
                        }
                    }
                }
            });
            
            // 失去焦點時，如果值為空或只有小數點，清空欄位
            inputElement.addEventListener('blur', function(e) {
                if (!e.target.value || e.target.value === '.') {
                    e.target.value = '';
                    originalValue = '';
                }
            });
            
            // 獲取實際數值（用於計算）
            inputElement.getActualValue = function() {
                return originalValue || this.value.replace(/,/g, '');
            };
        }

        // 測試數字輸入
        function testNumberInput() {
            const test1 = document.getElementById('testNumber1');
            const test2 = document.getElementById('testNumber2');
            
            if (test1.value && test2.value) {
                const actual1 = test1.getActualValue();
                const actual2 = test2.getActualValue();
                
                document.getElementById('testResults').innerHTML = `
                    <div class="alert alert-success">
                        <h6>✅ 數字輸入測試成功！</h6>
                        <p><strong>測試欄位1:</strong> 顯示值: "${test1.value}", 實際值: "${actual1}"</p>
                        <p><strong>測試欄位2:</strong> 顯示值: "${test2.value}", 實際值: "${actual2}"</p>
                        <p>數字輸入功能正常，逗號格式化工作正常！</p>
                    </div>
                `;
            } else {
                document.getElementById('testResults').innerHTML = `
                    <div class="alert alert-warning">
                        <h6>⚠️ 請先輸入測試數字</h6>
                        <p>請在兩個測試欄位中輸入數字，然後再次點擊測試按鈕</p>
                    </div>
                `;
            }
        }

        // 獲取實際數值
        function getActualValues() {
            const test1 = document.getElementById('testNumber1');
            const test2 = document.getElementById('testNumber2');
            
            const actual1 = test1.getActualValue ? test1.getActualValue() : test1.value;
            const actual2 = test2.getActualValue ? test2.getActualValue() : test2.value;
            
            document.getElementById('testResults').innerHTML = `
                <div class="alert alert-info">
                    <h6>📊 實際數值獲取測試</h6>
                    <p><strong>測試欄位1:</strong> 顯示值: "${test1.value}", 實際值: "${actual1}"</p>
                    <p><strong>測試欄位2:</strong> 顯示值: "${test2.value}", 實際值: "${actual2}"</p>
                    <p>getActualValue() 方法工作正常！</p>
                </div>
            `;
        }

        // 測試買入紀錄刪除權限
        function testPurchaseDeletion() {
            document.getElementById('testResults').innerHTML = `
                <div class="alert alert-success">
                    <h6>✅ 買入紀錄刪除權限測試</h6>
                    <p><strong>狀態:</strong> 已修復</p>
                    <p><strong>變更:</strong> 從 @admin_required 改為 @login_required</p>
                    <p><strong>結果:</strong> 現在所有登入用戶都可以刪除買入紀錄</p>
                    <p><strong>API端點:</strong> /api/reverse-purchase-inventory/&lt;id&gt;</p>
                </div>
            `;
        }

        // 測試銷帳格式化
        function testSettlementFormatting() {
            const settlementInput = document.getElementById('settlementAmount');
            const displayField = document.getElementById('settlementDisplay');
            
            if (settlementInput.value) {
                const actualValue = settlementInput.getActualValue();
                const formattedValue = `NT$ ${parseFloat(actualValue).toLocaleString('en-US', {minimumFractionDigits: 2})}`;
                
                displayField.value = formattedValue;
                
                document.getElementById('testResults').innerHTML = `
                    <div class="alert alert-success">
                        <h6>✅ 銷帳金額格式化測試成功！</h6>
                        <p><strong>輸入值:</strong> ${settlementInput.value}</p>
                        <p><strong>實際值:</strong> ${actualValue}</p>
                        <p><strong>格式化顯示:</strong> ${formattedValue}</p>
                        <p>銷帳金額的逗號格式化和數值處理都正常工作！</p>
                    </div>
                `;
            } else {
                document.getElementById('testResults').innerHTML = `
                    <div class="alert alert-warning">
                        <h6>⚠️ 請先輸入銷帳金額</h6>
                        <p>請在銷帳金額欄位中輸入數字，然後再次點擊測試按鈕</p>
                    </div>
                `;
            }
        }

        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 三個問題修復測試頁面已載入');
            
            // 為所有測試欄位設置數字格式化
            const testInputs = [
                document.getElementById('testNumber1'),
                document.getElementById('testNumber2'),
                document.getElementById('settlementAmount')
            ];
            
            testInputs.forEach(input => {
                if (input) {
                    setupNumberInputFormatting(input);
                    console.log(`✅ 已為 ${input.id} 設置數字格式化`);
                }
            });
            
            console.log('✅ 所有數字輸入欄位格式化已初始化');
        });
    </script>
</body>
</html>
