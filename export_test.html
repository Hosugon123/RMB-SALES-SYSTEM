<!DOCTYPE html>
<html>
<head>
    <title>數據庫導出測試</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .status { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>🔍 數據庫導出測試</h1>
    
    <p>點擊下面的按鈕來導出您的本地數據庫數據：</p>
    
    <button onclick="exportData()">📥 導出數據庫數據</button>
    <button onclick="downloadAsJson()">💾 下載為JSON文件</button>
    
    <div id="status"></div>
    <div id="result"></div>

    <script>
        let exportedData = null;
        
        async function exportData() {
            const statusDiv = document.getElementById('status');
            const resultDiv = document.getElementById('result');
            
            statusDiv.innerHTML = '<div class="status">正在導出數據...</div>';
            resultDiv.innerHTML = '';
            
            try {
                const response = await fetch('/api/export_database');
                
                if (response.ok) {
                    exportedData = await response.json();
                    
                    // 顯示統計信息
                    const stats = `
                        <div class="status success">
                            ✅ 導出成功！<br>
                            👥 用戶: ${exportedData.users.length} 個<br>
                            🏢 持有人: ${exportedData.holders.length} 個<br>
                            💰 現金帳戶: ${exportedData.cash_accounts.length} 個<br>
                            👤 客戶: ${exportedData.customers.length} 個<br>
                            📡 渠道: ${exportedData.channels.length} 個
                        </div>
                    `;
                    statusDiv.innerHTML = stats;
                    
                    // 顯示詳細數據
                    resultDiv.innerHTML = `
                        <h3>📋 導出的數據：</h3>
                        <pre>${JSON.stringify(exportedData, null, 2)}</pre>
                    `;
                    
                } else {
                    const error = await response.text();
                    statusDiv.innerHTML = `<div class="status error">❌ 導出失敗: ${error}</div>`;
                }
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">❌ 請求失敗: ${error.message}</div>`;
            }
        }
        
        function downloadAsJson() {
            if (!exportedData) {
                alert('請先導出數據！');
                return;
            }
            
            const dataStr = JSON.stringify(exportedData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `database_export_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
