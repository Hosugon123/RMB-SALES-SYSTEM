{% extends "base.html" %}

{% block title %}ç¾é‡‘ç®¡ç†å„€è¡¨æ¿{% endblock %}

{% block content %}
<div class="container-fluid pt-3">
    <!-- é é¢æ¨™é¡Œå’ŒåŠŸèƒ½æŒ‰éˆ• -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-4 border-bottom">
        <h1 class="h2"><i class="bi bi-wallet2 me-2"></i>ç¾é‡‘ç®¡ç†</h1>
        <div>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addHolderModal"><i class="bi bi-person-plus-fill me-1"></i> æ–°å¢æŒæœ‰äºº</button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAccountModal"><i class="bi bi-plus-circle-fill me-1"></i> æ–°å¢å¸³æˆ¶</button>
            <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#transferModal"><i class="bi bi-arrow-left-right me-1"></i> å…§éƒ¨è½‰å¸³</button>
        </div>
    </div>

    <!-- é ‚éƒ¨æ ¸å¿ƒæŒ‡æ¨™å¡ç‰‡ -->
    <div class="row">
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm text-center h-100">
                <div class="card-body">
                    <p class="text-muted mb-1">ç¸½å°å¹£è³‡ç”¢ (TWD)</p>
                    <h2 class="fw-bold text-primary" id="totalTwdDisplay">NT$ {{ "{:,.2f}".format(total_twd or 0) }}</h2>
                    <small class="text-muted">å³æ™‚æ›´æ–°</small>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm text-center h-100">
                <div class="card-body">
                    <p class="text-muted mb-1">ç¸½äººæ°‘å¹£è³‡ç”¢ (RMB)</p>
                    <h2 class="fw-bold text-success" id="totalRmbDisplay">Â¥ {{ "{:,.2f}".format(total_rmb or 0) }}</h2>
                    <small class="text-muted">å³æ™‚æ›´æ–°</small>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm text-center h-100">
                <div class="card-body">
                    <p class="text-muted mb-1">ç¸½æ‡‰æ”¶å¸³æ¬¾ (TWD)</p>
                    <h2 class="fw-bold text-danger">NT$ {{ "{:,.2f}".format(total_receivables or 0) }}</h2>
                    <small class="text-muted">å¾…æ”¶æ¬¾é …</small>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¨ç«‹çš„å¸³æˆ¶è³‡è¨Šå€å¡Š -->
    <div class="card shadow-sm mt-3">
        <div class="card-header"><h5 class="mb-0 fw-light"><i class="bi bi-people-fill me-2"></i>è³‡é‡‘æŒæœ‰äººèˆ‡å¸³æˆ¶</h5></div>
        <div class="card-body">
            <div id="accounts-container" class="row">
                <!-- JavaScript å°‡æœƒå‹•æ…‹å¡«å……é€™è£¡ -->
            </div>
        </div>
    </div>

    <!-- æ‡‰æ”¶å¸³æ¬¾ç®¡ç†å€å¡Š -->
    <div class="card shadow-sm mt-4">
        <div class="card-header">
            <h5 class="mb-0 fw-light"><i class="bi bi-receipt me-2"></i>æ‡‰æ”¶å¸³æ¬¾ç®¡ç†</h5>
        </div>
        <div class="card-body p-0">
            {% if customers_with_receivables %}
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-3">å®¢æˆ¶åç¨±</th>
                            <th class="text-end">æ‡‰æ”¶å¸³æ¬¾ (TWD)</th>
                            <th class="text-center">æ“ä½œ</th>
                            <th class="pe-3">å‚™è¨»</th>
                        </tr>
                    </thead>
                    <tbody>
                                                {% for customer in customers_with_receivables %}
                        <tr>
                            <td class="ps-3">
                                <a href="#" class="text-decoration-none fw-bold text-primary customer-transactions" 
                                   data-customer-id="{{ customer.id }}" 
                                   data-customer-name="{{ customer.name }}"
                                   title="é»æ“ŠæŸ¥çœ‹äº¤æ˜“ç´€éŒ„">
                                    {{ customer.name }}
                                    <i class="bi bi-arrow-right-circle ms-1 text-muted"></i>
                                </a>
                            </td>
                            <td class="text-end">
                                <span class="fw-bold text-danger">NT$ {{ "{:,.2f}".format(customer.total_receivables_twd) }}</span>
                            </td>
                            <td class="text-center">
                                <button class="btn btn-success btn-sm" 
                                        onclick="openSettlementModal('{{ customer.id }}', '{{ customer.name }}', {{ customer.total_receivables_twd }})">
                                    <i class="bi bi-cash-coin me-1"></i>éŠ·å¸³
                                </button>
                            </td>
                            <td class="pe-3">
                                <small class="text-muted">é»æ“Šå®¢æˆ¶åç¨±æŸ¥çœ‹äº¤æ˜“ç´€éŒ„</small>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center p-5 text-muted">
                <i class="bi bi-check-circle display-4 text-success"></i>
                <p class="mt-3">å¤ªæ£’äº†ï¼æ‰€æœ‰æ‡‰æ”¶å¸³æ¬¾éƒ½å·²çµæ¸…</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ç¨ç«‹çš„æµæ°´å¸³å€å¡Š -->
    <div class="card shadow-sm mt-4">
        <div class="card-header"><h5 class="mb-0 fw-light"><i class="bi bi-graph-up-arrow me-2"></i>è¿‘æœŸäº¤æ˜“è¨˜éŒ„</h5></div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead id="movements-thead">
                        <tr>
                            <th class="ps-3">æ™‚é–“</th>
                            <th>é¡å‹</th>
                            <th>æè¿°</th>
                            <th>æ“ä½œäººå“¡</th>
                            <th>å‡ºæ¬¾å¸³æˆ¶</th>
                            <th>å…¥æ¬¾å¸³æˆ¶</th>
                            <th>å‚™è¨»</th>
                            <th class="text-end" id="twd-header">TWD è®Šå‹•</th>
                            <th class="text-end" id="rmb-header">RMB è®Šå‹•</th>
                            <th class="text-end">ç´¯ç©é¤˜é¡</th>
                            <th class="text-end pe-3">åˆ©æ½¤</th>
                        </tr>
                    </thead>
                    <tbody id="movements-tbody">
                        <!-- JavaScript å°‡æœƒå‹•æ…‹å¡«å……é€™è£¡ -->
                    </tbody>
                </table>
            </div>
        </div>
        <!-- ****** é—œéµæ–°å¢ï¼šåˆ†é æ§åˆ¶é … ****** -->
        {% if pagination and pagination.pages > 1 %}
        <div class="card-footer d-flex justify-content-center">
            <nav aria-label="Page navigation">
                <ul class="pagination mb-0">
                    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('cash_management', page=pagination.prev_num) }}">&laquo;</a>
                    </li>
                    
                    {% for p in range(1, pagination.pages + 1) %}
                        <li class="page-item {% if p == pagination.page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('cash_management', page=p) }}">{{ p }}</a>
                        </li>
                    {% endfor %}

                    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('cash_management', page=pagination.next_num) }}">&raquo;</a>
                    </li>
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<!-- å¼•ç”¨æ‰€æœ‰çš„æ“ä½œæ¨¡æ…‹æ¡† -->
{% include '_cash_management_modals.html' %}
{% endblock %}


{% block scripts %}
<style>
/* ç¾é‡‘ç®¡ç†é é¢çš„è¦–è¦ºå„ªåŒ– */
.transaction-row {
    transition: all 0.2s ease;
}

.transaction-row:hover {
    background-color: #f8f9fa !important;
    transform: translateX(2px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.transaction-row[data-type="è²·å…¥"] {
    border-left: 3px solid #ffc107;
}

.transaction-row[data-type="å”®å‡º"] {
    border-left: 3px solid #198754;
}

.transaction-row[data-type="éŠ·å¸³"] {
    border-left: 3px solid #0d6efd;
}

.transaction-row[data-type="DEPOSIT"] {
    border-left: 3px solid #6f42c1;
}

.transaction-row[data-type="CARD_PURCHASE"] {
    border-left: 3px solid #6c757d;
}

/* ç´¯ç©é¤˜é¡åˆ—çš„æ¨£å¼ */
.running-balance {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 6px;
    padding: 8px;
}

/* é ‚éƒ¨å¡ç‰‡çš„å‹•ç•«æ•ˆæœ */
.card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // å¾å¾Œç«¯ Jinja2 ç²å–å·²ç¶“æº–å‚™å¥½çš„æ•¸æ“šï¼Œä¸¦æä¾›å®‰å…¨çš„é è¨­å€¼
    const accountsByHolder = {{ accounts_by_holder|tojson if accounts_by_holder is defined else '{}' }};
    const movements = {{ movements|tojson if movements is defined else '[]' }};
    const holders = {{ holders|tojson if holders is defined else '[]' }};
    console.log('holders:', holders);
    const allAccounts = {{ owner_accounts|tojson if owner_accounts is defined else '[]' }}; // Renamed for clarity
    
    // ç²å–æ‰€æœ‰éœ€è¦æ“ä½œçš„ DOM å…ƒç´ 
    const accountsContainer = document.getElementById('accounts-container');
    const movementsTbody = document.getElementById('movements-tbody');
    const movementModalEl = document.getElementById('addMovementModal');
    const movementModal = movementModalEl ? new bootstrap.Modal(movementModalEl) : null;
    const movementModalTitle = document.getElementById('movementModalTitle');
    const movementAccountIdInput = document.getElementById('movementAccountId');

    // --- å¡«å……ä¸‹æ‹‰é¸å–®çš„é€šç”¨å‡½å¼ ---
    function populateSelect(selectId, options) {
        const select = document.getElementById(selectId);
        if (!select) return;
        if (!Array.isArray(options)) {
            select.innerHTML = '<option value="" disabled selected>--- æ•¸æ“šè¼‰å…¥éŒ¯èª¤ ---</option>';
            return;
        }
        select.innerHTML = '<option value="" disabled selected>--- è«‹é¸æ“‡ ---</option>';
        options.forEach(opt => select.add(new Option(opt.text, opt.value)));
    }

    // --- å¡«å……å¸¶æœ‰åˆ†çµ„çš„ä¸‹æ‹‰é¸å–® ---
    function populateGroupedSelect(selectId, groupedOptions) {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = '<option value="" disabled selected>--- è«‹é¸æ“‡å¸³æˆ¶ ---</option>';
        
        groupedOptions.forEach(group => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = group.holder_name; // è¨­å®šåˆ†çµ„æ¨™é¡Œ
            group.accounts.forEach(acc => {
                const optionText = `${acc.name} (${acc.currency})`;
                optgroup.appendChild(new Option(optionText, acc.id));
            });
            select.appendChild(optgroup);
        });
    }

    // --- æ¸²æŸ“å¸³æˆ¶åˆ—è¡¨çš„å‡½å¼ ---
    function renderAccounts() {
        if (!accountsContainer) return;
        accountsContainer.innerHTML = '';
        if (!holders || holders.length === 0) {
            accountsContainer.innerHTML = '<div class="col-12 text-center text-muted p-4">å°šç„¡è³‡é‡‘æŒæœ‰äººã€‚</div>';
            return;
        }
        holders.forEach(holder => {
            const holderId = holder.id;
            const holderName = holder.name;
            const holderData = accountsByHolder[holderId];
            let accountsHtml = '';
            let totalTwd = 0;
            let totalRmb = 0;
            if (holderData && holderData.accounts && holderData.accounts.length > 0) {
                holderData.accounts.forEach(acc => {
                    // æ ¹æ“šè²¨å¹£é¡å‹è¨­ç½®ä¸åŒçš„é¡è‰²
                    const currencyBadgeClass = acc.currency === 'TWD' ? 'bg-primary' : 'bg-success';
                    const currencyTextClass = acc.currency === 'TWD' ? 'text-primary' : 'text-success';
                    
                    accountsHtml += `<li class="list-group-item py-2 d-flex justify-content-between align-items-center ps-3"><div><i class="bi bi-caret-right-fill text-muted me-1"></i><span>${acc.name} <span class="badge ${currencyBadgeClass} rounded-pill">${acc.currency}</span></span></div><div class="d-flex align-items-center"><strong class="me-2 ${currencyTextClass}">${acc.balance.toLocaleString('en-US', {minimumFractionDigits: 2})}</strong><div class="btn-group btn-group-sm"><button class="btn btn-outline-primary btn-movement btn-sm" data-account-id="${acc.id}" data-account-name="${acc.name}" title="å­˜å…¥/æå‡º"><i class="bi bi-arrow-down-up"></i></button><form action="{{ url_for('admin_update_cash_account') }}" method="POST" class="d-inline" onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å¸³æˆ¶å—ï¼Ÿ');"><input type="hidden" name="action" value="delete_account"><input type="hidden" name="account_id" value="${acc.id}"><button type="submit" class="btn btn-outline-danger btn-sm" title="åˆªé™¤å¸³æˆ¶">&times;</button></form></div></div></li>`;
                });
                totalTwd = holderData.total_twd || 0;
                totalRmb = holderData.total_rmb || 0;
            } else {
                // å¼·åˆ¶é¡¯ç¤ºæŒæœ‰äººï¼Œå³ä½¿æ²’æœ‰å¸³æˆ¶
                accountsHtml = '<li class="list-group-item py-1 text-muted text-center small">-- å°šç„¡å¸³æˆ¶ --</li>';
                totalTwd = 0;
                totalRmb = 0;
            }
            const subtotalFooter = `<div class="card-footer bg-light d-flex justify-content-around py-1"><div><small class="text-muted">TWD:</small> <strong class="text-primary">${totalTwd.toLocaleString('en-US', {minimumFractionDigits: 2})}</strong></div><div><small class="text-muted">RMB:</small> <strong class="text-success">${totalRmb.toLocaleString('en-US', {minimumFractionDigits: 2})}</strong></div></div>`;
            accountsContainer.innerHTML += `<div class="col-lg-4 col-md-6 mb-2"><div class="card shadow-sm h-100"><div class="card-header py-2 d-flex justify-content-between align-items-center"><strong class="h6 mb-0">${holderName}</strong><form action="{{ url_for('admin_update_cash_account') }}" method="POST" class="d-inline" onsubmit="return confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æŒæœ‰äººåŠå…¶æ‰€æœ‰å¸³æˆ¶å—ï¼Ÿ');"><input type="hidden" name="action" value="delete_holder"><input type="hidden" name="holder_id" value="${holderId}"><button type="submit" class="btn btn-danger btn-sm py-0 px-2">åˆªé™¤</button></form></div><ul class="list-group list-group-flush">${accountsHtml}</ul>${subtotalFooter}</div></div>`;
        });
        document.querySelectorAll('.btn-movement').forEach(btn => {
            btn.addEventListener('click', function() {
                const accountId = this.dataset.accountId;
                const accountName = this.dataset.accountName;
                if(movementModalTitle) movementModalTitle.textContent = `ç‚ºã€Œ${accountName}ã€é€²è¡Œè³‡é‡‘æ“ä½œ`;
                if(movementAccountIdInput) movementAccountIdInput.value = accountId;
                if(movementModal) movementModal.show();
            });
        });
    }

    // --- æ¸²æŸ“è³‡é‡‘æµæ°´çš„å‡½å¼ ---
    function renderMovements() {
        if (!movementsTbody) return;
        movementsTbody.innerHTML = '';
        if (movements.length === 0) {
            movementsTbody.innerHTML = '<tr><td colspan="11" class="text-center p-5 text-muted">å°šç„¡è³‡é‡‘æµæ°´ç´€éŒ„ã€‚</td></tr>';
            return;
        }
        
        // æª¢æŸ¥æ˜¯å¦æœ‰TWDæˆ–RMBè®Šå‹•ï¼Œå‹•æ…‹éš±è—/é¡¯ç¤ºæ¨™é¡Œ
        let hasTwdChange = false;
        let hasRmbChange = false;
        
        movements.forEach(m => {
            // å”®å‡ºæ“ä½œä¸é¡¯ç¤ºTWDè®Šå‹•ï¼Œå› ç‚ºéŠ·å¸³æ™‚æ‰æœƒæœ‰è®Šå‹•
            if (m.type === 'å”®å‡º') {
                // å”®å‡ºæ™‚TWDè®Šå‹•è¨­ç‚º0ï¼Œä¸é¡¯ç¤º
                m.twd_change = 0;
            } else if (parseFloat(m.twd_change) !== 0) {
                hasTwdChange = true;
            }
            
            if (parseFloat(m.rmb_change) !== 0) hasRmbChange = true;
        });
        
        // å‹•æ…‹éš±è—/é¡¯ç¤ºæ¨™é¡Œ
        const twdHeader = document.getElementById('twd-header');
        const rmbHeader = document.getElementById('rmb-header');
        if (twdHeader) twdHeader.style.display = hasTwdChange ? 'table-cell' : 'none';
        if (rmbHeader) rmbHeader.style.display = hasRmbChange ? 'table-cell' : 'none';
        movements.forEach(m => {
            const twdChange = parseFloat(m.twd_change) || 0;
            const rmbChange = parseFloat(m.rmb_change) || 0;
            const profit = m.profit || 0;
            
            // å°‡é¡å‹è½‰æ›ç‚ºä¸­æ–‡é¡¯ç¤º
            let typeDisplay = m.type;
            let typeClass = 'bg-info-subtle text-info-emphasis';
            
            switch(m.type) {
                case 'å”®å‡º':
                    typeDisplay = 'å”®å‡º';
                    typeClass = 'bg-success-subtle text-success-emphasis';
                    break;
                case 'SETTLEMENT':
                    typeDisplay = 'éŠ·å¸³';
                    typeClass = 'bg-primary-subtle text-primary-emphasis';
                    break;
                case 'è²·å…¥':
                    typeDisplay = 'è²·å…¥';
                    typeClass = 'bg-warning-subtle text-warning-emphasis';
                    break;
                case 'CARD_PURCHASE':
                    typeDisplay = 'åˆ·å¡';
                    typeClass = 'bg-secondary-subtle text-secondary-emphasis';
                    break;
                default:
                    typeDisplay = m.type;
                    typeClass = 'bg-info-subtle text-info-emphasis';
            }
            
            let profitHtml = '';
            if (m.type === 'å”®å‡º' && profit !== undefined) {
                const profitClass = profit >= 0 ? 'text-success' : 'text-danger';
                profitHtml = `<td class="text-end pe-3 fw-bold ${profitClass}">NT$ ${profit.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>`;
            } else {
                profitHtml = `<td class="text-end pe-3 text-muted">-</td>`;
            }
            
            // åˆ†é›¢æè¿°å’Œå‚™è¨»
            let description = m.description || '';
            let note = m.note || '';
            
            // å¦‚æœdescriptionåŒ…å«åˆ†éš”ç¬¦ï¼Œå‰‡åˆ†é›¢å‚™è¨»
            if (description.includes(' | ')) {
                const parts = description.split(' | ');
                description = parts[0];
                note = parts[1] || note;
            }
            
            // å‹•æ…‹ç”Ÿæˆè¡¨æ ¼è¡Œï¼ŒåŒ…å«ç´¯ç©é¤˜é¡
            let rowHtml = `<tr class="transaction-row" data-type="${m.type}">
                <td class="ps-3"><strong>${new Date(m.date).toLocaleDateString()}</strong></td>
                <td><span class="badge ${typeClass}">${typeDisplay}</span></td>
                <td><strong>${description}</strong></td>
                <td><small class="text-muted">${m.operator || 'æœªçŸ¥'}</small></td>
                <td><small class="text-muted">${m.payment_account || 'N/A'}</small></td>
                <td><small class="text-muted">${m.deposit_account || 'N/A'}</small></td>
                <td><small class="text-muted">${note || '-'}</small></td>`;
            
            // åªæœ‰TWDæœ‰è®Šå‹•æ™‚æ‰æ·»åŠ TWDæ¬„ä½
            if (twdChange !== 0) {
                rowHtml += `<td class="text-end fw-bold ${twdChange > 0 ? 'text-success' : 'text-danger'}">${twdChange.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>`;
            } else {
                rowHtml += `<td class="text-end text-muted">-</td>`;
            }
            
            // åªæœ‰RMBæœ‰è®Šå‹•æ™‚æ‰æ·»åŠ RMBæ¬„ä½
            if (rmbChange !== 0) {
                rowHtml += `<td class="text-end fw-bold ${rmbChange > 0 ? 'text-success' : 'text-danger'}">${rmbChange.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>`;
            } else {
                rowHtml += `<td class="text-end text-muted">-</td>`;
            }
            
            // æ·»åŠ ç´¯ç©é¤˜é¡åˆ—
            const runningTwd = m.running_twd_balance || 0;
            const runningRmb = m.running_rmb_balance || 0;
            rowHtml += `<td class="text-end">
                <div class="small running-balance">
                    <div class="text-primary fw-bold border-bottom border-primary pb-1 mb-1">NT$ ${runningTwd.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                    <div class="text-success">Â¥ ${runningRmb.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                </div>
            </td>`;
            
            rowHtml += profitHtml + '</tr>';
            movementsTbody.innerHTML += rowHtml;
        });
    }
    
    const groupedAccounts = [];
    if (Array.isArray(holders) && Array.isArray(allAccounts)) {
        holders.forEach(holder => {
            const accountsInGroup = allAccounts.filter(acc => acc.holder_id === holder.id);
            if (accountsInGroup.length > 0) {
                groupedAccounts.push({
                    holder_name: holder.name,
                    accounts: accountsInGroup
                });
            }
        });
    }

    populateGroupedSelect('fromAccount', groupedAccounts);
    populateGroupedSelect('toAccount', groupedAccounts);
    
    // å¡«å……æ–°å¢å¸³æˆ¶æ¨¡æ…‹æ¡†ä¸­çš„æŒæœ‰äººä¸‹æ‹‰é¸å–®
    populateSelect('accountHolder', holders.map(h => ({ value: h.id, text: h.name })));
    
    // å¡«å……éŠ·å¸³æ¨¡æ…‹æ¡†ä¸­çš„æ”¶æ¬¾å¸³æˆ¶ä¸‹æ‹‰é¸å–® - åªé¡¯ç¤ºTWDå¸³æˆ¶
    const twdAccounts = [];
    if (Array.isArray(holders) && Array.isArray(allAccounts)) {
        holders.forEach(holder => {
            const twdAccountsInGroup = allAccounts.filter(acc => acc.holder_id === holder.id && acc.currency === 'TWD');
            if (twdAccountsInGroup.length > 0) {
                twdAccounts.push({
                    holder_name: holder.name,
                    accounts: twdAccountsInGroup
                });
            }
        });
    }
    populateGroupedSelect('settlementAccount', twdAccounts);
    
    // èª¿ç”¨æ¸²æŸ“å‡½æ•¸ä¾†é¡¯ç¤ºæŒæœ‰äººå’Œå¸³æˆ¶
    renderAccounts();
    renderMovements();
    
    // æ›´æ–°é ‚éƒ¨å¡ç‰‡çš„é¤˜é¡é¡¯ç¤º
    updateTopCardBalances();
    
    // è¨­ç½®å®¢æˆ¶äº¤æ˜“ç´€éŒ„é»æ“Šäº‹ä»¶ç›£è½å™¨
    setupCustomerTransactionsListeners();
    
    // å‡½æ•¸ï¼šæ›´æ–°é ‚éƒ¨å¡ç‰‡çš„é¤˜é¡é¡¯ç¤º
    function updateTopCardBalances() {
        if (movements && movements.length > 0) {
            // æ‰¾åˆ°æœ€æ–°çš„äº¤æ˜“è¨˜éŒ„ï¼ˆç¬¬ä¸€ç­†ï¼‰
            const latestTransaction = movements[0];
            if (latestTransaction) {
                const twdDisplay = document.getElementById('totalTwdDisplay');
                const rmbDisplay = document.getElementById('totalRmbDisplay');
                
                if (twdDisplay && latestTransaction.running_twd_balance !== undefined) {
                    twdDisplay.textContent = `NT$ ${latestTransaction.running_twd_balance.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
                }
                
                if (rmbDisplay && latestTransaction.running_rmb_balance !== undefined) {
                    rmbDisplay.textContent = `Â¥ ${latestTransaction.running_rmb_balance.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
                }
            }
        }
    }
    
    // éŠ·å¸³æ¨¡æ…‹æ¡†ç›¸é—œåŠŸèƒ½
    const settlementModal = new bootstrap.Modal(document.getElementById('settlementModal'));
    const settlementForm = document.getElementById('settlementForm');
    
    // éŠ·å¸³è¡¨å–®æäº¤è™•ç†
    if (settlementForm) {
        settlementForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const customerId = document.querySelector('input[name="customer_id"]').value;
            const amount = parseFloat(document.getElementById('settlementAmount').value);
            const accountId = document.querySelector('input[name="account_id"]').value;
            const note = document.getElementById('settlementNote').value;
            
            // é©—è­‰å¿…å¡«æ¬„ä½
            if (!customerId || !amount || !accountId) {
                Swal.fire('éŒ¯èª¤', 'è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'error');
                return;
            }
            
            console.log('éŠ·å¸³è¡¨å–®æäº¤:', { customerId, amount, accountId, note });
            
            try {
                const response = await fetch('/api/settlement', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customer_id: customerId,
                        amount: amount,
                        account_id: accountId,
                        note: note
                    })
                });
                
                const result = await response.json();
                console.log('éŠ·å¸³å›æ‡‰:', result);
                
                if (result.status === 'success') {
                    Swal.fire({
                        icon: 'success',
                        title: 'éŠ·å¸³æˆåŠŸï¼',
                        text: result.message,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // é—œé–‰æ¨¡æ…‹æ¡†ä¸¦é‡æ–°è¼‰å…¥é é¢
                    console.log('æº–å‚™é—œé–‰æ¨¡æ…‹æ¡†...');
                    const modalElement = document.getElementById('settlementModal');
                    const modalInstance = bootstrap.Modal.getInstance(modalElement);
                    console.log('æ¨¡æ…‹æ¡†å…ƒç´ :', modalElement);
                    console.log('æ¨¡æ…‹æ¡†å¯¦ä¾‹:', modalInstance);
                    
                    if (modalInstance) {
                        console.log('é—œé–‰æ¨¡æ…‹æ¡†...');
                        modalInstance.hide();
                    } else {
                        console.log('ç„¡æ³•ç²å–æ¨¡æ…‹æ¡†å¯¦ä¾‹ï¼Œå˜—è©¦ç›´æ¥éš±è—...');
                        // å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥éš±è—æ¨¡æ…‹æ¡†
                        modalElement.style.display = 'none';
                        modalElement.classList.remove('show');
                        document.body.classList.remove('modal-open');
                        const backdrop = document.querySelector('.modal-backdrop');
                        if (backdrop) {
                            backdrop.remove();
                        }
                    }
                    
                    // å»¶é²é‡æ–°è¼‰å…¥é é¢ï¼Œç¢ºä¿æ¨¡æ…‹æ¡†æœ‰æ™‚é–“é—œé–‰
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else {
                    Swal.fire('éŒ¯èª¤', result.message, 'error');
                }
            } catch (error) {
                console.error('éŠ·å¸³éŒ¯èª¤:', error);
                Swal.fire('éŒ¯èª¤', 'éŠ·å¸³æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            }
        });
    }
});

// å…¨å±€å‡½æ•¸ï¼šæ‰“é–‹éŠ·å¸³æ¨¡æ…‹æ¡†
function openSettlementModal(customerId, customerName, totalReceivable) {
    console.log('æ‰“é–‹éŠ·å¸³æ¨¡æ…‹æ¡†:', { customerId, customerName, totalReceivable });
    
    // è¨­ç½®æ¨¡æ…‹æ¡†æ•¸æ“š
    document.getElementById('settlementCustomerName').value = customerName;
    document.getElementById('settlementTotalReceivable').value = `NT$ ${totalReceivable.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
    document.getElementById('settlementAmount').value = totalReceivable;
    document.getElementById('settlementNote').value = '';
    
    // æ·»åŠ éš±è—çš„å®¢æˆ¶IDå’Œå¸³æˆ¶IDæ¬„ä½
    let customerIdInput = document.getElementById('settlementForm').querySelector('input[name="customer_id"]');
    if (!customerIdInput) {
        customerIdInput = document.createElement('input');
        customerIdInput.type = 'hidden';
        customerIdInput.name = 'customer_id';
        document.getElementById('settlementForm').appendChild(customerIdInput);
    }
    customerIdInput.value = customerId;
    
    // ç§»é™¤èˆŠçš„éš±è—å¸³æˆ¶IDæ¬„ä½ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    let oldAccountIdInput = document.getElementById('settlementForm').querySelector('input[name="account_id"]');
    if (oldAccountIdInput) {
        oldAccountIdInput.remove();
    }
    
    // æ·»åŠ æ–°çš„éš±è—å¸³æˆ¶IDæ¬„ä½
    let accountIdInput = document.createElement('input');
    accountIdInput.type = 'hidden';
    accountIdInput.name = 'account_id';
    accountIdInput.id = 'hiddenAccountId';
    document.getElementById('settlementForm').appendChild(accountIdInput);
    
    // ç›£è½æ”¶æ¬¾å¸³æˆ¶ä¸‹æ‹‰é¸å–®çš„è®ŠåŒ–ï¼Œè‡ªå‹•æ›´æ–°éš±è—çš„å¸³æˆ¶ID
    const settlementAccountSelect = document.getElementById('settlementAccount');
    if (settlementAccountSelect) {
        settlementAccountSelect.addEventListener('change', function() {
            document.getElementById('hiddenAccountId').value = this.value;
        });
    }
    
    // é¡¯ç¤ºæ¨¡æ…‹æ¡†
    const modalElement = document.getElementById('settlementModal');
    let modalInstance = bootstrap.Modal.getInstance(modalElement);
    if (!modalInstance) {
        modalInstance = new bootstrap.Modal(modalElement);
    }
    modalInstance.show();
}

// --- å®¢æˆ¶äº¤æ˜“ç´€éŒ„ç›¸é—œåŠŸèƒ½ ---
function setupCustomerTransactionsListeners() {
    console.log('ğŸ”§ è¨­ç½®å®¢æˆ¶äº¤æ˜“ç´€éŒ„é»æ“Šäº‹ä»¶ç›£è½å™¨...');
    
    // ä½¿ç”¨äº‹ä»¶å§”è¨—ï¼Œç›£è½æ•´å€‹æ‡‰æ”¶å¸³æ¬¾è¡¨æ ¼çš„é»æ“Šäº‹ä»¶
    document.addEventListener('click', function(event) {
        console.log('ğŸ–±ï¸ é»æ“Šäº‹ä»¶:', event.target);
        
        if (event.target.closest('.customer-transactions')) {
            const customerLink = event.target.closest('.customer-transactions');
            const customerId = customerLink.dataset.customerId;
            const customerName = customerLink.dataset.customerName;
            
            console.log('ğŸ‘¤ é»æ“Šå®¢æˆ¶:', { customerId, customerName });
            
            if (customerId && customerName) {
                openCustomerTransactionsModal(customerId, customerName);
            } else {
                console.error('âŒ å®¢æˆ¶IDæˆ–åç¨±ç¼ºå¤±:', { customerId, customerName });
            }
        }
    });
    
    console.log('âœ… å®¢æˆ¶äº¤æ˜“ç´€éŒ„é»æ“Šäº‹ä»¶ç›£è½å™¨è¨­ç½®å®Œæˆ');
}

function openCustomerTransactionsModal(customerId, customerName) {
    // æ›´æ–°æ¨¡æ…‹æ¡†æ¨™é¡Œ
    document.getElementById('customerTransactionsTitle').textContent = `${customerName} çš„äº¤æ˜“ç´€éŒ„`;
    document.getElementById('customerTransactionsName').textContent = customerName;
    
    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    document.getElementById('customerTransactionsTable').innerHTML = '<tr><td colspan="7" class="text-center p-3"><div class="spinner-border spinner-border-sm me-2"></div>è¼‰å…¥ä¸­...</td></tr>';
    document.getElementById('customerTransactionsEmpty').style.display = 'none';
    
    // é¡¯ç¤ºæ¨¡æ…‹æ¡†
    const modal = new bootstrap.Modal(document.getElementById('customerTransactionsModal'));
    modal.show();
    
    // ç²å–å®¢æˆ¶äº¤æ˜“ç´€éŒ„
    fetchCustomerTransactions(customerId);
}

function fetchCustomerTransactions(customerId) {
    fetch(`/api/customer/transactions/${customerId}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                displayCustomerTransactions(data);
            } else {
                console.error('ç²å–å®¢æˆ¶äº¤æ˜“ç´€éŒ„å¤±æ•—:', data.message);
                document.getElementById('customerTransactionsTable').innerHTML = 
                    '<tr><td colspan="7" class="text-center text-danger">è¼‰å…¥å¤±æ•—</td></tr>';
            }
        })
        .catch(error => {
            console.error('ç²å–å®¢æˆ¶äº¤æ˜“ç´€éŒ„å¤±æ•—:', error);
            document.getElementById('customerTransactionsTable').innerHTML = 
                '<tr><td colspan="7" class="text-center text-danger">è¼‰å…¥å¤±æ•—</td></tr>';
        });
}

function displayCustomerTransactions(data) {
    const tableBody = document.getElementById('customerTransactionsTable');
    const emptyDiv = document.getElementById('customerTransactionsEmpty');
    
    // æ›´æ–°æ‡‰æ”¶å¸³æ¬¾ä¿¡æ¯
    document.getElementById('customerTransactionsReceivable').textContent = 
        `NT$ ${parseFloat(data.total_receivables).toLocaleString('en-US', {minimumFractionDigits: 2})}`;
    
    if (!data.transactions || data.transactions.length === 0) {
        tableBody.style.display = 'none';
        emptyDiv.style.display = 'block';
        return;
    }
    
    tableBody.style.display = 'table-row-group';
    emptyDiv.style.display = 'none';
    
    let html = '';
    data.transactions.forEach(transaction => {
        // æ ¹æ“šé¡å‹è¨­ç½®ä¸åŒçš„æ¨£å¼
        let typeClass = 'badge bg-secondary';
        let typeText = transaction.type;
        
        switch(transaction.type) {
            case 'å”®å‡º':
                typeClass = 'badge bg-success';
                break;
            case 'éŠ·å¸³':
                typeClass = 'badge bg-primary';
                break;
            default:
                typeClass = 'badge bg-info';
        }
        
        // æ ¼å¼åŒ–é‡‘é¡é¡¯ç¤º
        const rmbAmount = transaction.rmb_amount > 0 ? `Â¥ ${transaction.rmb_amount.toLocaleString('en-US', {minimumFractionDigits: 2})}` : '-';
        const twdAmount = transaction.twd_amount > 0 ? `NT$ ${transaction.twd_amount.toLocaleString('en-US', {minimumFractionDigits: 2})}` : '-';
        const profitAmount = transaction.profit_twd !== 0 ? `NT$ ${transaction.profit_twd.toLocaleString('en-US', {minimumFractionDigits: 2})}` : '-';
        
        // è¨­ç½®åˆ©æ½¤é¡è‰²
        const profitClass = transaction.profit_twd > 0 ? 'text-success' : 
                           transaction.profit_twd < 0 ? 'text-danger' : 'text-muted';
        
        html += `
            <tr>
                <td><small>${transaction.date}</small></td>
                <td><span class="${typeClass}">${typeText}</span></td>
                <td>${transaction.description}</td>
                <td class="text-end text-success">${rmbAmount}</td>
                <td class="text-end text-primary">${twdAmount}</td>
                <td class="text-end fw-bold ${profitClass}">${profitAmount}</td>
                <td><span class="badge bg-light text-dark">${transaction.status}</span></td>
            </tr>
        `;
    });
    
    tableBody.innerHTML = html;
}
</script>
{% endblock %}