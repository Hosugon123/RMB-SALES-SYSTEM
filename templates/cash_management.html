{% extends "base.html" %}

{% block title %}現金管理儀表板{% endblock %}

{% block content %}
<div class="container-fluid pt-3">
    <!-- 頁面標題和功能按鈕 -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-4 border-bottom">
        <h1 class="h2"><i class="bi bi-wallet2 me-2"></i>現金管理</h1>
        <div>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addHolderModal"><i class="bi bi-person-plus-fill me-1"></i> 新增持有人</button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAccountModal"><i class="bi bi-plus-circle-fill me-1"></i> 新增帳戶</button>
            <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#transferModal"><i class="bi bi-arrow-left-right me-1"></i> 內部轉帳</button>
        </div>
    </div>

    <!-- 頂部核心指標卡片 -->
    <div class="row">
        <div class="col-md-6 mb-3">
            <div class="card shadow-sm text-center h-100">
                <div class="card-body">
                    <p class="text-muted mb-1">總台幣資產 (TWD)</p>
                    <h2 class="fw-bold text-primary">NT$ {{ "{:,.2f}".format(total_twd or 0) }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card shadow-sm text-center h-100">
                <div class="card-body">
                    <p class="text-muted mb-1">總人民幣資產 (RMB)</p>
                    <h2 class="fw-bold text-success">¥ {{ "{:,.2f}".format(total_rmb or 0) }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- 獨立的帳戶資訊區塊 -->
    <div class="card shadow-sm mt-3">
        <div class="card-header"><h5 class="mb-0 fw-light"><i class="bi bi-people-fill me-2"></i>資金持有人與帳戶</h5></div>
        <div class="card-body">
            <div id="accounts-container" class="row">
                <!-- JavaScript 將會動態填充這裡 -->
            </div>
        </div>
    </div>

    <!-- 獨立的流水帳區塊 -->
    <div class="card shadow-sm mt-4">
        <div class="card-header"><h5 class="mb-0 fw-light"><i class="bi bi-graph-up-arrow me-2"></i>近期資金流水</h5></div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th class="ps-3">時間</th>
                            <th>操作人員</th>
                            <th>類型</th>
                            <th>描述</th>
                            <th class="text-end">TWD 變動</th>
                            <th class="text-end pe-3">RMB 變動</th>
                        </tr>
                    </thead>
                    <tbody id="movements-tbody">
                        <!-- JavaScript 將會動態填充這裡 -->
                    </tbody>
                </table>
            </div>
        </div>
        <!-- ****** 關鍵新增：分頁控制項 ****** -->
        {% if pagination and pagination.pages > 1 %}
        <div class="card-footer d-flex justify-content-center">
            <nav aria-label="Page navigation">
                <ul class="pagination mb-0">
                    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('cash_management', page=pagination.prev_num) }}">&laquo;</a>
                    </li>
                    
                    {% for p in range(1, pagination.pages + 1) %}
                        <li class="page-item {% if p == pagination.page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('cash_management', page=p) }}">{{ p }}</a>
                        </li>
                    {% endfor %}

                    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('cash_management', page=pagination.next_num) }}">&raquo;</a>
                    </li>
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<!-- 引用所有的操作模態框 -->
{% include '_cash_management_modals.html' %}
{% endblock %}


{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // 從後端 Jinja2 獲取已經準備好的數據，並提供安全的預設值
    const accountsByHolder = {{ accounts_by_holder|tojson if accounts_by_holder is defined else '{}' }};
    const movements = {{ movements|tojson if movements is defined else '[]' }};
    const holders = {{ holders|tojson if holders is defined else '[]' }};
    console.log('holders:', holders);
    const allAccounts = {{ owner_accounts|tojson if owner_accounts is defined else '[]' }}; // Renamed for clarity
    
    // 獲取所有需要操作的 DOM 元素
    const accountsContainer = document.getElementById('accounts-container');
    const movementsTbody = document.getElementById('movements-tbody');
    const movementModalEl = document.getElementById('addMovementModal');
    const movementModal = movementModalEl ? new bootstrap.Modal(movementModalEl) : null;
    const movementModalTitle = document.getElementById('movementModalTitle');
    const movementAccountIdInput = document.getElementById('movementAccountId');

    // --- 填充下拉選單的通用函式 ---
    function populateSelect(selectId, options) {
        const select = document.getElementById(selectId);
        if (!select) return;
        if (!Array.isArray(options)) {
            select.innerHTML = '<option value="" disabled selected>--- 數據載入錯誤 ---</option>';
            return;
        }
        select.innerHTML = '<option value="" disabled selected>--- 請選擇 ---</option>';
        options.forEach(opt => select.add(new Option(opt.text, opt.value)));
    }

    // --- 填充帶有分組的下拉選單 ---
    function populateGroupedSelect(selectId, groupedOptions) {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = '<option value="" disabled selected>--- 請選擇帳戶 ---</option>';
        
        groupedOptions.forEach(group => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = group.holder_name; // 設定分組標題
            group.accounts.forEach(acc => {
                const optionText = `${acc.name} (${acc.currency})`;
                optgroup.appendChild(new Option(optionText, acc.id));
            });
            select.appendChild(optgroup);
        });
    }

    // --- 渲染帳戶列表的函式 ---
    function renderAccounts() {
        if (!accountsContainer) return;
        accountsContainer.innerHTML = '';
        if (!holders || holders.length === 0) {
            accountsContainer.innerHTML = '<div class="col-12 text-center text-muted p-4">尚無資金持有人。</div>';
            return;
        }
        holders.forEach(holder => {
            const holderId = holder.id;
            const holderName = holder.name;
            const holderData = accountsByHolder[holderId];
            let accountsHtml = '';
            let totalTwd = 0;
            let totalRmb = 0;
            if (holderData && holderData.accounts && holderData.accounts.length > 0) {
                holderData.accounts.forEach(acc => {
                    accountsHtml += `<li class="list-group-item d-flex justify-content-between align-items-center ps-4"><div><i class="bi bi-caret-right-fill text-muted me-1"></i><span>${acc.name} <span class="badge bg-secondary rounded-pill">${acc.currency}</span></span></div><div class="d-flex align-items-center"><strong class="me-3 ${acc.balance >= 0 ? 'text-dark' : 'text-danger'}">${acc.balance.toLocaleString('en-US', {minimumFractionDigits: 2})}</strong><div class="btn-group btn-group-sm"><button class="btn btn-outline-primary btn-movement" data-account-id="${acc.id}" data-account-name="${acc.name}" title="存入/提出"><i class="bi bi-arrow-down-up"></i></button><form action="{{ url_for('admin_update_cash_account') }}" method="POST" class="d-inline" onsubmit="return confirm('確定要刪除此帳戶嗎？');"><input type="hidden" name="action" value="delete_account"><input type="hidden" name="account_id" value="${acc.id}"><button type="submit" class="btn btn-outline-danger" title="刪除帳戶">&times;</button></form></div></div></li>`;
                });
                totalTwd = holderData.total_twd || 0;
                totalRmb = holderData.total_rmb || 0;
            } else {
                // 強制顯示持有人，即使沒有帳戶
                accountsHtml = '<li class="list-group-item text-muted text-center">-- 尚無帳戶 --</li>';
                totalTwd = 0;
                totalRmb = 0;
            }
            const subtotalFooter = `<div class="card-footer bg-light d-flex justify-content-around p-2"><div><small class="text-muted">TWD 小計:</small> <strong class="text-primary">${totalTwd.toLocaleString('en-US', {minimumFractionDigits: 2})}</strong></div><div><small class="text-muted">RMB 小計:</small> <strong class="text-success">${totalRmb.toLocaleString('en-US', {minimumFractionDigits: 2})}</strong></div></div>`;
            accountsContainer.innerHTML += `<div class="col-lg-6 mb-4"><div class="card h-100 shadow-sm"><div class="card-header d-flex justify-content-between align-items-center"><strong>${holderName}</strong><form action="{{ url_for('admin_update_cash_account') }}" method="POST" class="d-inline" onsubmit="return confirm('確定要刪除此持有人及其所有帳戶嗎？');"><input type="hidden" name="action" value="delete_holder"><input type="hidden" name="holder_id" value="${holderId}"><button type="submit" class="btn btn-danger btn-sm py-0">刪除持有人</button></form></div><ul class="list-group list-group-flush">${accountsHtml}</ul>${subtotalFooter}</div></div>`;
        });
        document.querySelectorAll('.btn-movement').forEach(btn => {
            btn.addEventListener('click', function() {
                const accountId = this.dataset.accountId;
                const accountName = this.dataset.accountName;
                if(movementModalTitle) movementModalTitle.textContent = `為「${accountName}」進行資金操作`;
                if(movementAccountIdInput) movementAccountIdInput.value = accountId;
                if(movementModal) movementModal.show();
            });
        });
    }

    // --- 渲染資金流水的函式 ---
    function renderMovements() {
        if (!movementsTbody) return;
        movementsTbody.innerHTML = '';
        if (movements.length === 0) {
            movementsTbody.innerHTML = '<tr><td colspan="6" class="text-center p-5 text-muted">尚無資金流水紀錄。</td></tr>';
            return;
        }
        movements.forEach(m => {
            const twdChange = parseFloat(m.twd_change) || 0;
            const rmbChange = parseFloat(m.rmb_change) || 0;
            movementsTbody.innerHTML += `<tr>
                <td class="ps-3">${new Date(m.date).toLocaleDateString()}</td>
                <td>${m.operator || ''}</td>
                <td><span class="badge bg-info-subtle text-info-emphasis">${m.type}</span></td>
                <td>${m.description}</td>
                <td class="text-end fw-bold ${twdChange >= 0 ? 'text-success' : 'text-danger'}">${twdChange.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                <td class="text-end pe-3 fw-bold ${rmbChange >= 0 ? 'text-success' : 'text-danger'}">${rmbChange.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
            </tr>`;
        });
    }
    
    const groupedAccounts = [];
    if (Array.isArray(holders) && Array.isArray(allAccounts)) {
        holders.forEach(holder => {
            const accountsInGroup = allAccounts.filter(acc => acc.holder_id === holder.id);
            if (accountsInGroup.length > 0) {
                groupedAccounts.push({
                    holder_name: holder.name,
                    accounts: accountsInGroup
                });
            }
        });
    }

    populateGroupedSelect('fromAccount', groupedAccounts);
    populateGroupedSelect('toAccount', groupedAccounts);
});
</script>
{% endblock %}