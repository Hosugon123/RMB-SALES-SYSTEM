{% extends "base.html" %}

{% block title %}ç¾é‡‘ç®¡ç†{% endblock %}

{% block content %}
<div class="container-fluid">
    <style>
        /* å°è¢å¹•åˆªé™¤æŒ‰éˆ•èˆ‡æ’ç‰ˆå„ªåŒ– */
        .delete-account-btn {
            width: 28px;
            height: 28px;
            padding: 0;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .delete-account-btn i {
            font-size: 16px;
            line-height: 1;
        }
        .btn-movement {
            line-height: 1;
        }
        /* èª¿æ•´é¤˜é¡åœ¨è¼ƒå°è¢å¹•ä¸‹çš„æœ€å°å¯¬åº¦ï¼Œé¿å…å› æ“ å£“å°è‡´æº¢å‡º */
        @media (max-width: 400px) {
            .account-balance {
                min-width: 90px !important;
            }
        }
        
        /* é˜²æ­¢è¡¨æ ¼æ–‡å­—æ›è¡Œ */
        .table th, .table td {
            white-space: nowrap;
            padding: 0.5rem 0.75rem;
        }
        
        /* å…è¨±æè¿°æ¬„ä½æ›è¡Œ */
        .table th:nth-child(3), .table td:nth-child(3) {
            white-space: normal;
        }
        
        /* å…è¨±å‚™è¨»æ¬„ä½æ›è¡Œ */
        .table th:nth-child(7), .table td:nth-child(7) {
            white-space: normal;
        }
        /* å…è¨±åˆ©æ½¤è®Šå‹•æ¬„ä½ï¼ˆç¬¬ 11 æ¬„ï¼‰æ›è¡Œ */
        .table th:nth-child(11), .table td:nth-child(11) {
            white-space: normal;
        }
    </style>
    <!-- æ¨™é¡Œè¡Œ -->
    <div class="row align-items-center mb-4">
        <div class="col">
            <h2 class="fw-light mb-0">
                <i class="bi bi-cash-stack me-2"></i>ç¾é‡‘ç®¡ç†
            </h2>
        </div>
    </div>

    <!-- ç¸½è³‡ç”¢æ¦‚è¦½ -->
    <div class="card shadow-sm mb-4">
        <div class="card-body text-center">
            <div class="row">
                <div class="col-md-4 border-end">
                    <h5 class="text-primary mb-1">ç¸½å°å¹£</h5>
                    <h3 class="fw-bold text-primary" id="totalTwdDisplay">NT$ {{ "{:,.2f}".format(total_twd) }}</h3>
                </div>
                <div class="col-md-4 border-end">
                    <h5 class="text-success mb-1">ç¸½äººæ°‘å¹£</h5>
                    <h3 class="fw-bold text-success" id="totalRmbDisplay">Â¥ {{ "{:,.2f}".format(total_rmb) }}</h3>
                </div>
                <div class="col-md-4">
                    <h5 class="text-danger mb-1">æ‡‰æ”¶å¸³æ¬¾</h5>
                    <h3 class="fw-bold text-danger" id="totalReceivablesDisplay">NT$ {{ "{:,.2f}".format(total_receivables_twd) }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- æ“ä½œå€å¡Š -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex gap-2 justify-content-center">
                <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addHolderModal">
                    <i class="bi bi-person-plus me-1"></i>æ–°å¢æŒæœ‰äºº
                </button>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addAccountModal">
                    <i class="bi bi-plus-circle me-1"></i>æ–°å¢å¸³æˆ¶
                </button>
                <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#transferModal">
                    <i class="bi bi-arrow-left-right me-1"></i>å…§éƒ¨è½‰å¸³
                </button>
                <!-- æ–°å¢ï¼šé›†ä¸­åˆ©æ½¤æ“ä½œä¸»æŒ‰éˆ• -->
                <button class="btn btn-warning btn-sm" id="btnOpenGlobalProfit">
                    <i class="bi bi-cash-coin me-1"></i>åˆ©æ½¤
                </button>
                <button class="btn btn-secondary btn-sm" onclick="manualRefreshData()">
                    <i class="bi bi-arrow-clockwise me-1"></i>åˆ·æ–°æ•¸æ“š
                </button>
            </div>
        </div>
    </div>

    <!-- è³‡é‡‘æŒæœ‰äººèˆ‡å¸³æˆ¶å€å¡Š -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0 fw-light">
                <i class="bi bi-people me-2"></i>è³‡é‡‘æŒæœ‰äººèˆ‡å¸³æˆ¶
                <small class="text-muted">ï¼ˆå…± {{ holders|length }} ä½æŒæœ‰äººï¼‰</small>
            </h5>
        </div>
        <div class="card-body">
            <div class="row" id="accounts-container">
                <!-- JavaScript å°‡æœƒå‹•æ…‹å¡«å……é€™è£¡ -->
            </div>
        </div>
    </div>

    <!-- æ‡‰æ”¶å¸³æ¬¾ç®¡ç†å€å¡Š -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0 fw-light">
                <i class="bi bi-receipt me-2"></i>æ‡‰æ”¶å¸³æ¬¾ç®¡ç†
                <small class="text-muted">ï¼ˆå…± {{ customers_with_receivables|length }} ç­†ï¼‰</small>
            </h5>
        </div>
        <div class="card-body p-0">
            {% if customers_with_receivables %}
            <div class="table-responsive">
                <table class="table align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-3">å®¢æˆ¶åç¨±</th>
                            <th class="text-end">æ‡‰æ”¶é‡‘é¡</th>
                            <th class="text-center">æ“ä½œ</th>
                            <th class="pe-3">èªªæ˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for customer in customers_with_receivables %}
                        <tr>
                            <td class="ps-3">
                                <a href="javascript:void(0)" class="text-decoration-none customer-transactions" 
                                   data-customer-id="{{ customer.id }}" data-customer-name="{{ customer.name }}" data-customer-receivable="{{ customer.total_receivables_twd }}">
                                    {{ customer.name }}
                                </a>
                            </td>
                            <td class="text-end">
                                <span class="fw-bold text-danger">NT$ {{ "{:,.2f}".format(customer.total_receivables_twd) }}</span>
                            </td>
                            <td class="text-center">
                                <button class="btn btn-primary btn-sm settlement-btn" 
                                        data-customer-id="{{ customer.id }}" 
                                        data-customer-name="{{ customer.name }}" 
                                        data-amount="{{ customer.total_receivables_twd }}">
                                    <i class="bi bi-check-circle me-1"></i>éŠ·å¸³
                                </button>
                            </td>
                            <td class="pe-3">
                                <small class="text-muted">é»æ“Šå®¢æˆ¶åç¨±æŸ¥çœ‹äº¤æ˜“ç´€éŒ„</small>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center p-4 text-muted">
                <i class="bi bi-inbox fs-1"></i>
                <p class="mt-2">å°šç„¡æ‡‰æ”¶å¸³æ¬¾</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- å¾…ä»˜æ¬¾é …ç®¡ç†å€å¡Š -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0 fw-light"><i class="bi bi-credit-card me-2"></i>å¾…ä»˜æ¬¾é …ç®¡ç†</h5>
        </div>
        <div class="card-body p-0">
            {% if pending_payments %}
            <div class="table-responsive">
                <table class="table align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-3">è²·å…¥è¨˜éŒ„ID</th>
                            <th>æ¸ é“</th>
                            <th class="text-end">å¾…ä»˜é‡‘é¡</th>
                            <th class="text-center">æ“ä½œ</th>
                            <th class="pe-3">èªªæ˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pending in pending_payments %}
                        <tr>
                            <td class="ps-3">
                                <span class="fw-bold">#{{ pending.purchase_record_id }}</span>
                            </td>
                            <td>
                                <small>{{ pending.purchase_record.channel.name if pending.purchase_record.channel else 'N/A' }}</small>
                            </td>
                            <td class="text-end">
                                <span class="fw-bold text-warning">NT$ {{ "{:,.2f}".format(pending.amount_twd) }}</span>
                            </td>
                            <td class="text-center">
                                <button class="btn btn-warning btn-sm payment-btn" 
                                        data-pending-id="{{ pending.id }}" 
                                        data-purchase-record-id="{{ pending.purchase_record_id }}" 
                                        data-amount="{{ pending.amount_twd }}" 
                                        data-channel="{{ pending.purchase_record.channel.name if pending.purchase_record.channel else 'N/A' }}">
                                    <i class="bi bi-credit-card me-1"></i>ä»˜æ¬¾
                                </button>
                            </td>
                            <td class="pe-3">
                                <small class="text-muted">é»æ“Šä»˜æ¬¾æŒ‰éˆ•é€²è¡ŒéŠ·å¸³</small>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center p-4 text-muted">
                <i class="bi bi-check-circle display-4 text-success"></i>
                <p class="mt-2">å°šç„¡å¾…ä»˜æ¬¾é …</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- è³‡é‡‘æµæ°´å€å¡Š -->
    <div class="card shadow-sm mt-4">
        <div class="card-header">
            <h5 class="mb-0 fw-light"><i class="bi bi-graph-up-arrow me-2"></i>è¿‘æœŸäº¤æ˜“è¨˜éŒ„</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-3">æ™‚é–“</th>
                            <th>é¡å‹</th>
                            <th>æè¿°</th>
                            <th style="min-width: 60px;">æ“ä½œäºº</th>
                            <th style="min-width: 70px;">å‡ºæ¬¾æˆ¶</th>
                            <th style="min-width: 70px;">å…¥æ¬¾æˆ¶</th>
                            <th>å‚™è¨»</th>
                            <th class="text-end">TWD/RMB è®Šå‹•</th>
                            <th class="text-end">å‡ºæ¬¾æˆ¶é¤˜é¡è®ŠåŒ–</th>
                            <th class="text-end">å…¥æ¬¾æˆ¶é¤˜é¡è®ŠåŒ–</th>
                            <th class="text-end pe-3">åˆ©æ½¤è®Šå‹•</th>
                        </tr>
                    </thead>
                    <tbody id="movements-tbody">
                        <!-- JavaScript å°‡æœƒå‹•æ…‹å¡«å……é€™è£¡ -->
                    </tbody>
                </table>
            </div>
            
            <!-- åˆ†é æ§åˆ¶é … -->
            <div class="card-footer">
                <div class="d-flex justify-content-between align-items-center">
                    <div id="pagination-info" class="text-muted">
                        <!-- åˆ†é ä¿¡æ¯å°‡å‹•æ…‹å¡«å…… -->
                    </div>
                    <nav aria-label="æµæ°´è¨˜éŒ„åˆ†é ">
                        <ul class="pagination pagination-sm mb-0" id="pagination-controls">
                            <!-- åˆ†é æŒ‰éˆ•å°‡å‹•æ…‹å¡«å…… -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å¼•ç”¨æ‰€æœ‰çš„æ“ä½œæ¨¡æ…‹æ¡† -->
{% include '_cash_management_modals.html' %}

<!-- å°‡å¾Œç«¯æ•¸æ“šå‚³éçµ¦JavaScript -->
<script type="application/json" id="cash-management-data"></script>
{% endblock %}

{% block scripts %}
<style>
/* ç´¯ç©é¤˜é¡åˆ—çš„æ¨£å¼ */
.running-balance {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 6px;
    padding: 8px;
}

/* äº¤æ˜“è¡Œçš„æ¨£å¼ */
.transaction-row {
    transition: all 0.2s ease;
}

.transaction-row:hover {
    background-color: #f8f9fa !important;
    transform: translateX(2px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    console.log('ğŸš€ ç¾é‡‘ç®¡ç†é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
    
    // å…¼å®¹éµåèˆ‡ç©ºå€¼å·¥å…·
    function pick() {
        for (var i = 0; i < arguments.length; i++) {
            var v = arguments[i];
            if (v !== undefined && v !== null) return v;
        }
        return undefined;
    }

    // å¾å¾Œç«¯æ¨¡æ¿è®Šæ•¸ç›´æ¥å–å¾—åˆå§‹è³‡æ–™ï¼ˆé¿å… tojson å¤±æ•—ï¼‰
    // è¨­ç‚ºå…¨åŸŸè®Šæ•¸ä»¥ä¾¿å…¶ä»–å‡½æ•¸ä½¿ç”¨
    window.accountsByHolder = {{ accounts_by_holder|tojson|safe if accounts_by_holder is defined else '{}' }};
    window.holders = {{ holders|tojson|safe if holders is defined else '[]' }};
    window.movements = {{ movements|tojson|safe if movements is defined else '[]' }};
    var accountsByHolder = window.accountsByHolder;
    var holders = window.holders;
    var movements = window.movements;
    var customersList = [];
    
    console.log('ğŸ“Š æ•¸æ“šæª¢æŸ¥:', { holders: holders, accountsByHolder: accountsByHolder, movements: movements });

    // å¾ DOM è’é›†æ‡‰æ”¶å¸³æ¬¾åˆ—è¡¨ï¼Œé¿å…å¾Œç«¯åºåˆ—åŒ–æ¨¡å‹ç‰©ä»¶å¤±æ•—
    function refreshCustomersList() {
        try {
            customersList = Array.from(document.querySelectorAll('.customer-transactions')).map(function(a) {
                return {
                    id: parseInt(a.dataset.customerId),
                    name: a.dataset.customerName,
                    total_receivables_twd: parseFloat(a.dataset.customerReceivable || 0)
                };
            });
            console.log('ğŸ§¾ å·²å»ºç«‹ customersList:', customersList);
        } catch (e) {
            console.warn('ç„¡æ³•å»ºç«‹ customersList:', e);
            customersList = [];
        }
    }
    refreshCustomersList();
    
    // å°‡å¸³æˆ¶æ•¸æ“šè½‰æ›ç‚ºå¹³é¢æ•¸çµ„ä¾›æ¨¡æ…‹æ¡†ä½¿ç”¨
    window.ownerAccountsData = [];
    
    // å¾ accountsByHolder çµæ§‹ä¸­æå–æ‰€æœ‰å¸³æˆ¶
    Object.keys(accountsByHolder).forEach(holderId => {
        const holderData = accountsByHolder[holderId];
        if (holderData && holderData.accounts) {
            holderData.accounts.forEach(account => {
                window.ownerAccountsData.push({
                    id: account.id,
                    name: account.name,
                    currency: account.currency,
                    holder_id: parseInt(holderId)
                });
            });
        }
    });
    
    console.log('ğŸ”§ ä¿å­˜å¸³æˆ¶æ•¸æ“šåˆ°å…¨å±€è®Šé‡:', window.ownerAccountsData);
    
    // ç²å– DOM å…ƒç´ 
    const accountsContainer = document.getElementById('accounts-container');
    const movementsTbody = document.getElementById('movements-tbody');
    
    // æ¸²æŸ“å¸³æˆ¶åˆ—è¡¨
    function renderAccounts() {
        console.log('ğŸ” é–‹å§‹æ¸²æŸ“å¸³æˆ¶åˆ—è¡¨...');
        
        if (!accountsContainer) {
            console.error('âŒ æ‰¾ä¸åˆ° accounts-container å…ƒç´ ');
            return;
        }
        
        accountsContainer.innerHTML = '';
        
        if (!holders || holders.length === 0) {
            console.log('âš ï¸ æ²’æœ‰æŒæœ‰äººæ•¸æ“š');
            accountsContainer.innerHTML = '<div class="col-12 text-center text-muted p-4">å°šç„¡è³‡é‡‘æŒæœ‰äººã€‚</div>';
            return;
        }
        
        console.log('âœ… æ‰¾åˆ° ' + holders.length + ' å€‹æŒæœ‰äººï¼Œé–‹å§‹æ¸²æŸ“...');
        
        holders.forEach(function(holder, index) {
            const holderId = holder.id;
            const holderName = holder.name;
            const holderData = accountsByHolder[holderId];
            
            console.log('ğŸ“‹ æ¸²æŸ“æŒæœ‰äºº ' + (index + 1) + ': ' + holderName + ' (ID: ' + holderId + ')');
            
            let accountsHtml = '';
            let totalTwd = 0;
            let totalRmb = 0;
            
            if (holderData && holderData.accounts && holderData.accounts.length > 0) {
                console.log('ğŸ“‹ æŒæœ‰äºº ' + holderName + ' æœ‰ ' + holderData.accounts.length + ' å€‹å¸³æˆ¶');
                holderData.accounts.forEach(function(acc) {
                    const currencyBadgeClass = acc.currency === 'TWD' ? 'bg-primary' : 'bg-success';
                    const currencyTextClass = acc.currency === 'TWD' ? 'text-primary' : 'text-success';
                    
                    accountsHtml += '<li class="list-group-item py-2">';
                    accountsHtml += '<div class="d-flex justify-content-between align-items-center">';
                    
                    // å·¦å´ï¼šè²¨å¹£æ¨™ç±¤å’Œå¸³æˆ¶åç¨±
                    accountsHtml += '<div class="d-flex align-items-center">';
                    accountsHtml += '<span class="badge ' + currencyBadgeClass + ' me-2" style="min-width: 50px;">' + acc.currency + '</span>';
                    accountsHtml += '<span class="fw-medium">' + acc.name + '</span>';
                    accountsHtml += '</div>';
                    
                    // å³å´ï¼šé‡‘é¡å’Œæ“ä½œæŒ‰éˆ•
                    accountsHtml += '<div class="d-flex align-items-center">';
                    accountsHtml += '<div class="me-3 text-end" style="min-width: 200px;">';
                    accountsHtml += '<div class="' + currencyTextClass + ' fw-bold account-balance">' + acc.balance.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</div>';
                    accountsHtml += '</div>';
                    accountsHtml += '<div class="btn-group btn-group-sm">';
                    accountsHtml += '<button class="btn btn-outline-primary btn-movement btn-sm" data-account-id="' + acc.id + '" data-account-name="' + acc.name + '" title="å­˜å…¥/æå‡º">';
                    accountsHtml += '<i class="bi bi-arrow-down-up"></i>';
                    accountsHtml += '</button>';
                    // ç§»é™¤æ¯å¸³æˆ¶çš„åˆ©æ½¤ç®¡ç†æŒ‰éˆ•ï¼Œæ”¹ç”±å…¨åŸŸåˆ©æ½¤æŒ‰éˆ•çµ±ä¸€è™•ç†
                    accountsHtml += '<button class="btn btn-outline-danger btn-sm delete-account-btn" data-account-id="' + acc.id + '" data-account-name="' + acc.name + '" title="åˆªé™¤å¸³æˆ¶">';
                    accountsHtml += '<i class="bi bi-x-lg"></i>';
                    accountsHtml += '</button>';
                    accountsHtml += '</div>';
                    accountsHtml += '</div>';
                    
                    accountsHtml += '</div>';
                    accountsHtml += '</li>';
                });
                totalTwd = holderData.total_twd || 0;
                totalRmb = holderData.total_rmb || 0;
            } else {
                console.log('ğŸ“‹ æŒæœ‰äºº ' + holderName + ' æ²’æœ‰å¸³æˆ¶');
                accountsHtml = '<li class="list-group-item py-1 text-muted text-center small">-- å°šç„¡å¸³æˆ¶ --</li>';
                totalTwd = 0;
                totalRmb = 0;
            }
            
            const subtotalFooter = '<div class="card-footer bg-light d-flex justify-content-around py-1">' +
                '<div><small class="text-muted">TWD:</small> <strong class="text-primary">' + totalTwd.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</strong></div>' +
                '<div><small class="text-muted">RMB:</small> <strong class="text-success">' + totalRmb.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</strong></div>' +
                '</div>';
            
            const holderCard = '<div class="col-lg-4 col-md-6 mb-2">' +
                '<div class="card shadow-sm h-100">' +
                '<div class="card-header py-2 d-flex justify-content-between align-items-center">' +
                '<strong class="h6 mb-0">' + holderName + '</strong>' +
                '<button class="btn btn-danger btn-sm py-0 px-2 delete-holder-btn" data-holder-id="' + holderId + '" data-holder-name="' + holderName + '">åˆªé™¤</button>' +
                '</div>' +
                '<ul class="list-group list-group-flush">' + accountsHtml + '</ul>' +
                subtotalFooter +
                '</div>' +
                '</div>';
            
            accountsContainer.innerHTML += holderCard;
        });
        
        console.log('âœ… å¸³æˆ¶åˆ—è¡¨æ¸²æŸ“å®Œæˆ');
        
        // é‡æ–°è¨­ç½®äº‹ä»¶ç›£è½å™¨
        setupEventListeners();
    }
    
    // è¨­ç½®äº‹ä»¶ç›£è½å™¨
    function setupEventListeners() {
        // è¨­ç½®å‡ºå…¥å¸³æŒ‰éˆ•äº‹ä»¶
        const movementButtons = document.querySelectorAll('.btn-movement');
        movementButtons.forEach(button => {
            button.addEventListener('click', function() {
                const accountId = this.getAttribute('data-account-id');
                const accountName = this.getAttribute('data-account-name');
                openMovementModal(accountId, accountName);
            });
        });
        
        // è¨­ç½®åˆªé™¤å¸³æˆ¶æŒ‰éˆ•äº‹ä»¶
        const deleteAccountButtons = document.querySelectorAll('.delete-account-btn');
        deleteAccountButtons.forEach(button => {
            button.addEventListener('click', function() {
                const accountId = this.getAttribute('data-account-id');
                const accountName = this.getAttribute('data-account-name');
                deleteAccount(accountId, accountName);
            });
        });
        
        // è¨­ç½®åˆªé™¤æŒæœ‰äººæŒ‰éˆ•äº‹ä»¶
        const deleteHolderButtons = document.querySelectorAll('.delete-holder-btn');
        deleteHolderButtons.forEach(button => {
            button.addEventListener('click', function() {
                const holderId = this.getAttribute('data-holder-id');
                const holderName = this.getAttribute('data-holder-name');
                deleteHolder(holderId, holderName);
            });
        });
        
        // è¨­ç½®RMBåŒ¯ç‡æ¬„ä½çš„é¡¯ç¤º/éš±è—é‚è¼¯
        setupRmbRateFieldLogic();
        
        // å¡«å……æ¨¡æ…‹æ¡†ä¸­çš„ä¸‹æ‹‰é¸å–®
        populateModalSelects();
    }
    
    // å¡«å……ä¸‹æ‹‰é¸å–®çš„é€šç”¨å‡½å¼
    function populateSelect(selectId, options) {
        const select = document.getElementById(selectId);
        if (!select) return;
        if (!Array.isArray(options)) {
            select.innerHTML = '<option value="" disabled selected>--- æ•¸æ“šè¼‰å…¥éŒ¯èª¤ ---</option>';
            return;
        }
        select.innerHTML = '<option value="" disabled selected>--- è«‹é¸æ“‡ ---</option>';
        options.forEach(opt => select.add(new Option(opt.text, opt.value)));
    }

    // å¡«å……å¸¶æœ‰åˆ†çµ„çš„ä¸‹æ‹‰é¸å–®
    function populateGroupedSelect(selectId, groupedOptions) {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = '<option value="" disabled selected>--- è«‹é¸æ“‡å¸³æˆ¶ ---</option>';
        
        groupedOptions.forEach(group => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = group.holder_name; // è¨­å®šåˆ†çµ„æ¨™é¡Œ
            group.accounts.forEach(acc => {
                const optionText = `${acc.name} (${acc.currency})`;
                optgroup.appendChild(new Option(optionText, acc.id));
            });
            select.appendChild(optgroup);
        });
    }



    // è¨­ç½®RMBåŒ¯ç‡æ¬„ä½å’Œå°å¹£ææ¬¾ä¾†æºæ¬„ä½çš„é¡¯ç¤º/éš±è—é‚è¼¯
    function setupRmbRateFieldLogic() {
        // ç›£è½æ“ä½œé¡å‹é¸æ“‡çš„è®ŠåŒ–
        const depositRadio = document.getElementById('movementDeposit');
        const withdrawRadio = document.getElementById('movementWithdraw');
        
        if (depositRadio && withdrawRadio) {
            depositRadio.addEventListener('change', function() {
                if (this.checked) {
                    // é¸æ“‡å­˜æ¬¾æ™‚ï¼Œæª¢æŸ¥æ˜¯å¦éœ€è¦é¡¯ç¤ºåŒ¯ç‡æ¬„ä½
                    const accountId = document.getElementById('movementAccountId')?.value;
                    if (accountId) {
                        checkAndShowRmbRateField(accountId);
                    }
                    
                    // éš±è—ææ¬¾é¡å‹é¸æ“‡æ¬„ä½
                    const withdrawTypeDiv = document.getElementById('withdrawTypeDiv');
                    if (withdrawTypeDiv) {
                        withdrawTypeDiv.style.display = 'none';
                        console.log('âœ… éš±è—ææ¬¾é¡å‹é¸æ“‡æ¬„ä½');
                    }
                    
                    // éš±è—å°å¹£ææ¬¾ä¾†æºé¸æ“‡æ¬„ä½
                    hideTwdWithdrawSourceField();
                }
            });
            
            withdrawRadio.addEventListener('change', function() {
                if (this.checked) {
                    // é¸æ“‡ææ¬¾æ™‚ï¼Œéš±è—åŒ¯ç‡æ¬„ä½
                    const rmbRateDiv = document.getElementById('rmbCostRateDiv');
                    if (rmbRateDiv) {
                        rmbRateDiv.style.display = 'none';
                        const rmbRateInput = document.getElementById('rmbCostRate');
                        if (rmbRateInput) {
                            rmbRateInput.required = false;
                            rmbRateInput.value = '';
                        }
                    }
                    
                    // é¡¯ç¤ºææ¬¾é¡å‹é¸æ“‡æ¬„ä½
                    const withdrawTypeDiv = document.getElementById('withdrawTypeDiv');
                    if (withdrawTypeDiv) {
                        withdrawTypeDiv.style.display = 'block';
                        console.log('âœ… é¡¯ç¤ºææ¬¾é¡å‹é¸æ“‡æ¬„ä½');
                    }
                    
                    // æª¢æŸ¥æ˜¯å¦éœ€è¦é¡¯ç¤ºå°å¹£ææ¬¾ä¾†æºé¸æ“‡æ¬„ä½
                    const accountId = document.getElementById('movementAccountId')?.value;
                    if (accountId) {
                        checkAndShowTwdWithdrawSourceField(accountId);
                    }
                }
            });
        }
    }
    
    // éš±è—å°å¹£ææ¬¾ä¾†æºé¸æ“‡æ¬„ä½
    function hideTwdWithdrawSourceField() {
        const twdWithdrawSourceDiv = document.getElementById('twdWithdrawSourceDiv');
        if (twdWithdrawSourceDiv) {
            twdWithdrawSourceDiv.style.display = 'none';
        }
    }
    
    // æª¢æŸ¥ä¸¦é¡¯ç¤ºå°å¹£ææ¬¾ä¾†æºé¸æ“‡æ¬„ä½
    function checkAndShowTwdWithdrawSourceField(accountId) {
        // å¾å¸³æˆ¶æ•¸æ“šä¸­æŸ¥æ‰¾è©²å¸³æˆ¶çš„å¹£åˆ¥
        let isTwdAccount = false;
        for (const holderId in accountsByHolder) {
            const holder = accountsByHolder[holderId];
            for (const account of holder.accounts) {
                if (account.id == accountId && account.currency === 'TWD') {
                    isTwdAccount = true;
                    break;
                }
            }
            if (isTwdAccount) break;
        }
        
        // é¡¯ç¤ºæˆ–éš±è—å°å¹£ææ¬¾ä¾†æºé¸æ“‡æ¬„ä½
        const twdWithdrawSourceDiv = document.getElementById('twdWithdrawSourceDiv');
        if (twdWithdrawSourceDiv) {
            if (isTwdAccount) {
                twdWithdrawSourceDiv.style.display = 'block';
                // è¨­ç½®é è¨­å€¼ç‚ºè³‡ç”¢é¤˜é¡
                const assetRadio = document.getElementById('withdrawSourceAsset');
                if (assetRadio) {
                    assetRadio.checked = true;
                }
            } else {
                twdWithdrawSourceDiv.style.display = 'none';
            }
        }
    }
    
    // æ‰“é–‹å‡ºå…¥å¸³æ¨¡æ…‹æ¡†
    function openMovementModal(accountId, accountName) {
        console.log('ğŸ”„ æ‰“é–‹å‡ºå…¥å¸³æ¨¡æ…‹æ¡†:', accountId, accountName);
        
        // è¨­ç½®æ¨¡æ…‹æ¡†æ¨™é¡Œå’Œå¸³æˆ¶ä¿¡æ¯
        const modalTitle = document.getElementById('movementModalTitle');
        
        if (modalTitle) modalTitle.textContent = `ç‚ºã€Œ${accountName}ã€é€²è¡Œè³‡é‡‘æ“ä½œ`;
        
        // è¨­ç½®éš±è—çš„å¸³æˆ¶ID
        const accountIdInput = document.getElementById('movementAccountId');
        if (accountIdInput) accountIdInput.value = accountId;
        
        // é‡ç½®æ‰€æœ‰é¸æ“‡æ¬„ä½
        hideTwdWithdrawSourceField();
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºRMBå¸³æˆ¶ï¼Œå¦‚æœæ˜¯å‰‡é¡¯ç¤ºåŒ¯ç‡æ¬„ä½
        checkAndShowRmbRateField(accountId);
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºTWDå¸³æˆ¶ä¸”é¸æ“‡ææ¬¾ï¼Œå¦‚æœæ˜¯å‰‡é¡¯ç¤ºæ‰£é™¤ä¾†æºé¸æ“‡æ¬„ä½
        const withdrawRadio = document.getElementById('movementWithdraw');
        if (withdrawRadio && withdrawRadio.checked) {
            checkAndShowTwdWithdrawSourceField(accountId);
        }
        
        // é¡¯ç¤ºæ¨¡æ…‹æ¡†
        const modal = new bootstrap.Modal(document.getElementById('addMovementModal'));
        modal.show();
    }
    
    // æª¢æŸ¥ä¸¦é¡¯ç¤ºRMBåŒ¯ç‡æ¬„ä½
    function checkAndShowRmbRateField(accountId) {
        // å¾å¸³æˆ¶æ•¸æ“šä¸­æŸ¥æ‰¾è©²å¸³æˆ¶çš„å¹£åˆ¥
        let isRmbAccount = false;
        for (const holderId in accountsByHolder) {
            const holder = accountsByHolder[holderId];
            for (const account of holder.accounts) {
                if (account.id == accountId && account.currency === 'RMB') {
                    isRmbAccount = true;
                    break;
                }
            }
            if (isRmbAccount) break;
        }
        
        // é¡¯ç¤ºæˆ–éš±è—åŒ¯ç‡æ¬„ä½
        const rmbRateDiv = document.getElementById('rmbCostRateDiv');
        if (rmbRateDiv) {
            if (isRmbAccount) {
                rmbRateDiv.style.display = 'block';
                // è¨­ç½®åŒ¯ç‡æ¬„ä½ç‚ºå¿…å¡«
                const rmbRateInput = document.getElementById('rmbCostRate');
                if (rmbRateInput) {
                    rmbRateInput.required = true;
                    // åˆå§‹åŒ–æ•¸å­—æ ¼å¼åŒ–
                    setupNumberInputFormatting(rmbRateInput, { maxDecimals: 4 });
                }
            } else {
                rmbRateDiv.style.display = 'none';
                // è¨­ç½®åŒ¯ç‡æ¬„ä½ç‚ºéå¿…å¡«
                const rmbRateInput = document.getElementById('rmbCostRate');
                if (rmbRateInput) {
                    rmbRateInput.required = false;
                    rmbRateInput.value = '';
                }
            }
        }
    }
    
    // åˆªé™¤å¸³æˆ¶
    function deleteAccount(accountId, accountName) {
        console.log('ğŸ—‘ï¸ åˆªé™¤å¸³æˆ¶:', accountId, accountName);
        
        // ä½¿ç”¨ SweetAlert2 é€²è¡ŒäºŒæ¬¡ç¢ºèª
        Swal.fire({
            title: 'ç¢ºèªåˆªé™¤å¸³æˆ¶',
            html: `
                <div class="text-start">
                    <p><strong>å¸³æˆ¶åç¨±ï¼š</strong>${accountName}</p>
                    <p><strong>æ“ä½œé¡å‹ï¼š</strong>æ°¸ä¹…åˆªé™¤</p>
                    <div class="alert alert-warning mt-3">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>è­¦å‘Šï¼š</strong>æ­¤æ“ä½œä¸å¯é€†è½‰ï¼
                    </div>
                </div>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'ç¢ºèªåˆªé™¤',
            cancelButtonText: 'å–æ¶ˆ',
            reverseButtons: true,
            focusCancel: true
        }).then((result) => {
            if (result.isConfirmed) {
                // ç¬¬äºŒæ¬¡ç¢ºèª
                Swal.fire({
                    title: 'æœ€çµ‚ç¢ºèª',
                    html: `
                        <div class="text-start">
                            <p>æ‚¨ç¢ºå®šè¦åˆªé™¤å¸³æˆ¶ã€Œ<strong>${accountName}</strong>ã€å—ï¼Ÿ</p>
                            <div class="alert alert-danger mt-3">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>æ­¤æ“ä½œå°‡ï¼š</strong>
                                <ul class="mt-2 mb-0">
                                    <li>æ°¸ä¹…åˆªé™¤è©²å¸³æˆ¶</li>
                                    <li>ç„¡æ³•æ¢å¾©</li>
                                    <li>å¯èƒ½å½±éŸ¿ç›¸é—œè¨˜éŒ„</li>
                                </ul>
                            </div>
                        </div>
                    `,
                    icon: 'error',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'æ˜¯çš„ï¼Œåˆªé™¤å®ƒï¼',
                    cancelButtonText: 'å–æ¶ˆ',
                    reverseButtons: true
                }).then((finalResult) => {
                    if (finalResult.isConfirmed) {
                        // åŸ·è¡Œåˆªé™¤æ“ä½œ
                        executeDeleteAccount(accountId, accountName);
                    }
                });
            }
        });
    }
    
    // åŸ·è¡Œåˆªé™¤å¸³æˆ¶æ“ä½œ
    function executeDeleteAccount(accountId, accountName) {
        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        Swal.fire({
            title: 'æ­£åœ¨åˆªé™¤...',
            text: `æ­£åœ¨åˆªé™¤å¸³æˆ¶ã€Œ${accountName}ã€`,
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        // ç™¼é€åˆªé™¤è«‹æ±‚
        fetch('/api/delete-account', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                account_id: accountId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: 'åˆªé™¤æˆåŠŸï¼',
                    text: `å¸³æˆ¶ã€Œ${accountName}ã€å·²æˆåŠŸåˆªé™¤`,
                    timer: 2000,
                    showConfirmButton: false
                });
                // åˆ·æ–°é é¢æ•¸æ“š
                manualRefreshData();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'åˆªé™¤å¤±æ•—',
                    text: data.message,
                    confirmButtonText: 'ç¢ºå®š'
                });
            }
        })
        .catch(error => {
            console.error('âŒ åˆªé™¤å¸³æˆ¶æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            Swal.fire({
                icon: 'error',
                title: 'åˆªé™¤å¤±æ•—',
                text: 'è«‹æª¢æŸ¥ç¶²è·¯é€£æ¥æˆ–è¯ç¹«ç®¡ç†å“¡',
                confirmButtonText: 'ç¢ºå®š'
            });
        });
    }
    
    // å¡«å……ä¸‹æ‹‰é¸å–®çš„é€šç”¨å‡½å¼
    function populateSelect(selectId, options) {
        const select = document.getElementById(selectId);
        if (!select) return;
        if (!Array.isArray(options)) {
            select.innerHTML = '<option value="" disabled selected>--- æ•¸æ“šè¼‰å…¥éŒ¯èª¤ ---</option>';
            return;
        }
        select.innerHTML = '<option value="" disabled selected>--- è«‹é¸æ“‡ ---</option>';
        options.forEach(opt => select.add(new Option(opt.text, opt.value)));
    }

    // å¡«å……å¸¶æœ‰åˆ†çµ„çš„ä¸‹æ‹‰é¸å–®
    function populateGroupedSelect(selectId, groupedOptions) {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = '<option value="" disabled selected>--- è«‹é¸æ“‡å¸³æˆ¶ ---</option>';
        
        groupedOptions.forEach(group => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = group.holder_name; // è¨­å®šåˆ†çµ„æ¨™é¡Œ
            group.accounts.forEach(acc => {
                const optionText = `${acc.name} (${acc.currency})`;
                optgroup.appendChild(new Option(optionText, acc.id));
            });
            select.appendChild(optgroup);
        });
    }

    // å¡«å……æ¨¡æ…‹æ¡†ä¸­çš„ä¸‹æ‹‰é¸å–®
    function populateModalSelects() {
        console.log('ğŸ”§ é–‹å§‹å¡«å……æ¨¡æ…‹æ¡†ä¸‹æ‹‰é¸å–®...');
        
        // å¡«å……æ–°å¢å¸³æˆ¶æ¨¡æ…‹æ¡†ä¸­çš„æŒæœ‰äººä¸‹æ‹‰é¸å–®
        if (holders && holders.length > 0) {
            console.log('âœ… å¡«å……æŒæœ‰äººä¸‹æ‹‰é¸å–®ï¼Œæ‰¾åˆ°', holders.length, 'å€‹æŒæœ‰äºº');
            populateSelect('accountHolder', holders.map(h => ({ value: h.id, text: h.name })));
        } else {
            console.log('âš ï¸ æ²’æœ‰æŒæœ‰äººæ•¸æ“šå¯å¡«å……');
        }
        
        // å¡«å……å…§éƒ¨è½‰å¸³æ¨¡æ…‹æ¡†ä¸­çš„å¸³æˆ¶ä¸‹æ‹‰é¸å–®
        // è½‰å‡ºå¸³æˆ¶ï¼šåªé¡¯ç¤ºæœ‰é¤˜é¡çš„å¸³æˆ¶
        const fromAccounts = [];
        if (accountsByHolder && Object.keys(accountsByHolder).length > 0) {
            Object.keys(accountsByHolder).forEach(holderId => {
                const holderData = accountsByHolder[holderId];
                if (holderData && holderData.accounts && holderData.accounts.length > 0) {
                    const accountsInGroup = holderData.accounts.filter(acc => acc.balance > 0); // åªé¡¯ç¤ºæœ‰é¤˜é¡çš„å¸³æˆ¶
                    if (accountsInGroup.length > 0) {
                        fromAccounts.push({
                            holder_name: holderData.holder_name,
                            accounts: accountsInGroup
                        });
                    }
                }
            });
        }
        
        // è½‰å…¥å¸³æˆ¶ï¼šé¡¯ç¤ºæ‰€æœ‰å¸³æˆ¶ï¼ˆç”¨æ–¼å‹•æ…‹éæ¿¾ï¼‰
        const allAccounts = [];
        if (accountsByHolder && Object.keys(accountsByHolder).length > 0) {
            Object.keys(accountsByHolder).forEach(holderId => {
                const holderData = accountsByHolder[holderId];
                if (holderData && holderData.accounts && holderData.accounts.length > 0) {
                    allAccounts.push({
                        holder_name: holderData.holder_name,
                        accounts: holderData.accounts
                    });
                }
            });
        }
        
        populateGroupedSelect('fromAccount', fromAccounts);
        populateGroupedSelect('toAccount', allAccounts);
        
        // æ·»åŠ è½‰å‡ºå¸³æˆ¶è®Šæ›´äº‹ä»¶ç›£è½å™¨ï¼Œå‹•æ…‹éæ¿¾è½‰å…¥å¸³æˆ¶é¸é …
        const fromAccountSelect = document.getElementById('fromAccount');
        if (fromAccountSelect) {
            fromAccountSelect.addEventListener('change', function() {
                const selectedAccountId = this.value;
                if (selectedAccountId) {
                    // æ‰¾åˆ°é¸ä¸­çš„è½‰å‡ºå¸³æˆ¶
                    let selectedAccount = null;
                    for (const holderGroup of allAccounts) {
                        for (const account of holderGroup.accounts) {
                            if (account.id == selectedAccountId) {
                                selectedAccount = account;
                                break;
                            }
                        }
                        if (selectedAccount) break;
                    }
                    
                    if (selectedAccount) {
                        // éæ¿¾å‡ºç›¸åŒå¹£ç¨®çš„å¸³æˆ¶ï¼ˆæ’é™¤è‡ªå·±ï¼‰
                        const filteredAccounts = allAccounts.map(holderGroup => ({
                            holder_name: holderGroup.holder_name,
                            accounts: holderGroup.accounts.filter(acc => 
                                acc.currency === selectedAccount.currency && acc.id != selectedAccount.id
                            )
                        })).filter(holderGroup => holderGroup.accounts.length > 0);
                        
                        // é‡æ–°å¡«å……è½‰å…¥å¸³æˆ¶é¸å–®
                        populateGroupedSelect('toAccount', filteredAccounts);
                    }
                } else {
                    // å¦‚æœæ²’æœ‰é¸æ“‡è½‰å‡ºå¸³æˆ¶ï¼Œé¡¯ç¤ºæ‰€æœ‰å¸³æˆ¶
                    populateGroupedSelect('toAccount', allAccounts);
                }
            });
        }
        
        console.log('âœ… æ¨¡æ…‹æ¡†ä¸‹æ‹‰é¸å–®å¡«å……å®Œæˆ');
    }

    // åˆªé™¤æŒæœ‰äºº
    function deleteHolder(holderId, holderName) {
        console.log('ğŸ—‘ï¸ åˆªé™¤æŒæœ‰äºº:', holderId, holderName);
        
        // ä½¿ç”¨ SweetAlert2 é€²è¡ŒäºŒæ¬¡ç¢ºèª
        Swal.fire({
            title: 'ç¢ºèªåˆªé™¤æŒæœ‰äºº',
            html: `
                <div class="text-start">
                    <p><strong>æŒæœ‰äººåç¨±ï¼š</strong>${holderName}</p>
                    <p><strong>æ“ä½œé¡å‹ï¼š</strong>æ°¸ä¹…åˆªé™¤</p>
                    <div class="alert alert-warning mt-3">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>è­¦å‘Šï¼š</strong>æ­¤æ“ä½œå°‡åŒæ™‚åˆªé™¤è©²æŒæœ‰äººä¸‹çš„æ‰€æœ‰å¸³æˆ¶ï¼
                    </div>
                </div>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'ç¢ºèªåˆªé™¤',
            cancelButtonText: 'å–æ¶ˆ',
            reverseButtons: true,
            focusCancel: true
        }).then((result) => {
            if (result.isConfirmed) {
                // ç¬¬äºŒæ¬¡ç¢ºèª
                Swal.fire({
                    title: 'æœ€çµ‚ç¢ºèª',
                    html: `
                        <div class="text-start">
                            <p>æ‚¨ç¢ºå®šè¦åˆªé™¤æŒæœ‰äººã€Œ<strong>${holderName}</strong>ã€å—ï¼Ÿ</p>
                            <div class="alert alert-danger mt-3">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>æ­¤æ“ä½œå°‡ï¼š</strong>
                                <ul class="mt-2 mb-0">
                                    <li>æ°¸ä¹…åˆªé™¤è©²æŒæœ‰äºº</li>
                                    <li>åŒæ™‚åˆªé™¤å…¶ä¸‹æ‰€æœ‰å¸³æˆ¶</li>
                                    <li>ç„¡æ³•æ¢å¾©</li>
                                    <li>å¯èƒ½å½±éŸ¿ç›¸é—œè¨˜éŒ„</li>
                                </ul>
                            </div>
                        </div>
                    `,
                    icon: 'error',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'æ˜¯çš„ï¼Œåˆªé™¤å®ƒï¼',
                    cancelButtonText: 'å–æ¶ˆ',
                    reverseButtons: true
                }).then((finalResult) => {
                    if (finalResult.isConfirmed) {
                        // åŸ·è¡Œåˆªé™¤æ“ä½œ
                        executeDeleteHolder(holderId, holderName);
                    }
                });
            }
        });
    }
    
    // åŸ·è¡Œåˆªé™¤æŒæœ‰äººæ“ä½œ
    function executeDeleteHolder(holderId, holderName) {
        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        Swal.fire({
            title: 'æ­£åœ¨åˆªé™¤...',
            text: `æ­£åœ¨åˆªé™¤æŒæœ‰äººã€Œ${holderName}ã€åŠå…¶æ‰€æœ‰å¸³æˆ¶`,
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        // ç™¼é€åˆªé™¤è«‹æ±‚
        fetch('/api/delete-holder', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                holder_id: holderId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: 'åˆªé™¤æˆåŠŸï¼',
                    text: `æŒæœ‰äººã€Œ${holderName}ã€åŠå…¶æ‰€æœ‰å¸³æˆ¶å·²æˆåŠŸåˆªé™¤`,
                    timer: 2000,
                    showConfirmButton: false
                });
                // åˆ·æ–°é é¢æ•¸æ“š
                manualRefreshData();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'åˆªé™¤å¤±æ•—',
                    text: data.message,
                    confirmButtonText: 'ç¢ºå®š'
                });
            }
        })
        .catch(error => {
            console.error('âŒ åˆªé™¤æŒæœ‰äººæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            Swal.fire({
                icon: 'error',
                title: 'åˆªé™¤å¤±æ•—',
                text: 'è«‹æª¢æŸ¥ç¶²è·¯é€£æ¥æˆ–è¯ç¹«ç®¡ç†å“¡',
                confirmButtonText: 'ç¢ºå®š'
            });
        });
    }
    
    // å…¨å±€å‡½æ•¸ï¼šæ‰“é–‹éŠ·å¸³æ¨¡æ…‹æ¡†
    window.openSettlementModal = function(customerId, customerName, totalReceivable) {
        console.log('æ‰“é–‹éŠ·å¸³æ¨¡æ…‹æ¡†:', { customerId, customerName, totalReceivable });
        
        // è¨­ç½®æ¨¡æ…‹æ¡†æ•¸æ“š
        document.getElementById('settlementCustomerName').value = customerName;
        document.getElementById('settlementTotalReceivable').value = `NT$ ${totalReceivable.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
        // æ¸…ç©ºè¼¸å…¥æ¡†ï¼Œé¿å…é è¨­å¡«å…¥é‡‘é¡
        const amountInput = document.getElementById('settlementAmount');
        if (amountInput) amountInput.value = '';
        // é¡¯ç¤ºå€é è¨­ç‚º 0.00ï¼ˆè—è‰²æ¨£å¼åœ¨æ¨¡æ¿ä¸­ï¼‰
        const amountDisplay = document.getElementById('settlementAmountDisplay');
        if (amountDisplay) amountDisplay.value = `NT$ 0.00`;
        document.getElementById('settlementRemainingReceivable').value = `NT$ 0.00`;
        document.getElementById('settlementNote').value = '';
        
        // æ·»åŠ éŠ·å¸³é‡‘é¡è®Šæ›´äº‹ä»¶ç›£è½å™¨ï¼Œå³æ™‚è¨ˆç®—å‰©é¤˜æ‡‰æ”¶
        const settlementAmountInput = document.getElementById('settlementAmount');
        if (settlementAmountInput) {
            // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨ï¼ˆé¿å…é‡è¤‡ç¶å®šï¼‰
            if (settlementAmountInput._inputHandler) {
                settlementAmountInput.removeEventListener('input', settlementAmountInput._inputHandler);
            }
            
            // å‰µå»ºæ–°çš„äº‹ä»¶è™•ç†å‡½æ•¸
            settlementAmountInput._inputHandler = function() {
                const amount = parseFloat(this.getActualValue ? this.getActualValue() : this.value) || 0;
                const remaining = Math.max(0, totalReceivable - amount);
                
                // æ›´æ–°é¡¯ç¤ºæ¬„ä½
                document.getElementById('settlementAmountDisplay').value = `NT$ ${amount.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
                document.getElementById('settlementRemainingReceivable').value = `NT$ ${remaining.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
                
                console.log('éŠ·å¸³é‡‘é¡è®Šæ›´:', { amount, remaining, totalReceivable });
            };
            
            // ç¶å®šäº‹ä»¶ç›£è½å™¨
            settlementAmountInput.addEventListener('input', settlementAmountInput._inputHandler);
            console.log('âœ… éŠ·å¸³é‡‘é¡è®Šæ›´äº‹ä»¶ç›£è½å™¨ç¶å®šå®Œæˆ');
            
            // è§¸ç™¼ä¸€æ¬¡åˆå§‹è¨ˆç®—
            settlementAmountInput._inputHandler();
            
            // æ·»åŠ æ•¸å­—æ ¼å¼åŒ–åŠŸèƒ½
            setupNumberInputFormatting(settlementAmountInput, { maxDecimals: 2 });
        }
        
        console.log('æ¨¡æ…‹æ¡†æ•¸æ“šè¨­ç½®å®Œæˆ:', {
            customerName: customerName,
            totalReceivable: totalReceivable,
            settlementAmount: totalReceivable
        });
        
        // æ·»åŠ éš±è—çš„å®¢æˆ¶IDå’Œå¸³æˆ¶IDæ¬„ä½
        let customerIdInput = document.getElementById('settlementForm').querySelector('input[name="customer_id"]');
        if (!customerIdInput) {
            customerIdInput = document.createElement('input');
            customerIdInput.type = 'hidden';
            customerIdInput.name = 'customer_id';
            document.getElementById('settlementForm').appendChild(customerIdInput);
        }
        customerIdInput.value = customerId;
        console.log('å®¢æˆ¶IDè¨­ç½®å®Œæˆ:', customerId);
        
        // ç§»é™¤èˆŠçš„éš±è—å¸³æˆ¶IDæ¬„ä½ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        let oldAccountIdInput = document.getElementById('settlementForm').querySelector('input[name="account_id"]');
        if (oldAccountIdInput) {
            oldAccountIdInput.remove();
        }
        
        // æ·»åŠ æ–°çš„éš±è—å¸³æˆ¶IDæ¬„ä½
        let accountIdInput = document.createElement('input');
        accountIdInput.type = 'hidden';
        accountIdInput.name = 'account_id';
        accountIdInput.id = 'hiddenAccountId';
        document.getElementById('settlementForm').appendChild(accountIdInput);
        
        console.log('éš±è—å¸³æˆ¶IDæ¬„ä½å‰µå»ºå®Œæˆ');
        
        // å¡«å……æ”¶æ¬¾å¸³æˆ¶ä¸‹æ‹‰é¸å–® - åªé¡¯ç¤ºå•Ÿç”¨çš„TWDå¸³æˆ¶
        const twdAccounts = [];
        if (accountsByHolder && Object.keys(accountsByHolder).length > 0) {
            Object.keys(accountsByHolder).forEach(holderId => {
                const holderData = accountsByHolder[holderId];
                if (holderData && holderData.accounts && holderData.accounts.length > 0) {
                    const twdAccountsInGroup = holderData.accounts.filter(acc => acc.currency === 'TWD' && acc.is_active);
                    if (twdAccountsInGroup.length > 0) {
                        twdAccounts.push({
                            holder_name: holderData.holder_name,
                            accounts: twdAccountsInGroup
                        });
                    }
                }
            });
        }
        
        console.log('æ‰¾åˆ°çš„TWDå¸³æˆ¶:', twdAccounts);
        
        // å¡«å……æ”¶æ¬¾å¸³æˆ¶ä¸‹æ‹‰é¸å–®
        populateGroupedSelect('settlementAccount', twdAccounts);
        
                // ç«‹å³è¨­ç½®é è¨­å€¼ï¼ˆåŒæ­¥æ–¹å¼ï¼‰
        const settlementAccountSelect = document.getElementById('settlementAccount');
        console.log('æ”¶æ¬¾å¸³æˆ¶ä¸‹æ‹‰é¸å–®å…ƒç´ :', settlementAccountSelect);
        
        if (settlementAccountSelect && twdAccounts.length > 0 && twdAccounts[0].accounts.length > 0) {
            const defaultAccount = twdAccounts[0].accounts[0];
            console.log('é¸æ“‡é è¨­å¸³æˆ¶:', defaultAccount);
            
            // è¨­ç½®ä¸‹æ‹‰é¸å–®çš„å€¼
            settlementAccountSelect.value = defaultAccount.id;
            console.log('ä¸‹æ‹‰é¸å–®å€¼è¨­ç½®ç‚º:', settlementAccountSelect.value);
            
            // ç«‹å³è¨­ç½®éš±è—æ¬„ä½çš„å€¼
            const hiddenAccountIdElement = document.getElementById('hiddenAccountId');
            if (hiddenAccountIdElement) {
                hiddenAccountIdElement.value = defaultAccount.id;
                console.log('éš±è—å¸³æˆ¶IDæ¬„ä½å€¼è¨­ç½®ç‚º:', hiddenAccountIdElement.value);
            } else {
                console.error('âŒ æ‰¾ä¸åˆ°éš±è—å¸³æˆ¶IDæ¬„ä½');
            }
            
            console.log('è‡ªå‹•é¸æ“‡é è¨­æ”¶æ¬¾å¸³æˆ¶:', defaultAccount.name, 'ID:', defaultAccount.id);
        } else {
            console.warn('âš ï¸ æ²’æœ‰æ‰¾åˆ°å¯ç”¨çš„TWDå¸³æˆ¶æˆ–ä¸‹æ‹‰é¸å–®å…ƒç´ ');
        }
        
        // ç­‰å¾…DOMæ›´æ–°å®Œæˆå¾Œå†æ¬¡æª¢æŸ¥å’Œè¨­ç½®
        setTimeout(() => {
            // å†æ¬¡ç²å–æ”¶æ¬¾å¸³æˆ¶ä¸‹æ‹‰é¸å–®å…ƒç´ 
            const settlementAccountSelect = document.getElementById('settlementAccount');
            console.log('å»¶é²æª¢æŸ¥ - æ”¶æ¬¾å¸³æˆ¶ä¸‹æ‹‰é¸å–®å…ƒç´ :', settlementAccountSelect);
            
            if (settlementAccountSelect) {
                console.log('âœ… å»¶é²æª¢æŸ¥ - æ‰¾åˆ°æ”¶æ¬¾å¸³æˆ¶ä¸‹æ‹‰é¸å–®å…ƒç´ ');
                
                // ç›£è½æ”¶æ¬¾å¸³æˆ¶ä¸‹æ‹‰é¸å–®çš„è®ŠåŒ–ï¼Œè‡ªå‹•æ›´æ–°éš±è—çš„å¸³æˆ¶ID
                // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨ï¼ˆé¿å…é‡è¤‡ç¶å®šï¼‰
                if (settlementAccountSelect._changeHandler) {
                    settlementAccountSelect.removeEventListener('change', settlementAccountSelect._changeHandler);
                }
                
                // å‰µå»ºæ–°çš„äº‹ä»¶è™•ç†å‡½æ•¸
                settlementAccountSelect._changeHandler = function() {
                    const selectedValue = this.value;
                    const hiddenElement = document.getElementById('hiddenAccountId');
                    if (hiddenElement) {
                        hiddenElement.value = selectedValue;
                        console.log('æ”¶æ¬¾å¸³æˆ¶é¸æ“‡è®Šæ›´ï¼Œéš±è—æ¬„ä½æ›´æ–°ç‚º:', selectedValue);
                    } else {
                        console.error('âŒ æ‰¾ä¸åˆ°éš±è—å¸³æˆ¶IDæ¬„ä½ï¼Œç„¡æ³•æ›´æ–°å€¼');
                    }
                };
                
                // ç¶å®šäº‹ä»¶ç›£è½å™¨
                settlementAccountSelect.addEventListener('change', settlementAccountSelect._changeHandler);
                console.log('âœ… æ”¶æ¬¾å¸³æˆ¶è®Šæ›´äº‹ä»¶ç›£è½å™¨ç¶å®šå®Œæˆ');
                
                // æœ€çµ‚æª¢æŸ¥éš±è—æ¬„ä½çš„å€¼
                setTimeout(() => {
                    const finalCheck = document.getElementById('hiddenAccountId');
                    if (finalCheck) {
                        console.log('ğŸ” æœ€çµ‚æª¢æŸ¥ - éš±è—å¸³æˆ¶IDæ¬„ä½å€¼:', finalCheck.value);
                        
                        // å¦‚æœå€¼ä»ç„¶ç‚ºç©ºï¼Œå¼·åˆ¶è¨­ç½®
                        if (!finalCheck.value && settlementAccountSelect.value) {
                            finalCheck.value = settlementAccountSelect.value;
                            console.log('ğŸ”„ å¼·åˆ¶è¨­ç½®éš±è—å¸³æˆ¶IDæ¬„ä½å€¼:', finalCheck.value);
                        }
                    } else {
                        console.error('âŒ æœ€çµ‚æª¢æŸ¥ - æ‰¾ä¸åˆ°éš±è—å¸³æˆ¶IDæ¬„ä½');
                    }
                }, 100);
                
            } else {
                console.error('âŒ å»¶é²æª¢æŸ¥ - æ‰¾ä¸åˆ°æ”¶æ¬¾å¸³æˆ¶ä¸‹æ‹‰é¸å–®å…ƒç´ ');
            }
        }, 100); // ç­‰å¾…DOMæ›´æ–°å®Œæˆ
        
        // é¡¯ç¤ºæ¨¡æ…‹æ¡†
        const modalElement = document.getElementById('settlementModal');
        let modalInstance = bootstrap.Modal.getInstance(modalElement);
        if (!modalInstance) {
            modalInstance = new bootstrap.Modal(modalElement);
        }
        
        // åœ¨æ¨¡æ…‹æ¡†é¡¯ç¤ºå¾Œæª¢æŸ¥éš±è—æ¬„ä½çš„å€¼
        modalElement.addEventListener('shown.bs.modal', function() {
            console.log('ğŸ­ æ¨¡æ…‹æ¡†å·²é¡¯ç¤ºï¼Œæª¢æŸ¥éš±è—æ¬„ä½å€¼...');
            
            const customerIdCheck = document.querySelector('input[name="customer_id"]');
            const accountIdCheck = document.getElementById('hiddenAccountId');
            
            console.log('å®¢æˆ¶IDæ¬„ä½:', customerIdCheck ? customerIdCheck.value : 'æœªæ‰¾åˆ°');
            console.log('å¸³æˆ¶IDæ¬„ä½:', accountIdCheck ? accountIdCheck.value : 'æœªæ‰¾åˆ°');
            
            // å¼·åˆ¶é‡æ–°è¨­ç½®éš±è—æ¬„ä½çš„å€¼
            if (accountIdCheck) {
                // å„ªå…ˆå¾ä¸‹æ‹‰é¸å–®ç²å–å€¼
                const settlementAccountSelect = document.getElementById('settlementAccount');
                if (settlementAccountSelect && settlementAccountSelect.value) {
                    accountIdCheck.value = settlementAccountSelect.value;
                    console.log('ğŸ”„ å¾ä¸‹æ‹‰é¸å–®å¼·åˆ¶è¨­ç½®éš±è—å¸³æˆ¶IDæ¬„ä½å€¼:', accountIdCheck.value);
                } else if (twdAccounts.length > 0 && twdAccounts[0].accounts.length > 0) {
                    // å¦‚æœä¸‹æ‹‰é¸å–®æ²’æœ‰å€¼ï¼Œä½¿ç”¨é è¨­å¸³æˆ¶
                    const defaultAccount = twdAccounts[0].accounts[0];
                    accountIdCheck.value = defaultAccount.id;
                    console.log('ğŸ”„ ä½¿ç”¨é è¨­å¸³æˆ¶å¼·åˆ¶è¨­ç½®éš±è—å¸³æˆ¶IDæ¬„ä½å€¼:', accountIdCheck.value);
                }
                
                // æœ€çµ‚ç¢ºèªéš±è—æ¬„ä½çš„å€¼
                console.log('ğŸ¯ æœ€çµ‚ç¢ºèª - éš±è—å¸³æˆ¶IDæ¬„ä½å€¼:', accountIdCheck.value);
                
                // å¦‚æœå€¼ä»ç„¶ç‚ºç©ºï¼Œé¡¯ç¤ºè­¦å‘Š
                if (!accountIdCheck.value) {
                    console.warn('âš ï¸ è­¦å‘Šï¼šéš±è—å¸³æˆ¶IDæ¬„ä½å€¼ä»ç„¶ç‚ºç©ºï¼');
                }
            } else {
                console.error('âŒ æ‰¾ä¸åˆ°éš±è—å¸³æˆ¶IDæ¬„ä½å…ƒç´ ');
            }
        });
        
        modalInstance.show();
    };
    
    // è¨­ç½®å®¢æˆ¶äº¤æ˜“ç´€éŒ„ç›¸é—œåŠŸèƒ½
    function setupCustomerTransactionsListeners() {
        console.log('ğŸ”§ è¨­ç½®å®¢æˆ¶äº¤æ˜“ç´€éŒ„é»æ“Šäº‹ä»¶ç›£è½å™¨...');
        
        // ä½¿ç”¨äº‹ä»¶å§”è¨—ï¼Œç›£è½æ•´å€‹æ‡‰æ”¶å¸³æ¬¾è¡¨æ ¼çš„é»æ“Šäº‹ä»¶
        document.addEventListener('click', function(event) {
            console.log('ğŸ–±ï¸ é»æ“Šäº‹ä»¶:', event.target);
            
            if (event.target.closest('.customer-transactions')) {
                const customerLink = event.target.closest('.customer-transactions');
                const customerId = customerLink.dataset.customerId;
                const customerName = customerLink.dataset.customerName;
                
                console.log('ğŸ‘¤ é»æ“Šå®¢æˆ¶:', { customerId, customerName });
                
                if (customerId && customerName) {
                    openCustomerTransactionsModal(customerId, customerName);
                } else {
                    console.error('âŒ å®¢æˆ¶IDæˆ–åç¨±ç¼ºå¤±:', { customerId, customerName });
                }
            }
        });
        
        console.log('âœ… å®¢æˆ¶äº¤æ˜“ç´€éŒ„é»æ“Šäº‹ä»¶ç›£è½å™¨è¨­ç½®å®Œæˆ');
    }
    
    function openCustomerTransactionsModal(customerId, customerName) {
        // æ›´æ–°æ¨¡æ…‹æ¡†æ¨™é¡Œ
        document.getElementById('customerTransactionsTitle').textContent = `${customerName} çš„äº¤æ˜“ç´€éŒ„`;
        document.getElementById('customerTransactionsName').textContent = customerName;
        
        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        document.getElementById('customerTransactionsTable').innerHTML = '<tr><td colspan="7" class="text-center p-3"><div class="spinner-border spinner-border-sm me-2"></div>è¼‰å…¥ä¸­...</td></tr>';
        document.getElementById('customerTransactionsEmpty').style.display = 'none';
        
        // é¡¯ç¤ºæ¨¡æ…‹æ¡†
        const modal = new bootstrap.Modal(document.getElementById('customerTransactionsModal'));
        modal.show();
        
        // ç²å–å®¢æˆ¶äº¤æ˜“ç´€éŒ„
        fetchCustomerTransactions(customerId);
    }
    
    function fetchCustomerTransactions(customerId) {
        fetch(`/api/customer/transactions/${customerId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    displayCustomerTransactions(data);
                } else {
                    console.error('âŒ ç²å–å®¢æˆ¶äº¤æ˜“ç´€éŒ„å¤±æ•—:', data.message);
                    document.getElementById('customerTransactionsTable').innerHTML = '<tr><td colspan="7" class="text-center p-3 text-danger">è¼‰å…¥å¤±æ•—: ' + data.message + '</td></tr>';
                }
            })
            .catch(error => {
                console.error('âŒ ç¶²è·¯éŒ¯èª¤:', error);
                document.getElementById('customerTransactionsTable').innerHTML = '<tr><td colspan="7" class="text-center p-3 text-danger">ç¶²è·¯éŒ¯èª¤ï¼Œè«‹é‡è©¦</td></tr>';
            });
    }
    
    function displayCustomerTransactions(data) {
        const tableBody = document.getElementById('customerTransactionsTable');
        const emptyMessage = document.getElementById('customerTransactionsEmpty');
        
        if (!data.transactions || data.transactions.length === 0) {
            tableBody.innerHTML = '';
            emptyMessage.style.display = 'block';
            return;
        }
        
        emptyMessage.style.display = 'none';

        // å–å¾—æ‡‰æ”¶å¸³æ¬¾ï¼ˆå¤šéµç›¸å®¹ï¼‰
        const receivableNode = document.getElementById('customerTransactionsReceivable');
        if (receivableNode) {
            function pick() {
                for (var i = 0; i < arguments.length; i++) {
                    var v = arguments[i];
                    if (v !== undefined && v !== null) return v;
                }
                return undefined;
            }
            // å…ˆå˜—è©¦å¾é€™æ¬¡å›æ‡‰æ‰¾ï¼Œæ‰¾ä¸åˆ°å°±å¾é é¢åˆå§‹æä¾›çš„ customers é›†åˆæ¯”å°
            let receivable = pick(
                data.current_receivable,
                data.receivable_twd,
                data.receivable,
                data.customer_receivable,
                data.customer && (data.customer.receivable_twd || data.customer.receivable),
                data.summary && (data.summary.receivable_twd || data.summary.receivable)
            );

            if (receivable === undefined) {
                try {
                    var customers = customersList || [];
                    // åœ¨è¡¨æ ¼ä¸Šæ–¹æˆ‘å€‘å·²ç¶“æŠŠå®¢æˆ¶åç¨±å¯«é€² #customerTransactionsName
                    var nameNode = document.getElementById('customerTransactionsName');
                    var customerName = nameNode ? nameNode.textContent.trim() : '';
                    var matched = customers.find(function(c){ return (c.name || c.customer_name) === customerName; });
                    if (matched) {
                        receivable = pick(matched.total_receivables_twd, matched.receivable_twd, matched.receivable);
                    }
                } catch(e) { /* å¿½ç•¥è§£æéŒ¯èª¤ */ }
            }
            if (receivable === undefined) receivable = 0;
            receivableNode.textContent = 'NT$ ' + Number(receivable).toLocaleString('en-US', {minimumFractionDigits: 2});
        }
        
        let tableHtml = '';
        data.transactions.forEach(tx => {
            const date = tx.date ? new Date(tx.date).toLocaleString('zh-TW') : '-';
            const type = tx.type || 'N/A';
            const desc = tx.description || '-';
            const rmbDelta = (tx.rmb_amount !== undefined ? tx.rmb_amount : (tx.rmbChange !== undefined ? tx.rmbChange : tx.rmb_change));
            const twdDelta = (tx.amount !== undefined ? tx.amount : (tx.twd_amount !== undefined ? tx.twd_amount : (tx.twdChange !== undefined ? tx.twdChange : tx.twd_change)));
            const rmbStr = (rmbDelta === undefined || rmbDelta === null) ? '-' : `Â¥ ${parseFloat(rmbDelta).toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            const twdStr = (twdDelta === undefined || twdDelta === null) ? '-' : `NT$ ${parseFloat(twdDelta).toLocaleString('en-US', {minimumFractionDigits: 2})}`;

            // ä¾ç…§è¡¨é ­é †åºï¼šæ—¥æœŸæ™‚é–“ã€é¡å‹ã€æè¿°ã€RMBã€TWDï¼ˆä¸åŒ…å«åˆ©æ½¤èˆ‡æ“ä½œäººå“¡ï¼‰
            tableHtml += `
                <tr>
                    <td><small>${date}</small></td>
                    <td><span class="badge bg-primary">${type}</span></td>
                    <td><small>${desc}</small></td>
                    <td class="text-end"><small>${rmbStr}</small></td>
                    <td class="text-end"><small>${twdStr}</small></td>
                </tr>
            `;
        });
        
        tableBody.innerHTML = tableHtml;
    }
    
    // åˆ†é ç›¸é—œè®Šæ•¸
    let currentPage = 1;
    let currentPagination = null;

    // è¼‰å…¥åˆ†é æµæ°´è¨˜éŒ„
    function loadMovements(page = 1) {
        console.log('ğŸ” é–‹å§‹è¼‰å…¥ç¬¬', page, 'é æµæ°´è¨˜éŒ„...');
        
        if (!movementsTbody) {
            console.error('âŒ æ‰¾ä¸åˆ° movements-tbody å…ƒç´ ');
            return;
        }
        
        // é¡¯ç¤ºè¼‰å…¥ä¸­
        movementsTbody.innerHTML = '<tr><td colspan="11" class="text-center p-3"><i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</td></tr>';
        
        // ç™¼é€APIè«‹æ±‚
        fetch(`/api/cash_management/transactions?page=${page}`)
            .then(response => response.json())
            .then(result => {
                if (result.status === 'success') {
                    currentPage = page;
                    currentPagination = result.data.pagination;
                    renderMovements(result.data.transactions);
                    renderPagination(result.data.pagination);
                } else {
                    console.error('âŒ è¼‰å…¥æµæ°´è¨˜éŒ„å¤±æ•—:', result.message);
                    movementsTbody.innerHTML = '<tr><td colspan="11" class="text-center p-3 text-danger">è¼‰å…¥å¤±æ•—: ' + result.message + '</td></tr>';
                }
            })
            .catch(error => {
                console.error('âŒ ç¶²è·¯éŒ¯èª¤:', error);
                movementsTbody.innerHTML = '<tr><td colspan="11" class="text-center p-3 text-danger">ç¶²è·¯éŒ¯èª¤ï¼Œè«‹é‡è©¦</td></tr>';
            });
    }

    // æ¸²æŸ“è³‡é‡‘æµæ°´ï¼ˆæœ¬åœ°ä½œç”¨åŸŸç‰ˆæœ¬ï¼‰
    function renderMovements(transactions) {
        console.log('ğŸ” é–‹å§‹æ¸²æŸ“è³‡é‡‘æµæ°´...');
        
        if (!movementsTbody) {
            console.error('âŒ æ‰¾ä¸åˆ° movements-tbody å…ƒç´ ');
            return;
        }
        
        movementsTbody.innerHTML = '';
        
        if (!transactions || transactions.length === 0) {
            console.log('âš ï¸ æ²’æœ‰è³‡é‡‘æµæ°´æ•¸æ“š');
            movementsTbody.innerHTML = '<tr><td colspan="11" class="text-center p-5 text-muted">å°šç„¡è³‡é‡‘æµæ°´ç´€éŒ„ã€‚</td></tr>';
            return;
        }
        
        console.log('âœ… æ‰¾åˆ° ' + transactions.length + ' ç­†è³‡é‡‘æµæ°´ï¼Œé–‹å§‹æ¸²æŸ“...');
        
        transactions.forEach(function(m, index) {
            const twdChange = parseFloat(m.twd_change ?? m.twdChange) || 0;
            const rmbChange = parseFloat(m.rmb_change ?? m.rmbChange) || 0;
            let profit = parseFloat(m.profit ?? 0) || 0;
            
            // è™•ç†åˆ©æ½¤é¡¯ç¤ºæ ¼å¼
            let profitDisplay = '';
            if (m.type === 'PROFIT_WITHDRAW' || (m.description && m.description.includes('åˆ©æ½¤æ‰£é™¤'))) {
                // å¾descriptionä¸­è§£æåŸåˆ©æ½¤å’Œæ–°åˆ©æ½¤ä¿¡æ¯
                const description = m.description || '';
                const originalMatch = description.match(/åŸåˆ©æ½¤: ([\d,]+\.?\d*)/);
                const newMatch = description.match(/æ–°åˆ©æ½¤: ([\d,]+\.?\d*)/);
                
                if (originalMatch && newMatch) {
                    const originalProfit = parseFloat(originalMatch[1].replace(/,/g, ''));
                    const newProfit = parseFloat(newMatch[1].replace(/,/g, ''));
                    const deductedAmount = Math.abs(twdChange);
                    profitDisplay = `${originalProfit.toLocaleString()} - ${deductedAmount.toLocaleString()} = ${newProfit.toLocaleString()}`;
                } else {
                    // å¦‚æœè§£æå¤±æ•—ï¼Œé¡¯ç¤ºç°¡å–®æ ¼å¼
                    const deductedAmount = Math.abs(twdChange);
                    profitDisplay = `-${deductedAmount.toLocaleString()}`;
                }
                profit = -Math.abs(twdChange);  // ä¿æŒåŸæœ‰çš„profitå€¼ç”¨æ–¼é¡è‰²åˆ¤æ–·
            } else if (m.type === 'SALES' || (m.description && m.description.includes('å”®å‡º'))) {
                // å”®å‡ºï¼šé¡¯ç¤º "åŸåˆ©æ½¤ + å”®å‡ºåˆ©æ½¤ = æ–°åˆ©æ½¤"
                const saleProfit = Math.abs(profit);
                profitDisplay = `+${saleProfit.toLocaleString()}`;  // æš«æ™‚é¡¯ç¤ºç°¡å–®æ ¼å¼
            } else {
                // å…¶ä»–æƒ…æ³ï¼šé¡¯ç¤ºç°¡å–®çš„æ•¸å­—
                profitDisplay = profit !== 0 ? profit.toLocaleString('en-US', {minimumFractionDigits: 2}) : '-';
            }
            
            // å°‡é¡å‹è½‰æ›ç‚ºä¸­æ–‡é¡¯ç¤º
            let typeDisplay = m.type;
            let typeClass = 'badge bg-info-subtle text-info-emphasis';
            
            switch(m.type) {
                case 'PURCHASE':
                case 'è²·å…¥':
                    typeDisplay = 'è²·å…¥';
                    typeClass = 'badge bg-primary-subtle text-primary-emphasis';
                    break;
                case 'SALES':
                case 'å”®å‡º':
                    typeDisplay = 'å”®å‡º';
                    typeClass = 'badge bg-danger-subtle text-danger-emphasis';
                    break;
                case 'TRANSFER':
                case 'è½‰å¸³':
                    typeDisplay = 'è½‰å¸³';
                    typeClass = 'badge bg-warning-subtle text-warning-emphasis';
                    break;
                case 'SETTLEMENT':
                case 'éŠ·å¸³':
                    typeDisplay = 'éŠ·å¸³';
                    typeClass = 'badge bg-primary-subtle text-primary-emphasis';
                    break;
                case 'DEPOSIT':
                case 'å­˜æ¬¾':
                    typeDisplay = 'å­˜æ¬¾';
                    typeClass = 'badge bg-secondary-subtle text-secondary-emphasis';
                    break;
                case 'WITHDRAWAL':
                case 'ææ¬¾':
                    typeDisplay = 'ææ¬¾';
                    typeClass = 'badge bg-danger-subtle text-danger-emphasis';
                    break;
                case 'CARD_PURCHASE':
                    typeDisplay = 'åˆ·å¡';
                    typeClass = 'badge bg-warning-subtle text-warning-emphasis';
                    break;
                case 'CUSTOMER_PAYMENT':
                    typeDisplay = 'å®¢æˆ¶ä»˜æ¬¾';
                    typeClass = 'badge bg-success-subtle text-success-emphasis';
                    break;
                case 'PROFIT_WITHDRAW':
                    typeDisplay = 'åˆ©æ½¤æ‰£é™¤';
                    typeClass = 'badge bg-warning-subtle text-warning-emphasis';
                    break;
                default:
                    typeDisplay = m.type;
                    typeClass = 'badge bg-info-subtle text-info-emphasis';
            }
            
            // TWD/RMB è®Šå‹•åˆä½µé¡¯ç¤ºï¼ˆæŒ‰ç…§æˆªåœ–2æ ¼å¼ï¼‰
            let twdRmbChangeHtml = '-';
            if (twdChange !== 0 || rmbChange !== 0) {
                // è¨ˆç®—ç¸½é¡ï¼ˆä½¿ç”¨ç´¯ç©é¤˜é¡ï¼‰
                const runningTwd = m.running_twd_balance ?? m.runningTwdBalance ?? 0;
                const runningRmb = m.running_rmb_balance ?? m.runningRmbBalance ?? 0;
                
                twdRmbChangeHtml = '<div class="card" style="background-color: #e3f2fd; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 8px; margin: 2px;">';
                
                if (twdChange !== 0) {
                    const twdColorClass = twdChange > 0 ? 'text-success' : 'text-danger';
                    const twdSymbol = twdChange > 0 ? '+' : '';
                    twdRmbChangeHtml += '<div class="' + twdColorClass + ' fw-bold" style="font-size: 0.85rem;">TWD: ' + twdSymbol + twdChange.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</div>';
                    twdRmbChangeHtml += '<div class="text-dark" style="font-size: 0.75rem; margin-top: 2px;">ç¸½é¡: ' + runningTwd.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</div>';
                }
                
                if (rmbChange !== 0) {
                    const rmbColorClass = rmbChange > 0 ? 'text-success' : 'text-danger';
                    const rmbSymbol = rmbChange > 0 ? '+' : '';
                    twdRmbChangeHtml += '<div class="' + rmbColorClass + ' fw-bold" style="font-size: 0.85rem; margin-top: 4px;">RMB: ' + rmbSymbol + rmbChange.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</div>';
                    twdRmbChangeHtml += '<div class="text-dark" style="font-size: 0.75rem; margin-top: 2px;">ç¸½é¡: ' + runningRmb.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</div>';
                }
                
                twdRmbChangeHtml += '</div>';
            }
            
            // åˆ©æ½¤è®Šå‹•é¡¯ç¤ºï¼ˆæŒ‰ç…§æˆªåœ–æ ¼å¼ï¼‰
            let profitChangeHtml = '-';
            if (m.profit_change_detail && typeof m.profit_change_detail === 'object') {
                const profitDetail = m.profit_change_detail;
                const before = (profitDetail.before || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
                const after = (profitDetail.after || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
                const change = (profitDetail.change || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
                const changeColor = (profitDetail.change || 0) > 0 ? 'text-success' : 'text-danger';
                const changeSymbol = (profitDetail.change || 0) > 0 ? '+' : '';
                
                profitChangeHtml = '<div class="card" style="background-color: #fff3cd; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 8px; margin: 2px; border: 1px solid #ffeaa7;">' +
                    '<div class="text-dark" style="font-size: 0.8rem;">å‰: ' + before + '</div>' +
                    '<div class="' + changeColor + ' fw-bold" style="font-size: 0.8rem;">è®Šå‹•: ' + changeSymbol + change + '</div>' +
                    '<div class="text-dark" style="font-size: 0.8rem;">å¾Œ: ' + after + '</div>' +
                    '</div>';
            } else if (m.profit_before !== null && m.profit_after !== null && m.profit_change !== null) {
                const before = (m.profit_before || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
                const after = (m.profit_after || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
                const change = (m.profit_change || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
                const changeColor = (m.profit_change || 0) > 0 ? 'text-success' : 'text-danger';
                const changeSymbol = (m.profit_change || 0) > 0 ? '+' : '';
                
                profitChangeHtml = '<div class="card" style="background-color: #fff3cd; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 8px; margin: 2px; border: 1px solid #ffeaa7;">' +
                    '<div class="text-dark" style="font-size: 0.8rem;">å‰: ' + before + '</div>' +
                    '<div class="' + changeColor + ' fw-bold" style="font-size: 0.8rem;">è®Šå‹•: ' + changeSymbol + change + '</div>' +
                    '<div class="text-dark" style="font-size: 0.8rem;">å¾Œ: ' + after + '</div>' +
                    '</div>';
            } else if (profit !== 0) {
                // æœ‰å‚³çµ±åˆ©æ½¤è¨˜éŒ„ï¼Œé¡¯ç¤ºç°¡å–®ä¿¡æ¯
                const profitDisplay = profit.toLocaleString('en-US', {minimumFractionDigits: 2});
                const profitColor = profit > 0 ? 'text-success' : 'text-danger';
                profitChangeHtml = '<div class="text-dark" style="font-size: 0.85rem;">' + profitDisplay + '</div>';
            } else {
                // å¦‚æœ profit_change_detail æ˜¯å­—ç¬¦ä¸²æˆ–å…¶ä»–é¡å‹ï¼Œé¡¯ç¤ºç‚ºæ–‡æœ¬
                if (m.profit_change_detail && typeof m.profit_change_detail === 'string') {
                    profitChangeHtml = '<div class="text-dark" style="font-size: 0.85rem;">' + m.profit_change_detail + '</div>';
                }
            }
            
            // è¨­ç½®åˆ©æ½¤é¡è‰²ï¼ˆç”¨æ–¼å‘å¾Œå…¼å®¹ï¼‰
            const profitClass = profit > 0 ? 'text-success' : (profit < 0 ? 'text-danger' : 'text-muted');
            
            const paymentAccount = m.payment_account ?? m.outgoing_account ?? '-';
            const depositAccount = m.deposit_account ?? m.incoming_account ?? '-';
            
            // å‡ºæ¬¾æˆ¶é¤˜é¡è®ŠåŒ–é¡¯ç¤ºï¼ˆæŒ‰ç…§æˆªåœ–æ ¼å¼ï¼‰
            let paymentAccountBalanceHtml = '-';
            if (m.payment_account_balance) {
                const balance = m.payment_account_balance;
                const before = (balance.before || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
                const change = (balance.change || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
                const after = (balance.after || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
                const changeColor = (balance.change || 0) > 0 ? 'text-success' : (balance.change || 0) < 0 ? 'text-danger' : 'text-muted';
                const changeSymbol = (balance.change || 0) > 0 ? '+' : '';
                
                paymentAccountBalanceHtml = '<div class="card" style="background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 8px; margin: 2px; border: 1px solid #e0e0e0;">' +
                    '<div class="text-primary fw-bold" style="font-size: 0.85rem; text-align: right; border-bottom: 1px solid #007bff; padding-bottom: 4px; margin-bottom: 4px;">' + paymentAccount + '</div>' +
                    '<div class="text-dark" style="font-size: 0.8rem;">å‰: ' + before + '</div>' +
                    '<div class="' + changeColor + ' fw-bold" style="font-size: 0.8rem;">è®Šå‹•: ' + changeSymbol + change + '</div>' +
                    '<div class="text-dark" style="font-size: 0.8rem;">å¾Œ: ' + after + '</div>' +
                    '</div>';
            }
            
            // å…¥æ¬¾æˆ¶é¤˜é¡è®ŠåŒ–é¡¯ç¤ºï¼ˆæŒ‰ç…§æˆªåœ–æ ¼å¼ï¼‰
            let depositAccountBalanceHtml = '-';
            if (m.deposit_account_balance) {
                const balance = m.deposit_account_balance;
                const before = (balance.before || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
                const change = (balance.change || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
                const after = (balance.after || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
                const changeSymbol = (balance.change || 0) > 0 ? '+' : '';
                
                // æ ¹æ“šæœ¬ç­†äº¤æ˜“çš„è®Šå‹•åˆ¤æ–·å…¥æ¬¾æˆ¶å¹£åˆ¥é¡è‰²ï¼šTWD è—ã€RMB ç¶ 
                // åˆ¤æ–·å…¥æ¬¾æˆ¶å¹£åˆ¥ï¼šå„ªå…ˆä¾é‡‘é¡æ­£å‘è®Šå‹•åˆ¤æ–·ï¼Œå…¶æ¬¡ä¾åç¨±é—œéµå­—
                const depositHeaderIsRmb = (rmbChange > 0 && twdChange <= 0) || /RMB|äººæ°‘å¹£|Â¥/.test(depositAccount || '');
                const depositHeaderColorClass = depositHeaderIsRmb ? 'text-success' : 'text-primary';
                const depositHeaderBorder = depositHeaderIsRmb ? '1px solid #28a745' : '1px solid #007bff';
                const depositChangeColorClass = depositHeaderIsRmb ? 'text-success' : 'text-primary';
                depositAccountBalanceHtml = '<div class="card" style="background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 8px; margin: 2px; border: 1px solid #e0e0e0;">' +
                    '<div class="' + depositHeaderColorClass + ' fw-bold" style="font-size: 0.85rem; text-align: right; border-bottom: ' + depositHeaderBorder + '; padding-bottom: 4px; margin-bottom: 4px;">' + depositAccount + '</div>' +
                    '<div class="text-dark" style="font-size: 0.8rem;">å‰: ' + before + '</div>' +
                    '<div class="' + depositChangeColorClass + ' fw-bold" style="font-size: 0.8rem;">è®Šå‹•: ' + changeSymbol + change + '</div>' +
                    '<div class="text-dark" style="font-size: 0.8rem;">å¾Œ: ' + after + '</div>' +
                    '</div>';
            }
            
            // æè¿°å’Œå‚™è¨»ç¾åœ¨éƒ½åœ¨descriptionä¸­ï¼Œç”¨ | åˆ†éš”
            const fullDescription = m.description || '-';
            const parts = fullDescription.split(' | ');
            const description = parts[0] || '-';
            const note = parts.slice(1).join(' | ') || '-';

            const row = '<tr>' +
                '<td class="ps-3"><small>' + (m.date ? new Date(m.date + 'Z').toLocaleString('zh-TW', {timeZone: 'Asia/Taipei'}) : '-') + '</small></td>' +
                '<td><span class="' + typeClass + '">' + typeDisplay + '</span></td>' +
                '<td><small>' + description + '</small></td>' +
                '<td><small>' + (m.operator || '-') + '</small></td>' +
                '<td><small>' + paymentAccount + '</small></td>' +
                '<td><small>' + depositAccount + '</small></td>' +
                '<td><small>' + note + '</small></td>' +
                '<td class="text-end">' + twdRmbChangeHtml + '</td>' +
                '<td class="text-end">' + paymentAccountBalanceHtml + '</td>' +
                '<td class="text-end">' + depositAccountBalanceHtml + '</td>' +
                '<td class="text-end pe-3">' + profitChangeHtml + '</td>' +
                '</tr>';
            
            movementsTbody.innerHTML += row;
        });
        
        console.log('âœ… è³‡é‡‘æµæ°´æ¸²æŸ“å®Œæˆ');
    }
    
    // æ¸²æŸ“åˆ†é æ§åˆ¶é …
    function renderPagination(pagination) {
        const paginationInfo = document.getElementById('pagination-info');
        const paginationControls = document.getElementById('pagination-controls');
        if (!paginationInfo || !paginationControls) return;
        
        // æ­£è¦åŒ–ä¸åŒå›æ‡‰éµåï¼ˆé¿å…éƒ¨åˆ†ç€è¦½å™¨ä¸æ”¯æ´ ??ï¼‰
        const currentPage = pick(pagination.current_page, pagination.page, 1);
        const perPage = pick(pagination.per_page, pagination.perPage, 50);
        const totalRecords = pick(pagination.total_records, pagination.total, 0);
        const totalPages = pick(pagination.total_pages, pagination.pages, Math.ceil(totalRecords / perPage) || 1);
        const hasPrev = (pick(pagination.has_prev, (currentPage > 1)) ? true : false);
        const hasNext = (pick(pagination.has_next, (currentPage < totalPages)) ? true : false);
        const prevNum = pick(pagination.prev_num, (hasPrev ? currentPage - 1 : 1));
        const nextNum = pick(pagination.next_num, (hasNext ? currentPage + 1 : totalPages));
        
        // æ›´æ–°åˆ†é ä¿¡æ¯
        const startItem = (currentPage - 1) * perPage + 1;
        const endItem = Math.min(currentPage * perPage, totalRecords);
        paginationInfo.innerHTML = `é¡¯ç¤ºç¬¬ ${startItem}-${endItem} ç­†ï¼Œå…± ${totalRecords} ç­†è¨˜éŒ„`;
        
        // æ¸…ç©ºåˆ†é æŒ‰éˆ•
        paginationControls.innerHTML = '';
        
        // ä¸Šä¸€é 
        if (hasPrev) {
            paginationControls.innerHTML += '<li class="page-item"><a class="page-link" href="javascript:void(0)" onclick="loadMovements(' + prevNum + '); return false;">ä¸Šä¸€é </a></li>';
        }
        
        // é ç¢¼
        for (let i = 1; i <= totalPages; i++) {
            if (i === currentPage) {
                paginationControls.innerHTML += '<li class="page-item active"><span class="page-link">' + i + '</span></li>';
            } else {
                paginationControls.innerHTML += '<li class="page-item"><a class="page-link" href="javascript:void(0)" onclick="loadMovements(' + i + '); return false;">' + i + '</a></li>';
            }
        }
        
        // ä¸‹ä¸€é 
        if (hasNext) {
            paginationControls.innerHTML += '<li class="page-item"><a class="page-link" href="javascript:void(0)" onclick="loadMovements(' + nextNum + '); return false;">ä¸‹ä¸€é </a></li>';
        }
    }
    
    // æ›´æ–°ç¸½è³‡ç”¢æ•¸æ“š
    function updateTotalAssets() {
        console.log('ğŸ”„ æ›´æ–°ç¸½è³‡ç”¢æ•¸æ“š...');
        
        fetch('/api/cash_management/totals')
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                console.log('ğŸ“Š ç²å–åˆ°æ–°çš„ç¸½è³‡ç”¢æ•¸æ“š:', data);
                
                const totalTwdElement = document.getElementById('totalTwdDisplay');
                const totalRmbElement = document.getElementById('totalRmbDisplay');
                const totalReceivablesElement = document.getElementById('totalReceivablesDisplay');
                
                if (totalTwdElement) {
                    totalTwdElement.textContent = 'NT$ ' + data.total_twd.toLocaleString('en-US', {minimumFractionDigits: 2});
                }
                
                if (totalRmbElement) {
                    totalRmbElement.textContent = 'Â¥ ' + data.total_rmb.toLocaleString('en-US', {minimumFractionDigits: 2});
                }
                
                if (totalReceivablesElement) {
                    totalReceivablesElement.textContent = 'NT$ ' + data.total_receivables_twd.toLocaleString('en-US', {minimumFractionDigits: 2});
                }
                
                console.log('âœ… ç¸½è³‡ç”¢æ•¸æ“šæ›´æ–°å®Œæˆ');
            })
            .catch(function(error) {
                console.error('âŒ æ›´æ–°ç¸½è³‡ç”¢æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            });
    }
    
    // æ‰‹å‹•åˆ·æ–°æ•¸æ“šå‡½æ•¸
    window.manualRefreshData = function() {
        console.log('ğŸ”„ æ‰‹å‹•åˆ·æ–°æ•¸æ“š...');
        updateTotalAssets();
        renderAccounts();
        loadMovements(1);
        console.log('âœ… æ‰‹å‹•åˆ·æ–°å®Œæˆ');
    };
    
    // ç›£è½éŠ·å”®æ•¸æ“šè®Šæ›´äº‹ä»¶ï¼Œè‡ªå‹•åˆ·æ–°é é¢æ•¸æ“š
    window.addEventListener('salesDataChanged', function(event) {
        console.log('ğŸ”„ æ”¶åˆ°éŠ·å”®æ•¸æ“šè®Šæ›´äº‹ä»¶:', event.detail);
        if (event.detail.action === 'cancel_sale') {
            console.log('ğŸ”„ æª¢æ¸¬åˆ°éŠ·å”®è¨˜éŒ„å–æ¶ˆï¼Œè‡ªå‹•åˆ·æ–°ç¾é‡‘ç®¡ç†æ•¸æ“š...');
            // å»¶é²ä¸€ä¸‹å†åˆ·æ–°ï¼Œç¢ºä¿å¾Œç«¯æ•¸æ“šå·²æ›´æ–°
            setTimeout(() => {
                manualRefreshData();
            }, 500);
        }
    });
    
            // è¨­ç½®éŠ·å¸³è¡¨å–®æäº¤äº‹ä»¶ç›£è½å™¨
        const settlementForm = document.getElementById('settlementForm');
        if (settlementForm) {
            settlementForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // ç²å–è¡¨å–®æ•¸æ“š
                const customerId = document.querySelector('input[name="customer_id"]').value;
                const amount = parseFloat(document.getElementById('settlementAmount').getActualValue ? document.getElementById('settlementAmount').getActualValue() : document.getElementById('settlementAmount').value);
                let accountId = document.querySelector('input[name="account_id"]').value;
                const note = document.getElementById('settlementNote').value;
                
                // å¦‚æœéš±è—æ¬„ä½çš„å€¼ç‚ºç©ºï¼Œå˜—è©¦å¾ä¸‹æ‹‰é¸å–®ç²å–
                if (!accountId) {
                    console.log('âš ï¸ éš±è—æ¬„ä½å€¼ç‚ºç©ºï¼Œå˜—è©¦å¾ä¸‹æ‹‰é¸å–®ç²å–...');
                    const settlementAccountSelect = document.getElementById('settlementAccount');
                    if (settlementAccountSelect && settlementAccountSelect.value) {
                        accountId = settlementAccountSelect.value;
                        console.log('ğŸ”„ å¾ä¸‹æ‹‰é¸å–®ç²å–å¸³æˆ¶ID:', accountId);
                        
                        // åŒæ™‚æ›´æ–°éš±è—æ¬„ä½çš„å€¼
                        const hiddenElement = document.querySelector('input[name="account_id"]');
                        if (hiddenElement) {
                            hiddenElement.value = accountId;
                            console.log('ğŸ”„ æ›´æ–°éš±è—æ¬„ä½å€¼:', hiddenElement.value);
                        }
                    }
                }
                
                console.log('è¡¨å–®æ•¸æ“šé©—è­‰:', { customerId, amount, accountId, note });
                
                // é©—è­‰å¿…å¡«æ¬„ä½
                if (!customerId) {
                    console.error('âŒ å®¢æˆ¶IDç¼ºå¤±');
                    Swal.fire('éŒ¯èª¤', 'è«‹é¸æ“‡å®¢æˆ¶', 'error');
                    return;
                }
                
                if (!accountId) {
                    console.error('âŒ æ”¶æ¬¾å¸³æˆ¶IDç¼ºå¤±');
                    Swal.fire('éŒ¯èª¤', 'è«‹é¸æ“‡æ”¶æ¬¾å¸³æˆ¶', 'error');
                    return;
                }
            
            // é©—è­‰éŠ·å¸³é‡‘é¡
            if (isNaN(amount)) {
                console.error('âŒ éŠ·å¸³é‡‘é¡æ ¼å¼éŒ¯èª¤');
                Swal.fire('éŒ¯èª¤', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„éŠ·å¸³é‡‘é¡', 'error');
                return;
            }
            
            if (amount <= 0) {
                console.error('âŒ éŠ·å¸³é‡‘é¡å¿…é ˆå¤§æ–¼0');
                Swal.fire('éŒ¯èª¤', 'éŠ·å¸³é‡‘é¡å¿…é ˆå¤§æ–¼0', 'error');
                return;
            }
            
            console.log('âœ… è¡¨å–®é©—è­‰é€šé');
            
            // éŠ·å¸³å‰äºŒæ¬¡ç¢ºèª
            const customerName = document.getElementById('settlementCustomerName').value;
            const accountName = document.getElementById('settlementAccount').options[document.getElementById('settlementAccount').selectedIndex].text;
            
            const confirmResult = await Swal.fire({
                title: 'ç¢ºèªéŠ·å¸³æ“ä½œ',
                html: `
                    <div class="text-start">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>å®¢æˆ¶åç¨±ï¼š</strong>${customerName}</p>
                                <p><strong>éŠ·å¸³é‡‘é¡ï¼š</strong>NT$ ${amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>å…¥åº«å¸³æˆ¶ï¼š</strong>${accountName}</p>
                                <p><strong>å‚™è¨»ï¼š</strong>${note || 'ç„¡'}</p>
                            </div>
                        </div>
                        <div class="alert alert-info mt-3">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>éŠ·å¸³å¾Œï¼š</strong>å®¢æˆ¶æ‡‰æ”¶å¸³æ¬¾å°‡æ¸›å°‘ NT$ ${amount.toLocaleString('en-US', {minimumFractionDigits: 2})}
                        </div>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'ç¢ºèªéŠ·å¸³',
                cancelButtonText: 'å–æ¶ˆ',
                reverseButtons: true
            });
            
            if (!confirmResult.isConfirmed) {
                return;
            }
            
            // ç¬¬äºŒæ¬¡ç¢ºèª
            const finalConfirmResult = await Swal.fire({
                title: 'æœ€çµ‚ç¢ºèª',
                html: `
                    <div class="text-start">
                        <p>æ‚¨ç¢ºå®šè¦åŸ·è¡ŒéŠ·å¸³æ“ä½œå—ï¼Ÿ</p>
                        <div class="alert alert-warning mt-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>æ­¤æ“ä½œå°‡ï¼š</strong>
                            <ul class="mt-2 mb-0">
                                <li>æ¸›å°‘å®¢æˆ¶æ‡‰æ”¶å¸³æ¬¾</li>
                                <li>å¢åŠ å…¥åº«å¸³æˆ¶é¤˜é¡</li>
                                <li>è¨˜éŒ„éŠ·å¸³æ­·å²</li>
                                <li>ç„¡æ³•è¼•æ˜“æ’¤éŠ·</li>
                            </ul>
                        </div>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'æ˜¯çš„ï¼ŒåŸ·è¡ŒéŠ·å¸³',
                cancelButtonText: 'å–æ¶ˆ',
                reverseButtons: true
            });
            
            if (!finalConfirmResult.isConfirmed) {
                return;
            }
            
            console.log('éŠ·å¸³è¡¨å–®æäº¤:', { customerId, amount, accountId, note });
            
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            Swal.fire({
                title: 'æ­£åœ¨åŸ·è¡ŒéŠ·å¸³...',
                text: 'è«‹ç¨å€™ï¼Œæ­£åœ¨è™•ç†éŠ·å¸³æ“ä½œ',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            try {
                const response = await fetch('/api/settlement', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customer_id: customerId,
                        amount: amount,
                        account_id: accountId,
                        note: note
                    })
                });
                
                const result = await response.json();
                console.log('éŠ·å¸³å›æ‡‰:', result);
                
                if (result.status === 'success') {
                    Swal.fire({
                        icon: 'success',
                        title: 'éŠ·å¸³æˆåŠŸï¼',
                        text: result.message,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // é—œé–‰æ¨¡æ…‹æ¡†ä¸¦é‡æ–°è¼‰å…¥é é¢
                    console.log('æº–å‚™é—œé–‰æ¨¡æ…‹æ¡†...');
                    const modalElement = document.getElementById('settlementModal');
                    const modalInstance = bootstrap.Modal.getInstance(modalElement);
                    console.log('æ¨¡æ…‹æ¡†å…ƒç´ :', modalElement);
                    console.log('æ¨¡æ…‹æ¡†å¯¦ä¾‹:', modalInstance);
                    
                    if (modalInstance) {
                        console.log('é—œé–‰æ¨¡æ…‹æ¡†...');
                        modalInstance.hide();
                    } else {
                        console.log('ç„¡æ³•ç²å–æ¨¡æ…‹æ¡†å¯¦ä¾‹ï¼Œå˜—è©¦ç›´æ¥éš±è—...');
                        // å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥éš±è—æ¨¡æ…‹æ¡†
                        modalElement.style.display = 'none';
                        modalElement.classList.remove('show');
                        document.body.classList.remove('modal-open');
                        const backdrop = document.querySelector('.modal-backdrop');
                        if (backdrop) {
                            backdrop.remove();
                        }
                    }
                    
                    // å»¶é²æ›´æ–°ç¸½è³‡ç”¢é¡¯ç¤ºï¼Œç¢ºä¿æ¨¡æ…‹æ¡†æœ‰æ™‚é–“é—œé–‰
                    setTimeout(() => {
                        updateTotalAssets();
                        manualRefreshData(); // é‡æ–°è¼‰å…¥æ‰€æœ‰æ•¸æ“š
                    }, 500);
                } else {
                    Swal.fire('éŒ¯èª¤', result.message, 'error');
                }
            } catch (error) {
                console.error('éŠ·å¸³éŒ¯èª¤:', error);
                Swal.fire('éŒ¯èª¤', 'éŠ·å¸³æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            }
        });
    }
    
    // æ·»åŠ æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
    document.addEventListener('click', function(e) {
        if (e.target.closest('.settlement-btn')) {
            const btn = e.target.closest('.settlement-btn');
            const customerId = btn.dataset.customerId;
            const customerName = btn.dataset.customerName;
            const amount = parseFloat(btn.dataset.amount);
            openSettlementModal(customerId, customerName, amount);
        } else if (e.target.closest('.payment-btn')) {
            const btn = e.target.closest('.payment-btn');
            const pendingId = btn.dataset.pendingId;
            const purchaseRecordId = btn.dataset.purchaseRecordId;
            const amount = parseFloat(btn.dataset.amount);
            const channel = btn.dataset.channel;
            openPendingPaymentModal(pendingId, purchaseRecordId, amount, channel);
        }
    });

    // åˆå§‹åŒ–æ¸²æŸ“
    renderAccounts();
    loadMovements(1);
    setupCustomerTransactionsListeners(); // åˆå§‹åŒ–å®¢æˆ¶äº¤æ˜“ç´€éŒ„ç›£è½å™¨
    
    console.log('âœ… ç¾é‡‘ç®¡ç†é é¢åˆå§‹åŒ–å®Œæˆ');
    
    // æ¸¬è©¦èª¿è©¦ä»£ç¢¼æ˜¯å¦èƒ½æ­£å¸¸åŸ·è¡Œ
    console.log('ğŸ§ª æ¸¬è©¦èª¿è©¦ä»£ç¢¼åŸ·è¡Œ...');
    setTimeout(() => {
        console.log('ğŸ§ª èª¿è©¦ä»£ç¢¼æ¸¬è©¦å®Œæˆï¼Œå¦‚æœçœ‹åˆ°é€™æ¢è¨Šæ¯ï¼Œèªªæ˜ JavaScript æ­£å¸¸åŸ·è¡Œ');
    }, 1000);
});

// é€šç”¨äºŒæ¬¡ç¢ºèªå‡½æ•¸
async function confirmOperation(options) {
    const {
        title,
        message,
        confirmText = 'ç¢ºèª',
        cancelText = 'å–æ¶ˆ',
        confirmColor = '#28a745',
        cancelColor = '#6c757d',
        icon = 'question',
        showSecondConfirm = true,
        secondTitle = 'æœ€çµ‚ç¢ºèª',
        secondMessage = 'æ‚¨ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ',
        secondConfirmText = 'æ˜¯çš„ï¼ŒåŸ·è¡Œ',
        secondCancelText = 'å–æ¶ˆ'
    } = options;
    
    // ç¬¬ä¸€æ¬¡ç¢ºèª
    const firstResult = await Swal.fire({
        title: title,
        html: message,
        icon: icon,
        showCancelButton: true,
        confirmButtonColor: confirmColor,
        cancelButtonColor: cancelColor,
        confirmButtonText: confirmText,
        cancelButtonText: cancelText,
        reverseButtons: true,
        focusCancel: true
    });
    
    if (!firstResult.isConfirmed) {
        return false;
    }
    
    // å¦‚æœéœ€è¦ç¬¬äºŒæ¬¡ç¢ºèª
    if (showSecondConfirm) {
        const secondResult = await Swal.fire({
            title: secondTitle,
            html: secondMessage,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: confirmColor,
            cancelButtonColor: cancelColor,
            confirmButtonText: secondConfirmText,
            cancelButtonText: secondCancelText,
            reverseButtons: true
        });
        
        return secondResult.isConfirmed;
    }
    
    return true;
}

// ç‚ºå…§éƒ¨è½‰å¸³å¢åŠ ç¢ºèª
document.addEventListener('DOMContentLoaded', function() {
    const transferForm = document.querySelector('#transferModal form');
    if (transferForm) {
        transferForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fromAccount = document.getElementById('fromAccount');
            const toAccount = document.getElementById('toAccount');
            const amount = document.getElementById('transferAmount');
            
            if (!fromAccount.value || !toAccount.value || !amount.value) {
                Swal.fire('éŒ¯èª¤', 'è«‹å¡«å¯«å®Œæ•´çš„è½‰å¸³è³‡è¨Š', 'error');
                return;
            }
            
            const fromAccountText = fromAccount.options[fromAccount.selectedIndex].text;
            const toAccountText = toAccount.options[toAccount.selectedIndex].text;
            const transferAmount = parseFloat(amount.value);
            
            // äºŒæ¬¡ç¢ºèª
            const confirmed = await confirmOperation({
                title: 'ç¢ºèªå…§éƒ¨è½‰å¸³',
                message: `
                    <div class="text-start">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>è½‰å‡ºå¸³æˆ¶ï¼š</strong>${fromAccountText}</p>
                                <p><strong>è½‰å…¥å¸³æˆ¶ï¼š</strong>${toAccountText}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>è½‰å¸³é‡‘é¡ï¼š</strong>NT$ ${transferAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}</p>
                            </div>
                        </div>
                        <div class="alert alert-info mt-3">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>è½‰å¸³å¾Œï¼š</strong>è½‰å‡ºå¸³æˆ¶é¤˜é¡å°‡æ¸›å°‘ï¼Œè½‰å…¥å¸³æˆ¶é¤˜é¡å°‡å¢åŠ 
                        </div>
                    </div>
                `,
                confirmText: 'ç¢ºèªè½‰å¸³',
                secondMessage: `
                    <div class="text-start">
                        <p>æ‚¨ç¢ºå®šè¦åŸ·è¡Œæ­¤å…§éƒ¨è½‰å¸³å—ï¼Ÿ</p>
                        <div class="alert alert-warning mt-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>æ­¤æ“ä½œå°‡ï¼š</strong>
                            <ul class="mt-2 mb-0">
                                <li>å¾ ${fromAccountText} è½‰å‡º NT$ ${transferAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}</li>
                                <li>è½‰å…¥ ${toAccountText}</li>
                                <li>è¨˜éŒ„è½‰å¸³æ­·å²</li>
                                <li>ç„¡æ³•è¼•æ˜“æ’¤éŠ·</li>
                            </ul>
                        </div>
                    </div>
                `,
                secondConfirmText: 'æ˜¯çš„ï¼ŒåŸ·è¡Œè½‰å¸³'
            });
            
            if (confirmed) {
                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                Swal.fire({
                    title: 'æ­£åœ¨åŸ·è¡Œè½‰å¸³...',
                    text: 'è«‹ç¨å€™ï¼Œæ­£åœ¨è™•ç†è½‰å¸³æ“ä½œ',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // æäº¤è¡¨å–®
                this.submit();
            }
        });
    }
    
    // ç‚ºè³‡é‡‘æ“ä½œå¢åŠ ç¢ºèª
    const movementForm = document.querySelector('#addMovementModal form');
    if (movementForm) {
        movementForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const accountId = document.getElementById('movementAccountId').value;
            const amount = document.getElementById('movementAmount').value;
            const isDecrease = document.querySelector('input[name="is_decrease"]:checked').value === 'true';
            const note = document.getElementById('movementNote').value;
            
            if (!accountId || !amount) {
                Swal.fire('éŒ¯èª¤', 'è«‹å¡«å¯«å®Œæ•´çš„æ“ä½œè³‡è¨Š', 'error');
                return;
            }
            
            const operationType = isDecrease ? 'æå‡º' : 'å­˜å…¥';
            const operationAmount = parseFloat(amount);
            
            // äºŒæ¬¡ç¢ºèª
            const confirmed = await confirmOperation({
                title: `ç¢ºèªè³‡é‡‘${operationType}`,
                message: `
                    <div class="text-start">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>æ“ä½œé¡å‹ï¼š</strong>${operationType}</p>
                                <p><strong>æ“ä½œé‡‘é¡ï¼š</strong>NT$ ${operationAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>å‚™è¨»ï¼š</strong>${note || 'ç„¡'}</p>
                            </div>
                        </div>
                        <div class="alert alert-info mt-3">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>æ“ä½œå¾Œï¼š</strong>å¸³æˆ¶é¤˜é¡å°‡${isDecrease ? 'æ¸›å°‘' : 'å¢åŠ '} NT$ ${operationAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}
                        </div>
                    </div>
                `,
                confirmText: `ç¢ºèª${operationType}`,
                secondMessage: `
                    <div class="text-start">
                        <p>æ‚¨ç¢ºå®šè¦åŸ·è¡Œæ­¤è³‡é‡‘${operationType}æ“ä½œå—ï¼Ÿ</p>
                        <div class="alert alert-warning mt-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>æ­¤æ“ä½œå°‡ï¼š</strong>
                            <ul class="mt-2 mb-0">
                                <li>${operationType} NT$ ${operationAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}</li>
                                <li>æ›´æ–°å¸³æˆ¶é¤˜é¡</li>
                                <li>è¨˜éŒ„æ“ä½œæ­·å²</li>
                                <li>ç„¡æ³•è¼•æ˜“æ’¤éŠ·</li>
                            </ul>
                        </div>
                    </div>
                `,
                secondConfirmText: `æ˜¯çš„ï¼ŒåŸ·è¡Œ${operationType}`
            });
            
            if (confirmed) {
                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                Swal.fire({
                    title: `æ­£åœ¨åŸ·è¡Œ${operationType}...`,
                    text: 'è«‹ç¨å€™ï¼Œæ­£åœ¨è™•ç†è³‡é‡‘æ“ä½œ',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // æäº¤è¡¨å–®
                this.submit();
            }
        });
    }
});

// å…¨å±€å‡½æ•¸ï¼šè¼‰å…¥åˆ†é æµæ°´è¨˜éŒ„
window.loadMovements = function(page = 1) {
    console.log('ğŸ” é–‹å§‹è¼‰å…¥ç¬¬', page, 'é æµæ°´è¨˜éŒ„...');
    
    const movementsTbody = document.getElementById('movements-tbody');
    if (!movementsTbody) {
        console.error('âŒ æ‰¾ä¸åˆ° movements-tbody å…ƒç´ ');
        return;
    }
    
    // é¡¯ç¤ºè¼‰å…¥ä¸­
    movementsTbody.innerHTML = '<tr><td colspan="11" class="text-center p-3"><i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</td></tr>';
    
    // ç™¼é€APIè«‹æ±‚
    fetch(`/api/cash_management/transactions?page=${page}`)
        .then(response => response.json())
        .then(result => {
            console.log('ğŸ“¡ APIå›æ‡‰çµæœ:', result);
            if (result.status === 'success') {
                console.log('âœ… è¼‰å…¥æˆåŠŸï¼Œé é¢:', page);
                console.log('ğŸ“Š åˆ†é è³‡è¨Š:', result.data.pagination);
                console.log('ğŸ“‹ äº¤æ˜“è¨˜éŒ„:', result.data.transactions);
                
                window.currentPage = page;
                window.currentPagination = result.data.pagination;
                window.renderMovements(result.data.transactions);
                window.renderPagination(result.data.pagination);
            } else {
                console.error('âŒ è¼‰å…¥æµæ°´è¨˜éŒ„å¤±æ•—:', result.message);
                movementsTbody.innerHTML = '<tr><td colspan="11" class="text-center p-3 text-danger">è¼‰å…¥å¤±æ•—: ' + result.message + '</td></tr>';
            }
        })
        .catch(error => {
            console.error('âŒ ç¶²è·¯éŒ¯èª¤:', error);
            movementsTbody.innerHTML = '<tr><td colspan="11" class="text-center p-3 text-danger">ç¶²è·¯éŒ¯èª¤ï¼Œè«‹é‡è©¦</td></tr>';
        });
};

// å…¨å±€å‡½æ•¸ï¼šæ¸²æŸ“è³‡é‡‘æµæ°´
window.renderMovements = function(transactions) {
    console.log('ğŸ” é–‹å§‹æ¸²æŸ“è³‡é‡‘æµæ°´...');
    
    const movementsTbody = document.getElementById('movements-tbody');
    if (!movementsTbody) {
        console.error('âŒ æ‰¾ä¸åˆ° movements-tbody å…ƒç´ ');
        return;
    }
    
    movementsTbody.innerHTML = '';
    
    if (!transactions || transactions.length === 0) {
        console.log('âš ï¸ æ²’æœ‰è³‡é‡‘æµæ°´æ•¸æ“š');
        movementsTbody.innerHTML = '<tr><td colspan="11" class="text-center p-5 text-muted">å°šç„¡è³‡é‡‘æµæ°´ç´€éŒ„ã€‚</td></tr>';
        return;
    }
    
    console.log('âœ… æ‰¾åˆ° ' + transactions.length + ' ç­†è³‡é‡‘æµæ°´ï¼Œé–‹å§‹æ¸²æŸ“...');
    
    transactions.forEach(function(m, index) {
        // èª¿è©¦ï¼šè¼¸å‡ºå‰5ç­†è¨˜éŒ„çš„å®Œæ•´æ•¸æ“šçµæ§‹
        if (index < 5) {
            console.log(`ğŸ“‹ è¨˜éŒ„ ${index + 1} å®Œæ•´æ•¸æ“š:`, m);
        }
        
        const twdChange = parseFloat(m.twd_change ?? m.twdChange) || 0;
        const rmbChange = parseFloat(m.rmb_change ?? m.rmbChange) || 0;
        const profit = parseFloat(m.profit ?? 0) || 0;
        
        // æ–°å¢ï¼šè©³ç´°åˆ©æ½¤ä¿¡æ¯
        const profitBefore = parseFloat(m.profit_before ?? m.profitBefore) || null;
        const profitAfter = parseFloat(m.profit_after ?? m.profitAfter) || null;
        const profitChange = parseFloat(m.profit_change ?? m.profitChange) || null;
        
        // åˆ¤æ–·æ˜¯å¦ç‚ºåˆ©æ½¤ææ¬¾ï¼ˆåŒæ™‚æ”¯æ´åŸå§‹è‹±æ–‡ä»£ç¢¼èˆ‡ä¸­æ–‡é¡¯ç¤ºï¼‰
        const rawType = (m.entry_type ?? m.type ?? '').toString();
        const isProfitWithdraw = rawType === 'PROFIT_WITHDRAW' || rawType === 'åˆ©æ½¤æ‰£é™¤' || (m.description ?? '').includes('åˆ©æ½¤ææ¬¾');
        
        // èª¿è©¦æ—¥èªŒï¼šæª¢æŸ¥åˆ©æ½¤è©³ç´°æ•¸æ“š
        if (isProfitWithdraw) {
            console.log('ğŸ” åˆ©æ½¤ææ¬¾è¨˜éŒ„èª¿è©¦:', {
                id: m.id,
                type: m.type,
                entry_type: m.entry_type,
                description: m.description,
                profit_before: m.profit_before,
                profit_after: m.profit_after,
                profit_change: m.profit_change,
                profit: m.profit,
                parsed_profitBefore: profitBefore,
                parsed_profitAfter: profitAfter,
                parsed_profitChange: profitChange
            });
        } else if ((m.type + '').includes('WITHDRAW') || (m.description ?? '').includes('ææ¬¾')) {
            // è‹¥æ²’æœ‰è¢«åˆ¤å®šç‚ºåˆ©æ½¤ææ¬¾ï¼Œä½†ç–‘ä¼¼ææ¬¾ï¼Œè¼¸å‡ºåŸå§‹ m ä¾›èª¿è©¦
            console.log('â„¹ï¸ ç–‘ä¼¼ææ¬¾ä½†æœªè­˜åˆ¥ç‚ºåˆ©æ½¤ææ¬¾ï¼ŒåŸå§‹è³‡æ–™ m =', m);
        }
        
        // å°‡é¡å‹è½‰æ›ç‚ºä¸­æ–‡é¡¯ç¤º
        let typeDisplay = m.type;
        let typeClass = 'badge bg-info-subtle text-info-emphasis';
        
        switch(m.type) {
            case 'PURCHASE':
            case 'è²·å…¥':
                typeDisplay = 'è²·å…¥';
                typeClass = 'badge bg-primary-subtle text-primary-emphasis';
                break;
            case 'SALES':
            case 'å”®å‡º':
                typeDisplay = 'å”®å‡º';
                typeClass = 'badge bg-danger-subtle text-danger-emphasis';
                break;
            case 'TRANSFER':
            case 'è½‰å¸³':
                typeDisplay = 'è½‰å¸³';
                typeClass = 'badge bg-warning-subtle text-warning-emphasis';
                break;
            case 'SETTLEMENT':
            case 'éŠ·å¸³':
                typeDisplay = 'éŠ·å¸³';
                typeClass = 'badge bg-primary-subtle text-primary-emphasis';
                break;
            case 'DEPOSIT':
            case 'å­˜æ¬¾':
                typeDisplay = 'å­˜æ¬¾';
                typeClass = 'badge bg-secondary-subtle text-secondary-emphasis';
                break;
            case 'WITHDRAWAL':
            case 'ææ¬¾':
                typeDisplay = 'ææ¬¾';
                typeClass = 'badge bg-danger-subtle text-danger-emphasis';
                break;
            case 'CARD_PURCHASE':
                typeDisplay = 'åˆ·å¡';
                typeClass = 'badge bg-warning-subtle text-warning-emphasis';
                break;
            case 'CUSTOMER_PAYMENT':
                typeDisplay = 'å®¢æˆ¶ä»˜æ¬¾';
                typeClass = 'badge bg-success-subtle text-success-emphasis';
                break;
            case 'PROFIT_WITHDRAW':
                typeDisplay = 'åˆ©æ½¤æ‰£é™¤';
                typeClass = 'badge bg-warning-subtle text-warning-emphasis';
                break;
            case 'ASSET_WITHDRAW':
                typeDisplay = 'è³‡ç”¢ææ¬¾';
                typeClass = 'badge bg-secondary-subtle text-secondary-emphasis';
                break;
            default:
                typeDisplay = m.type;
                typeClass = 'badge bg-info-subtle text-info-emphasis';
        }
        
        // æ ¼å¼åŒ–é‡‘é¡é¡¯ç¤º
        const twdDisplay = twdChange !== 0 ? (twdChange > 0 ? '+' : '') + twdChange.toLocaleString('en-US', {minimumFractionDigits: 2}) : '-';
        const rmbDisplay = rmbChange !== 0 ? (rmbChange > 0 ? '+' : '') + rmbChange.toLocaleString('en-US', {minimumFractionDigits: 2}) : '-';
        const profitDisplay = profit !== 0 ? profit.toLocaleString('en-US', {minimumFractionDigits: 2}) : '-';
        
        // æ ¼å¼åŒ–è©³ç´°åˆ©æ½¤ä¿¡æ¯
        const profitBeforeDisplay = profitBefore !== null ? profitBefore.toLocaleString('en-US', {minimumFractionDigits: 2}) : '-';
        const profitAfterDisplay = profitAfter !== null ? profitAfter.toLocaleString('en-US', {minimumFractionDigits: 2}) : '-';
        const profitChangeDisplay = profitChange !== null ? (profitChange > 0 ? '+' : '') + profitChange.toLocaleString('en-US', {minimumFractionDigits: 2}) : '-';
        
        // æ ¹æ“šè®ŠåŒ–é¡å‹è¨­ç½®é¡è‰²
        const twdColorClass = twdChange > 0 ? 'text-success' : twdChange < 0 ? 'text-danger' : 'text-muted';
        const rmbColorClass = rmbChange > 0 ? 'text-success' : rmbChange < 0 ? 'text-danger' : 'text-muted';
        const profitColorClass = profit > 0 ? 'text-success' : profit < 0 ? 'text-danger' : 'text-muted';
        const profitChangeColorClass = profitChange !== null ? (profitChange > 0 ? 'text-success' : 'text-danger') : 'text-muted';
        
        // TWD/RMB è®Šå‹•åˆä½µé¡¯ç¤ºï¼ˆæŒ‰ç…§æˆªåœ–2æ ¼å¼ï¼‰
        let twdRmbChangeHtml = '-';
        if (twdChange !== 0 || rmbChange !== 0) {
            // è¨ˆç®—ç¸½é¡ï¼ˆä½¿ç”¨ç´¯ç©é¤˜é¡ï¼‰
            const runningTwd = m.running_twd_balance ?? m.runningTwdBalance ?? 0;
            const runningRmb = m.running_rmb_balance ?? m.runningRmbBalance ?? 0;
            
            twdRmbChangeHtml = '<div class="card" style="background-color: #e3f2fd; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 8px; margin: 2px;">';
            
            if (twdChange !== 0) {
                const twdColorClass = twdChange > 0 ? 'text-success' : 'text-danger';
                const twdSymbol = twdChange > 0 ? '+' : '';
                twdRmbChangeHtml += '<div class="' + twdColorClass + ' fw-bold" style="font-size: 0.85rem;">TWD: ' + twdSymbol + twdChange.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</div>';
                twdRmbChangeHtml += '<div class="text-dark" style="font-size: 0.75rem; margin-top: 2px;">ç¸½é¡: ' + runningTwd.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</div>';
            }
            
            if (rmbChange !== 0) {
                const rmbColorClass = rmbChange > 0 ? 'text-success' : 'text-danger';
                const rmbSymbol = rmbChange > 0 ? '+' : '';
                twdRmbChangeHtml += '<div class="' + rmbColorClass + ' fw-bold" style="font-size: 0.85rem; margin-top: 4px;">RMB: ' + rmbSymbol + rmbChange.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</div>';
                twdRmbChangeHtml += '<div class="text-dark" style="font-size: 0.75rem; margin-top: 2px;">ç¸½é¡: ' + runningRmb.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</div>';
            }
            
            twdRmbChangeHtml += '</div>';
        }

        // åˆ©æ½¤è®Šå‹•è©³æƒ…ï¼ˆæ¨¡ä»¿ç´¯ç©é¤˜é¡çš„é¡¯ç¤ºæ–¹å¼ï¼‰
        let profitDetailHtml = '-';
        
        // èª¿è©¦æ—¥èªŒï¼šæª¢æŸ¥åˆ©æ½¤è®Šå‹•è©³æƒ…æ¸²æŸ“é‚è¼¯
        if (isProfitWithdraw) {
            console.log('ğŸ¨ åˆ©æ½¤è®Šå‹•è©³æƒ…æ¸²æŸ“èª¿è©¦:', {
                id: m.id,
                profitBefore: profitBefore,
                profitAfter: profitAfter,
                profitChange: profitChange,
                profit: profit,
                willShowDetailed: (profitBefore !== null && profitAfter !== null && profitChange !== null),
                willShowSimple: (profit !== 0)
            });
        }
        
        // æª¢æŸ¥æ˜¯å¦æœ‰è©³ç´°çš„åˆ©æ½¤è®Šå‹•è¨˜éŒ„
        if (m.profit_change_detail) {
            const profitDetail = m.profit_change_detail;
            const before = (profitDetail.before || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
            const after = (profitDetail.after || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
            const change = (profitDetail.change || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
            const changeColor = (profitDetail.change || 0) > 0 ? 'text-success' : (profitDetail.change || 0) < 0 ? 'text-danger' : 'text-muted';
            const changeSymbol = (profitDetail.change || 0) > 0 ? '+' : '';
            
            profitDetailHtml = '<div class="card" style="background-color: #fff3cd; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 8px; margin: 2px;">' +
                '<div class="text-dark" style="font-size: 0.8rem;">å‰: ' + before + '</div>' +
                '<div class="' + changeColor + ' fw-bold" style="font-size: 0.8rem;">è®Šå‹•: ' + changeSymbol + change + '</div>' +
                '<div class="text-dark" style="font-size: 0.8rem;">å¾Œ: ' + after + '</div>' +
                '</div>';
        } else if (profitBefore !== null && profitAfter !== null && profitChange !== null) {
            // æœ‰åˆ©æ½¤è®Šå‹•è¨˜éŒ„ï¼Œé¡¯ç¤ºè©³ç´°ä¿¡æ¯
            const changeColorClass = profitChange > 0 ? 'text-success' : 'text-danger';
            const changeSymbol = profitChange > 0 ? '+' : '';
            
            console.log('âœ… æ¸²æŸ“è©³ç´°åˆ©æ½¤ä¿¡æ¯:', {
                id: m.id,
                before: profitBeforeDisplay,
                after: profitAfterDisplay,
                change: changeSymbol + profitChangeDisplay
            });
            
            profitDetailHtml = '<div class="card" style="background-color: #fff3cd; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 8px; margin: 2px;">' +
                '<div class="text-dark" style="font-size: 0.8rem;">å‰: ' + profitBeforeDisplay + '</div>' +
                '<div class="' + changeColorClass + ' fw-bold" style="font-size: 0.8rem;">è®Šå‹•: ' + changeSymbol + profitChangeDisplay + '</div>' +
                '<div class="text-dark" style="font-size: 0.8rem;">å¾Œ: ' + profitAfterDisplay + '</div>' +
                '</div>';
        } else if (profit !== 0) {
            // æœ‰å‚³çµ±åˆ©æ½¤è¨˜éŒ„ï¼Œé¡¯ç¤ºç°¡å–®ä¿¡æ¯ï¼ˆæ•¸æ“šåº«å°šæœªæ›´æ–°æ™‚çš„è‡¨æ™‚é¡¯ç¤ºï¼‰
            profitDetailHtml = '<div class="text-dark" style="font-size: 0.85rem;">' + profitDisplay + '</div>';
        }

        const paymentAccount = m.payment_account ?? m.outgoing_account ?? '-';
        const depositAccount = m.deposit_account ?? m.incoming_account ?? '-';

        // æ–°å¢ï¼šå‡ºæ¬¾æˆ¶é¤˜é¡è®ŠåŒ–é¡¯ç¤º
        let paymentAccountBalanceHtml = '-';
        if (m.payment_account_balance) {
            const balance = m.payment_account_balance;
            const before = (balance.before || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
            const change = (balance.change || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
            const after = (balance.after || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
            const changeColor = (balance.change || 0) > 0 ? 'text-success' : (balance.change || 0) < 0 ? 'text-danger' : 'text-muted';
            const changeSymbol = (balance.change || 0) > 0 ? '+' : '';
            
            paymentAccountBalanceHtml = '<div class="card" style="background-color: #f5f5f5; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 8px; margin: 2px;">' +
                '<div class="text-primary fw-bold" style="font-size: 0.85rem; text-align: right; border-bottom: 1px solid #007bff; padding-bottom: 4px; margin-bottom: 4px;">' + paymentAccount + '</div>' +
                '<div class="text-dark" style="font-size: 0.8rem;">å‰: ' + before + '</div>' +
                '<div class="' + changeColor + ' fw-bold" style="font-size: 0.8rem;">è®Šå‹•: ' + changeSymbol + change + '</div>' +
                '<div class="text-dark" style="font-size: 0.8rem;">å¾Œ: ' + after + '</div>' +
                '</div>';
        }

        // æ–°å¢ï¼šå…¥æ¬¾æˆ¶é¤˜é¡è®ŠåŒ–é¡¯ç¤º
        let depositAccountBalanceHtml = '-';
        if (m.deposit_account_balance) {
            const balance = m.deposit_account_balance;
            const before = (balance.before || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
            const change = (balance.change || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
            const after = (balance.after || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
            const changeColor = (balance.change || 0) > 0 ? 'text-success' : (balance.change || 0) < 0 ? 'text-danger' : 'text-muted';
            const changeSymbol = (balance.change || 0) > 0 ? '+' : '';
            
            depositAccountBalanceHtml = '<div class="card" style="background-color: #f5f5f5; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 8px; margin: 2px;">' +
                '<div class="text-success fw-bold" style="font-size: 0.85rem; text-align: right; border-bottom: 1px solid #28a745; padding-bottom: 4px; margin-bottom: 4px;">' + depositAccount + '</div>' +
                '<div class="text-dark" style="font-size: 0.8rem;">å‰: ' + before + '</div>' +
                '<div class="' + changeColor + ' fw-bold" style="font-size: 0.8rem;">è®Šå‹•: ' + changeSymbol + change + '</div>' +
                '<div class="text-dark" style="font-size: 0.8rem;">å¾Œ: ' + after + '</div>' +
                '</div>';
        }

        // æ–°å¢ï¼šRMBå¸³æˆ¶é¤˜é¡è®ŠåŒ–é¡¯ç¤º
        let rmbAccountBalanceHtml = '-';
        if (m.rmb_account_balance) {
            const balance = m.rmb_account_balance;
            const before = (balance.before || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
            const change = (balance.change || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
            const after = (balance.after || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
            const changeColor = (balance.change || 0) > 0 ? 'text-success' : (balance.change || 0) < 0 ? 'text-danger' : 'text-muted';
            const changeSymbol = (balance.change || 0) > 0 ? '+' : '';
            
            rmbAccountBalanceHtml = '<div class="card" style="background-color: #f5f5f5; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 8px; margin: 2px;">' +
                '<div class="text-success fw-bold" style="font-size: 0.85rem; text-align: right; border-bottom: 1px solid #28a745; padding-bottom: 4px; margin-bottom: 4px;">RMBå¸³æˆ¶</div>' +
                '<div class="text-dark" style="font-size: 0.8rem;">å‰: ' + before + '</div>' +
                '<div class="' + changeColor + ' fw-bold" style="font-size: 0.8rem;">è®Šå‹•: ' + changeSymbol + change + '</div>' +
                '<div class="text-dark" style="font-size: 0.8rem;">å¾Œ: ' + after + '</div>' +
                '</div>';
        }

        // æ–°å¢ï¼šå¸³æˆ¶é¤˜é¡è®ŠåŒ–é¡¯ç¤ºï¼ˆç”¨æ–¼å…¶ä»–è¨˜å¸³è¨˜éŒ„ï¼‰
        let accountBalanceHtml = '-';
        if (m.account_balance) {
            const balance = m.account_balance;
            const before = (balance.before || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
            const change = (balance.change || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
            const after = (balance.after || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
            const changeColor = (balance.change || 0) > 0 ? 'text-success' : (balance.change || 0) < 0 ? 'text-danger' : 'text-muted';
            const changeSymbol = (balance.change || 0) > 0 ? '+' : '';
            
            accountBalanceHtml = '<div class="card" style="background-color: #f5f5f5; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 8px; margin: 2px;">' +
                '<div class="text-primary fw-bold" style="font-size: 0.85rem; text-align: right; border-bottom: 1px solid #007bff; padding-bottom: 4px; margin-bottom: 4px;">å¸³æˆ¶</div>' +
                '<div class="text-dark" style="font-size: 0.8rem;">å‰: ' + before + '</div>' +
                '<div class="' + changeColor + ' fw-bold" style="font-size: 0.8rem;">è®Šå‹•: ' + changeSymbol + change + '</div>' +
                '<div class="text-dark" style="font-size: 0.8rem;">å¾Œ: ' + after + '</div>' +
                '</div>';
        }

        const row = '<tr class="transaction-row">' +
            '<td class="ps-3"><small>' + (m.date ? new Date(m.date + 'Z').toLocaleString('zh-TW', {timeZone: 'Asia/Taipei'}) : '-') + '</small></td>' +
            '<td><span class="' + typeClass + '">' + typeDisplay + '</span></td>' +
            '<td><small>' + (m.description || '-') + '</small></td>' +
            '<td><small>' + (m.operator || '-') + '</small></td>' +
            '<td><small>' + paymentAccount + '</small></td>' +
            '<td><small>' + depositAccount + '</small></td>' +
            '<td><small>' + (m.note || '-') + '</small></td>' +
            '<td class="text-end">' + twdRmbChangeHtml + '</td>' +
            '<td class="text-end">' + paymentAccountBalanceHtml + '</td>' +
            '<td class="text-end">' + depositAccountBalanceHtml + '</td>' +
            '<td class="text-end pe-3">' + profitDetailHtml + '</td>' +
            '</tr>';
        
        movementsTbody.innerHTML += row;
    });
    
    console.log('âœ… è³‡é‡‘æµæ°´æ¸²æŸ“å®Œæˆ');
};

// å…¨å±€å‡½æ•¸ï¼šæ¸²æŸ“åˆ†é 
window.renderPagination = function(pagination) {
    if (!pagination) return;
    
    // æœ¬åœ°pickä»¥é¿å… ?? ç›¸å®¹æ€§å•é¡Œ
    function pick() {
        for (var i = 0; i < arguments.length; i++) {
            var v = arguments[i];
            if (v !== undefined && v !== null) return v;
        }
        return undefined;
    }
    
    // æ­£è¦åŒ–ä¸åŒå›æ‡‰éµå
    const currentPage = pick(pagination.current_page, pagination.page, 1);
    const perPage = pick(pagination.per_page, pagination.perPage, 50);
    const totalRecords = pick(pagination.total, pagination.total_records, 0);
    const totalPages = pick(pagination.total_pages, pagination.pages, Math.ceil(totalRecords / perPage) || 1);
    const hasPrev = pick(pagination.has_prev, (currentPage > 1)) ? true : false;
    const hasNext = pick(pagination.has_next, (currentPage < totalPages)) ? true : false;
    const prevNum = pick(pagination.prev_num, hasPrev ? currentPage - 1 : 1);
    const nextNum = pick(pagination.next_num, hasNext ? currentPage + 1 : totalPages);
    
    // æ›´æ–°åˆ†é ä¿¡æ¯
    const paginationInfo = document.getElementById('pagination-info');
    if (paginationInfo) {
        const startRecord = (currentPage - 1) * perPage + 1;
        const endRecord = Math.min(currentPage * perPage, totalRecords);
        paginationInfo.innerHTML = `é¡¯ç¤ºç¬¬${startRecord}-${endRecord}ç­†,å…±${totalRecords}ç­†è¨˜éŒ„`;
    }
    
    // æ›´æ–°åˆ†é æ§åˆ¶é …
    const paginationControls = document.getElementById('pagination-controls');
    if (!paginationControls) return;
    
    let paginationHtml = '<ul class="pagination pagination-sm mb-0">';
    
    // ä¸Šä¸€é 
    if (hasPrev) {
        paginationHtml += '<li class="page-item"><a class="page-link" href="javascript:void(0)" onclick="loadMovements(' + prevNum + '); return false;">ä¸Šä¸€é </a></li>';
    }
    
    // é ç¢¼
    for (let i = 1; i <= totalPages; i++) {
        if (i === currentPage) {
            paginationHtml += '<li class="page-item active"><span class="page-link">' + i + '</span></li>';
        } else {
            paginationHtml += '<li class="page-item"><a class="page-link" href="javascript:void(0)" onclick="loadMovements(' + i + '); return false;">' + i + '</a></li>';
        }
    }
    
    // ä¸‹ä¸€é 
    if (hasNext) {
        paginationHtml += '<li class="page-item"><a class="page-link" href="javascript:void(0)" onclick="loadMovements(' + nextNum + '); return false;">ä¸‹ä¸€é </a></li>';
    }
    
    paginationHtml += '</ul>';
    paginationControls.innerHTML = paginationHtml;
};

// æ•¸å­—è¼¸å…¥æ¬„ä½æ ¼å¼åŒ–å‡½æ•¸ - ä½¿ç”¨å…¨å±€å¢å¼·ç‰ˆæœ¬

// åˆå§‹åŒ–æ•¸å­—è¼¸å…¥æ¬„ä½æ ¼å¼åŒ–
function initializeNumberFormatting() {
    console.log('ğŸ”§ é–‹å§‹åˆå§‹åŒ–ç°¡åŒ–çš„æ•¸å­—è¼¸å…¥æ¬„ä½æ ¼å¼åŒ–...');
    
    // æŸ¥æ‰¾æ‰€æœ‰æ•¸å­—è¼¸å…¥æ¬„ä½
    const numberInputs = document.querySelectorAll('input[type="text"][pattern*="[0-9]"], input[type="text"][id*="amount"], input[type="text"][id*="rate"], input[type="text"][id*="balance"], input[type="text"][id*="rmb"]');
    
    console.log('ğŸ” æ‰¾åˆ°æ•¸å­—è¼¸å…¥æ¬„ä½:', numberInputs.length);
    
    numberInputs.forEach((input, index) => {
        console.log(`ğŸ“ åˆå§‹åŒ–æ¬„ä½ ${index + 1}:`, input.id, input.name);
        
        // æ ¹æ“šæ¬„ä½IDæ±ºå®šé¸é …
        let options = { minDecimals: 0, maxDecimals: 2 };
        
        if (input.id.includes('rate') || input.id.includes('exchange') || input.id.includes('CostRate')) {
            options.maxDecimals = 4;
        }
        
        if (input.id.includes('balance') || input.id.includes('amount')) {
            options.maxDecimals = 2;
        }
        
        // è¨­ç½®ç°¡åŒ–çš„æ•¸å­—æ ¼å¼åŒ–ï¼ˆç„¡åƒä½åˆ†éš”ç¬¦ï¼‰
        if (typeof setupNumberInputFormatting === 'function') {
            setupNumberInputFormatting(input, options);
            console.log(`âœ… æ¬„ä½ ${input.id} ç°¡åŒ–æ ¼å¼åŒ–å®Œæˆï¼Œé¸é …:`, options);
        } else {
            console.warn(`âš ï¸ setupNumberInputFormatting å‡½æ•¸æœªå®šç¾©ï¼Œè·³éæ¬„ä½ ${input.id}`);
        }
    });
    
    console.log('âœ… ç°¡åŒ–çš„æ•¸å­—è¼¸å…¥æ¬„ä½æ ¼å¼åŒ–åˆå§‹åŒ–å®Œæˆï¼ˆç„¡åƒä½åˆ†éš”ç¬¦ï¼‰');
}

// é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–æ•¸å­—æ ¼å¼åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ ç¾é‡‘ç®¡ç†é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
    
    // å»¶é²åˆå§‹åŒ–ï¼Œç¢ºä¿æ‰€æœ‰æ¨¡æ…‹æ¡†éƒ½å·²è¼‰å…¥
    setTimeout(() => {
        initializeNumberFormatting();
    }, 100);
    
    // ç•¶æ¨¡æ…‹æ¡†é¡¯ç¤ºæ™‚ï¼Œé‡æ–°åˆå§‹åŒ–æ•¸å­—æ ¼å¼åŒ–
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        modal.addEventListener('shown.bs.modal', function() {
            console.log('ğŸ”„ æ¨¡æ…‹æ¡†é¡¯ç¤ºï¼Œé‡æ–°åˆå§‹åŒ–æ•¸å­—æ ¼å¼åŒ–...');
            setTimeout(() => {
                initializeNumberFormatting();
            }, 50);
        });
    });
});

// å¾…ä»˜æ¬¾é …éŠ·å¸³åŠŸèƒ½
window.openPendingPaymentModal = function(pendingId, purchaseRecordId, amount, channelName) {
    console.log('æ‰“é–‹å¾…ä»˜æ¬¾é …éŠ·å¸³æ¨¡æ…‹æ¡†:', { pendingId, purchaseRecordId, amount, channelName });
    
    // å‰µå»ºå‹•æ…‹æ¨¡æ…‹æ¡†
    const modalHtml = `
        <div class="modal fade" id="pendingPaymentModal" tabindex="-1" aria-labelledby="pendingPaymentModalLabel">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="pendingPaymentModalLabel">
                            <i class="bi bi-credit-card me-2"></i>å¾…ä»˜æ¬¾é …éŠ·å¸³
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é—œé–‰"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <h6><strong>ä»˜æ¬¾è³‡è¨Š</strong></h6>
                            <p><strong>è²·å…¥è¨˜éŒ„ID:</strong> #${purchaseRecordId}</p>
                            <p><strong>æ¸ é“:</strong> ${channelName}</p>
                            <p><strong>å¾…ä»˜é‡‘é¡:</strong> NT$ ${amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</p>
                        </div>
                        
                        <form id="pendingPaymentForm">
                            <div class="mb-3">
                                <label for="paymentAccountSelect" class="form-label">
                                    <strong>å¾å“ªå€‹ TWD å¸³æˆ¶ä»˜æ¬¾</strong>
                                </label>
                                <select class="form-select" id="paymentAccountSelect" required>
                                    <option value="" disabled selected>--- è«‹é¸æ“‡ä»˜æ¬¾å¸³æˆ¶ ---</option>
                                    <!-- å°‡ç”± JavaScript å‹•æ…‹å¡«å…… -->
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="settlementAmount" class="form-label">
                                    <strong>éŠ·å¸³é‡‘é¡ (TWD)</strong>
                                </label>
                                <input type="text" class="form-control" id="settlementAmount" 
                                       value="${amount}" pattern="[0-9]*\.?[0-9]*" required>
                                <small class="text-muted">è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—é‡‘é¡</small>
                            </div>
                            
                            <div class="mb-3">
                                <label for="settlementNote" class="form-label">
                                    <strong>å‚™è¨» (é¸å¡«)</strong>
                                </label>
                                <textarea class="form-control" id="settlementNote" rows="3" 
                                          placeholder="è¼¸å…¥ä»˜æ¬¾ç›¸é—œå‚™è¨»..."></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                        <button type="button" class="btn btn-warning" onclick="executePendingPaymentSettlement('${pendingId}', ${amount})">
                            <i class="bi bi-credit-card me-1"></i>ç¢ºèªä»˜æ¬¾
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // ç§»é™¤ç¾æœ‰çš„æ¨¡æ…‹æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    const existingModal = document.getElementById('pendingPaymentModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // æ·»åŠ æ¨¡æ…‹æ¡†åˆ°é é¢
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // å¡«å……ä»˜æ¬¾å¸³æˆ¶é¸é …
    populatePaymentAccounts();
    
    // å»¶é²é¡¯ç¤ºæ¨¡æ…‹æ¡†ï¼Œç¢ºä¿ DOM å·²æ›´æ–°
    setTimeout(() => {
        const modalElement = document.getElementById('pendingPaymentModal');
        const modal = new bootstrap.Modal(modalElement);
        
        // ç«‹å³åˆå§‹åŒ–æ•¸å­—æ ¼å¼åŒ–ï¼ˆåœ¨æ¨¡æ…‹æ¡†é¡¯ç¤ºå‰ï¼‰
        const settlementAmountInput = document.getElementById('settlementAmount');
        if (settlementAmountInput) {
            console.log('ğŸ” æ¨¡æ…‹æ¡†å‰µå»ºæ™‚ç«‹å³åˆå§‹åŒ–æ•¸å­—æ ¼å¼åŒ–:', {
                originalValue: settlementAmountInput.value,
                expectedAmount: '${amount}',
                hasGetActualValue: !!settlementAmountInput.getActualValue
            });
            
            // æ‰‹å‹•åˆå§‹åŒ–æ•¸å­—æ ¼å¼åŒ–
            if (typeof setupNumberInputFormatting === 'function') {
                try {
                    setupNumberInputFormatting(settlementAmountInput, { maxDecimals: 2 });
                    console.log('âœ… éŠ·å¸³é‡‘é¡è¼¸å…¥æ¡†æ•¸å­—æ ¼å¼åŒ–å·²ç«‹å³æ‡‰ç”¨');
                } catch (error) {
                    console.error('âŒ setupNumberInputFormatting åŸ·è¡Œå¤±æ•—:', error);
                    // æ‰‹å‹•å‰µå»º getActualValue æ–¹æ³•ä½œç‚ºå‚™ç”¨
                    settlementAmountInput.getActualValue = function() {
                        return this.value;
                    };
                }
            } else {
                console.warn('âš ï¸ setupNumberInputFormatting å‡½æ•¸ä¸å­˜åœ¨ï¼Œå˜—è©¦æ‰‹å‹•å‰µå»º');
                // æ‰‹å‹•å‰µå»º getActualValue æ–¹æ³•ä½œç‚ºå‚™ç”¨
                settlementAmountInput.getActualValue = function() {
                    return this.value;
                };
            }
            
            // é©—è­‰åˆå§‹åŒ–çµæœ
            setTimeout(() => {
                console.log('ğŸ” åˆå§‹åŒ–å¾Œæª¢æŸ¥:', {
                    hasGetActualValue: !!settlementAmountInput.getActualValue,
                    value: settlementAmountInput.value,
                    getActualValue: settlementAmountInput.getActualValue ? settlementAmountInput.getActualValue() : 'N/A'
                });
            }, 50);
        }
        
        // æ·»åŠ äº‹ä»¶ç›£è½å™¨ç¢ºä¿æ­£ç¢ºçš„ aria-hidden ç‹€æ…‹
        modalElement.addEventListener('shown.bs.modal', function () {
            this.setAttribute('aria-hidden', 'false');
            this.setAttribute('aria-modal', 'true');
            
            // ç‚ºéŠ·å¸³é‡‘é¡è¼¸å…¥æ¡†æ‡‰ç”¨æ•¸å­—æ ¼å¼åŒ–
            const settlementAmountInput = document.getElementById('settlementAmount');
            if (settlementAmountInput) {
                console.log('ğŸ” æ¨¡æ…‹æ¡†é¡¯ç¤ºæ™‚çš„åˆå§‹å€¼:', {
                    originalValue: settlementAmountInput.value,
                    expectedAmount: '${amount}',
                    hasGetActualValue: !!settlementAmountInput.getActualValue
                });
                
                // ç¢ºä¿æ•¸å­—æ ¼å¼åŒ–è¢«æ­£ç¢ºæ‡‰ç”¨
                if (typeof setupNumberInputFormatting === 'function') {
                    setupNumberInputFormatting(settlementAmountInput, { maxDecimals: 2 });
                    console.log('âœ… éŠ·å¸³é‡‘é¡è¼¸å…¥æ¡†æ•¸å­—æ ¼å¼åŒ–å·²æ‡‰ç”¨');
                } else {
                    console.warn('âš ï¸ setupNumberInputFormatting å‡½æ•¸ä¸å­˜åœ¨');
                }
                
                // é©—è­‰ getActualValue æ–¹æ³•æ˜¯å¦å­˜åœ¨
                setTimeout(() => {
                    console.log('ğŸ” å»¶é²æª¢æŸ¥ getActualValue:', {
                        hasGetActualValue: !!settlementAmountInput.getActualValue,
                        value: settlementAmountInput.value
                    });
                }, 100);
            }
        });
        
        modalElement.addEventListener('hidden.bs.modal', function () {
            this.setAttribute('aria-hidden', 'true');
            this.removeAttribute('aria-modal');
            // æ¸…ç†æ¨¡æ…‹æ¡†
            this.remove();
        });
        
        modal.show();
    }, 100);
};

// å¡«å……ä»˜æ¬¾å¸³æˆ¶é¸é …
function populatePaymentAccounts() {
    const paymentAccountSelect = document.getElementById('paymentAccountSelect');
    if (!paymentAccountSelect) return;
    
    console.log('ğŸ” é–‹å§‹å¡«å……ä»˜æ¬¾å¸³æˆ¶é¸é …...');
    
    // æ¸…ç©ºç¾æœ‰é¸é …
    paymentAccountSelect.innerHTML = '<option value="" disabled selected>--- è«‹é¸æ“‡ä»˜æ¬¾å¸³æˆ¶ ---</option>';
    
    // å¾ accountsByHolder æ•¸æ“šä¸­ç²å– TWD å¸³æˆ¶
    if (typeof window.accountsByHolder !== 'undefined' && window.accountsByHolder) {
        let twdAccountCount = 0;
        
        Object.keys(window.accountsByHolder).forEach(holderId => {
            const holderData = window.accountsByHolder[holderId];
            if (holderData && holderData.accounts) {
                holderData.accounts.forEach(account => {
                    if (account.currency === 'TWD') {
                        const option = document.createElement('option');
                        option.value = account.id;
                        option.textContent = `${account.name} (é¤˜é¡: ${account.currency} ${account.balance.toLocaleString()})`;
                        paymentAccountSelect.appendChild(option);
                        twdAccountCount++;
                        console.log('âœ… æ·»åŠ  TWD å¸³æˆ¶:', account.name, 'é¤˜é¡:', account.balance);
                    }
                });
            }
        });
        
        console.log(`âœ… æˆåŠŸæ·»åŠ  ${twdAccountCount} å€‹ TWD å¸³æˆ¶åˆ°ä»˜æ¬¾é¸é …`);
    } else {
        console.error('âŒ ç„¡æ³•ç²å– accountsByHolder æ•¸æ“š');
        // æ·»åŠ éŒ¯èª¤æç¤ºé¸é …
        const errorOption = document.createElement('option');
        errorOption.value = '';
        errorOption.textContent = '--- ç„¡æ³•è¼‰å…¥å¸³æˆ¶æ•¸æ“š ---';
        errorOption.disabled = true;
        paymentAccountSelect.appendChild(errorOption);
    }
}

// åŸ·è¡Œå¾…ä»˜æ¬¾é …éŠ·å¸³
window.executePendingPaymentSettlement = async function(pendingId, originalAmount) {
    const paymentAccountId = document.getElementById('paymentAccountSelect').value;
    
    // æ­£ç¢ºè™•ç†æ•¸å­—è¼¸å…¥
    const settlementAmountInput = document.getElementById('settlementAmount');
    let settlementAmount;
    
    console.log('ğŸ” éŠ·å¸³é‡‘é¡è¼¸å…¥æ¡†ä¿¡æ¯:', {
        type: settlementAmountInput.type,
        value: settlementAmountInput.value,
        valueLength: settlementAmountInput.value.length,
        valueCharCodes: settlementAmountInput.value.split('').map(c => c.charCodeAt(0)),
        hasGetActualValue: !!settlementAmountInput.getActualValue
    });
    
    // æ¸¬è©¦ parseFloat æ˜¯å¦æ­£å¸¸å·¥ä½œ
    console.log('ğŸ” parseFloat æ¸¬è©¦:', {
        'parseFloat("1200")': parseFloat("1200"),
        'parseFloat("test")': parseFloat("test"),
        'parseFloat("")': parseFloat(""),
        'typeof parseFloat': typeof parseFloat,
        'parseFloat.toString()': parseFloat.toString().substring(0, 100)
    });
    
    // å„ªå…ˆä½¿ç”¨ getActualValue æ–¹æ³•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå¦å‰‡ç›´æ¥è§£æ value
    if (settlementAmountInput.getActualValue) {
        const actualValue = settlementAmountInput.getActualValue();
        console.log('ğŸ” ä½¿ç”¨ getActualValue æ–¹æ³•:', {
            rawValue: actualValue,
            type: typeof actualValue,
            length: actualValue ? actualValue.length : 0,
            charCodes: actualValue ? actualValue.split('').map(c => c.charCodeAt(0)) : []
        });
        
        // å˜—è©¦å¤šç¨®è§£ææ–¹å¼
        settlementAmount = parseFloat(actualValue);
        console.log('ğŸ” parseFloat çµæœ:', settlementAmount);
        
        if (isNaN(settlementAmount)) {
            console.warn('âš ï¸ parseFloat å¤±æ•—ï¼Œå˜—è©¦ Number()');
            settlementAmount = Number(actualValue);
            console.log('ğŸ” Number() çµæœ:', settlementAmount);
        }
        
        if (isNaN(settlementAmount)) {
            console.warn('âš ï¸ Number() ä¹Ÿå¤±æ•—ï¼Œå˜—è©¦ä¸€å…ƒåŠ è™Ÿé‹ç®—ç¬¦');
            settlementAmount = +actualValue;
            console.log('ğŸ” ä¸€å…ƒåŠ è™Ÿçµæœ:', settlementAmount);
        }
        
        // æœ€å¾Œçš„å‚™ç”¨æ–¹æ¡ˆï¼šæ‰‹å‹•è§£æ
        if (isNaN(settlementAmount)) {
            console.warn('âš ï¸ æ‰€æœ‰è§£ææ–¹å¼éƒ½å¤±æ•—ï¼Œå˜—è©¦æ‰‹å‹•è§£æ');
            const cleanValue = actualValue.replace(/[^\d.-]/g, '');
            if (cleanValue) {
                settlementAmount = parseFloat(cleanValue);
                console.log('ğŸ” æ‰‹å‹•è§£æçµæœ:', settlementAmount);
            }
        }
    } else {
        // ç§»é™¤æ ¼å¼åŒ–å­—ç¬¦å¾Œè§£æ
        const rawValue = settlementAmountInput.value.replace(/[^0-9.-]/g, '');
        console.log('ğŸ” ä½¿ç”¨ç›´æ¥è§£ææ–¹æ³•:', rawValue);
        
        settlementAmount = parseFloat(rawValue);
        if (isNaN(settlementAmount)) {
            settlementAmount = Number(rawValue);
        }
        if (isNaN(settlementAmount)) {
            settlementAmount = +rawValue;
        }
    }
    
    // å¦‚æœè§£æå¤±æ•—ï¼Œå˜—è©¦æ›´å¯¬é¬†çš„è§£ææ–¹å¼
    if (isNaN(settlementAmount)) {
        console.warn('âš ï¸ æ¨™æº–è§£æå¤±æ•—ï¼Œå˜—è©¦æ›´å¯¬é¬†çš„è§£æ');
        const fallbackValue = settlementAmountInput.value.replace(/[^\d.-]/g, '');
        settlementAmount = parseFloat(fallbackValue);
        console.log('ğŸ” å¯¬é¬†è§£æçµæœ:', settlementAmount);
        
        // å¦‚æœé‚„æ˜¯å¤±æ•—ï¼Œå˜—è©¦æœ€å¯¬é¬†çš„è§£æ
        if (isNaN(settlementAmount)) {
            console.warn('âš ï¸ å¯¬é¬†è§£æä¹Ÿå¤±æ•—ï¼Œå˜—è©¦æœ€å¯¬é¬†çš„è§£æ');
            const ultraFallbackValue = settlementAmountInput.value.replace(/[^\d]/g, '');
            settlementAmount = parseFloat(ultraFallbackValue);
            console.log('ğŸ” æœ€å¯¬é¬†è§£æçµæœ:', settlementAmount);
        }
        
        // æœ€çµ‚å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥å¾å­—ç¬¦ä¸²æ§‹å»ºæ•¸å­—
        if (isNaN(settlementAmount)) {
            console.warn('âš ï¸ æ‰€æœ‰è§£æéƒ½å¤±æ•—ï¼Œå˜—è©¦å­—ç¬¦ä¸²æ§‹å»º');
            const digitsOnly = settlementAmountInput.value.replace(/[^\d]/g, '');
            if (digitsOnly) {
                settlementAmount = parseInt(digitsOnly, 10);
                console.log('ğŸ” å­—ç¬¦ä¸²æ§‹å»ºçµæœ:', settlementAmount);
            }
        }
    }
    
    console.log('ğŸ” è§£æå¾Œçš„éŠ·å¸³é‡‘é¡:', settlementAmount);
    console.log('ğŸ” åŸå§‹å¾…ä»˜é‡‘é¡:', originalAmount);
    console.log('ğŸ” æ¯”è¼ƒçµæœ:', {
        settlementAmount: settlementAmount,
        originalAmount: originalAmount,
        isGreater: settlementAmount > originalAmount,
        comparison: `${settlementAmount} > ${originalAmount} = ${settlementAmount > originalAmount}`
    });
    
    const settlementNote = document.getElementById('settlementNote').value.trim();
    
    if (!paymentAccountId) {
        Swal.fire('éŒ¯èª¤', 'è«‹é¸æ“‡ä»˜æ¬¾å¸³æˆ¶', 'error');
        return;
    }
    
    if (!settlementAmount || settlementAmount <= 0 || isNaN(settlementAmount)) {
        console.error('âŒ éŠ·å¸³é‡‘é¡é©—è­‰å¤±æ•—:', { settlementAmount, isNaN: isNaN(settlementAmount) });
        Swal.fire('éŒ¯èª¤', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„éŠ·å¸³é‡‘é¡', 'error');
        return;
    }
    
    if (settlementAmount > originalAmount) {
        console.error('âŒ éŠ·å¸³é‡‘é¡è¶…éå¾…ä»˜é‡‘é¡:', {
            settlementAmount,
            originalAmount,
            difference: settlementAmount - originalAmount
        });
        Swal.fire('éŒ¯èª¤', 'éŠ·å¸³é‡‘é¡ä¸èƒ½è¶…éå¾…ä»˜é‡‘é¡', 'error');
        return;
    }
    
    // ç¢ºèªå°è©±æ¡†
    const result = await Swal.fire({
        title: 'ç¢ºèªä»˜æ¬¾',
        html: `
            <div class="text-start">
                <p><strong>å¾…ä»˜æ¬¾é …ID:</strong> #${pendingId}</p>
                <p><strong>éŠ·å¸³é‡‘é¡:</strong> NT$ ${settlementAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}</p>
                <p><strong>å‚™è¨»:</strong> ${settlementNote || 'ç„¡'}</p>
            </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'ç¢ºèªä»˜æ¬¾',
        cancelButtonText: 'å–æ¶ˆ'
    });
    
    if (!result.isConfirmed) return;
    
    try {
        const response = await fetch('/api/settle-pending-payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                pending_id: pendingId,
                payment_account_id: parseInt(paymentAccountId),
                settlement_amount: settlementAmount,
                note: settlementNote
            })
        });
        
        const responseData = await response.json();
        
        if (responseData.status === 'success') {
            Swal.fire('æˆåŠŸ', responseData.message, 'success').then(() => {
                // é—œé–‰æ¨¡æ…‹æ¡†
                const modal = bootstrap.Modal.getInstance(document.getElementById('pendingPaymentModal'));
                if (modal) modal.hide();
                
                // é‡æ–°è¼‰å…¥é é¢ä»¥æ›´æ–°æ•¸æ“š
                window.location.reload();
            });
        } else {
            Swal.fire('éŒ¯èª¤', responseData.message, 'error');
        }
    } catch (error) {
        console.error('éŠ·å¸³è«‹æ±‚å¤±æ•—:', error);
        Swal.fire('éŒ¯èª¤', 'ç¶²è·¯è«‹æ±‚å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
    }
};

// ===================================================================
// åˆ©æ½¤ç®¡ç†åŠŸèƒ½
// ===================================================================

let currentProfitAccountId = null;
let currentProfitAccountName = null;

// åˆ©æ½¤ç®¡ç†æŒ‰éˆ•é»æ“Šäº‹ä»¶
document.addEventListener('click', function(e) {
    if (e.target.closest('#btnOpenGlobalProfit')) {
        // å…¨åŸŸåˆ©æ½¤å…¥å£ï¼šä¸ç¶å®šç‰¹å®šå¸³æˆ¶ï¼Œåƒ…é–‹å•Ÿæ¨¡æ…‹æ¡†èˆ‡æ­·å²
        currentProfitAccountId = null;
        currentProfitAccountName = '';
        openProfitManagementModal();
    }
});

// è®Šæ›´é¸æ“‡ä¹‹å¸³æˆ¶
document.addEventListener('change', function(e){
    if (e.target && e.target.id === 'profitAccountSelect'){
        const select = e.target;
        const selectedId = select.value ? parseInt(select.value) : null;
        currentProfitAccountId = selectedId;
        const selectedOption = select.options[select.selectedIndex];
        const nameText = selectedOption ? selectedOption.textContent : '';
        const balance = selectedOption ? parseFloat(selectedOption.dataset.profitBalance || '0') : 0;
        currentProfitAccountName = nameText;
        document.getElementById('profitAccountName').value = nameText;
        document.getElementById('profitCurrentBalance').value = balance.toLocaleString('en-US', {minimumFractionDigits: 2});
        // é‡æ–°è¼‰å…¥æ­·å²
        loadProfitHistory();
    }
});

// æ‰“é–‹åˆ©æ½¤ç®¡ç†æ¨¡æ…‹æ¡†
function openProfitManagementModal() {
    // è¼‰å…¥ç¸½åˆ©æ½¤
    fetch('/api/total-profit')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                document.getElementById('totalSystemProfit').innerText = `NT$ ${data.data.total_profit_twd.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            } else {
                document.getElementById('totalSystemProfit').innerText = 'è¼‰å…¥å¤±æ•—';
            }
        })
        .catch(error => {
            console.error('Error fetching total profit:', error);
            document.getElementById('totalSystemProfit').innerText = 'è¼‰å…¥å¤±æ•—';
        });

    // è¼‰å…¥å¯ææ¬¾çš„åˆ©æ½¤ä¾†æºå¸³æˆ¶
    loadProfitSourceAccounts();
    
    // è¼‰å…¥æ‰€æœ‰ç¾é‡‘å¸³æˆ¶ä½œç‚ºè½‰å…¥ç›®æ¨™
    loadCashAccounts();
    
    // è¼‰å…¥åˆ©æ½¤æ›´å‹•ç´€éŒ„
    loadProfitHistory();
    
    // é¡¯ç¤ºæ¨¡æ…‹æ¡†
    const profitModal = new bootstrap.Modal(document.getElementById('profitManagementModal'));
    profitModal.show();
}

// è¼‰å…¥æœ‰åˆ©æ½¤é¤˜é¡çš„å¸³æˆ¶
function loadProfitSourceAccounts() {
    const sourceAccountSelect = document.getElementById('withdrawSourceAccount');
    sourceAccountSelect.innerHTML = '<option value="" selected disabled>è«‹é¸æ“‡åˆ©æ½¤ä¾†æºå¸³æˆ¶</option>';
    
    (window.ownerAccountsData || []).forEach(function(acc){
        if (acc.profit_balance > 0) {
            const option = document.createElement('option');
            option.value = acc.id;
            option.innerText = `${acc.name} (åˆ©æ½¤é¤˜é¡: NT$ ${acc.profit_balance.toLocaleString('en-US', {minimumFractionDigits: 2})})`;
            sourceAccountSelect.appendChild(option);
        }
    });
}

// è¼‰å…¥æ‰€æœ‰ç¾é‡‘å¸³æˆ¶
function loadCashAccounts() {
    const targetAccountSelect = document.getElementById('withdrawTargetAccount');
    targetAccountSelect.innerHTML = '<option value="" selected disabled>è«‹é¸æ“‡è½‰å…¥çš„ç¾é‡‘å¸³æˆ¶</option>';
    
    (window.ownerAccountsData || []).forEach(function(acc){
        const option = document.createElement('option');
        option.value = acc.id;
        option.innerText = `${acc.name} (${acc.currency})`;
        targetAccountSelect.appendChild(option);
    });
}

// éš±è—æ‰€æœ‰åˆ©æ½¤è¡¨å–®
function hideAllProfitForms() {
    document.getElementById('addProfitForm').style.display = 'none';
    document.getElementById('withdrawProfitForm').style.display = 'none';
    document.getElementById('adjustProfitForm').style.display = 'none';
}

// è¼‰å…¥åˆ©æ½¤æ­·å²
async function loadProfitHistory() {
    try {
        const accountQuery = currentProfitAccountId ? `?account_id=${currentProfitAccountId}&limit=20` : `?limit=20`;
        const response = await fetch(`/api/profit/history${accountQuery}`);
        const result = await response.json();
        
        const historyContainer = document.getElementById('profitHistoryTableContainer');
        
        if (result.status === 'success' && result.data.transactions.length > 0) {
            let historyHtml = '';
            result.data.transactions.forEach(transaction => {
                const amountClass = transaction.amount > 0 ? 'text-success' : 'text-danger';
                const amountSymbol = transaction.amount > 0 ? '+' : '';
                
                historyHtml += `
                    <div class="card mb-2">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <small class="fw-bold">${transaction.description || 'åˆ©æ½¤è®Šå‹•'}</small>
                                    <br>
                                    <small class="text-muted">${new Date(transaction.created_at).toLocaleString('zh-TW')}</small>
                                </div>
                                <div class="text-end">
                                    <div class="${amountClass} fw-bold">${amountSymbol}${transaction.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                                    <small class="text-muted">é¤˜é¡: ${transaction.balance_after.toLocaleString('en-US', {minimumFractionDigits: 2})}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            historyContainer.innerHTML = historyHtml;
        } else {
            historyContainer.innerHTML = '<div class="text-center text-muted">æš«ç„¡åˆ©æ½¤è®Šå‹•è¨˜éŒ„</div>';
        }
    } catch (error) {
        console.error('è¼‰å…¥åˆ©æ½¤æ­·å²å¤±æ•—:', error);
        document.getElementById('profitHistoryTableContainer').innerHTML = '<div class="text-center text-danger">è¼‰å…¥å¤±æ•—</div>';
    }
}

// æ–°çš„ææ¬¾è¡¨å–®æäº¤è™•ç†
document.getElementById('withdrawProfitForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const amount = parseFloat(document.getElementById('withdrawAmount').value);
    const sourceAccountId = document.getElementById('withdrawSourceAccount').value;
    const targetAccountId = document.getElementById('withdrawTargetAccount').value;
    
    if (!amount || !sourceAccountId || !targetAccountId) {
        Swal.fire('éŒ¯èª¤', 'è«‹å¡«å¯«æ‰€æœ‰ææ¬¾è³‡è¨Š', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/profit/withdraw', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                account_id: sourceAccountId,
                amount: amount,
                description: `åˆ©æ½¤ææ¬¾è½‰å…¥ç¾é‡‘å¸³æˆ¶`,
                note: `å¾åˆ©æ½¤å¸³æˆ¶ææ¬¾è½‰å…¥ç¾é‡‘å¸³æˆ¶`
            }),
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            Swal.fire('æˆåŠŸ', 'åˆ©æ½¤ææ¬¾æˆåŠŸï¼', 'success');
            // åˆ·æ–°æ•¸æ“š
            document.getElementById('withdrawProfitForm').reset();
            // é‡æ–°è¼‰å…¥é é¢æ•¸æ“š
            location.reload();
        } else {
            Swal.fire('éŒ¯èª¤', result.message || 'ææ¬¾å¤±æ•—', 'error');
        }
    } catch (error) {
        console.error('ææ¬¾éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error);
        Swal.fire('éŒ¯èª¤', 'ææ¬¾éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤', 'error');
    }
});

// åˆ©æ½¤æ“ä½œæŒ‰éˆ•äº‹ä»¶ (èˆŠçš„ï¼Œæš«æ™‚ä¿ç•™)
document.getElementById('btnAddProfit').addEventListener('click', function() {
    hideAllProfitForms();
    document.getElementById('addProfitForm').style.display = 'block';
});

document.getElementById('btnWithdrawProfit').addEventListener('click', function() {
    hideAllProfitForms();
    document.getElementById('withdrawProfitForm').style.display = 'block';
});

document.getElementById('btnAdjustProfit').addEventListener('click', function() {
    hideAllProfitForms();
    document.getElementById('adjustProfitForm').style.display = 'block';
});

// å–æ¶ˆæŒ‰éˆ•äº‹ä»¶
document.getElementById('cancelAddProfit').addEventListener('click', hideAllProfitForms);
document.getElementById('cancelWithdrawProfit').addEventListener('click', hideAllProfitForms);
document.getElementById('cancelAdjustProfit').addEventListener('click', hideAllProfitForms);

// å¢åŠ åˆ©æ½¤è¡¨å–®æäº¤
document.getElementById('addProfitFormData').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const amount = parseFloat(document.getElementById('addProfitAmount').value);
    const description = document.getElementById('addProfitDescription').value;
    const note = document.getElementById('addProfitNote').value;
    
    try {
        const response = await fetch('/api/profit/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                account_id: currentProfitAccountId,
                amount: amount,
                transaction_type: 'PROFIT_EARNED',
                description: description,
                note: note
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            Swal.fire('æˆåŠŸ', result.data.message, 'success');
            hideAllProfitForms();
            loadProfitHistory();
            // é‡æ–°è¼‰å…¥é é¢ä»¥æ›´æ–°é¡¯ç¤º
            location.reload();
        } else {
            Swal.fire('éŒ¯èª¤', result.message, 'error');
        }
    } catch (error) {
        console.error('å¢åŠ åˆ©æ½¤å¤±æ•—:', error);
        Swal.fire('éŒ¯èª¤', 'ç¶²è·¯è«‹æ±‚å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
    }
});

// æå–åˆ©æ½¤è¡¨å–®æäº¤
document.getElementById('withdrawProfitFormData').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const amount = parseFloat(document.getElementById('withdrawProfitAmount').value);
    const description = document.getElementById('withdrawProfitDescription').value;
    const note = document.getElementById('withdrawProfitNote').value;
    
    try {
        const response = await fetch('/api/profit/withdraw', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                account_id: currentProfitAccountId,
                amount: amount,
                description: description,
                note: note
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            Swal.fire('æˆåŠŸ', result.data.message, 'success');
            hideAllProfitForms();
            loadProfitHistory();
            // é‡æ–°è¼‰å…¥é é¢ä»¥æ›´æ–°é¡¯ç¤º
            location.reload();
        } else {
            Swal.fire('éŒ¯èª¤', result.message, 'error');
        }
    } catch (error) {
        console.error('æå–åˆ©æ½¤å¤±æ•—:', error);
        Swal.fire('éŒ¯èª¤', 'ç¶²è·¯è«‹æ±‚å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
    }
});

// èª¿æ•´åˆ©æ½¤è¡¨å–®æäº¤
document.getElementById('adjustProfitFormData').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const newBalance = parseFloat(document.getElementById('adjustProfitNewBalance').value);
    const description = document.getElementById('adjustProfitDescription').value;
    const note = document.getElementById('adjustProfitNote').value;
    
    try {
        const response = await fetch('/api/profit/adjust', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                account_id: currentProfitAccountId,
                new_balance: newBalance,
                description: description,
                note: note
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            Swal.fire('æˆåŠŸ', result.data.message, 'success');
            hideAllProfitForms();
            loadProfitHistory();
            // é‡æ–°è¼‰å…¥é é¢ä»¥æ›´æ–°é¡¯ç¤º
            location.reload();
        } else {
            Swal.fire('éŒ¯èª¤', result.message, 'error');
        }
    } catch (error) {
        console.error('èª¿æ•´åˆ©æ½¤å¤±æ•—:', error);
        Swal.fire('éŒ¯èª¤', 'ç¶²è·¯è«‹æ±‚å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
    }
});

</script>

    <!-- åˆ©æ½¤ç®¡ç†æ¨¡æ…‹æ¡† -->
    <div class="modal fade" id="profitManagementModal" tabindex="-1" aria-labelledby="profitManagementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="profitManagementModalLabel">åˆ©æ½¤ç®¡ç†</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 1. é¡¯ç¤ºåˆ©æ½¤ç¸½é¡ -->
                    <div class="card mb-3 bg-info bg-opacity-10 border-info">
                        <div class="card-body">
                            <h5 class="card-title text-info"><i class="bi bi-wallet2 me-2"></i>ç³»çµ±åˆ©æ½¤ç¸½é¡</h5>
                            <p class="card-text fs-3 text-info fw-bold" id="totalSystemProfit">NT$ 0.00</p>
                            <small class="text-muted">æ­¤ç‚ºæ‰€æœ‰å·²çµæ¸…éŠ·å”®çš„ç´¯ç©åˆ©æ½¤</small>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-lg-5 border-end pe-lg-4">
                            <!-- 2. ææ¬¾åˆ©æ½¤ -->
                            <h5 class="mb-3"><i class="bi bi-cash-coin me-2"></i>æå–åˆ©æ½¤</h5>
                            <form id="withdrawProfitForm">
                                <div class="mb-3">
                                    <label for="withdrawAmount" class="form-label">ææ¬¾é‡‘é¡</label>
                                    <input type="number" class="form-control" id="withdrawAmount" step="0.01" min="0" required>
                                </div>
                                <div class="mb-3">
                                    <label for="withdrawSourceAccount" class="form-label">å¾å“ªå€‹åˆ©æ½¤å¸³æˆ¶ææ¬¾</label>
                                    <select class="form-select" id="withdrawSourceAccount" required>
                                        <option value="" selected disabled>è«‹é¸æ“‡åˆ©æ½¤ä¾†æºå¸³æˆ¶</option>
                                        <!-- Options will be loaded dynamically from accounts with profit_balance > 0 -->
                                    </select>
                                    <small class="form-text text-muted">åƒ…é¡¯ç¤ºæœ‰åˆ©æ½¤é¤˜é¡çš„å¸³æˆ¶</small>
                                </div>
                                <div class="mb-3">
                                    <label for="withdrawTargetAccount" class="form-label">è½‰å…¥å“ªå€‹ç¾é‡‘å¸³æˆ¶</label>
                                    <select class="form-select" id="withdrawTargetAccount" required>
                                        <option value="" selected disabled>è«‹é¸æ“‡è½‰å…¥çš„ç¾é‡‘å¸³æˆ¶</option>
                                        <!-- Options will be loaded dynamically from all cash accounts -->
                                    </select>
                                    <small class="form-text text-muted">åˆ©æ½¤å°‡è½‰å…¥æ­¤ç¾é‡‘å¸³æˆ¶</small>
                                </div>
                                <button type="submit" class="btn btn-primary w-100 mt-3">ç¢ºèªææ¬¾</button>
                            </form>

                            <hr class="my-4">

                            <!-- èª¿æ•´é¤˜é¡ (ç®¡ç†å“¡å¯è¦‹ï¼Œæš«æ™‚éš±è—) -->
                            <div class="d-grid gap-2 d-none">
                                <button type="button" class="btn btn-outline-success" id="addProfitBtn">å¢åŠ åˆ©æ½¤</button>
                                <button type="button" class="btn btn-outline-info" id="adjustProfitBtn">èª¿æ•´é¤˜é¡</button>
                            </div>
                        </div>

                        <div class="col-lg-7 ps-lg-4">
                            <!-- 3. é¡¯ç¤ºåˆ©æ½¤æ›´å‹•çš„äº¤æ˜“ç´€éŒ„ -->
                            <h5 class="mb-3"><i class="bi bi-list-ul me-2"></i>åˆ©æ½¤æ›´å‹•ç´€éŒ„</h5>
                            <div id="profitHistoryTableContainer">
                                <p class="text-muted text-center">è¼‰å…¥ä¸­...</p>
                                <!-- Profit history table will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¢å¼·æ•¸å­—è¼¸å…¥è…³æœ¬å·²åœ¨ base.html å…¨åŸŸå¼•å…¥ï¼Œé€™è£¡ä¸é‡è¤‡è¼‰å…¥ -->
{% endblock %}