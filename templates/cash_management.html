{% extends "base.html" %}

{% block title %}現金管理{% endblock %}

{% block content %}
<div class="container-fluid">
    <style>
        /* 小螢幕刪除按鈕與排版優化 */
        .delete-account-btn {
            width: 28px;
            height: 28px;
            padding: 0;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .delete-account-btn i {
            font-size: 16px;
            line-height: 1;
        }
        .btn-movement {
            line-height: 1;
        }
        /* 調整餘額在較小螢幕下的最小寬度，避免因擠壓導致溢出 */
        @media (max-width: 400px) {
            .account-balance {
                min-width: 90px !important;
            }
        }
    </style>
    <!-- 標題行 -->
    <div class="row align-items-center mb-4">
        <div class="col">
            <h2 class="fw-light mb-0">
                <i class="bi bi-cash-stack me-2"></i>現金管理
            </h2>
        </div>
    </div>

    <!-- 總資產概覽 -->
    <div class="card shadow-sm mb-4">
        <div class="card-body text-center">
            <div class="row">
                <div class="col-md-4 border-end">
                    <h5 class="text-primary mb-1">總台幣</h5>
                    <h3 class="fw-bold text-primary" id="totalTwdDisplay">NT$ {{ "{:,.2f}".format(total_twd) }}</h3>
                </div>
                <div class="col-md-4 border-end">
                    <h5 class="text-success mb-1">總人民幣</h5>
                    <h3 class="fw-bold text-success" id="totalRmbDisplay">¥ {{ "{:,.2f}".format(total_rmb) }}</h3>
                </div>
                <div class="col-md-4">
                    <h5 class="text-danger mb-1">應收帳款</h5>
                    <h3 class="fw-bold text-danger" id="totalReceivablesDisplay">NT$ {{ "{:,.2f}".format(total_receivables_twd) }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- 操作區塊 -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex gap-2 justify-content-center">
                <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addHolderModal">
                    <i class="bi bi-person-plus me-1"></i>新增持有人
                </button>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addAccountModal">
                    <i class="bi bi-plus-circle me-1"></i>新增帳戶
                </button>
                <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#transferModal">
                    <i class="bi bi-arrow-left-right me-1"></i>內部轉帳
                </button>
                <button class="btn btn-secondary btn-sm" onclick="manualRefreshData()">
                    <i class="bi bi-arrow-clockwise me-1"></i>刷新數據
                </button>
            </div>
        </div>
    </div>

    <!-- 資金持有人與帳戶區塊 -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0 fw-light">
                <i class="bi bi-people me-2"></i>資金持有人與帳戶
                <small class="text-muted">（共 {{ holders|length }} 位持有人）</small>
            </h5>
        </div>
        <div class="card-body">
            <div class="row" id="accounts-container">
                <!-- JavaScript 將會動態填充這裡 -->
            </div>
        </div>
    </div>

    <!-- 應收帳款管理區塊 -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0 fw-light">
                <i class="bi bi-receipt me-2"></i>應收帳款管理
                <small class="text-muted">（共 {{ customers_with_receivables|length }} 筆）</small>
            </h5>
        </div>
        <div class="card-body p-0">
            {% if customers_with_receivables %}
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-3">客戶名稱</th>
                            <th class="text-end">應收金額</th>
                            <th class="text-center">操作</th>
                            <th class="pe-3">說明</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for customer in customers_with_receivables %}
                        <tr>
                            <td class="ps-3">
                                <a href="javascript:void(0)" class="text-decoration-none customer-transactions" 
                                   data-customer-id="{{ customer.id }}" data-customer-name="{{ customer.name }}" data-customer-receivable="{{ customer.total_receivables_twd }}">
                                    {{ customer.name }}
                                </a>
                            </td>
                            <td class="text-end">
                                <span class="fw-bold text-danger">NT$ {{ "{:,.2f}".format(customer.total_receivables_twd) }}</span>
                            </td>
                            <td class="text-center">
                                <button class="btn btn-success btn-sm" onclick="openSettlementModal('{{ customer.id }}', '{{ customer.name }}', {{ customer.total_receivables_twd }})">
                                    <i class="bi bi-check-circle me-1"></i>銷帳
                                </button>
                            </td>
                            <td class="pe-3">
                                <small class="text-muted">點擊客戶名稱查看交易紀錄</small>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center p-4 text-muted">
                <i class="bi bi-inbox fs-1"></i>
                <p class="mt-2">尚無應收帳款</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- 資金流水區塊 -->
    <div class="card shadow-sm mt-4">
        <div class="card-header">
            <h5 class="mb-0 fw-light"><i class="bi bi-graph-up-arrow me-2"></i>近期交易記錄</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-3">時間</th>
                            <th>類型</th>
                            <th>描述</th>
                            <th>操作人員</th>
                            <th>出款帳戶</th>
                            <th>入款帳戶</th>
                            <th>備註</th>
                            <th class="text-end" id="twd-header">TWD 變動</th>
                            <th class="text-end" id="rmb-header">RMB 變動</th>
                            <th class="text-end">累積餘額</th>
                            <th class="text-end pe-3">利潤</th>
                        </tr>
                    </thead>
                    <tbody id="movements-tbody">
                        <!-- JavaScript 將會動態填充這裡 -->
                    </tbody>
                </table>
            </div>
            
            <!-- 分頁控制項 -->
            <div class="card-footer">
                <div class="d-flex justify-content-between align-items-center">
                    <div id="pagination-info" class="text-muted">
                        <!-- 分頁信息將動態填充 -->
                    </div>
                    <nav aria-label="流水記錄分頁">
                        <ul class="pagination pagination-sm mb-0" id="pagination-controls">
                            <!-- 分頁按鈕將動態填充 -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 引用所有的操作模態框 -->
{% include '_cash_management_modals.html' %}

<!-- 將後端數據傳遞給JavaScript -->
<script type="application/json" id="cash-management-data"></script>
{% endblock %}

{% block scripts %}
<style>
/* 累積餘額列的樣式 */
.running-balance {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 6px;
    padding: 8px;
}

/* 交易行的樣式 */
.transaction-row {
    transition: all 0.2s ease;
}

.transaction-row:hover {
    background-color: #f8f9fa !important;
    transform: translateX(2px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    console.log('🚀 現金管理頁面載入完成，開始初始化...');
    
    // 兼容鍵名與空值工具
    function pick() {
        for (var i = 0; i < arguments.length; i++) {
            var v = arguments[i];
            if (v !== undefined && v !== null) return v;
        }
        return undefined;
    }

    // 從後端模板變數直接取得初始資料（避免 tojson 失敗）
    var accountsByHolder = {{ accounts_by_holder|tojson|safe if accounts_by_holder is defined else '{}' }};
    var holders = {{ holders|tojson|safe if holders is defined else '[]' }};
    var movements = {{ movements|tojson|safe if movements is defined else '[]' }};
    var customersList = [];
    
    console.log('📊 數據檢查:', { holders: holders, accountsByHolder: accountsByHolder, movements: movements });

    // 從 DOM 蒐集應收帳款列表，避免後端序列化模型物件失敗
    function refreshCustomersList() {
        try {
            customersList = Array.from(document.querySelectorAll('.customer-transactions')).map(function(a) {
                return {
                    id: parseInt(a.dataset.customerId),
                    name: a.dataset.customerName,
                    total_receivables_twd: parseFloat(a.dataset.customerReceivable || 0)
                };
            });
            console.log('🧾 已建立 customersList:', customersList);
        } catch (e) {
            console.warn('無法建立 customersList:', e);
            customersList = [];
        }
    }
    refreshCustomersList();
    
    // 將帳戶數據轉換為平面數組供模態框使用
    window.ownerAccountsData = [];
    
    // 從 accountsByHolder 結構中提取所有帳戶
    Object.keys(accountsByHolder).forEach(holderId => {
        const holderData = accountsByHolder[holderId];
        if (holderData && holderData.accounts) {
            holderData.accounts.forEach(account => {
                window.ownerAccountsData.push({
                    id: account.id,
                    name: account.name,
                    currency: account.currency,
                    holder_id: parseInt(holderId)
                });
            });
        }
    });
    
    console.log('🔧 保存帳戶數據到全局變量:', window.ownerAccountsData);
    
    // 獲取 DOM 元素
    const accountsContainer = document.getElementById('accounts-container');
    const movementsTbody = document.getElementById('movements-tbody');
    
    // 渲染帳戶列表
    function renderAccounts() {
        console.log('🔍 開始渲染帳戶列表...');
        
        if (!accountsContainer) {
            console.error('❌ 找不到 accounts-container 元素');
            return;
        }
        
        accountsContainer.innerHTML = '';
        
        if (!holders || holders.length === 0) {
            console.log('⚠️ 沒有持有人數據');
            accountsContainer.innerHTML = '<div class="col-12 text-center text-muted p-4">尚無資金持有人。</div>';
            return;
        }
        
        console.log('✅ 找到 ' + holders.length + ' 個持有人，開始渲染...');
        
        holders.forEach(function(holder, index) {
            const holderId = holder.id;
            const holderName = holder.name;
            const holderData = accountsByHolder[holderId];
            
            console.log('📋 渲染持有人 ' + (index + 1) + ': ' + holderName + ' (ID: ' + holderId + ')');
            
            let accountsHtml = '';
            let totalTwd = 0;
            let totalRmb = 0;
            
            if (holderData && holderData.accounts && holderData.accounts.length > 0) {
                console.log('📋 持有人 ' + holderName + ' 有 ' + holderData.accounts.length + ' 個帳戶');
                holderData.accounts.forEach(function(acc) {
                    const currencyBadgeClass = acc.currency === 'TWD' ? 'bg-primary' : 'bg-success';
                    const currencyTextClass = acc.currency === 'TWD' ? 'text-primary' : 'text-success';
                    
                    accountsHtml += '<li class="list-group-item py-2">';
                    accountsHtml += '<div class="d-flex justify-content-between align-items-center">';
                    
                    // 左側：貨幣標籤和帳戶名稱
                    accountsHtml += '<div class="d-flex align-items-center">';
                    accountsHtml += '<span class="badge ' + currencyBadgeClass + ' me-2" style="min-width: 50px;">' + acc.currency + '</span>';
                    accountsHtml += '<span class="fw-medium">' + acc.name + '</span>';
                    accountsHtml += '</div>';
                    
                    // 右側：金額和操作按鈕
                    accountsHtml += '<div class="d-flex align-items-center">';
                    accountsHtml += '<strong class="me-3 ' + currencyTextClass + ' account-balance" style="min-width: 120px; text-align: right;">' + acc.balance.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</strong>';
                    accountsHtml += '<div class="btn-group btn-group-sm">';
                    accountsHtml += '<button class="btn btn-outline-primary btn-movement btn-sm" data-account-id="' + acc.id + '" data-account-name="' + acc.name + '" title="存入/提出">';
                    accountsHtml += '<i class="bi bi-arrow-down-up"></i>';
                    accountsHtml += '</button>';
                    accountsHtml += '<button class="btn btn-outline-danger btn-sm delete-account-btn" data-account-id="' + acc.id + '" data-account-name="' + acc.name + '" title="刪除帳戶">';
                    accountsHtml += '<i class="bi bi-x-lg"></i>';
                    accountsHtml += '</button>';
                    accountsHtml += '</div>';
                    accountsHtml += '</div>';
                    
                    accountsHtml += '</div>';
                    accountsHtml += '</li>';
                });
                totalTwd = holderData.total_twd || 0;
                totalRmb = holderData.total_rmb || 0;
            } else {
                console.log('📋 持有人 ' + holderName + ' 沒有帳戶');
                accountsHtml = '<li class="list-group-item py-1 text-muted text-center small">-- 尚無帳戶 --</li>';
                totalTwd = 0;
                totalRmb = 0;
            }
            
            const subtotalFooter = '<div class="card-footer bg-light d-flex justify-content-around py-1">' +
                '<div><small class="text-muted">TWD:</small> <strong class="text-primary">' + totalTwd.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</strong></div>' +
                '<div><small class="text-muted">RMB:</small> <strong class="text-success">' + totalRmb.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</strong></div>' +
                '</div>';
            
            const holderCard = '<div class="col-lg-4 col-md-6 mb-2">' +
                '<div class="card shadow-sm h-100">' +
                '<div class="card-header py-2 d-flex justify-content-between align-items-center">' +
                '<strong class="h6 mb-0">' + holderName + '</strong>' +
                '<button class="btn btn-danger btn-sm py-0 px-2 delete-holder-btn" data-holder-id="' + holderId + '" data-holder-name="' + holderName + '">刪除</button>' +
                '</div>' +
                '<ul class="list-group list-group-flush">' + accountsHtml + '</ul>' +
                subtotalFooter +
                '</div>' +
                '</div>';
            
            accountsContainer.innerHTML += holderCard;
        });
        
        console.log('✅ 帳戶列表渲染完成');
        
        // 重新設置事件監聽器
        setupEventListeners();
    }
    
    // 設置事件監聽器
    function setupEventListeners() {
        // 設置出入帳按鈕事件
        const movementButtons = document.querySelectorAll('.btn-movement');
        movementButtons.forEach(button => {
            button.addEventListener('click', function() {
                const accountId = this.getAttribute('data-account-id');
                const accountName = this.getAttribute('data-account-name');
                openMovementModal(accountId, accountName);
            });
        });
        
        // 設置刪除帳戶按鈕事件
        const deleteAccountButtons = document.querySelectorAll('.delete-account-btn');
        deleteAccountButtons.forEach(button => {
            button.addEventListener('click', function() {
                const accountId = this.getAttribute('data-account-id');
                const accountName = this.getAttribute('data-account-name');
                deleteAccount(accountId, accountName);
            });
        });
        
        // 設置刪除持有人按鈕事件
        const deleteHolderButtons = document.querySelectorAll('.delete-holder-btn');
        deleteHolderButtons.forEach(button => {
            button.addEventListener('click', function() {
                const holderId = this.getAttribute('data-holder-id');
                const holderName = this.getAttribute('data-holder-name');
                deleteHolder(holderId, holderName);
            });
        });
        
        // 設置RMB匯率欄位的顯示/隱藏邏輯
        setupRmbRateFieldLogic();
        
        // 填充模態框中的下拉選單
        populateModalSelects();
    }
    
    // 填充下拉選單的通用函式
    function populateSelect(selectId, options) {
        const select = document.getElementById(selectId);
        if (!select) return;
        if (!Array.isArray(options)) {
            select.innerHTML = '<option value="" disabled selected>--- 數據載入錯誤 ---</option>';
            return;
        }
        select.innerHTML = '<option value="" disabled selected>--- 請選擇 ---</option>';
        options.forEach(opt => select.add(new Option(opt.text, opt.value)));
    }

    // 填充帶有分組的下拉選單
    function populateGroupedSelect(selectId, groupedOptions) {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = '<option value="" disabled selected>--- 請選擇帳戶 ---</option>';
        
        groupedOptions.forEach(group => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = group.holder_name; // 設定分組標題
            group.accounts.forEach(acc => {
                const optionText = `${acc.name} (${acc.currency})`;
                optgroup.appendChild(new Option(optionText, acc.id));
            });
            select.appendChild(optgroup);
        });
    }



    // 設置RMB匯率欄位的顯示/隱藏邏輯
    function setupRmbRateFieldLogic() {
        // 監聽操作類型選擇的變化
        const depositRadio = document.getElementById('movementDeposit');
        const withdrawRadio = document.getElementById('movementWithdraw');
        
        if (depositRadio && withdrawRadio) {
            depositRadio.addEventListener('change', function() {
                if (this.checked) {
                    // 選擇存款時，檢查是否需要顯示匯率欄位
                    const accountId = document.getElementById('movementAccountId')?.value;
                    if (accountId) {
                        checkAndShowRmbRateField(accountId);
                    }
                }
            });
            
            withdrawRadio.addEventListener('change', function() {
                if (this.checked) {
                    // 選擇提款時，隱藏匯率欄位
                    const rmbRateDiv = document.getElementById('rmbCostRateDiv');
                    if (rmbRateDiv) {
                        rmbRateDiv.style.display = 'none';
                        const rmbRateInput = document.getElementById('rmbCostRate');
                        if (rmbRateInput) {
                            rmbRateInput.required = false;
                            rmbRateInput.value = '';
                        }
                    }
                }
            });
        }
    }
    
    // 打開出入帳模態框
    function openMovementModal(accountId, accountName) {
        console.log('🔄 打開出入帳模態框:', accountId, accountName);
        
        // 設置模態框標題和帳戶信息
        const modalTitle = document.getElementById('movementModalTitle');
        
        if (modalTitle) modalTitle.textContent = `為「${accountName}」進行資金操作`;
        
        // 設置隱藏的帳戶ID
        const accountIdInput = document.getElementById('movementAccountId');
        if (accountIdInput) accountIdInput.value = accountId;
        
        // 檢查是否為RMB帳戶，如果是則顯示匯率欄位
        checkAndShowRmbRateField(accountId);
        
        // 顯示模態框
        const modal = new bootstrap.Modal(document.getElementById('addMovementModal'));
        modal.show();
    }
    
    // 檢查並顯示RMB匯率欄位
    function checkAndShowRmbRateField(accountId) {
        // 從帳戶數據中查找該帳戶的幣別
        let isRmbAccount = false;
        for (const holderId in accountsByHolder) {
            const holder = accountsByHolder[holderId];
            for (const account of holder.accounts) {
                if (account.id == accountId && account.currency === 'RMB') {
                    isRmbAccount = true;
                    break;
                }
            }
            if (isRmbAccount) break;
        }
        
        // 顯示或隱藏匯率欄位
        const rmbRateDiv = document.getElementById('rmbCostRateDiv');
        if (rmbRateDiv) {
            if (isRmbAccount) {
                rmbRateDiv.style.display = 'block';
                // 設置匯率欄位為必填
                const rmbRateInput = document.getElementById('rmbCostRate');
                if (rmbRateInput) {
                    rmbRateInput.required = true;
                    // 初始化數字格式化
                    setupNumberInputFormatting(rmbRateInput, { maxDecimals: 4 });
                }
            } else {
                rmbRateDiv.style.display = 'none';
                // 設置匯率欄位為非必填
                const rmbRateInput = document.getElementById('rmbCostRate');
                if (rmbRateInput) {
                    rmbRateInput.required = false;
                    rmbRateInput.value = '';
                }
            }
        }
    }
    
    // 刪除帳戶
    function deleteAccount(accountId, accountName) {
        console.log('🗑️ 刪除帳戶:', accountId, accountName);
        
        // 使用 SweetAlert2 進行二次確認
        Swal.fire({
            title: '確認刪除帳戶',
            html: `
                <div class="text-start">
                    <p><strong>帳戶名稱：</strong>${accountName}</p>
                    <p><strong>操作類型：</strong>永久刪除</p>
                    <div class="alert alert-warning mt-3">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>警告：</strong>此操作不可逆轉！
                    </div>
                </div>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: '確認刪除',
            cancelButtonText: '取消',
            reverseButtons: true,
            focusCancel: true
        }).then((result) => {
            if (result.isConfirmed) {
                // 第二次確認
                Swal.fire({
                    title: '最終確認',
                    html: `
                        <div class="text-start">
                            <p>您確定要刪除帳戶「<strong>${accountName}</strong>」嗎？</p>
                            <div class="alert alert-danger mt-3">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>此操作將：</strong>
                                <ul class="mt-2 mb-0">
                                    <li>永久刪除該帳戶</li>
                                    <li>無法恢復</li>
                                    <li>可能影響相關記錄</li>
                                </ul>
                            </div>
                        </div>
                    `,
                    icon: 'error',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: '是的，刪除它！',
                    cancelButtonText: '取消',
                    reverseButtons: true
                }).then((finalResult) => {
                    if (finalResult.isConfirmed) {
                        // 執行刪除操作
                        executeDeleteAccount(accountId, accountName);
                    }
                });
            }
        });
    }
    
    // 執行刪除帳戶操作
    function executeDeleteAccount(accountId, accountName) {
        // 顯示載入狀態
        Swal.fire({
            title: '正在刪除...',
            text: `正在刪除帳戶「${accountName}」`,
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        // 發送刪除請求
        fetch('/api/delete-account', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                account_id: accountId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: '刪除成功！',
                    text: `帳戶「${accountName}」已成功刪除`,
                    timer: 2000,
                    showConfirmButton: false
                });
                // 刷新頁面數據
                manualRefreshData();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: '刪除失敗',
                    text: data.message,
                    confirmButtonText: '確定'
                });
            }
        })
        .catch(error => {
            console.error('❌ 刪除帳戶時發生錯誤:', error);
            Swal.fire({
                icon: 'error',
                title: '刪除失敗',
                text: '請檢查網路連接或聯繫管理員',
                confirmButtonText: '確定'
            });
        });
    }
    
    // 填充下拉選單的通用函式
    function populateSelect(selectId, options) {
        const select = document.getElementById(selectId);
        if (!select) return;
        if (!Array.isArray(options)) {
            select.innerHTML = '<option value="" disabled selected>--- 數據載入錯誤 ---</option>';
            return;
        }
        select.innerHTML = '<option value="" disabled selected>--- 請選擇 ---</option>';
        options.forEach(opt => select.add(new Option(opt.text, opt.value)));
    }

    // 填充帶有分組的下拉選單
    function populateGroupedSelect(selectId, groupedOptions) {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = '<option value="" disabled selected>--- 請選擇帳戶 ---</option>';
        
        groupedOptions.forEach(group => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = group.holder_name; // 設定分組標題
            group.accounts.forEach(acc => {
                const optionText = `${acc.name} (${acc.currency})`;
                optgroup.appendChild(new Option(optionText, acc.id));
            });
            select.appendChild(optgroup);
        });
    }

    // 填充模態框中的下拉選單
    function populateModalSelects() {
        console.log('🔧 開始填充模態框下拉選單...');
        
        // 填充新增帳戶模態框中的持有人下拉選單
        if (holders && holders.length > 0) {
            console.log('✅ 填充持有人下拉選單，找到', holders.length, '個持有人');
            populateSelect('accountHolder', holders.map(h => ({ value: h.id, text: h.name })));
        } else {
            console.log('⚠️ 沒有持有人數據可填充');
        }
        
        // 填充內部轉帳模態框中的帳戶下拉選單
        // 轉出帳戶：只顯示有餘額的帳戶
        const fromAccounts = [];
        if (accountsByHolder && Object.keys(accountsByHolder).length > 0) {
            Object.keys(accountsByHolder).forEach(holderId => {
                const holderData = accountsByHolder[holderId];
                if (holderData && holderData.accounts && holderData.accounts.length > 0) {
                    const accountsInGroup = holderData.accounts.filter(acc => acc.balance > 0); // 只顯示有餘額的帳戶
                    if (accountsInGroup.length > 0) {
                        fromAccounts.push({
                            holder_name: holderData.holder_name,
                            accounts: accountsInGroup
                        });
                    }
                }
            });
        }
        
        // 轉入帳戶：顯示所有帳戶（用於動態過濾）
        const allAccounts = [];
        if (accountsByHolder && Object.keys(accountsByHolder).length > 0) {
            Object.keys(accountsByHolder).forEach(holderId => {
                const holderData = accountsByHolder[holderId];
                if (holderData && holderData.accounts && holderData.accounts.length > 0) {
                    allAccounts.push({
                        holder_name: holderData.holder_name,
                        accounts: holderData.accounts
                    });
                }
            });
        }
        
        populateGroupedSelect('fromAccount', fromAccounts);
        populateGroupedSelect('toAccount', allAccounts);
        
        // 添加轉出帳戶變更事件監聽器，動態過濾轉入帳戶選項
        const fromAccountSelect = document.getElementById('fromAccount');
        if (fromAccountSelect) {
            fromAccountSelect.addEventListener('change', function() {
                const selectedAccountId = this.value;
                if (selectedAccountId) {
                    // 找到選中的轉出帳戶
                    let selectedAccount = null;
                    for (const holderGroup of allAccounts) {
                        for (const account of holderGroup.accounts) {
                            if (account.id == selectedAccountId) {
                                selectedAccount = account;
                                break;
                            }
                        }
                        if (selectedAccount) break;
                    }
                    
                    if (selectedAccount) {
                        // 過濾出相同幣種的帳戶（排除自己）
                        const filteredAccounts = allAccounts.map(holderGroup => ({
                            holder_name: holderGroup.holder_name,
                            accounts: holderGroup.accounts.filter(acc => 
                                acc.currency === selectedAccount.currency && acc.id != selectedAccount.id
                            )
                        })).filter(holderGroup => holderGroup.accounts.length > 0);
                        
                        // 重新填充轉入帳戶選單
                        populateGroupedSelect('toAccount', filteredAccounts);
                    }
                } else {
                    // 如果沒有選擇轉出帳戶，顯示所有帳戶
                    populateGroupedSelect('toAccount', allAccounts);
                }
            });
        }
        
        console.log('✅ 模態框下拉選單填充完成');
    }

    // 刪除持有人
    function deleteHolder(holderId, holderName) {
        console.log('🗑️ 刪除持有人:', holderId, holderName);
        
        // 使用 SweetAlert2 進行二次確認
        Swal.fire({
            title: '確認刪除持有人',
            html: `
                <div class="text-start">
                    <p><strong>持有人名稱：</strong>${holderName}</p>
                    <p><strong>操作類型：</strong>永久刪除</p>
                    <div class="alert alert-warning mt-3">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>警告：</strong>此操作將同時刪除該持有人下的所有帳戶！
                    </div>
                </div>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: '確認刪除',
            cancelButtonText: '取消',
            reverseButtons: true,
            focusCancel: true
        }).then((result) => {
            if (result.isConfirmed) {
                // 第二次確認
                Swal.fire({
                    title: '最終確認',
                    html: `
                        <div class="text-start">
                            <p>您確定要刪除持有人「<strong>${holderName}</strong>」嗎？</p>
                            <div class="alert alert-danger mt-3">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>此操作將：</strong>
                                <ul class="mt-2 mb-0">
                                    <li>永久刪除該持有人</li>
                                    <li>同時刪除其下所有帳戶</li>
                                    <li>無法恢復</li>
                                    <li>可能影響相關記錄</li>
                                </ul>
                            </div>
                        </div>
                    `,
                    icon: 'error',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: '是的，刪除它！',
                    cancelButtonText: '取消',
                    reverseButtons: true
                }).then((finalResult) => {
                    if (finalResult.isConfirmed) {
                        // 執行刪除操作
                        executeDeleteHolder(holderId, holderName);
                    }
                });
            }
        });
    }
    
    // 執行刪除持有人操作
    function executeDeleteHolder(holderId, holderName) {
        // 顯示載入狀態
        Swal.fire({
            title: '正在刪除...',
            text: `正在刪除持有人「${holderName}」及其所有帳戶`,
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        // 發送刪除請求
        fetch('/api/delete-holder', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                holder_id: holderId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: '刪除成功！',
                    text: `持有人「${holderName}」及其所有帳戶已成功刪除`,
                    timer: 2000,
                    showConfirmButton: false
                });
                // 刷新頁面數據
                manualRefreshData();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: '刪除失敗',
                    text: data.message,
                    confirmButtonText: '確定'
                });
            }
        })
        .catch(error => {
            console.error('❌ 刪除持有人時發生錯誤:', error);
            Swal.fire({
                icon: 'error',
                title: '刪除失敗',
                text: '請檢查網路連接或聯繫管理員',
                confirmButtonText: '確定'
            });
        });
    }
    
    // 全局函數：打開銷帳模態框
    window.openSettlementModal = function(customerId, customerName, totalReceivable) {
        console.log('打開銷帳模態框:', { customerId, customerName, totalReceivable });
        
        // 設置模態框數據
        document.getElementById('settlementCustomerName').value = customerName;
        document.getElementById('settlementTotalReceivable').value = `NT$ ${totalReceivable.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
        document.getElementById('settlementAmount').value = totalReceivable;
        document.getElementById('settlementAmountDisplay').value = `NT$ ${totalReceivable.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
        document.getElementById('settlementRemainingReceivable').value = `NT$ 0.00`;
        document.getElementById('settlementNote').value = '';
        
        // 添加銷帳金額變更事件監聽器，即時計算剩餘應收
        const settlementAmountInput = document.getElementById('settlementAmount');
        if (settlementAmountInput) {
            // 移除舊的事件監聽器（避免重複綁定）
            if (settlementAmountInput._inputHandler) {
                settlementAmountInput.removeEventListener('input', settlementAmountInput._inputHandler);
            }
            
            // 創建新的事件處理函數
            settlementAmountInput._inputHandler = function() {
                const amount = parseFloat(this.value) || 0;
                const remaining = Math.max(0, totalReceivable - amount);
                
                // 更新顯示欄位
                document.getElementById('settlementAmountDisplay').value = `NT$ ${amount.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
                document.getElementById('settlementRemainingReceivable').value = `NT$ ${remaining.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
                
                console.log('銷帳金額變更:', { amount, remaining, totalReceivable });
            };
            
            // 綁定事件監聽器
            settlementAmountInput.addEventListener('input', settlementAmountInput._inputHandler);
            console.log('✅ 銷帳金額變更事件監聽器綁定完成');
            
            // 觸發一次初始計算
            settlementAmountInput._inputHandler();
            
            // 添加數字格式化功能
            setupNumberInputFormatting(settlementAmountInput, { maxDecimals: 2 });
        }
        
        console.log('模態框數據設置完成:', {
            customerName: customerName,
            totalReceivable: totalReceivable,
            settlementAmount: totalReceivable
        });
        
        // 添加隱藏的客戶ID和帳戶ID欄位
        let customerIdInput = document.getElementById('settlementForm').querySelector('input[name="customer_id"]');
        if (!customerIdInput) {
            customerIdInput = document.createElement('input');
            customerIdInput.type = 'hidden';
            customerIdInput.name = 'customer_id';
            document.getElementById('settlementForm').appendChild(customerIdInput);
        }
        customerIdInput.value = customerId;
        console.log('客戶ID設置完成:', customerId);
        
        // 移除舊的隱藏帳戶ID欄位（如果存在）
        let oldAccountIdInput = document.getElementById('settlementForm').querySelector('input[name="account_id"]');
        if (oldAccountIdInput) {
            oldAccountIdInput.remove();
        }
        
        // 添加新的隱藏帳戶ID欄位
        let accountIdInput = document.createElement('input');
        accountIdInput.type = 'hidden';
        accountIdInput.name = 'account_id';
        accountIdInput.id = 'hiddenAccountId';
        document.getElementById('settlementForm').appendChild(accountIdInput);
        
        console.log('隱藏帳戶ID欄位創建完成');
        
        // 填充收款帳戶下拉選單 - 只顯示TWD帳戶
        const twdAccounts = [];
        if (accountsByHolder && Object.keys(accountsByHolder).length > 0) {
            Object.keys(accountsByHolder).forEach(holderId => {
                const holderData = accountsByHolder[holderId];
                if (holderData && holderData.accounts && holderData.accounts.length > 0) {
                    const twdAccountsInGroup = holderData.accounts.filter(acc => acc.currency === 'TWD');
                    if (twdAccountsInGroup.length > 0) {
                        twdAccounts.push({
                            holder_name: holderData.holder_name,
                            accounts: twdAccountsInGroup
                        });
                    }
                }
            });
        }
        
        console.log('找到的TWD帳戶:', twdAccounts);
        
        // 填充收款帳戶下拉選單
        populateGroupedSelect('settlementAccount', twdAccounts);
        
                // 立即設置預設值（同步方式）
        const settlementAccountSelect = document.getElementById('settlementAccount');
        console.log('收款帳戶下拉選單元素:', settlementAccountSelect);
        
        if (settlementAccountSelect && twdAccounts.length > 0 && twdAccounts[0].accounts.length > 0) {
            const defaultAccount = twdAccounts[0].accounts[0];
            console.log('選擇預設帳戶:', defaultAccount);
            
            // 設置下拉選單的值
            settlementAccountSelect.value = defaultAccount.id;
            console.log('下拉選單值設置為:', settlementAccountSelect.value);
            
            // 立即設置隱藏欄位的值
            const hiddenAccountIdElement = document.getElementById('hiddenAccountId');
            if (hiddenAccountIdElement) {
                hiddenAccountIdElement.value = defaultAccount.id;
                console.log('隱藏帳戶ID欄位值設置為:', hiddenAccountIdElement.value);
            } else {
                console.error('❌ 找不到隱藏帳戶ID欄位');
            }
            
            console.log('自動選擇預設收款帳戶:', defaultAccount.name, 'ID:', defaultAccount.id);
        } else {
            console.warn('⚠️ 沒有找到可用的TWD帳戶或下拉選單元素');
        }
        
        // 等待DOM更新完成後再次檢查和設置
        setTimeout(() => {
            // 再次獲取收款帳戶下拉選單元素
            const settlementAccountSelect = document.getElementById('settlementAccount');
            console.log('延遲檢查 - 收款帳戶下拉選單元素:', settlementAccountSelect);
            
            if (settlementAccountSelect) {
                console.log('✅ 延遲檢查 - 找到收款帳戶下拉選單元素');
                
                // 監聽收款帳戶下拉選單的變化，自動更新隱藏的帳戶ID
                // 移除舊的事件監聽器（避免重複綁定）
                if (settlementAccountSelect._changeHandler) {
                    settlementAccountSelect.removeEventListener('change', settlementAccountSelect._changeHandler);
                }
                
                // 創建新的事件處理函數
                settlementAccountSelect._changeHandler = function() {
                    const selectedValue = this.value;
                    const hiddenElement = document.getElementById('hiddenAccountId');
                    if (hiddenElement) {
                        hiddenElement.value = selectedValue;
                        console.log('收款帳戶選擇變更，隱藏欄位更新為:', selectedValue);
                    } else {
                        console.error('❌ 找不到隱藏帳戶ID欄位，無法更新值');
                    }
                };
                
                // 綁定事件監聽器
                settlementAccountSelect.addEventListener('change', settlementAccountSelect._changeHandler);
                console.log('✅ 收款帳戶變更事件監聽器綁定完成');
                
                // 最終檢查隱藏欄位的值
                setTimeout(() => {
                    const finalCheck = document.getElementById('hiddenAccountId');
                    if (finalCheck) {
                        console.log('🔍 最終檢查 - 隱藏帳戶ID欄位值:', finalCheck.value);
                        
                        // 如果值仍然為空，強制設置
                        if (!finalCheck.value && settlementAccountSelect.value) {
                            finalCheck.value = settlementAccountSelect.value;
                            console.log('🔄 強制設置隱藏帳戶ID欄位值:', finalCheck.value);
                        }
                    } else {
                        console.error('❌ 最終檢查 - 找不到隱藏帳戶ID欄位');
                    }
                }, 100);
                
            } else {
                console.error('❌ 延遲檢查 - 找不到收款帳戶下拉選單元素');
            }
        }, 100); // 等待DOM更新完成
        
        // 顯示模態框
        const modalElement = document.getElementById('settlementModal');
        let modalInstance = bootstrap.Modal.getInstance(modalElement);
        if (!modalInstance) {
            modalInstance = new bootstrap.Modal(modalElement);
        }
        
        // 在模態框顯示後檢查隱藏欄位的值
        modalElement.addEventListener('shown.bs.modal', function() {
            console.log('🎭 模態框已顯示，檢查隱藏欄位值...');
            
            const customerIdCheck = document.querySelector('input[name="customer_id"]');
            const accountIdCheck = document.getElementById('hiddenAccountId');
            
            console.log('客戶ID欄位:', customerIdCheck ? customerIdCheck.value : '未找到');
            console.log('帳戶ID欄位:', accountIdCheck ? accountIdCheck.value : '未找到');
            
            // 強制重新設置隱藏欄位的值
            if (accountIdCheck) {
                // 優先從下拉選單獲取值
                const settlementAccountSelect = document.getElementById('settlementAccount');
                if (settlementAccountSelect && settlementAccountSelect.value) {
                    accountIdCheck.value = settlementAccountSelect.value;
                    console.log('🔄 從下拉選單強制設置隱藏帳戶ID欄位值:', accountIdCheck.value);
                } else if (twdAccounts.length > 0 && twdAccounts[0].accounts.length > 0) {
                    // 如果下拉選單沒有值，使用預設帳戶
                    const defaultAccount = twdAccounts[0].accounts[0];
                    accountIdCheck.value = defaultAccount.id;
                    console.log('🔄 使用預設帳戶強制設置隱藏帳戶ID欄位值:', accountIdCheck.value);
                }
                
                // 最終確認隱藏欄位的值
                console.log('🎯 最終確認 - 隱藏帳戶ID欄位值:', accountIdCheck.value);
                
                // 如果值仍然為空，顯示警告
                if (!accountIdCheck.value) {
                    console.warn('⚠️ 警告：隱藏帳戶ID欄位值仍然為空！');
                }
            } else {
                console.error('❌ 找不到隱藏帳戶ID欄位元素');
            }
        });
        
        modalInstance.show();
    };
    
    // 設置客戶交易紀錄相關功能
    function setupCustomerTransactionsListeners() {
        console.log('🔧 設置客戶交易紀錄點擊事件監聽器...');
        
        // 使用事件委託，監聽整個應收帳款表格的點擊事件
        document.addEventListener('click', function(event) {
            console.log('🖱️ 點擊事件:', event.target);
            
            if (event.target.closest('.customer-transactions')) {
                const customerLink = event.target.closest('.customer-transactions');
                const customerId = customerLink.dataset.customerId;
                const customerName = customerLink.dataset.customerName;
                
                console.log('👤 點擊客戶:', { customerId, customerName });
                
                if (customerId && customerName) {
                    openCustomerTransactionsModal(customerId, customerName);
                } else {
                    console.error('❌ 客戶ID或名稱缺失:', { customerId, customerName });
                }
            }
        });
        
        console.log('✅ 客戶交易紀錄點擊事件監聽器設置完成');
    }
    
    function openCustomerTransactionsModal(customerId, customerName) {
        // 更新模態框標題
        document.getElementById('customerTransactionsTitle').textContent = `${customerName} 的交易紀錄`;
        document.getElementById('customerTransactionsName').textContent = customerName;
        
        // 顯示載入狀態
        document.getElementById('customerTransactionsTable').innerHTML = '<tr><td colspan="7" class="text-center p-3"><div class="spinner-border spinner-border-sm me-2"></div>載入中...</td></tr>';
        document.getElementById('customerTransactionsEmpty').style.display = 'none';
        
        // 顯示模態框
        const modal = new bootstrap.Modal(document.getElementById('customerTransactionsModal'));
        modal.show();
        
        // 獲取客戶交易紀錄
        fetchCustomerTransactions(customerId);
    }
    
    function fetchCustomerTransactions(customerId) {
        fetch(`/api/customer/transactions/${customerId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    displayCustomerTransactions(data);
                } else {
                    console.error('❌ 獲取客戶交易紀錄失敗:', data.message);
                    document.getElementById('customerTransactionsTable').innerHTML = '<tr><td colspan="7" class="text-center p-3 text-danger">載入失敗: ' + data.message + '</td></tr>';
                }
            })
            .catch(error => {
                console.error('❌ 網路錯誤:', error);
                document.getElementById('customerTransactionsTable').innerHTML = '<tr><td colspan="7" class="text-center p-3 text-danger">網路錯誤，請重試</td></tr>';
            });
    }
    
    function displayCustomerTransactions(data) {
        const tableBody = document.getElementById('customerTransactionsTable');
        const emptyMessage = document.getElementById('customerTransactionsEmpty');
        
        if (!data.transactions || data.transactions.length === 0) {
            tableBody.innerHTML = '';
            emptyMessage.style.display = 'block';
            return;
        }
        
        emptyMessage.style.display = 'none';

        // 取得應收帳款（多鍵相容）
        const receivableNode = document.getElementById('customerTransactionsReceivable');
        if (receivableNode) {
            function pick() {
                for (var i = 0; i < arguments.length; i++) {
                    var v = arguments[i];
                    if (v !== undefined && v !== null) return v;
                }
                return undefined;
            }
            // 先嘗試從這次回應找，找不到就從頁面初始提供的 customers 集合比對
            let receivable = pick(
                data.current_receivable,
                data.receivable_twd,
                data.receivable,
                data.customer_receivable,
                data.customer && (data.customer.receivable_twd || data.customer.receivable),
                data.summary && (data.summary.receivable_twd || data.summary.receivable)
            );

            if (receivable === undefined) {
                try {
                    var customers = customersList || [];
                    // 在表格上方我們已經把客戶名稱寫進 #customerTransactionsName
                    var nameNode = document.getElementById('customerTransactionsName');
                    var customerName = nameNode ? nameNode.textContent.trim() : '';
                    var matched = customers.find(function(c){ return (c.name || c.customer_name) === customerName; });
                    if (matched) {
                        receivable = pick(matched.total_receivables_twd, matched.receivable_twd, matched.receivable);
                    }
                } catch(e) { /* 忽略解析錯誤 */ }
            }
            if (receivable === undefined) receivable = 0;
            receivableNode.textContent = 'NT$ ' + Number(receivable).toLocaleString('en-US', {minimumFractionDigits: 2});
        }
        
        let tableHtml = '';
        data.transactions.forEach(tx => {
            const date = tx.date ? new Date(tx.date).toLocaleString('zh-TW') : '-';
            const type = tx.type || 'N/A';
            const desc = tx.description || '-';
            const rmbDelta = (tx.rmb_amount !== undefined ? tx.rmb_amount : (tx.rmbChange !== undefined ? tx.rmbChange : tx.rmb_change));
            const twdDelta = (tx.amount !== undefined ? tx.amount : (tx.twd_amount !== undefined ? tx.twd_amount : (tx.twdChange !== undefined ? tx.twdChange : tx.twd_change)));
            const rmbStr = (rmbDelta === undefined || rmbDelta === null) ? '-' : `¥ ${parseFloat(rmbDelta).toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            const twdStr = (twdDelta === undefined || twdDelta === null) ? '-' : `NT$ ${parseFloat(twdDelta).toLocaleString('en-US', {minimumFractionDigits: 2})}`;

            // 依照表頭順序：日期時間、類型、描述、RMB、TWD（不包含利潤與操作人員）
            tableHtml += `
                <tr>
                    <td><small>${date}</small></td>
                    <td><span class="badge bg-primary">${type}</span></td>
                    <td><small>${desc}</small></td>
                    <td class="text-end"><small>${rmbStr}</small></td>
                    <td class="text-end"><small>${twdStr}</small></td>
                </tr>
            `;
        });
        
        tableBody.innerHTML = tableHtml;
    }
    
    // 分頁相關變數
    let currentPage = 1;
    let currentPagination = null;

    // 載入分頁流水記錄
    function loadMovements(page = 1) {
        console.log('🔍 開始載入第', page, '頁流水記錄...');
        
        if (!movementsTbody) {
            console.error('❌ 找不到 movements-tbody 元素');
            return;
        }
        
        // 顯示載入中
        movementsTbody.innerHTML = '<tr><td colspan="11" class="text-center p-3"><i class="fas fa-spinner fa-spin"></i> 載入中...</td></tr>';
        
        // 發送API請求
        fetch(`/api/cash_management/transactions?page=${page}`)
            .then(response => response.json())
            .then(result => {
                if (result.status === 'success') {
                    currentPage = page;
                    currentPagination = result.data.pagination;
                    renderMovements(result.data.transactions);
                    renderPagination(result.data.pagination);
                } else {
                    console.error('❌ 載入流水記錄失敗:', result.message);
                    movementsTbody.innerHTML = '<tr><td colspan="11" class="text-center p-3 text-danger">載入失敗: ' + result.message + '</td></tr>';
                }
            })
            .catch(error => {
                console.error('❌ 網路錯誤:', error);
                movementsTbody.innerHTML = '<tr><td colspan="11" class="text-center p-3 text-danger">網路錯誤，請重試</td></tr>';
            });
    }

    // 渲染資金流水（本地作用域版本）
    function renderMovements(transactions) {
        console.log('🔍 開始渲染資金流水...');
        
        if (!movementsTbody) {
            console.error('❌ 找不到 movements-tbody 元素');
            return;
        }
        
        movementsTbody.innerHTML = '';
        
        if (!transactions || transactions.length === 0) {
            console.log('⚠️ 沒有資金流水數據');
            movementsTbody.innerHTML = '<tr><td colspan="11" class="text-center p-5 text-muted">尚無資金流水紀錄。</td></tr>';
            return;
        }
        
        console.log('✅ 找到 ' + transactions.length + ' 筆資金流水，開始渲染...');
        
        transactions.forEach(function(m, index) {
            const twdChange = parseFloat(m.twd_change ?? m.twdChange) || 0;
            const rmbChange = parseFloat(m.rmb_change ?? m.rmbChange) || 0;
            const profit = parseFloat(m.profit ?? 0) || 0;
            
            // 將類型轉換為中文顯示
            let typeDisplay = m.type;
            let typeClass = 'badge bg-info-subtle text-info-emphasis';
            
            switch(m.type) {
                case 'PURCHASE':
                case '買入':
                    typeDisplay = '買入';
                    typeClass = 'badge bg-primary-subtle text-primary-emphasis';
                    break;
                case 'SALES':
                case '售出':
                    typeDisplay = '售出';
                    typeClass = 'badge bg-primary-subtle text-primary-emphasis';
                    break;
                case 'TRANSFER':
                case '轉帳':
                    typeDisplay = '轉帳';
                    typeClass = 'badge bg-warning-subtle text-warning-emphasis';
                    break;
                case 'SETTLEMENT':
                case '銷帳':
                    typeDisplay = '銷帳';
                    typeClass = 'badge bg-danger-subtle text-danger-emphasis';
                    break;
                case 'DEPOSIT':
                case '存款':
                    typeDisplay = '存款';
                    typeClass = 'badge bg-secondary-subtle text-secondary-emphasis';
                    break;
                case 'WITHDRAWAL':
                case '提款':
                    typeDisplay = '提款';
                    typeClass = 'badge bg-danger-subtle text-danger-emphasis';
                    break;
                case 'CARD_PURCHASE':
                    typeDisplay = '刷卡';
                    typeClass = 'badge bg-warning-subtle text-warning-emphasis';
                    break;
                case 'CUSTOMER_PAYMENT':
                    typeDisplay = '客戶付款';
                    typeClass = 'badge bg-success-subtle text-success-emphasis';
                    break;
                default:
                    typeDisplay = m.type;
                    typeClass = 'badge bg-info-subtle text-info-emphasis';
            }
            
            // 格式化金額顯示
            const twdDisplay = twdChange !== 0 ? (twdChange > 0 ? '+' : '') + twdChange.toLocaleString('en-US', {minimumFractionDigits: 2}) : '-';
            const rmbDisplay = rmbChange !== 0 ? (rmbChange > 0 ? '+' : '') + rmbChange.toLocaleString('en-US', {minimumFractionDigits: 2}) : '-';
            const profitDisplay = profit !== 0 ? profit.toLocaleString('en-US', {minimumFractionDigits: 2}) : '-';
            
            // 設置金額顏色
            const twdClass = twdChange > 0 ? 'text-success' : (twdChange < 0 ? 'text-danger' : 'text-muted');
            const rmbClass = rmbChange > 0 ? 'text-success' : (rmbChange < 0 ? 'text-danger' : 'text-muted');
            const profitClass = profit > 0 ? 'text-success' : (profit < 0 ? 'text-danger' : 'text-muted');
            
            // 累積餘額顯示
            const runningTwd = m.running_twd_balance ?? m.runningTwdBalance ?? 0;
            const runningRmb = m.running_rmb_balance ?? m.runningRmbBalance ?? 0;
            const runningBalanceHtml = '<div class="small running-balance">' +
                '<div class="text-primary fw-bold border-bottom border-primary pb-1 mb-1">NT$ ' + (runningTwd || 0).toLocaleString('en-US', {minimumFractionDigits: 2}) + '</div>' +
                '<div class="text-success">¥ ' + (runningRmb || 0).toLocaleString('en-US', {minimumFractionDigits: 2}) + '</div>' +
                '</div>';
            
            const paymentAccount = m.payment_account ?? m.outgoing_account ?? '-';
            const depositAccount = m.deposit_account ?? m.incoming_account ?? '-';

            const row = '<tr>' +
                '<td class="ps-3"><small>' + (m.date ? new Date(m.date).toLocaleString('zh-TW') : '-') + '</small></td>' +
                '<td><span class="' + typeClass + '">' + typeDisplay + '</span></td>' +
                '<td><small>' + (m.description || '-') + '</small></td>' +
                '<td><small>' + (m.operator || '-') + '</small></td>' +
                '<td><small>' + paymentAccount + '</small></td>' +
                '<td><small>' + depositAccount + '</small></td>' +
                '<td><small>' + (m.note || '-') + '</small></td>' +
                '<td class="text-end"><span class="' + twdClass + '">' + twdDisplay + '</span></td>' +
                '<td class="text-end"><span class="' + rmbClass + '">' + rmbDisplay + '</span></td>' +
                '<td class="text-end">' + runningBalanceHtml + '</td>' +
                '<td class="text-end pe-3"><span class="' + profitClass + '">' + profitDisplay + '</span></td>' +
                '</tr>';
            
            movementsTbody.innerHTML += row;
        });
        
        console.log('✅ 資金流水渲染完成');
    }
    
    // 渲染分頁控制項
    function renderPagination(pagination) {
        const paginationInfo = document.getElementById('pagination-info');
        const paginationControls = document.getElementById('pagination-controls');
        if (!paginationInfo || !paginationControls) return;
        
        // 正規化不同回應鍵名（避免部分瀏覽器不支援 ??）
        const currentPage = pick(pagination.current_page, pagination.page, 1);
        const perPage = pick(pagination.per_page, pagination.perPage, 50);
        const totalRecords = pick(pagination.total_records, pagination.total, 0);
        const totalPages = pick(pagination.total_pages, pagination.pages, Math.ceil(totalRecords / perPage) || 1);
        const hasPrev = (pick(pagination.has_prev, (currentPage > 1)) ? true : false);
        const hasNext = (pick(pagination.has_next, (currentPage < totalPages)) ? true : false);
        const prevNum = pick(pagination.prev_num, (hasPrev ? currentPage - 1 : 1));
        const nextNum = pick(pagination.next_num, (hasNext ? currentPage + 1 : totalPages));
        
        // 更新分頁信息
        const startItem = (currentPage - 1) * perPage + 1;
        const endItem = Math.min(currentPage * perPage, totalRecords);
        paginationInfo.innerHTML = `顯示第 ${startItem}-${endItem} 筆，共 ${totalRecords} 筆記錄`;
        
        // 清空分頁按鈕
        paginationControls.innerHTML = '';
        
        // 上一頁
        if (hasPrev) {
            paginationControls.innerHTML += '<li class="page-item"><a class="page-link" href="javascript:void(0)" onclick="loadMovements(' + prevNum + '); return false;">上一頁</a></li>';
        }
        
        // 頁碼
        for (let i = 1; i <= totalPages; i++) {
            if (i === currentPage) {
                paginationControls.innerHTML += '<li class="page-item active"><span class="page-link">' + i + '</span></li>';
            } else {
                paginationControls.innerHTML += '<li class="page-item"><a class="page-link" href="javascript:void(0)" onclick="loadMovements(' + i + '); return false;">' + i + '</a></li>';
            }
        }
        
        // 下一頁
        if (hasNext) {
            paginationControls.innerHTML += '<li class="page-item"><a class="page-link" href="javascript:void(0)" onclick="loadMovements(' + nextNum + '); return false;">下一頁</a></li>';
        }
    }
    
    // 更新總資產數據
    function updateTotalAssets() {
        console.log('🔄 更新總資產數據...');
        
        fetch('/api/cash_management/totals')
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                console.log('📊 獲取到新的總資產數據:', data);
                
                const totalTwdElement = document.getElementById('totalTwdDisplay');
                const totalRmbElement = document.getElementById('totalRmbDisplay');
                const totalReceivablesElement = document.getElementById('totalReceivablesDisplay');
                
                if (totalTwdElement) {
                    totalTwdElement.textContent = 'NT$ ' + data.total_twd.toLocaleString('en-US', {minimumFractionDigits: 2});
                }
                
                if (totalRmbElement) {
                    totalRmbElement.textContent = '¥ ' + data.total_rmb.toLocaleString('en-US', {minimumFractionDigits: 2});
                }
                
                if (totalReceivablesElement) {
                    totalReceivablesElement.textContent = 'NT$ ' + data.total_receivables_twd.toLocaleString('en-US', {minimumFractionDigits: 2});
                }
                
                console.log('✅ 總資產數據更新完成');
            })
            .catch(function(error) {
                console.error('❌ 更新總資產數據時發生錯誤:', error);
            });
    }
    
    // 手動刷新數據函數
    window.manualRefreshData = function() {
        console.log('🔄 手動刷新數據...');
        updateTotalAssets();
        renderAccounts();
        loadMovements(1);
        console.log('✅ 手動刷新完成');
    };
    
    // 監聽銷售數據變更事件，自動刷新頁面數據
    window.addEventListener('salesDataChanged', function(event) {
        console.log('🔄 收到銷售數據變更事件:', event.detail);
        if (event.detail.action === 'cancel_sale') {
            console.log('🔄 檢測到銷售記錄取消，自動刷新現金管理數據...');
            // 延遲一下再刷新，確保後端數據已更新
            setTimeout(() => {
                manualRefreshData();
            }, 500);
        }
    });
    
            // 設置銷帳表單提交事件監聽器
        const settlementForm = document.getElementById('settlementForm');
        if (settlementForm) {
            settlementForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // 獲取表單數據
                const customerId = document.querySelector('input[name="customer_id"]').value;
                const amount = parseFloat(document.getElementById('settlementAmount').getActualValue ? document.getElementById('settlementAmount').getActualValue() : document.getElementById('settlementAmount').value);
                let accountId = document.querySelector('input[name="account_id"]').value;
                const note = document.getElementById('settlementNote').value;
                
                // 如果隱藏欄位的值為空，嘗試從下拉選單獲取
                if (!accountId) {
                    console.log('⚠️ 隱藏欄位值為空，嘗試從下拉選單獲取...');
                    const settlementAccountSelect = document.getElementById('settlementAccount');
                    if (settlementAccountSelect && settlementAccountSelect.value) {
                        accountId = settlementAccountSelect.value;
                        console.log('🔄 從下拉選單獲取帳戶ID:', accountId);
                        
                        // 同時更新隱藏欄位的值
                        const hiddenElement = document.querySelector('input[name="account_id"]');
                        if (hiddenElement) {
                            hiddenElement.value = accountId;
                            console.log('🔄 更新隱藏欄位值:', hiddenElement.value);
                        }
                    }
                }
                
                console.log('表單數據驗證:', { customerId, amount, accountId, note });
                
                // 驗證必填欄位
                if (!customerId) {
                    console.error('❌ 客戶ID缺失');
                    Swal.fire('錯誤', '請選擇客戶', 'error');
                    return;
                }
                
                if (!accountId) {
                    console.error('❌ 收款帳戶ID缺失');
                    Swal.fire('錯誤', '請選擇收款帳戶', 'error');
                    return;
                }
            
            // 驗證銷帳金額
            if (isNaN(amount)) {
                console.error('❌ 銷帳金額格式錯誤');
                Swal.fire('錯誤', '請輸入有效的銷帳金額', 'error');
                return;
            }
            
            if (amount <= 0) {
                console.error('❌ 銷帳金額必須大於0');
                Swal.fire('錯誤', '銷帳金額必須大於0', 'error');
                return;
            }
            
            console.log('✅ 表單驗證通過');
            
            // 銷帳前二次確認
            const customerName = document.getElementById('settlementCustomerName').value;
            const accountName = document.getElementById('settlementAccount').options[document.getElementById('settlementAccount').selectedIndex].text;
            
            const confirmResult = await Swal.fire({
                title: '確認銷帳操作',
                html: `
                    <div class="text-start">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>客戶名稱：</strong>${customerName}</p>
                                <p><strong>銷帳金額：</strong>NT$ ${amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>入庫帳戶：</strong>${accountName}</p>
                                <p><strong>備註：</strong>${note || '無'}</p>
                            </div>
                        </div>
                        <div class="alert alert-info mt-3">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>銷帳後：</strong>客戶應收帳款將減少 NT$ ${amount.toLocaleString('en-US', {minimumFractionDigits: 2})}
                        </div>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '確認銷帳',
                cancelButtonText: '取消',
                reverseButtons: true
            });
            
            if (!confirmResult.isConfirmed) {
                return;
            }
            
            // 第二次確認
            const finalConfirmResult = await Swal.fire({
                title: '最終確認',
                html: `
                    <div class="text-start">
                        <p>您確定要執行銷帳操作嗎？</p>
                        <div class="alert alert-warning mt-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>此操作將：</strong>
                            <ul class="mt-2 mb-0">
                                <li>減少客戶應收帳款</li>
                                <li>增加入庫帳戶餘額</li>
                                <li>記錄銷帳歷史</li>
                                <li>無法輕易撤銷</li>
                            </ul>
                        </div>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '是的，執行銷帳',
                cancelButtonText: '取消',
                reverseButtons: true
            });
            
            if (!finalConfirmResult.isConfirmed) {
                return;
            }
            
            console.log('銷帳表單提交:', { customerId, amount, accountId, note });
            
            // 顯示載入狀態
            Swal.fire({
                title: '正在執行銷帳...',
                text: '請稍候，正在處理銷帳操作',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            try {
                const response = await fetch('/api/settlement', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customer_id: customerId,
                        amount: amount,
                        account_id: accountId,
                        note: note
                    })
                });
                
                const result = await response.json();
                console.log('銷帳回應:', result);
                
                if (result.status === 'success') {
                    Swal.fire({
                        icon: 'success',
                        title: '銷帳成功！',
                        text: result.message,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // 關閉模態框並重新載入頁面
                    console.log('準備關閉模態框...');
                    const modalElement = document.getElementById('settlementModal');
                    const modalInstance = bootstrap.Modal.getInstance(modalElement);
                    console.log('模態框元素:', modalElement);
                    console.log('模態框實例:', modalInstance);
                    
                    if (modalInstance) {
                        console.log('關閉模態框...');
                        modalInstance.hide();
                    } else {
                        console.log('無法獲取模態框實例，嘗試直接隱藏...');
                        // 備用方案：直接隱藏模態框
                        modalElement.style.display = 'none';
                        modalElement.classList.remove('show');
                        document.body.classList.remove('modal-open');
                        const backdrop = document.querySelector('.modal-backdrop');
                        if (backdrop) {
                            backdrop.remove();
                        }
                    }
                    
                    // 延遲更新總資產顯示，確保模態框有時間關閉
                    setTimeout(() => {
                        updateTotalAssets();
                        manualRefreshData(); // 重新載入所有數據
                    }, 500);
                } else {
                    Swal.fire('錯誤', result.message, 'error');
                }
            } catch (error) {
                console.error('銷帳錯誤:', error);
                Swal.fire('錯誤', '銷帳時發生錯誤', 'error');
            }
        });
    }
    
    // 初始化渲染
    renderAccounts();
    loadMovements(1);
    setupCustomerTransactionsListeners(); // 初始化客戶交易紀錄監聽器
    
    console.log('✅ 現金管理頁面初始化完成');
});

// 通用二次確認函數
async function confirmOperation(options) {
    const {
        title,
        message,
        confirmText = '確認',
        cancelText = '取消',
        confirmColor = '#28a745',
        cancelColor = '#6c757d',
        icon = 'question',
        showSecondConfirm = true,
        secondTitle = '最終確認',
        secondMessage = '您確定要執行此操作嗎？',
        secondConfirmText = '是的，執行',
        secondCancelText = '取消'
    } = options;
    
    // 第一次確認
    const firstResult = await Swal.fire({
        title: title,
        html: message,
        icon: icon,
        showCancelButton: true,
        confirmButtonColor: confirmColor,
        cancelButtonColor: cancelColor,
        confirmButtonText: confirmText,
        cancelButtonText: cancelText,
        reverseButtons: true,
        focusCancel: true
    });
    
    if (!firstResult.isConfirmed) {
        return false;
    }
    
    // 如果需要第二次確認
    if (showSecondConfirm) {
        const secondResult = await Swal.fire({
            title: secondTitle,
            html: secondMessage,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: confirmColor,
            cancelButtonColor: cancelColor,
            confirmButtonText: secondConfirmText,
            cancelButtonText: secondCancelText,
            reverseButtons: true
        });
        
        return secondResult.isConfirmed;
    }
    
    return true;
}

// 為內部轉帳增加確認
document.addEventListener('DOMContentLoaded', function() {
    const transferForm = document.querySelector('#transferModal form');
    if (transferForm) {
        transferForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fromAccount = document.getElementById('fromAccount');
            const toAccount = document.getElementById('toAccount');
            const amount = document.getElementById('transferAmount');
            
            if (!fromAccount.value || !toAccount.value || !amount.value) {
                Swal.fire('錯誤', '請填寫完整的轉帳資訊', 'error');
                return;
            }
            
            const fromAccountText = fromAccount.options[fromAccount.selectedIndex].text;
            const toAccountText = toAccount.options[toAccount.selectedIndex].text;
            const transferAmount = parseFloat(amount.value);
            
            // 二次確認
            const confirmed = await confirmOperation({
                title: '確認內部轉帳',
                message: `
                    <div class="text-start">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>轉出帳戶：</strong>${fromAccountText}</p>
                                <p><strong>轉入帳戶：</strong>${toAccountText}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>轉帳金額：</strong>NT$ ${transferAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}</p>
                            </div>
                        </div>
                        <div class="alert alert-info mt-3">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>轉帳後：</strong>轉出帳戶餘額將減少，轉入帳戶餘額將增加
                        </div>
                    </div>
                `,
                confirmText: '確認轉帳',
                secondMessage: `
                    <div class="text-start">
                        <p>您確定要執行此內部轉帳嗎？</p>
                        <div class="alert alert-warning mt-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>此操作將：</strong>
                            <ul class="mt-2 mb-0">
                                <li>從 ${fromAccountText} 轉出 NT$ ${transferAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}</li>
                                <li>轉入 ${toAccountText}</li>
                                <li>記錄轉帳歷史</li>
                                <li>無法輕易撤銷</li>
                            </ul>
                        </div>
                    </div>
                `,
                secondConfirmText: '是的，執行轉帳'
            });
            
            if (confirmed) {
                // 顯示載入狀態
                Swal.fire({
                    title: '正在執行轉帳...',
                    text: '請稍候，正在處理轉帳操作',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // 提交表單
                this.submit();
            }
        });
    }
    
    // 為資金操作增加確認
    const movementForm = document.querySelector('#addMovementModal form');
    if (movementForm) {
        movementForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const accountId = document.getElementById('movementAccountId').value;
            const amount = document.getElementById('movementAmount').value;
            const isDecrease = document.querySelector('input[name="is_decrease"]:checked').value === 'true';
            const note = document.getElementById('movementNote').value;
            
            if (!accountId || !amount) {
                Swal.fire('錯誤', '請填寫完整的操作資訊', 'error');
                return;
            }
            
            const operationType = isDecrease ? '提出' : '存入';
            const operationAmount = parseFloat(amount);
            
            // 二次確認
            const confirmed = await confirmOperation({
                title: `確認資金${operationType}`,
                message: `
                    <div class="text-start">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>操作類型：</strong>${operationType}</p>
                                <p><strong>操作金額：</strong>NT$ ${operationAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>備註：</strong>${note || '無'}</p>
                            </div>
                        </div>
                        <div class="alert alert-info mt-3">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>操作後：</strong>帳戶餘額將${isDecrease ? '減少' : '增加'} NT$ ${operationAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}
                        </div>
                    </div>
                `,
                confirmText: `確認${operationType}`,
                secondMessage: `
                    <div class="text-start">
                        <p>您確定要執行此資金${operationType}操作嗎？</p>
                        <div class="alert alert-warning mt-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>此操作將：</strong>
                            <ul class="mt-2 mb-0">
                                <li>${operationType} NT$ ${operationAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}</li>
                                <li>更新帳戶餘額</li>
                                <li>記錄操作歷史</li>
                                <li>無法輕易撤銷</li>
                            </ul>
                        </div>
                    </div>
                `,
                secondConfirmText: `是的，執行${operationType}`
            });
            
            if (confirmed) {
                // 顯示載入狀態
                Swal.fire({
                    title: `正在執行${operationType}...`,
                    text: '請稍候，正在處理資金操作',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // 提交表單
                this.submit();
            }
        });
    }
});

// 全局函數：載入分頁流水記錄
window.loadMovements = function(page = 1) {
    console.log('🔍 開始載入第', page, '頁流水記錄...');
    
    const movementsTbody = document.getElementById('movements-tbody');
    if (!movementsTbody) {
        console.error('❌ 找不到 movements-tbody 元素');
        return;
    }
    
    // 顯示載入中
    movementsTbody.innerHTML = '<tr><td colspan="11" class="text-center p-3"><i class="fas fa-spinner fa-spin"></i> 載入中...</td></tr>';
    
    // 發送API請求
    fetch(`/api/cash_management/transactions?page=${page}`)
        .then(response => response.json())
        .then(result => {
            console.log('📡 API回應結果:', result);
            if (result.status === 'success') {
                console.log('✅ 載入成功，頁面:', page);
                console.log('📊 分頁資訊:', result.data.pagination);
                console.log('📋 交易記錄:', result.data.transactions);
                
                window.currentPage = page;
                window.currentPagination = result.data.pagination;
                window.renderMovements(result.data.transactions);
                window.renderPagination(result.data.pagination);
            } else {
                console.error('❌ 載入流水記錄失敗:', result.message);
                movementsTbody.innerHTML = '<tr><td colspan="11" class="text-center p-3 text-danger">載入失敗: ' + result.message + '</td></tr>';
            }
        })
        .catch(error => {
            console.error('❌ 網路錯誤:', error);
            movementsTbody.innerHTML = '<tr><td colspan="11" class="text-center p-3 text-danger">網路錯誤，請重試</td></tr>';
        });
};

// 全局函數：渲染資金流水
window.renderMovements = function(transactions) {
    console.log('🔍 開始渲染資金流水...');
    
    const movementsTbody = document.getElementById('movements-tbody');
    if (!movementsTbody) {
        console.error('❌ 找不到 movements-tbody 元素');
        return;
    }
    
    movementsTbody.innerHTML = '';
    
    if (!transactions || transactions.length === 0) {
        console.log('⚠️ 沒有資金流水數據');
        movementsTbody.innerHTML = '<tr><td colspan="11" class="text-center p-5 text-muted">尚無資金流水紀錄。</td></tr>';
        return;
    }
    
    console.log('✅ 找到 ' + transactions.length + ' 筆資金流水，開始渲染...');
    
    transactions.forEach(function(m, index) {
        const twdChange = parseFloat(m.twd_change ?? m.twdChange) || 0;
        const rmbChange = parseFloat(m.rmb_change ?? m.rmbChange) || 0;
        const profit = parseFloat(m.profit ?? 0) || 0;
        
        // 將類型轉換為中文顯示
        let typeDisplay = m.type;
        let typeClass = 'badge bg-info-subtle text-info-emphasis';
        
        switch(m.type) {
            case 'PURCHASE':
            case '買入':
                typeDisplay = '買入';
                typeClass = 'badge bg-primary-subtle text-primary-emphasis';
                break;
            case 'SALES':
            case '售出':
                typeDisplay = '售出';
                typeClass = 'badge bg-primary-subtle text-primary-emphasis';
                break;
            case 'TRANSFER':
            case '轉帳':
                typeDisplay = '轉帳';
                typeClass = 'badge bg-warning-subtle text-warning-emphasis';
                break;
            case 'SETTLEMENT':
            case '銷帳':
                typeDisplay = '銷帳';
                typeClass = 'badge bg-danger-subtle text-danger-emphasis';
                break;
            case 'DEPOSIT':
            case '存款':
                typeDisplay = '存款';
                typeClass = 'badge bg-secondary-subtle text-secondary-emphasis';
                break;
            case 'WITHDRAWAL':
            case '提款':
                typeDisplay = '提款';
                typeClass = 'badge bg-danger-subtle text-danger-emphasis';
                break;
            case 'CARD_PURCHASE':
                typeDisplay = '刷卡';
                typeClass = 'badge bg-warning-subtle text-warning-emphasis';
                break;
            case 'CUSTOMER_PAYMENT':
                typeDisplay = '客戶付款';
                typeClass = 'badge bg-success-subtle text-success-emphasis';
                break;
            default:
                typeDisplay = m.type;
                typeClass = 'badge bg-info-subtle text-info-emphasis';
        }
        
        // 格式化金額顯示
        const twdDisplay = twdChange !== 0 ? (twdChange > 0 ? '+' : '') + twdChange.toLocaleString('en-US', {minimumFractionDigits: 2}) : '-';
        const rmbDisplay = rmbChange !== 0 ? (rmbChange > 0 ? '+' : '') + rmbChange.toLocaleString('en-US', {minimumFractionDigits: 2}) : '-';
        const profitDisplay = profit !== 0 ? profit.toLocaleString('en-US', {minimumFractionDigits: 2}) : '-';
        
        // 根據變化類型設置顏色
        const twdColorClass = twdChange > 0 ? 'text-success' : twdChange < 0 ? 'text-danger' : 'text-muted';
        const rmbColorClass = rmbChange > 0 ? 'text-success' : rmbChange < 0 ? 'text-danger' : 'text-muted';
        const profitColorClass = profit > 0 ? 'text-success' : profit < 0 ? 'text-danger' : 'text-muted';
        
        // 累積餘額（同上方渲染保持一致）
        const runningTwd = m.running_twd_balance ?? m.runningTwdBalance ?? 0;
        const runningRmb = m.running_rmb_balance ?? m.runningRmbBalance ?? 0;
        const runningBalanceHtml = '<div class="small running-balance">' +
            '<div class="text-primary fw-bold border-bottom border-primary pb-1 mb-1">NT$ ' + (runningTwd || 0).toLocaleString('en-US', {minimumFractionDigits: 2}) + '</div>' +
            '<div class="text-success">¥ ' + (runningRmb || 0).toLocaleString('en-US', {minimumFractionDigits: 2}) + '</div>' +
            '</div>';

        const paymentAccount = m.payment_account ?? m.outgoing_account ?? '-';
        const depositAccount = m.deposit_account ?? m.incoming_account ?? '-';

        const row = '<tr class="transaction-row">' +
            '<td class="ps-3"><small>' + (m.date ? new Date(m.date).toLocaleString('zh-TW') : '-') + '</small></td>' +
            '<td><span class="' + typeClass + '">' + typeDisplay + '</span></td>' +
            '<td><small>' + (m.description || '-') + '</small></td>' +
            '<td><small>' + (m.operator || '-') + '</small></td>' +
            '<td><small>' + paymentAccount + '</small></td>' +
            '<td><small>' + depositAccount + '</small></td>' +
            '<td><small>' + (m.note || '-') + '</small></td>' +
            '<td class="text-end"><small class="' + twdColorClass + '">' + twdDisplay + '</small></td>' +
            '<td class="text-end"><small class="' + rmbColorClass + '">' + rmbDisplay + '</small></td>' +
            '<td class="text-end">' + runningBalanceHtml + '</td>' +
            '<td class="text-end pe-3"><small class="' + profitColorClass + '">' + profitDisplay + '</small></td>' +
            '</tr>';
        
        movementsTbody.innerHTML += row;
    });
    
    console.log('✅ 資金流水渲染完成');
};

// 全局函數：渲染分頁
window.renderPagination = function(pagination) {
    if (!pagination) return;
    
    // 本地pick以避免 ?? 相容性問題
    function pick() {
        for (var i = 0; i < arguments.length; i++) {
            var v = arguments[i];
            if (v !== undefined && v !== null) return v;
        }
        return undefined;
    }
    
    // 正規化不同回應鍵名
    const currentPage = pick(pagination.current_page, pagination.page, 1);
    const perPage = pick(pagination.per_page, pagination.perPage, 50);
    const totalRecords = pick(pagination.total, pagination.total_records, 0);
    const totalPages = pick(pagination.total_pages, pagination.pages, Math.ceil(totalRecords / perPage) || 1);
    const hasPrev = pick(pagination.has_prev, (currentPage > 1)) ? true : false;
    const hasNext = pick(pagination.has_next, (currentPage < totalPages)) ? true : false;
    const prevNum = pick(pagination.prev_num, hasPrev ? currentPage - 1 : 1);
    const nextNum = pick(pagination.next_num, hasNext ? currentPage + 1 : totalPages);
    
    // 更新分頁信息
    const paginationInfo = document.getElementById('pagination-info');
    if (paginationInfo) {
        const startRecord = (currentPage - 1) * perPage + 1;
        const endRecord = Math.min(currentPage * perPage, totalRecords);
        paginationInfo.innerHTML = `顯示第${startRecord}-${endRecord}筆,共${totalRecords}筆記錄`;
    }
    
    // 更新分頁控制項
    const paginationControls = document.getElementById('pagination-controls');
    if (!paginationControls) return;
    
    let paginationHtml = '<ul class="pagination pagination-sm mb-0">';
    
    // 上一頁
    if (hasPrev) {
        paginationHtml += '<li class="page-item"><a class="page-link" href="javascript:void(0)" onclick="loadMovements(' + prevNum + '); return false;">上一頁</a></li>';
    }
    
    // 頁碼
    for (let i = 1; i <= totalPages; i++) {
        if (i === currentPage) {
            paginationHtml += '<li class="page-item active"><span class="page-link">' + i + '</span></li>';
        } else {
            paginationHtml += '<li class="page-item"><a class="page-link" href="javascript:void(0)" onclick="loadMovements(' + i + '); return false;">' + i + '</a></li>';
        }
    }
    
    // 下一頁
    if (hasNext) {
        paginationHtml += '<li class="page-item"><a class="page-link" href="javascript:void(0)" onclick="loadMovements(' + nextNum + '); return false;">下一頁</a></li>';
    }
    
    paginationHtml += '</ul>';
    paginationControls.innerHTML = paginationHtml;
};

// 數字輸入欄位格式化函數 - 使用全局增強版本

// 初始化數字輸入欄位格式化
function initializeNumberFormatting() {
    console.log('🔧 開始初始化簡化的數字輸入欄位格式化...');
    
    // 查找所有數字輸入欄位
    const numberInputs = document.querySelectorAll('input[type="text"][pattern*="[0-9]"], input[type="text"][id*="amount"], input[type="text"][id*="rate"], input[type="text"][id*="balance"], input[type="text"][id*="rmb"]');
    
    console.log('🔍 找到數字輸入欄位:', numberInputs.length);
    
    numberInputs.forEach((input, index) => {
        console.log(`📝 初始化欄位 ${index + 1}:`, input.id, input.name);
        
        // 根據欄位ID決定選項
        let options = { minDecimals: 0, maxDecimals: 2 };
        
        if (input.id.includes('rate') || input.id.includes('exchange') || input.id.includes('CostRate')) {
            options.maxDecimals = 4;
        }
        
        if (input.id.includes('balance') || input.id.includes('amount')) {
            options.maxDecimals = 2;
        }
        
        // 設置簡化的數字格式化（無千位分隔符）
        if (typeof setupNumberInputFormatting === 'function') {
            setupNumberInputFormatting(input, options);
            console.log(`✅ 欄位 ${input.id} 簡化格式化完成，選項:`, options);
        } else {
            console.warn(`⚠️ setupNumberInputFormatting 函數未定義，跳過欄位 ${input.id}`);
        }
    });
    
    console.log('✅ 簡化的數字輸入欄位格式化初始化完成（無千位分隔符）');
}

// 頁面載入完成後初始化數字格式化
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 現金管理頁面載入完成，開始初始化...');
    
    // 延遲初始化，確保所有模態框都已載入
    setTimeout(() => {
        initializeNumberFormatting();
    }, 100);
    
    // 當模態框顯示時，重新初始化數字格式化
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        modal.addEventListener('shown.bs.modal', function() {
            console.log('🔄 模態框顯示，重新初始化數字格式化...');
            setTimeout(() => {
                initializeNumberFormatting();
            }, 50);
        });
    });
});

</script>

    <!-- 增強數字輸入腳本已在 base.html 全域引入，這裡不重複載入 -->
{% endblock %}