{% extends "base.html" %}

{% block title %}ç¾é‡‘ç®¡ç†{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- æ¨™é¡Œè¡Œ -->
    <div class="row align-items-center mb-4">
        <div class="col">
            <h2 class="fw-light mb-0">
                <i class="bi bi-cash-stack me-2"></i>ç¾é‡‘ç®¡ç†
            </h2>
        </div>
    </div>

    <!-- ç¸½è³‡ç”¢æ¦‚è¦½ -->
    <div class="card shadow-sm mb-4">
        <div class="card-body text-center">
            <div class="row">
                <div class="col-md-4 border-end">
                    <h5 class="text-primary mb-1">ç¸½å°å¹£</h5>
                    <h3 class="fw-bold text-primary" id="totalTwdDisplay">NT$ {{ "{:,.2f}".format(total_twd) }}</h3>
                </div>
                <div class="col-md-4 border-end">
                    <h5 class="text-success mb-1">ç¸½äººæ°‘å¹£</h5>
                    <h3 class="fw-bold text-success" id="totalRmbDisplay">Â¥ {{ "{:,.2f}".format(total_rmb) }}</h3>
                </div>
                <div class="col-md-4">
                    <h5 class="text-danger mb-1">æ‡‰æ”¶å¸³æ¬¾</h5>
                    <h3 class="fw-bold text-danger" id="totalReceivablesDisplay">NT$ {{ "{:,.2f}".format(total_receivables_twd) }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- æ“ä½œå€å¡Š -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex gap-2 justify-content-center">
                <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addHolderModal">
                    <i class="bi bi-person-plus me-1"></i>æ–°å¢æŒæœ‰äºº
                </button>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addAccountModal">
                    <i class="bi bi-plus-circle me-1"></i>æ–°å¢å¸³æˆ¶
                </button>
                <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#transferModal">
                    <i class="bi bi-arrow-left-right me-1"></i>å…§éƒ¨è½‰å¸³
                </button>
                <button class="btn btn-secondary btn-sm" onclick="manualRefreshData()">
                    <i class="bi bi-arrow-clockwise me-1"></i>åˆ·æ–°æ•¸æ“š
                </button>
            </div>
        </div>
    </div>

    <!-- è³‡é‡‘æŒæœ‰äººèˆ‡å¸³æˆ¶å€å¡Š -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0 fw-light">
                <i class="bi bi-people me-2"></i>è³‡é‡‘æŒæœ‰äººèˆ‡å¸³æˆ¶
                <small class="text-muted">ï¼ˆå…± {{ holders|length }} ä½æŒæœ‰äººï¼‰</small>
            </h5>
        </div>
        <div class="card-body">
            <div class="row" id="accounts-container">
                <!-- JavaScript å°‡æœƒå‹•æ…‹å¡«å……é€™è£¡ -->
            </div>
        </div>
    </div>

    <!-- æ‡‰æ”¶å¸³æ¬¾ç®¡ç†å€å¡Š -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0 fw-light">
                <i class="bi bi-receipt me-2"></i>æ‡‰æ”¶å¸³æ¬¾ç®¡ç†
                <small class="text-muted">ï¼ˆå…± {{ customers_with_receivables|length }} ç­†ï¼‰</small>
            </h5>
        </div>
        <div class="card-body p-0">
            {% if customers_with_receivables %}
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-3">å®¢æˆ¶åç¨±</th>
                            <th class="text-end">æ‡‰æ”¶é‡‘é¡</th>
                            <th class="text-center">æ“ä½œ</th>
                            <th class="pe-3">èªªæ˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for customer in customers_with_receivables %}
                        <tr>
                            <td class="ps-3">
                                <a href="#" class="text-decoration-none customer-transactions" 
                                   data-customer-id="{{ customer.id }}" data-customer-name="{{ customer.name }}">
                                    {{ customer.name }}
                                </a>
                            </td>
                            <td class="text-end">
                                <span class="fw-bold text-danger">NT$ {{ "{:,.2f}".format(customer.total_receivables_twd) }}</span>
                            </td>
                            <td class="text-center">
                                <button class="btn btn-success btn-sm settlement-btn" 
                                        data-customer-id="{{ customer.id }}" 
                                        data-customer-name="{{ customer.name }}" 
                                        data-receivable-amount="{{ customer.total_receivables_twd }}">
                                    <i class="bi bi-cash-coin me-1"></i>éŠ·å¸³
                                </button>
                            </td>
                            <td class="pe-3">
                                <small class="text-muted">é»æ“Šå®¢æˆ¶åç¨±æŸ¥çœ‹äº¤æ˜“ç´€éŒ„</small>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center p-5 text-muted">
                <i class="bi bi-check-circle display-4 text-success"></i>
                <p class="mt-3">å¤ªæ£’äº†ï¼æ‰€æœ‰æ‡‰æ”¶å¸³æ¬¾éƒ½å·²çµæ¸…</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- è³‡é‡‘æµæ°´å€å¡Š -->
    <div class="card shadow-sm mt-4">
        <div class="card-header">
            <h5 class="mb-0 fw-light"><i class="bi bi-graph-up-arrow me-2"></i>è¿‘æœŸäº¤æ˜“è¨˜éŒ„</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-3">æ™‚é–“</th>
                            <th>é¡å‹</th>
                            <th>æè¿°</th>
                            <th>æ“ä½œäººå“¡</th>
                            <th>å‡ºæ¬¾å¸³æˆ¶</th>
                            <th>å…¥æ¬¾å¸³æˆ¶</th>
                            <th>å‚™è¨»</th>
                            <th class="text-end">TWD è®Šå‹•</th>
                            <th class="text-end">RMB è®Šå‹•</th>
                            <th class="text-end pe-3">åˆ©æ½¤</th>
                        </tr>
                    </thead>
                    <tbody id="movements-tbody">
                        <!-- JavaScript å°‡æœƒå‹•æ…‹å¡«å……é€™è£¡ -->
                    </tbody>
                </table>
            </div>
            
            <!-- åˆ†é æ§åˆ¶é … -->
            <div class="card-footer">
                <div class="d-flex justify-content-between align-items-center">
                    <div id="pagination-info" class="text-muted">
                        <!-- åˆ†é ä¿¡æ¯å°‡å‹•æ…‹å¡«å…… -->
                    </div>
                    <nav aria-label="æµæ°´è¨˜éŒ„åˆ†é ">
                        <ul class="pagination pagination-sm mb-0" id="pagination-controls">
                            <!-- åˆ†é æŒ‰éˆ•å°‡å‹•æ…‹å¡«å…… -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- å¼•ç”¨æ‰€æœ‰çš„æ“ä½œæ¨¡æ…‹æ¡† -->
{% include '_cash_management_modals.html' %}

<!-- å°‡å¾Œç«¯æ•¸æ“šå‚³éçµ¦JavaScript -->
<script type="application/json" id="cash-management-data">
{
    "accountsByHolder": {{ accounts_by_holder|tojson|safe if accounts_by_holder is defined else '{}' }},
    "holders": {{ holders|tojson|safe if holders is defined else '[]' }},
    "movements": {{ movements|tojson|safe if movements is defined else '[]' }}
}
</script>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    console.log('ğŸš€ ç¾é‡‘ç®¡ç†é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
    
    // å¾å¾Œç«¯ç²å–æ•¸æ“š
    var dataElement = document.getElementById('cash-management-data');
    var data = JSON.parse(dataElement.textContent);
    var accountsByHolder = data.accountsByHolder;
    var holders = data.holders;
    var movements = data.movements;
    
            console.log('ğŸ“Š æ•¸æ“šæª¢æŸ¥:', { holders: holders, accountsByHolder: accountsByHolder, movements: movements });
        
        // å°‡å¸³æˆ¶æ•¸æ“šè½‰æ›ç‚ºå¹³é¢æ•¸çµ„ä¾›æ¨¡æ…‹æ¡†ä½¿ç”¨
        window.ownerAccountsData = [];
        
        // å¾ accountsByHolder çµæ§‹ä¸­æå–æ‰€æœ‰å¸³æˆ¶
        Object.keys(accountsByHolder).forEach(holderId => {
            const holderData = accountsByHolder[holderId];
            if (holderData && holderData.accounts) {
                holderData.accounts.forEach(account => {
                    window.ownerAccountsData.push({
                        id: account.id,
                        name: account.name,
                        currency: account.currency,
                        holder_id: parseInt(holderId)
                    });
                });
            }
        });
        
        console.log('ğŸ”§ ä¿å­˜å¸³æˆ¶æ•¸æ“šåˆ°å…¨å±€è®Šé‡:', window.ownerAccountsData);
        console.log('ğŸ” è©³ç´°æª¢æŸ¥æ¯å€‹å¸³æˆ¶:', window.ownerAccountsData.map(acc => ({
            id: acc.id,
            name: acc.name,
            currency: acc.currency,
            holder_id: acc.holder_id
        })));
    
    // ç²å– DOM å…ƒç´ 
    const accountsContainer = document.getElementById('accounts-container');
    const movementsTbody = document.getElementById('movements-tbody');
    
    // æ¸²æŸ“å¸³æˆ¶åˆ—è¡¨
    function renderAccounts() {
        console.log('ğŸ” é–‹å§‹æ¸²æŸ“å¸³æˆ¶åˆ—è¡¨...');
        
        if (!accountsContainer) {
            console.error('âŒ æ‰¾ä¸åˆ° accounts-container å…ƒç´ ');
            return;
        }
        
        accountsContainer.innerHTML = '';
        
        if (!holders || holders.length === 0) {
            console.log('âš ï¸ æ²’æœ‰æŒæœ‰äººæ•¸æ“š');
            accountsContainer.innerHTML = '<div class="col-12 text-center text-muted p-4">å°šç„¡è³‡é‡‘æŒæœ‰äººã€‚</div>';
            return;
        }
        
        console.log('âœ… æ‰¾åˆ° ' + holders.length + ' å€‹æŒæœ‰äººï¼Œé–‹å§‹æ¸²æŸ“...');
        
        holders.forEach(function(holder, index) {
            const holderId = holder.id;
            const holderName = holder.name;
            const holderData = accountsByHolder[holderId];
            
            console.log('ğŸ“‹ æ¸²æŸ“æŒæœ‰äºº ' + (index + 1) + ': ' + holderName + ' (ID: ' + holderId + ')');
            
            let accountsHtml = '';
            let totalTwd = 0;
            let totalRmb = 0;
            
            if (holderData && holderData.accounts && holderData.accounts.length > 0) {
                console.log('ğŸ“‹ æŒæœ‰äºº ' + holderName + ' æœ‰ ' + holderData.accounts.length + ' å€‹å¸³æˆ¶');
                holderData.accounts.forEach(function(acc) {
                    const currencyBadgeClass = acc.currency === 'TWD' ? 'bg-primary' : 'bg-success';
                    const currencyTextClass = acc.currency === 'TWD' ? 'text-primary' : 'text-success';
                    
                    accountsHtml += '<li class="list-group-item py-2">';
                    accountsHtml += '<div class="d-flex justify-content-between align-items-center">';
                    
                    // å·¦å´ï¼šè²¨å¹£æ¨™ç±¤å’Œå¸³æˆ¶åç¨±
                    accountsHtml += '<div class="d-flex align-items-center">';
                    accountsHtml += '<span class="badge ' + currencyBadgeClass + ' me-2" style="min-width: 50px;">' + acc.currency + '</span>';
                    accountsHtml += '<span class="fw-medium">' + acc.name + '</span>';
                    accountsHtml += '</div>';
                    
                    // å³å´ï¼šé‡‘é¡å’Œæ“ä½œæŒ‰éˆ•
                    accountsHtml += '<div class="d-flex align-items-center">';
                    accountsHtml += '<strong class="me-3 ' + currencyTextClass + ' account-balance" style="min-width: 120px; text-align: right;">' + acc.balance.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</strong>';
                    accountsHtml += '<div class="btn-group btn-group-sm">';
                    accountsHtml += '<button class="btn btn-outline-primary btn-movement btn-sm" data-account-id="' + acc.id + '" data-account-name="' + acc.name + '" title="å­˜å…¥/æå‡º">';
                    accountsHtml += '<i class="bi bi-arrow-down-up"></i>';
                    accountsHtml += '</button>';
                    accountsHtml += '<button class="btn btn-outline-danger btn-sm delete-account-btn" data-account-id="' + acc.id + '" data-account-name="' + acc.name + '" title="åˆªé™¤å¸³æˆ¶">';
                    accountsHtml += '&times;';
                    accountsHtml += '</button>';
                    accountsHtml += '</div>';
                    accountsHtml += '</div>';
                    
                    accountsHtml += '</div>';
                    accountsHtml += '</li>';
                });
                totalTwd = holderData.total_twd || 0;
                totalRmb = holderData.total_rmb || 0;
            } else {
                console.log('ğŸ“‹ æŒæœ‰äºº ' + holderName + ' æ²’æœ‰å¸³æˆ¶');
                accountsHtml = '<li class="list-group-item py-1 text-muted text-center small">-- å°šç„¡å¸³æˆ¶ --</li>';
                totalTwd = 0;
                totalRmb = 0;
            }
            
            const subtotalFooter = '<div class="card-footer bg-light d-flex justify-content-around py-1">' +
                '<div><small class="text-muted">TWD:</small> <strong class="text-primary">' + totalTwd.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</strong></div>' +
                '<div><small class="text-muted">RMB:</small> <strong class="text-success">' + totalRmb.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</strong></div>' +
                '</div>';
            
            const holderCard = '<div class="col-lg-4 col-md-6 mb-2">' +
                '<div class="card shadow-sm h-100">' +
                '<div class="card-header py-2 d-flex justify-content-between align-items-center">' +
                '<strong class="h6 mb-0">' + holderName + '</strong>' +
                '<button class="btn btn-danger btn-sm py-0 px-2 delete-holder-btn" data-holder-id="' + holderId + '" data-holder-name="' + holderName + '">åˆªé™¤</button>' +
                '</div>' +
                '<ul class="list-group list-group-flush">' + accountsHtml + '</ul>' +
                subtotalFooter +
                '</div>' +
                '</div>';
            
            accountsContainer.innerHTML += holderCard;
        });
        
        console.log('âœ… å¸³æˆ¶åˆ—è¡¨æ¸²æŸ“å®Œæˆ');
        
        // é‡æ–°è¨­ç½®äº‹ä»¶ç›£è½å™¨
        setupEventListeners();
    }
    
    // è¨­ç½®äº‹ä»¶ç›£è½å™¨
    function setupEventListeners() {
        // è¨­ç½®å‡ºå…¥å¸³æŒ‰éˆ•äº‹ä»¶
        const movementButtons = document.querySelectorAll('.btn-movement');
        movementButtons.forEach(function(btn) {
            btn.addEventListener('click', function() {
                const accountId = this.dataset.accountId;
                const accountName = this.dataset.accountName;
                console.log('ğŸ”„ é»æ“Šå‡ºå…¥å¸³æŒ‰éˆ•:', accountId, accountName);
                
                // æ‰“é–‹å‡ºå…¥å¸³æ¨¡æ…‹æ¡†
                openMovementModal(accountId, accountName);
            });
        });
        
        // è¨­ç½®åˆªé™¤æŒ‰éˆ•äº‹ä»¶
        const deleteAccountButtons = document.querySelectorAll('.delete-account-btn');
        deleteAccountButtons.forEach(function(btn) {
            btn.addEventListener('click', function() {
                const accountId = this.dataset.accountId;
                const accountName = this.dataset.accountName;
                
                if (!confirm('ç¢ºå®šè¦åˆªé™¤å¸³æˆ¶ã€Œ' + accountName + 'ã€å—ï¼Ÿ')) {
                    return;
                }
                
                fetch('/admin/update_cash_account', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'action=delete_account&account_id=' + accountId
                })
                .then(function(response) {
                    if (response.ok) {
                        console.log('âœ… å¸³æˆ¶åˆªé™¤æˆåŠŸ');
                        window.location.reload();
                    } else {
                        throw new Error('åˆªé™¤å¤±æ•—');
                    }
                })
                .catch(function(error) {
                    console.error('âŒ åˆªé™¤å¸³æˆ¶éŒ¯èª¤:', error);
                    alert('åˆªé™¤å¸³æˆ¶æ™‚ç™¼ç”ŸéŒ¯èª¤');
                });
            });
        });
        
        // è¨­ç½®åˆªé™¤æŒæœ‰äººæŒ‰éˆ•äº‹ä»¶
        const deleteHolderButtons = document.querySelectorAll('.delete-holder-btn');
        deleteHolderButtons.forEach(function(btn) {
            btn.addEventListener('click', function() {
                const holderId = this.dataset.holderId;
                const holderName = this.dataset.holderName;
                
                if (!confirm('ç¢ºå®šè¦åˆªé™¤æŒæœ‰äººã€Œ' + holderName + 'ã€åŠå…¶æ‰€æœ‰å¸³æˆ¶å—ï¼Ÿ')) {
                    return;
                }
                
                fetch('/admin/update_cash_account', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'action=delete_holder&holder_id=' + holderId
                })
                .then(function(response) {
                    if (response.ok) {
                        console.log('âœ… æŒæœ‰äººåˆªé™¤æˆåŠŸ');
                        window.location.reload();
                    } else {
                        throw new Error('åˆªé™¤å¤±æ•—');
                    }
                })
                .catch(function(error) {
                    console.error('âŒ åˆªé™¤æŒæœ‰äººéŒ¯èª¤:', error);
                    alert('åˆªé™¤æŒæœ‰äººæ™‚ç™¼ç”ŸéŒ¯èª¤');
                });
            });
        });

        // è¨­ç½®éŠ·å¸³æŒ‰éˆ•äº‹ä»¶
        const settlementButtons = document.querySelectorAll('.settlement-btn');
        settlementButtons.forEach(function(btn) {
            btn.addEventListener('click', function() {
                const customerId = this.dataset.customerId;
                const customerName = this.dataset.customerName;
                const receivableAmount = this.dataset.receivableAmount;
                console.log('ğŸ”„ é»æ“ŠéŠ·å¸³æŒ‰éˆ•:', customerId, customerName, receivableAmount);
                
                // æ‰“é–‹éŠ·å¸³æ¨¡æ…‹æ¡†
                openSettlementModal(customerId, customerName, receivableAmount);
            });
        });

        // è¨­ç½®å®¢æˆ¶äº¤æ˜“è¨˜éŒ„é»æ“Šäº‹ä»¶
        const customerTransactionLinks = document.querySelectorAll('.customer-transactions');
        customerTransactionLinks.forEach(function(link) {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const customerId = this.dataset.customerId;
                const customerName = this.dataset.customerName;
                console.log('ğŸ‘¤ é»æ“Šå®¢æˆ¶äº¤æ˜“è¨˜éŒ„:', customerId, customerName);
                
                if (customerId && customerName) {
                    openCustomerTransactionsModal(customerId, customerName);
                } else {
                    console.error('âŒ å®¢æˆ¶IDæˆ–åç¨±ç¼ºå¤±:', { customerId, customerName });
                }
            });
        });
    }
    
    // åˆ†é ç›¸é—œè®Šé‡
    let currentPage = 1;
    let currentPagination = null;

    // è¼‰å…¥åˆ†é æµæ°´è¨˜éŒ„
    function loadMovements(page = 1) {
        console.log('ğŸ” é–‹å§‹è¼‰å…¥ç¬¬', page, 'é æµæ°´è¨˜éŒ„...');
        
        if (!movementsTbody) {
            console.error('âŒ æ‰¾ä¸åˆ° movements-tbody å…ƒç´ ');
            return;
        }
        
        // é¡¯ç¤ºè¼‰å…¥ä¸­
        movementsTbody.innerHTML = '<tr><td colspan="9" class="text-center p-3"><i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</td></tr>';
        
        // ç™¼é€APIè«‹æ±‚
        fetch(`/api/cash_management/transactions?page=${page}`)
            .then(response => response.json())
            .then(result => {
                if (result.status === 'success') {
                    currentPage = page;
                    currentPagination = result.data.pagination;
                    renderMovements(result.data.transactions);
                    renderPagination(result.data.pagination);
                } else {
                    console.error('âŒ è¼‰å…¥æµæ°´è¨˜éŒ„å¤±æ•—:', result.message);
                    movementsTbody.innerHTML = '<tr><td colspan="9" class="text-center p-3 text-danger">è¼‰å…¥å¤±æ•—: ' + result.message + '</td></tr>';
                }
            })
            .catch(error => {
                console.error('âŒ ç¶²è·¯éŒ¯èª¤:', error);
                movementsTbody.innerHTML = '<tr><td colspan="9" class="text-center p-3 text-danger">ç¶²è·¯éŒ¯èª¤ï¼Œè«‹é‡è©¦</td></tr>';
            });
    }

    // æ¸²æŸ“è³‡é‡‘æµæ°´
    function renderMovements(transactions) {
        console.log('ğŸ” é–‹å§‹æ¸²æŸ“è³‡é‡‘æµæ°´...');
        
        if (!movementsTbody) {
            console.error('âŒ æ‰¾ä¸åˆ° movements-tbody å…ƒç´ ');
            return;
        }
        
        movementsTbody.innerHTML = '';
        
        if (!transactions || transactions.length === 0) {
            console.log('âš ï¸ æ²’æœ‰è³‡é‡‘æµæ°´æ•¸æ“š');
            movementsTbody.innerHTML = '<tr><td colspan="9" class="text-center p-5 text-muted">å°šç„¡è³‡é‡‘æµæ°´ç´€éŒ„ã€‚</td></tr>';
            return;
        }
        
        console.log('âœ… æ‰¾åˆ° ' + transactions.length + ' ç­†è³‡é‡‘æµæ°´ï¼Œé–‹å§‹æ¸²æŸ“...');
        
        transactions.forEach(function(m, index) {
            const twdChange = parseFloat(m.twd_change) || 0;
            const rmbChange = parseFloat(m.rmb_change) || 0;
            const profit = m.profit || 0;
            
            // å°‡é¡å‹è½‰æ›ç‚ºä¸­æ–‡é¡¯ç¤º
            let typeDisplay = m.type;
            let typeClass = 'badge bg-info-subtle text-info-emphasis';
            
            switch(m.type) {
                case 'PURCHASE':
                case 'è²·å…¥':
                    typeDisplay = 'è²·å…¥';
                    typeClass = 'badge bg-primary-subtle text-primary-emphasis';
                    break;
                case 'SALES':
                case 'å”®å‡º':
                    typeDisplay = 'å”®å‡º';
                    typeClass = 'badge bg-primary-subtle text-primary-emphasis';  // è—è‰²
                    break;
                case 'TRANSFER':
                case 'è½‰å¸³':
                    typeDisplay = 'è½‰å¸³';
                    typeClass = 'badge bg-warning-subtle text-warning-emphasis';
                    break;
                case 'SETTLEMENT':
                case 'éŠ·å¸³':
                    typeDisplay = 'éŠ·å¸³';
                    typeClass = 'badge bg-danger-subtle text-danger-emphasis';  // ç´…è‰²
                    break;
                case 'DEPOSIT':
                case 'å­˜æ¬¾':
                    typeDisplay = 'å­˜æ¬¾';
                    typeClass = 'badge bg-secondary-subtle text-secondary-emphasis';
                    break;
                case 'WITHDRAWAL':
                case 'ææ¬¾':
                    typeDisplay = 'ææ¬¾';
                    typeClass = 'badge bg-danger-subtle text-danger-emphasis';
                    break;
                case 'CARD_PURCHASE':
                    typeDisplay = 'åˆ·å¡';
                    typeClass = 'badge bg-warning-subtle text-warning-emphasis';
                    break;
                case 'CUSTOMER_PAYMENT':
                    typeDisplay = 'å®¢æˆ¶ä»˜æ¬¾';
                    typeClass = 'badge bg-success-subtle text-success-emphasis';
                    break;
                case 'è¨˜å¸³':
                    typeDisplay = 'è¨˜å¸³';
                    typeClass = 'badge bg-secondary-subtle text-secondary-emphasis';
                    break;
                default:
                    typeDisplay = m.type;
                    typeClass = 'badge bg-light-subtle text-muted';
                    break;
            }
            
            // åªåœ¨å”®å‡ºäº¤æ˜“æ™‚é¡¯ç¤ºåˆ©æ½¤
            const profitDisplay = (m.type === 'å”®å‡º' && profit) ? profit.toLocaleString('en-US', {minimumFractionDigits: 2}) : '';
            
            const row = '<tr>' +
                '<td class="ps-3"><small>' + (m.date ? new Date(m.date).toLocaleString('zh-TW') : 'N/A') + '</small></td>' +
                '<td><span class="' + typeClass + '">' + typeDisplay + '</span></td>' +
                '<td>' + (m.description || '') + '</td>' +
                '<td>' + (m.operator || '') + '</td>' +
                '<td>' + (m.payment_account || 'N/A') + '</td>' +
                '<td>' + (m.deposit_account || 'N/A') + '</td>' +
                '<td><small>' + (m.note || '') + '</small></td>' +
                '<td class="text-end"><span class="text-primary">' + (twdChange >= 0 ? '+' : '') + twdChange.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</span></td>' +
                '<td class="text-end"><span class="text-success">' + (rmbChange >= 0 ? '+' : '') + rmbChange.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</span></td>' +
                '<td class="text-end pe-3">' + profitDisplay + '</td>' +
                '</tr>';
            
            movementsTbody.innerHTML += row;
        });
        
        console.log('âœ… è³‡é‡‘æµæ°´æ¸²æŸ“å®Œæˆ');
    }

    // æ¸²æŸ“åˆ†é æ§åˆ¶é …
    function renderPagination(pagination) {
        const paginationInfo = document.getElementById('pagination-info');
        const paginationControls = document.getElementById('pagination-controls');
        
        if (!paginationInfo || !paginationControls) {
            console.error('âŒ æ‰¾ä¸åˆ°åˆ†é æ§åˆ¶å…ƒç´ ');
            return;
        }
        
        // é¡¯ç¤ºåˆ†é ä¿¡æ¯
        const startRecord = (pagination.current_page - 1) * pagination.per_page + 1;
        const endRecord = Math.min(pagination.current_page * pagination.per_page, pagination.total_records);
        paginationInfo.textContent = `ç¬¬ ${startRecord}-${endRecord} ç­†ï¼Œå…± ${pagination.total_records} ç­†è¨˜éŒ„`;
        
        // æ¸…ç©ºä¸¦é‡å»ºåˆ†é æŒ‰éˆ•
        paginationControls.innerHTML = '';
        
        // ä¸Šä¸€é æŒ‰éˆ•
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${pagination.has_prev ? '' : 'disabled'}`;
        prevLi.innerHTML = `<a class="page-link" href="#" data-page="${pagination.current_page - 1}">ä¸Šä¸€é </a>`;
        paginationControls.appendChild(prevLi);
        
        // é ç¢¼æŒ‰éˆ•
        const startPage = Math.max(1, pagination.current_page - 2);
        const endPage = Math.min(pagination.total_pages, pagination.current_page + 2);
        
        if (startPage > 1) {
            const firstLi = document.createElement('li');
            firstLi.className = 'page-item';
            firstLi.innerHTML = '<a class="page-link" href="#" data-page="1">1</a>';
            paginationControls.appendChild(firstLi);
            
            if (startPage > 2) {
                const ellipsisLi = document.createElement('li');
                ellipsisLi.className = 'page-item disabled';
                ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                paginationControls.appendChild(ellipsisLi);
            }
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const pageLi = document.createElement('li');
            pageLi.className = `page-item ${i === pagination.current_page ? 'active' : ''}`;
            pageLi.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
            paginationControls.appendChild(pageLi);
        }
        
        if (endPage < pagination.total_pages) {
            if (endPage < pagination.total_pages - 1) {
                const ellipsisLi = document.createElement('li');
                ellipsisLi.className = 'page-item disabled';
                ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                paginationControls.appendChild(ellipsisLi);
            }
            
            const lastLi = document.createElement('li');
            lastLi.className = 'page-item';
            lastLi.innerHTML = `<a class="page-link" href="#" data-page="${pagination.total_pages}">${pagination.total_pages}</a>`;
            paginationControls.appendChild(lastLi);
        }
        
        // ä¸‹ä¸€é æŒ‰éˆ•
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${pagination.has_next ? '' : 'disabled'}`;
        nextLi.innerHTML = `<a class="page-link" href="#" data-page="${pagination.current_page + 1}">ä¸‹ä¸€é </a>`;
        paginationControls.appendChild(nextLi);
        
        // ç‚ºåˆ†é æŒ‰éˆ•æ·»åŠ é»æ“Šäº‹ä»¶
        paginationControls.addEventListener('click', function(e) {
            e.preventDefault();
            if (e.target.classList.contains('page-link')) {
                const page = parseInt(e.target.getAttribute('data-page'));
                if (page && page >= 1 && page <= pagination.total_pages) {
                    loadMovements(page);
                }
            }
        });
    }
    
    // å¾æè¿°ä¸­æå–åŸºæœ¬æè¿°ï¼ˆå»é™¤å‚™è¨»å’Œç³»çµ±ä¿¡æ¯ï¼‰
    function extractBaseDescriptionFromDescription(description) {
        if (!description) return '';
        
        // å¦‚æœæè¿°åŒ…å« " | " åˆ†éš”ç¬¦ï¼Œåªè¿”å›ç¬¬ä¸€éƒ¨åˆ†ï¼ˆåŸºæœ¬æ“ä½œæè¿°ï¼‰
        const parts = description.split(' | ');
        return parts[0] || '';
    }
    
    // å¾æè¿°ä¸­æå–å‚™è¨»
    function extractNoteFromDescription(description) {
        if (!description) return '';
        
        // å¦‚æœæè¿°åŒ…å« " | " åˆ†éš”ç¬¦ï¼Œæå–åˆ†éš”ç¬¦å¾Œçš„å…§å®¹ä½œç‚ºå‚™è¨»
        const parts = description.split(' | ');
        if (parts.length > 1) {
            // è¿”å›æœ€å¾Œä¸€éƒ¨åˆ†ï¼Œä½†æ’é™¤æˆæœ¬åŒ¯ç‡ä¿¡æ¯
            const lastPart = parts[parts.length - 1];
            if (lastPart.includes('æˆæœ¬åŒ¯ç‡:') || lastPart.includes('å·²æŒ‰FIFO')) {
                // å¦‚æœæœ‰å¤šå€‹éƒ¨åˆ†ï¼Œè¿”å›å€’æ•¸ç¬¬äºŒéƒ¨åˆ†
                return parts.length > 2 ? parts[parts.length - 2] : '';
            }
            return lastPart;
        }
        
        return ''; // æ²’æœ‰å‚™è¨»
    }
    
    // æ›´æ–°ç¸½è³‡ç”¢æ•¸æ“š
    function updateTotalAssets() {
        console.log('ğŸ”„ æ›´æ–°ç¸½è³‡ç”¢æ•¸æ“š...');
        
        fetch('/api/cash_management/totals')
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                console.log('ğŸ“Š ç²å–åˆ°æ–°çš„ç¸½è³‡ç”¢æ•¸æ“š:', data);
                
                const totalTwdElement = document.getElementById('totalTwdDisplay');
                const totalRmbElement = document.getElementById('totalRmbDisplay');
                const totalReceivablesElement = document.getElementById('totalReceivablesDisplay');
                
                if (totalTwdElement) {
                    totalTwdElement.textContent = 'NT$ ' + data.total_twd.toLocaleString('en-US', {minimumFractionDigits: 2});
                }
                
                if (totalRmbElement) {
                    totalRmbElement.textContent = 'Â¥ ' + data.total_rmb.toLocaleString('en-US', {minimumFractionDigits: 2});
                }
                
                if (totalReceivablesElement) {
                    totalReceivablesElement.textContent = 'NT$ ' + data.total_receivables_twd.toLocaleString('en-US', {minimumFractionDigits: 2});
                }
                
                console.log('âœ… ç¸½è³‡ç”¢æ•¸æ“šæ›´æ–°å®Œæˆ');
            })
            .catch(function(error) {
                console.error('âŒ æ›´æ–°ç¸½è³‡ç”¢æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            });
    }
    
    // æ‰“é–‹å‡ºå…¥å¸³æ¨¡æ…‹æ¡†
    window.openMovementModal = function(accountId, accountName) {
        console.log('ğŸ”„ æ‰“é–‹å‡ºå…¥å¸³æ¨¡æ…‹æ¡†:', accountId, accountName);
        
        // è¨­ç½®æ¨¡æ…‹æ¡†æ¨™é¡Œå’Œå¸³æˆ¶ID
        const modalTitle = document.getElementById('movementModalTitle');
        const accountIdInput = document.getElementById('movementAccountId');
        
        if (modalTitle) {
            modalTitle.textContent = 'è³‡é‡‘æ“ä½œ - ' + accountName;
        }
        
        if (accountIdInput) {
            accountIdInput.value = accountId;
        }
        
        // å¾å¾Œç«¯æ•¸æ“šä¸­æŸ¥æ‰¾è©²å¸³æˆ¶çš„å¹£åˆ¥
        let isRmbAccount = false;
        const ownerAccounts = window.ownerAccountsData || [];
        
        console.log('ğŸ” é–‹å§‹æŸ¥æ‰¾å¸³æˆ¶:', {
            accountId: accountId,
            accountIdType: typeof accountId,
            ownerAccountsLength: ownerAccounts.length,
            allAccountIds: ownerAccounts.map(acc => ({ id: acc.id, idType: typeof acc.id, currency: acc.currency }))
        });
        
        // å˜—è©¦å¤šç¨®æ¯”è¼ƒæ–¹å¼
        const account = ownerAccounts.find(acc => 
            acc.id == accountId || 
            acc.id === accountId || 
            String(acc.id) === String(accountId) ||
            parseInt(acc.id) === parseInt(accountId)
        );
        
        if (account) {
            isRmbAccount = account.currency === 'RMB';
            console.log('âœ… æ‰¾åˆ°å¸³æˆ¶:', account, 'æ˜¯å¦ç‚ºRMB:', isRmbAccount);
        } else {
            console.log('âŒ æœªæ‰¾åˆ°å¸³æˆ¶ï¼Œä½¿ç”¨å‚™ç”¨åˆ¤æ–·');
            // å‚™ç”¨æ–¹æ¡ˆï¼šå¾å¸³æˆ¶åç¨±åˆ¤æ–·
            isRmbAccount = accountName.includes('RMB') || accountName.includes('äººæ°‘å¹£');
            console.log('âš ï¸ ä½¿ç”¨å‚™ç”¨åˆ¤æ–·é‚è¼¯ï¼Œå¸³æˆ¶åç¨±:', accountName, 'æ˜¯å¦ç‚ºRMB:', isRmbAccount);
        }
        
        const rmbCostRateDiv = document.getElementById('rmbCostRateDiv');
        const rmbCostRateInput = document.getElementById('rmbCostRate');
        
        console.log('ğŸ”§ RMBæ¬„ä½å…ƒç´ æª¢æŸ¥:', {
            rmbCostRateDiv: !!rmbCostRateDiv,
            rmbCostRateInput: !!rmbCostRateInput,
            isRmbAccount: isRmbAccount
        });
        
        if (rmbCostRateDiv && rmbCostRateInput) {
            if (isRmbAccount) {
                rmbCostRateDiv.style.display = 'block';
                rmbCostRateInput.required = true;
                console.log('âœ… RMBåŒ¯ç‡æ¬„ä½å·²é¡¯ç¤º');
            } else {
                rmbCostRateDiv.style.display = 'none';
                rmbCostRateInput.required = false;
                rmbCostRateInput.value = '';
                console.log('â¹ï¸ RMBåŒ¯ç‡æ¬„ä½å·²éš±è—');
            }
        } else {
            console.error('âŒ RMBåŒ¯ç‡æ¬„ä½å…ƒç´ æœªæ‰¾åˆ°');
        }
        
        // æ¸…ç©ºè¡¨å–®
        const movementForm = document.getElementById('addMovementModal').querySelector('form');
        if (movementForm) {
            movementForm.reset();
            // é‡æ–°è¨­ç½®å¸³æˆ¶ID
            const accountIdInput = document.getElementById('movementAccountId');
            if (accountIdInput) {
                accountIdInput.value = accountId;
            }
            
            // é»˜èªé¸æ“‡å­˜æ¬¾é¸é …
            const depositRadio = document.getElementById('movementDeposit');
            if (depositRadio) {
                depositRadio.checked = true;
                console.log('âœ… é»˜èªé¸æ“‡å­˜æ¬¾é¸é …');
            }
        }
        
        // è¨­ç½®æ“ä½œé¡å‹è®Šæ›´ç›£è½å™¨
        const depositRadio = document.getElementById('movementDeposit');
        const withdrawRadio = document.getElementById('movementWithdraw');
        
        function updateCostRateVisibility() {
            const isDeposit = depositRadio && depositRadio.checked;
            const shouldShowCostRate = isRmbAccount && isDeposit;
            
            if (rmbCostRateDiv && rmbCostRateInput) {
                if (shouldShowCostRate) {
                    rmbCostRateDiv.style.display = 'block';
                    rmbCostRateInput.required = true;
                } else {
                    rmbCostRateDiv.style.display = 'none';
                    rmbCostRateInput.required = false;
                    rmbCostRateInput.value = '';
                }
            }
        }
        
        if (depositRadio) {
            depositRadio.addEventListener('change', updateCostRateVisibility);
        }
        if (withdrawRadio) {
            withdrawRadio.addEventListener('change', updateCostRateVisibility);
        }
        
        // åˆå§‹åŒ–é¡¯ç¤ºç‹€æ…‹ï¼ˆåœ¨é»˜èªé¸æ“‡å­˜æ¬¾å¾Œå†æª¢æŸ¥ï¼‰
        setTimeout(() => {
            updateCostRateVisibility();
            console.log('ğŸ”„ åˆå§‹åŒ–RMBåŒ¯ç‡æ¬„ä½é¡¯ç¤ºç‹€æ…‹');
        }, 100);

        // é¡¯ç¤ºæ¨¡æ…‹æ¡†
        const modal = new bootstrap.Modal(document.getElementById('addMovementModal'));
        modal.show();
        
        // åœ¨æ¨¡æ…‹æ¡†é¡¯ç¤ºå¾Œå†æ¬¡æª¢æŸ¥RMBåŒ¯ç‡æ¬„ä½
        modal._element.addEventListener('shown.bs.modal', function() {
            console.log('ğŸ”§ æ¨¡æ…‹æ¡†å·²é¡¯ç¤ºï¼Œé‡æ–°æª¢æŸ¥RMBåŒ¯ç‡æ¬„ä½');
            const rmbDiv = document.getElementById('rmbCostRateDiv');
            const rmbInput = document.getElementById('rmbCostRate');
            const depositRadio = document.getElementById('movementDeposit');
            
            console.log('ğŸ” æ¨¡æ…‹æ¡†é¡¯ç¤ºå¾Œçš„å…ƒç´ æª¢æŸ¥:', {
                rmbDiv: !!rmbDiv,
                rmbInput: !!rmbInput,
                depositRadio: !!depositRadio,
                isRmbAccount: isRmbAccount,
                depositChecked: depositRadio ? depositRadio.checked : false
            });
            
            if (isRmbAccount && rmbDiv && depositRadio && depositRadio.checked) {
                rmbDiv.style.display = 'block';
                rmbDiv.style.visibility = 'visible';
                rmbDiv.style.opacity = '1';
                console.log('âœ… å¼·åˆ¶é¡¯ç¤ºRMBåŒ¯ç‡æ¬„ä½');
            } else if (isRmbAccount && rmbDiv) {
                console.log('âš ï¸ RMBå¸³æˆ¶ä½†æ¢ä»¶ä¸æ»¿è¶³:', {
                    depositRadio: !!depositRadio,
                    depositChecked: depositRadio ? depositRadio.checked : false
                });
            }
        });
    };
    
    // æ‰“é–‹éŠ·å¸³æ¨¡æ…‹æ¡†
    window.openSettlementModal = function(customerId, customerName, receivableAmount) {
        console.log('ğŸ”„ æ‰“é–‹éŠ·å¸³æ¨¡æ…‹æ¡†:', customerId, customerName, receivableAmount);
        
        // è¨­ç½®æ¨¡æ…‹æ¡†æ•¸æ“š
        const customerIdInput = document.getElementById('settlementCustomerId');
        const customerNameInput = document.getElementById('settlementCustomerName');
        const totalReceivableInput = document.getElementById('settlementTotalReceivable');
        const amountInput = document.getElementById('settlementAmount');
        
        // è¨­ç½®å®¢æˆ¶IDï¼ˆéš±è—æ¬„ä½ï¼‰
        if (customerIdInput) {
            customerIdInput.value = customerId;
        }
        
        // è‡ªå‹•å¡«å…¥å®¢æˆ¶åç¨±
        if (customerNameInput) {
            customerNameInput.value = customerName;
            console.log('âœ… å·²è‡ªå‹•å¡«å…¥å®¢æˆ¶åç¨±:', customerName);
        }
        
        // è‡ªå‹•å¡«å…¥æ‡‰æ”¶å¸³æ¬¾ç¸½é¡
        if (totalReceivableInput) {
            const formattedAmount = 'NT$ ' + parseFloat(receivableAmount).toLocaleString('en-US', {minimumFractionDigits: 2});
            totalReceivableInput.value = formattedAmount;
            console.log('âœ… å·²è‡ªå‹•å¡«å…¥æ‡‰æ”¶å¸³æ¬¾ç¸½é¡:', formattedAmount);
        }
        
        // é è¨­éŠ·å¸³é‡‘é¡ç‚ºå…¨é¡ï¼Œä¸¦è¨­ç½®æç¤º
        if (amountInput) {
            amountInput.value = parseFloat(receivableAmount).toFixed(2);
            amountInput.placeholder = 'å¯éƒ¨åˆ†éŠ·å¸³ï¼Œæœ€å¤š ' + parseFloat(receivableAmount).toLocaleString('en-US', {minimumFractionDigits: 2});
            console.log('âœ… å·²è‡ªå‹•å¡«å…¥éŠ·å¸³é‡‘é¡:', receivableAmount);
        }
        
        // é¡¯ç¤ºæ¨¡æ…‹æ¡†
        const modal = new bootstrap.Modal(document.getElementById('settlementModal'));
        modal.show();
    };
    
    // æ‰“é–‹å®¢æˆ¶äº¤æ˜“è¨˜éŒ„æ¨¡æ…‹æ¡†
    window.openCustomerTransactionsModal = function(customerId, customerName) {
        console.log('ğŸ”„ æ‰“é–‹å®¢æˆ¶äº¤æ˜“è¨˜éŒ„æ¨¡æ…‹æ¡†:', customerId, customerName);
        
        // æ›´æ–°æ¨¡æ…‹æ¡†æ¨™é¡Œ
        const modalTitle = document.getElementById('customerTransactionsTitle');
        const customerNameDisplay = document.getElementById('customerTransactionsName');
        
        if (modalTitle) {
            modalTitle.innerHTML = '<i class="bi bi-person-lines-fill me-2"></i>' + customerName + ' çš„äº¤æ˜“ç´€éŒ„';
        }
        
        if (customerNameDisplay) {
            customerNameDisplay.textContent = customerName;
        }
        
        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        const tableBody = document.getElementById('customerTransactionsTable');
        const emptyState = document.getElementById('customerTransactionsEmpty');
        
        if (tableBody) {
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-3"><div class="spinner-border spinner-border-sm me-2"></div>è¼‰å…¥ä¸­...</td></tr>';
        }
        
        if (emptyState) {
            emptyState.style.display = 'none';
        }
        
        // é¡¯ç¤ºæ¨¡æ…‹æ¡†
        const modal = new bootstrap.Modal(document.getElementById('customerTransactionsModal'));
        modal.show();
        
        // ç²å–å®¢æˆ¶äº¤æ˜“ç´€éŒ„
        fetchCustomerTransactions(customerId);
    };
    
    // ç²å–å®¢æˆ¶äº¤æ˜“ç´€éŒ„
    function fetchCustomerTransactions(customerId) {
        fetch(`/api/customer/transactions/${customerId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    displayCustomerTransactions(data);
                } else {
                    console.error('âŒ ç²å–å®¢æˆ¶äº¤æ˜“è¨˜éŒ„å¤±æ•—:', data.message);
                    const tableBody = document.getElementById('customerTransactionsTable');
                    if (tableBody) {
                        tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger p-3">è¼‰å…¥å¤±æ•—: ' + (data.message || 'æœªçŸ¥éŒ¯èª¤') + '</td></tr>';
                    }
                }
            })
            .catch(error => {
                console.error('âŒ ç¶²è·¯éŒ¯èª¤:', error);
                const tableBody = document.getElementById('customerTransactionsTable');
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger p-3">ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦</td></tr>';
                }
            });
    }
    
    // é¡¯ç¤ºå®¢æˆ¶äº¤æ˜“ç´€éŒ„
    function displayCustomerTransactions(data) {
        const tableBody = document.getElementById('customerTransactionsTable');
        const emptyState = document.getElementById('customerTransactionsEmpty');
        const receivableDisplay = document.getElementById('customerTransactionsReceivable');
        
        console.log('ğŸ” é¡¯ç¤ºå®¢æˆ¶äº¤æ˜“è¨˜éŒ„æ•¸æ“š:', data);
        
        // æ›´æ–°æ‡‰æ”¶å¸³æ¬¾é¡¯ç¤º
        if (receivableDisplay && data.total_receivables_twd !== undefined) {
            receivableDisplay.textContent = 'NT$ ' + data.total_receivables_twd.toLocaleString('en-US', {minimumFractionDigits: 2});
            console.log('âœ… æ›´æ–°æ‡‰æ”¶å¸³æ¬¾é¡¯ç¤º:', data.total_receivables_twd);
        } else {
            console.error('âŒ æ‡‰æ”¶å¸³æ¬¾é¡¯ç¤ºæ›´æ–°å¤±æ•—:', {
                receivableDisplay: !!receivableDisplay,
                total_receivables_twd: data.total_receivables_twd
            });
        }
        
        if (!data.transactions || data.transactions.length === 0) {
            if (tableBody) {
                tableBody.innerHTML = '';
            }
            if (emptyState) {
                emptyState.style.display = 'block';
            }
            return;
        }
        
        if (emptyState) {
            emptyState.style.display = 'none';
        }
        
        if (tableBody) {
            let html = '';
            data.transactions.forEach(function(transaction) {
                const date = transaction.date;
                const type = transaction.type || '-';
                const description = transaction.description || '-';
                
                // RMBé‡‘é¡é¡¯ç¤º
                const rmb = transaction.rmb_amount && transaction.rmb_amount > 0 
                    ? `Â¥ ${transaction.rmb_amount.toLocaleString('en-US', {minimumFractionDigits: 2})}`
                    : '-';
                
                // TWDé‡‘é¡é¡¯ç¤º
                const twd = transaction.twd_amount && transaction.twd_amount > 0
                    ? `NT$ ${transaction.twd_amount.toLocaleString('en-US', {minimumFractionDigits: 2})}`
                    : '-';
                
                // åˆ©æ½¤é¡¯ç¤ºï¼šåªæœ‰å”®å‡ºæ™‚æ‰é¡¯ç¤ºåˆ©æ½¤
                const profit = (type === 'å”®å‡º' && transaction.profit_twd && transaction.profit_twd > 0)
                    ? `NT$ ${transaction.profit_twd.toLocaleString('en-US', {minimumFractionDigits: 2})}`
                    : '-';
                
                // é¡å‹æ¨™ç±¤é¡è‰²ï¼šå”®å‡ºç‚ºè—è‰²ï¼ŒéŠ·å¸³ç‚ºç´…è‰²
                let typeBadgeClass = 'bg-secondary';
                if (type === 'å”®å‡º') {
                    typeBadgeClass = 'bg-primary';
                } else if (type === 'éŠ·å¸³') {
                    typeBadgeClass = 'bg-danger';
                }
                
                html += `<tr>
                    <td><small>${date}</small></td>
                    <td><span class="badge ${typeBadgeClass}">${type}</span></td>
                    <td>${description}</td>
                    <td class="text-end text-success fw-bold">${rmb}</td>
                    <td class="text-end text-primary fw-bold">${twd}</td>
                    <td class="text-end text-warning fw-bold">${profit}</td>
                </tr>`;
            });
            tableBody.innerHTML = html;
            console.log('âœ… äº¤æ˜“è¨˜éŒ„è¡¨æ ¼å·²æ›´æ–°ï¼Œå…±', data.transactions.length, 'ç­†è¨˜éŒ„');
        }
    }

    // è™•ç†éŠ·å¸³è¡¨å–®æäº¤
    document.getElementById('settlementForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('ğŸ”„ é–‹å§‹è™•ç†éŠ·å¸³è¡¨å–®æäº¤');
        
        const formData = new FormData(this);
        const customerId = formData.get('customer_id');
        const paymentAmount = parseFloat(formData.get('settlement_amount'));
        const twdAccountId = formData.get('settlement_account');
        const note = formData.get('settlement_note');
        
        // é©—è­‰æ•¸æ“š
        if (!customerId || !paymentAmount || !twdAccountId) {
            Swal.fire('éŒ¯èª¤', 'è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ã€‚', 'error');
            return;
        }
        
        if (paymentAmount <= 0) {
            Swal.fire('éŒ¯èª¤', 'éŠ·å¸³é‡‘é¡å¿…é ˆå¤§æ–¼0ã€‚', 'error');
            return;
        }
        
        try {
            // ç™¼é€éŠ·å¸³è«‹æ±‚
            const response = await fetch('/api/settlement', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    customer_id: parseInt(customerId),
                    amount: paymentAmount,
                    account_id: parseInt(twdAccountId),
                    note: note || null
                })
            });
            
            const result = await response.json();
            
            if (response.ok && result.status === 'success') {
                Swal.fire('æˆåŠŸ', result.message, 'success');
                
                // é—œé–‰æ¨¡æ…‹æ¡†
                const modal = bootstrap.Modal.getInstance(document.getElementById('settlementModal'));
                modal.hide();
                
                // é‡æ–°è¼‰å…¥é é¢ä»¥é¡¯ç¤ºæœ€æ–°æ•¸æ“š
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                Swal.fire('éŒ¯èª¤', result.message || 'éŠ·å¸³å¤±æ•—', 'error');
            }
        } catch (error) {
            console.error('âŒ éŠ·å¸³è«‹æ±‚å¤±æ•—:', error);
            Swal.fire('éŒ¯èª¤', 'ç¶²è·¯è«‹æ±‚å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'error');
        }
    });
    
    // åˆå§‹åŒ–æ‰€æœ‰ä¸‹æ‹‰é¸å–®
    function initializeDropdowns() {
        console.log('ğŸ”„ åˆå§‹åŒ–ä¸‹æ‹‰é¸å–®...');
        
        // 1. å¡«å……æ–°å¢å¸³æˆ¶æ¨¡æ…‹æ¡†ä¸­çš„æŒæœ‰äººä¸‹æ‹‰é¸å–®
        populateHoldersDropdown();
        
        // 2. å¡«å……è½‰å¸³æ¨¡æ…‹æ¡†ä¸­çš„å¸³æˆ¶ä¸‹æ‹‰é¸å–®
        populateAccountsDropdowns();
        
        // 3. å¡«å……éŠ·å¸³æ¨¡æ…‹æ¡†ä¸­çš„å°å¹£å¸³æˆ¶ä¸‹æ‹‰é¸å–®
        populateSettlementAccountsDropdown();
        
        console.log('âœ… ä¸‹æ‹‰é¸å–®åˆå§‹åŒ–å®Œæˆ');
    }
    
    // å¡«å……æŒæœ‰äººä¸‹æ‹‰é¸å–®
    function populateHoldersDropdown() {
        const accountHolderSelect = document.getElementById('accountHolder');
        if (!accountHolderSelect) return;
        
        accountHolderSelect.innerHTML = '<option value="">--- è«‹é¸æ“‡æŒæœ‰äºº ---</option>';
        
        if (holders && holders.length > 0) {
            holders.forEach(function(holder) {
                const option = document.createElement('option');
                option.value = holder.id;
                option.textContent = holder.name;
                accountHolderSelect.appendChild(option);
            });
            console.log('âœ… å·²å¡«å…… ' + holders.length + ' å€‹æŒæœ‰äººåˆ°æ–°å¢å¸³æˆ¶ä¸‹æ‹‰é¸å–®');
        }
    }
    
    // å¡«å……è½‰å¸³ç”¨çš„å¸³æˆ¶ä¸‹æ‹‰é¸å–®
    function populateAccountsDropdowns() {
        const fromAccountSelect = document.getElementById('fromAccount');
        const toAccountSelect = document.getElementById('toAccount');
        
        if (!fromAccountSelect || !toAccountSelect) return;
        
        // æ¸…ç©ºç¾æœ‰é¸é …
        fromAccountSelect.innerHTML = '<option value="">--- è«‹é¸æ“‡è½‰å‡ºå¸³æˆ¶ ---</option>';
        toAccountSelect.innerHTML = '<option value="">--- è«‹é¸æ“‡è½‰å…¥å¸³æˆ¶ ---</option>';
        
        // å¡«å……è½‰å‡ºå¸³æˆ¶ï¼ˆæ‰€æœ‰å¸³æˆ¶ï¼‰
        if (holders && holders.length > 0) {
            holders.forEach(function(holder) {
                const holderData = accountsByHolder[holder.id];
                if (holderData && holderData.accounts && holderData.accounts.length > 0) {
                    holderData.accounts.forEach(function(acc) {
                        const optionText = `${holder.name} - ${acc.name} (${acc.currency}: ${acc.balance.toLocaleString()})`;
                        
                        // æ·»åŠ åˆ°è½‰å‡ºå¸³æˆ¶
                        const fromOption = document.createElement('option');
                        fromOption.value = acc.id;
                        fromOption.textContent = optionText;
                        fromOption.dataset.currency = acc.currency; // ä¿å­˜å¹£ç¨®ä¿¡æ¯
                        fromAccountSelect.appendChild(fromOption);
                    });
                }
            });
        }
        
        // ç‚ºè½‰å‡ºå¸³æˆ¶æ·»åŠ è®Šæ›´ç›£è½å™¨
        fromAccountSelect.addEventListener('change', function() {
            updateToAccountOptions();
        });
    }
    
    // æ ¹æ“šè½‰å‡ºå¸³æˆ¶çš„å¹£ç¨®ç¯©é¸è½‰å…¥å¸³æˆ¶
    function updateToAccountOptions() {
        const fromAccountSelect = document.getElementById('fromAccount');
        const toAccountSelect = document.getElementById('toAccount');
        
        if (!fromAccountSelect || !toAccountSelect) return;
        
        const selectedFromOption = fromAccountSelect.options[fromAccountSelect.selectedIndex];
        const selectedCurrency = selectedFromOption ? selectedFromOption.dataset.currency : null;
        
        // æ¸…ç©ºè½‰å…¥å¸³æˆ¶é¸é …
        toAccountSelect.innerHTML = '<option value="">--- è«‹é¸æ“‡è½‰å…¥å¸³æˆ¶ ---</option>';
        
        if (selectedCurrency && holders && holders.length > 0) {
            holders.forEach(function(holder) {
                const holderData = accountsByHolder[holder.id];
                if (holderData && holderData.accounts && holderData.accounts.length > 0) {
                    holderData.accounts.forEach(function(acc) {
                        // åªé¡¯ç¤ºç›¸åŒå¹£ç¨®ä¸”ä¸æ˜¯è½‰å‡ºå¸³æˆ¶çš„å¸³æˆ¶
                        if (acc.currency === selectedCurrency && acc.id != fromAccountSelect.value) {
                            const optionText = `${holder.name} - ${acc.name} (${acc.currency}: ${acc.balance.toLocaleString()})`;
                            
                            const toOption = document.createElement('option');
                            toOption.value = acc.id;
                            toOption.textContent = optionText;
                            toAccountSelect.appendChild(toOption);
                        }
                    });
                }
            });
        }
    }
    
    // å¡«å……éŠ·å¸³ç”¨çš„å°å¹£å¸³æˆ¶ä¸‹æ‹‰é¸å–®
    function populateSettlementAccountsDropdown() {
        const settlementAccountSelect = document.getElementById('settlementAccount');
        if (!settlementAccountSelect) return;
        
        settlementAccountSelect.innerHTML = '<option value="">--- è«‹é¸æ“‡æ”¶æ¬¾å¸³æˆ¶ ---</option>';
        
        // åªæ·»åŠ å°å¹£å¸³æˆ¶
        if (holders && holders.length > 0) {
            let twdAccountCount = 0;
            holders.forEach(function(holder) {
                const holderData = accountsByHolder[holder.id];
                if (holderData && holderData.accounts && holderData.accounts.length > 0) {
                    holderData.accounts.forEach(function(acc) {
                        if (acc.currency === 'TWD') {
                            const optionText = `${holder.name} - ${acc.name} (é¤˜é¡: NT$ ${acc.balance.toLocaleString()})`;
                            const option = document.createElement('option');
                            option.value = acc.id;
                            option.textContent = optionText;
                            settlementAccountSelect.appendChild(option);
                            twdAccountCount++;
                        }
                    });
                }
            });
            console.log('âœ… å·²å¡«å…… ' + twdAccountCount + ' å€‹å°å¹£å¸³æˆ¶åˆ°éŠ·å¸³ä¸‹æ‹‰é¸å–®');
        }
    }
    
    // æ‰‹å‹•åˆ·æ–°æ•¸æ“šå‡½æ•¸
    window.manualRefreshData = function() {
        console.log('ğŸ”„ æ‰‹å‹•åˆ·æ–°æ•¸æ“š...');
        updateTotalAssets();
        renderAccounts();
        loadMovements(1);
        // é‡æ–°åˆå§‹åŒ–ä¸‹æ‹‰é¸å–®
        initializeDropdowns();
        console.log('âœ… æ‰‹å‹•åˆ·æ–°å®Œæˆ');
    };
    
    // ç›£è½éŠ·å”®æ•¸æ“šè®Šæ›´äº‹ä»¶ï¼Œè‡ªå‹•åˆ·æ–°é é¢æ•¸æ“š
    window.addEventListener('salesDataChanged', function(event) {
        console.log('ğŸ”„ æ”¶åˆ°éŠ·å”®æ•¸æ“šè®Šæ›´äº‹ä»¶:', event.detail);
        if (event.detail.action === 'cancel_sale') {
            console.log('ğŸ”„ æª¢æ¸¬åˆ°éŠ·å”®è¨˜éŒ„å–æ¶ˆï¼Œè‡ªå‹•åˆ·æ–°ç¾é‡‘ç®¡ç†æ•¸æ“š...');
            // å»¶é²ä¸€ä¸‹å†åˆ·æ–°ï¼Œç¢ºä¿å¾Œç«¯æ•¸æ“šå·²æ›´æ–°
            setTimeout(() => {
                manualRefreshData();
            }, 500);
        }
    });
    
    // åˆå§‹åŒ–æ‰€æœ‰ä¸‹æ‹‰é¸å–®
    initializeDropdowns();
    
    // åˆå§‹åŒ–æ¸²æŸ“
    renderAccounts();
    loadMovements(1);
    
    console.log('âœ… ç¾é‡‘ç®¡ç†é é¢åˆå§‹åŒ–å®Œæˆ');
});
</script>
{% endblock %}