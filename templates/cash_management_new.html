{% extends "base.html" %}

{% block title %}現金管理儀表板{% endblock %}

{% block content %}
<div class="container-fluid pt-3">
    <!-- 頁面標題 -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-4 border-bottom">
        <h1 class="h2"><i class="bi bi-wallet2 me-2"></i>現金管理</h1>
    </div>

    <!-- 頂部核心指標卡片 -->
    <div class="row">
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm text-center h-100">
                <div class="card-body">
                    <p class="text-muted mb-1">總台幣資產 (TWD)</p>
                    <h2 class="fw-bold text-primary" id="totalTwdDisplay">NT$ {{ "{:,.2f}".format(total_twd or 0) }}</h2>
                    <small class="text-muted">即時更新</small>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm text-center h-100">
                <div class="card-body">
                    <p class="text-muted mb-1">總人民幣資產 (RMB)</p>
                    <h2 class="fw-bold text-success" id="totalRmbDisplay">¥ {{ "{:,.2f}".format(total_rmb or 0) }}</h2>
                    <small class="text-muted">即時更新</small>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm text-center h-100">
                <div class="card-body">
                    <p class="text-muted mb-1">總應收帳款 (TWD)</p>
                    <h2 class="fw-bold text-danger">NT$ {{ "{:,.2f}".format(total_receivables or 0) }}</h2>
                    <small class="text-muted">待收款項</small>
                </div>
            </div>
        </div>
    </div>

    <!-- 資金持有人與帳戶區塊 -->
    <div class="card shadow-sm mt-3">
        <div class="card-header">
            <h5 class="mb-0 fw-light"><i class="bi bi-people-fill me-2"></i>資金持有人與帳戶</h5>
        </div>
        <div class="card-body">
            <div id="accounts-container" class="row">
                <!-- JavaScript 將會動態填充這裡 -->
            </div>
        </div>
    </div>

    <!-- 功能操作區塊 - 極簡版 -->
    <div class="row mt-3 mb-2">
        <div class="col-4 text-center mb-1">
            <button class="btn btn-outline-success btn-sm w-100 py-1" data-bs-toggle="modal" data-bs-target="#addHolderModal" style="font-size: 0.7rem;">
                <i class="bi bi-person-plus-fill me-1"></i>新增持有人
            </button>
        </div>
        
        <div class="col-4 text-center mb-1">
            <button class="btn btn-outline-primary btn-sm w-100 py-1" data-bs-toggle="modal" data-bs-target="#addAccountModal" style="font-size: 0.7rem;">
                <i class="bi bi-plus-circle-fill me-1"></i>新增帳戶
            </button>
        </div>
        
        <div class="col-4 text-center mb-1">
            <button class="btn btn-outline-warning btn-sm w-100 py-1" data-bs-toggle="modal" data-bs-target="#transferModal" style="font-size: 0.7rem;">
                <i class="bi bi-arrow-left-right me-1"></i>內部轉帳
            </button>
        </div>
    </div>

    <!-- 應收帳款管理區塊 -->
    <div class="card shadow-sm mt-4">
        <div class="card-header">
            <h5 class="mb-0 fw-light"><i class="bi bi-receipt me-2"></i>應收帳款管理</h5>
        </div>
        <div class="card-body p-0">
            {% if customers_with_receivables %}
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-3">客戶名稱</th>
                            <th class="text-end">應收帳款 (TWD)</th>
                            <th class="text-center">操作</th>
                            <th class="pe-3">備註</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for customer in customers_with_receivables %}
                        <tr>
                            <td class="ps-3">
                                <a href="#" class="text-decoration-none fw-bold text-primary customer-transactions" 
                                   data-customer-id="{{ customer.id }}" 
                                   data-customer-name="{{ customer.name }}"
                                   title="點擊查看交易紀錄">
                                    {{ customer.name }}
                                    <i class="bi bi-arrow-right-circle ms-1 text-muted"></i>
                                </a>
                            </td>
                            <td class="text-end">
                                <span class="fw-bold text-danger">NT$ {{ "{:,.2f}".format(customer.total_receivables_twd) }}</span>
                            </td>
                            <td class="text-center">
                                <button class="btn btn-success btn-sm" 
                                        onclick="openSettlementModal('{{ customer.id }}', '{{ customer.name }}', {{ customer.total_receivables_twd }})">
                                    <i class="bi bi-cash-coin me-1"></i>銷帳
                                </button>
                            </td>
                            <td class="pe-3">
                                <small class="text-muted">點擊客戶名稱查看交易紀錄</small>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center p-5 text-muted">
                <i class="bi bi-check-circle display-4 text-success"></i>
                <p class="mt-3">太棒了！所有應收帳款都已結清</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 引用所有的操作模態框 -->
{% include '_cash_management_modals.html' %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    console.log('🚀 現金管理頁面載入完成，開始初始化...');
    
    // 從後端獲取數據
    const accountsByHolder = {{ accounts_by_holder|tojson if accounts_by_holder is defined else '{}' }};
    const holders = {{ holders|tojson if holders is defined else '[]' }};
    
    console.log('📊 數據檢查:');
    console.log('📊 holders:', holders);
    console.log('📊 accountsByHolder:', accountsByHolder);
    
    // 獲取 DOM 元素
    const accountsContainer = document.getElementById('accounts-container');
    
    // 渲染帳戶列表
    function renderAccounts() {
        console.log('🔍 開始渲染帳戶列表...');
        
        if (!accountsContainer) {
            console.error('❌ 找不到 accounts-container 元素');
            return;
        }
        
        accountsContainer.innerHTML = '';
        
        if (!holders || holders.length === 0) {
            console.log('⚠️ 沒有持有人數據');
            accountsContainer.innerHTML = '<div class="col-12 text-center text-muted p-4">尚無資金持有人。</div>';
            return;
        }
        
        console.log(`✅ 找到 ${holders.length} 個持有人，開始渲染...`);
        
        holders.forEach((holder, index) => {
            const holderId = holder.id;
            const holderName = holder.name;
            const holderData = accountsByHolder[holderId];
            
            console.log(`📋 渲染持有人 ${index + 1}: ${holderName} (ID: ${holderId})`);
            
            let accountsHtml = '';
            let totalTwd = 0;
            let totalRmb = 0;
            
            if (holderData && holderData.accounts && holderData.accounts.length > 0) {
                console.log(`📋 持有人 ${holderName} 有 ${holderData.accounts.length} 個帳戶`);
                holderData.accounts.forEach(acc => {
                    const currencyBadgeClass = acc.currency === 'TWD' ? 'bg-primary' : 'bg-success';
                    const currencyTextClass = acc.currency === 'TWD' ? 'text-primary' : 'text-success';
                    
                    accountsHtml += `
                        <li class="list-group-item py-2 d-flex justify-content-between align-items-center ps-3">
                            <div>
                                <i class="bi bi-caret-right-fill text-muted me-1"></i>
                                <span>${acc.name} <span class="badge ${currencyBadgeClass} rounded-pill">${acc.currency}</span></span>
                            </div>
                            <div class="d-flex align-items-center">
                                <strong class="me-2 ${currencyTextClass}">${acc.balance.toLocaleString('en-US', {minimumFractionDigits: 2})}</strong>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary btn-movement btn-sm" data-account-id="${acc.id}" data-account-name="${acc.name}" title="存入/提出">
                                        <i class="bi bi-arrow-down-up"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm delete-account-btn" data-account-id="${acc.id}" data-account-name="${acc.name}" title="刪除帳戶">
                                        &times;
                                    </button>
                                </div>
                            </div>
                        </li>
                    `;
                });
                totalTwd = holderData.total_twd || 0;
                totalRmb = holderData.total_rmb || 0;
            } else {
                console.log(`📋 持有人 ${holderName} 沒有帳戶`);
                accountsHtml = '<li class="list-group-item py-1 text-muted text-center small">-- 尚無帳戶 --</li>';
                totalTwd = 0;
                totalRmb = 0;
            }
            
            const subtotalFooter = `
                <div class="card-footer bg-light d-flex justify-content-around py-1">
                    <div><small class="text-muted">TWD:</small> <strong class="text-primary">${totalTwd.toLocaleString('en-US', {minimumFractionDigits: 2})}</strong></div>
                    <div><small class="text-muted">RMB:</small> <strong class="text-success">${totalRmb.toLocaleString('en-US', {minimumFractionDigits: 2})}</strong></div>
                </div>
            `;
            
            const holderCard = `
                <div class="col-lg-4 col-md-6 mb-2">
                    <div class="card shadow-sm h-100">
                        <div class="card-header py-2 d-flex justify-content-between align-items-center">
                            <strong class="h6 mb-0">${holderName}</strong>
                            <button class="btn btn-danger btn-sm py-0 px-2 delete-holder-btn" 
                                    data-holder-id="${holderId}" 
                                    data-holder-name="${holderName}">刪除</button>
                        </div>
                        <ul class="list-group list-group-flush">${accountsHtml}</ul>
                        ${subtotalFooter}
                    </div>
                </div>
            `;
            
            accountsContainer.innerHTML += holderCard;
        });
        
        console.log('✅ 帳戶列表渲染完成');
    }
    
    // 更新總資產顯示
    async function updateTotalAssets() {
        try {
            console.log('🔄 正在更新總資產顯示...');
            
            const response = await fetch('/api/cash_management/totals', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('📊 獲取到最新資產數據:', data);
            
            const totalTwdDisplay = document.getElementById('totalTwdDisplay');
            const totalRmbDisplay = document.getElementById('totalRmbDisplay');
            
            if (totalTwdDisplay) {
                totalTwdDisplay.textContent = `NT$ ${(data.total_twd || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            }
            
            if (totalRmbDisplay) {
                totalRmbDisplay.textContent = `¥ ${(data.total_rmb || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            }
            
            console.log('✅ 總資產顯示更新完成');
            
        } catch (error) {
            console.error('❌ 更新總資產顯示時發生錯誤:', error);
        }
    }
    
    // 檢查是否需要刷新數據
    const urlParams = new URLSearchParams(window.location.search);
    const shouldRefresh = urlParams.get('refresh') === 'true';
    
    if (shouldRefresh) {
        console.log('🔄 檢測到刷新參數，自動刷新數據...');
        setTimeout(() => {
            updateTotalAssets();
            renderAccounts();
        }, 1000);
        
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
    }
    
    // 檢查成功訊息
    const successMessages = document.querySelectorAll('.alert-success');
    if (successMessages.length > 0) {
        console.log('📢 檢測到成功訊息，自動刷新數據...');
        setTimeout(() => {
            updateTotalAssets();
            renderAccounts();
        }, 1000);
    }
    
    // 初始化
    renderAccounts();
    updateTotalAssets();
    
    // 設置定期更新
    setInterval(updateTotalAssets, 30000);
    
    // 頁面可見性變化監聽器
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            console.log('👁️ 頁面重新可見，更新總資產數據...');
            updateTotalAssets();
            renderAccounts();
        }
    });
    
    console.log('✅ 現金管理頁面初始化完成');
});
</script>
{% endblock %}
