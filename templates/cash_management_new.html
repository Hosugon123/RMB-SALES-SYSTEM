{% extends "base.html" %}

{% block title %}ç¾é‡‘ç®¡ç†å„€è¡¨æ¿{% endblock %}

{% block content %}
<div class="container-fluid pt-3">
    <!-- é é¢æ¨™é¡Œ -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-4 border-bottom">
        <h1 class="h2"><i class="bi bi-wallet2 me-2"></i>ç¾é‡‘ç®¡ç†</h1>
    </div>

    <!-- é ‚éƒ¨æ ¸å¿ƒæŒ‡æ¨™å¡ç‰‡ -->
    <div class="row">
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm text-center h-100">
                <div class="card-body">
                    <p class="text-muted mb-1">ç¸½å°å¹£è³‡ç”¢ (TWD)</p>
                    <h2 class="fw-bold text-primary" id="totalTwdDisplay">NT$ {{ "{:,.2f}".format(total_twd or 0) }}</h2>
                    <small class="text-muted">å³æ™‚æ›´æ–°</small>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm text-center h-100">
                <div class="card-body">
                    <p class="text-muted mb-1">ç¸½äººæ°‘å¹£è³‡ç”¢ (RMB)</p>
                    <h2 class="fw-bold text-success" id="totalRmbDisplay">Â¥ {{ "{:,.2f}".format(total_rmb or 0) }}</h2>
                    <small class="text-muted">å³æ™‚æ›´æ–°</small>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm text-center h-100">
                <div class="card-body">
                    <p class="text-muted mb-1">ç¸½æ‡‰æ”¶å¸³æ¬¾ (TWD)</p>
                    <h2 class="fw-bold text-danger">NT$ {{ "{:,.2f}".format(total_receivables or 0) }}</h2>
                    <small class="text-muted">å¾…æ”¶æ¬¾é …</small>
                </div>
            </div>
        </div>
    </div>

    <!-- è³‡é‡‘æŒæœ‰äººèˆ‡å¸³æˆ¶å€å¡Š -->
    <div class="card shadow-sm mt-3">
        <div class="card-header">
            <h5 class="mb-0 fw-light"><i class="bi bi-people-fill me-2"></i>è³‡é‡‘æŒæœ‰äººèˆ‡å¸³æˆ¶</h5>
        </div>
        <div class="card-body">
            <div id="accounts-container" class="row">
                <!-- JavaScript å°‡æœƒå‹•æ…‹å¡«å……é€™è£¡ -->
            </div>
        </div>
    </div>

    <!-- åŠŸèƒ½æ“ä½œå€å¡Š - æ¥µç°¡ç‰ˆ -->
    <div class="row mt-3 mb-2">
        <div class="col-4 text-center mb-1">
            <button class="btn btn-outline-success btn-sm w-100 py-1" data-bs-toggle="modal" data-bs-target="#addHolderModal" style="font-size: 0.7rem;">
                <i class="bi bi-person-plus-fill me-1"></i>æ–°å¢æŒæœ‰äºº
            </button>
        </div>
        
        <div class="col-4 text-center mb-1">
            <button class="btn btn-outline-primary btn-sm w-100 py-1" data-bs-toggle="modal" data-bs-target="#addAccountModal" style="font-size: 0.7rem;">
                <i class="bi bi-plus-circle-fill me-1"></i>æ–°å¢å¸³æˆ¶
            </button>
        </div>
        
        <div class="col-4 text-center mb-1">
            <button class="btn btn-outline-warning btn-sm w-100 py-1" data-bs-toggle="modal" data-bs-target="#transferModal" style="font-size: 0.7rem;">
                <i class="bi bi-arrow-left-right me-1"></i>å…§éƒ¨è½‰å¸³
            </button>
        </div>
    </div>

    <!-- æ‡‰æ”¶å¸³æ¬¾ç®¡ç†å€å¡Š -->
    <div class="card shadow-sm mt-4">
        <div class="card-header">
            <h5 class="mb-0 fw-light"><i class="bi bi-receipt me-2"></i>æ‡‰æ”¶å¸³æ¬¾ç®¡ç†</h5>
        </div>
        <div class="card-body p-0">
            {% if customers_with_receivables %}
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-3">å®¢æˆ¶åç¨±</th>
                            <th class="text-end">æ‡‰æ”¶å¸³æ¬¾ (TWD)</th>
                            <th class="text-center">æ“ä½œ</th>
                            <th class="pe-3">å‚™è¨»</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for customer in customers_with_receivables %}
                        <tr>
                            <td class="ps-3">
                                <a href="#" class="text-decoration-none fw-bold text-primary customer-transactions" 
                                   data-customer-id="{{ customer.id }}" 
                                   data-customer-name="{{ customer.name }}"
                                   title="é»æ“ŠæŸ¥çœ‹äº¤æ˜“ç´€éŒ„">
                                    {{ customer.name }}
                                    <i class="bi bi-arrow-right-circle ms-1 text-muted"></i>
                                </a>
                            </td>
                            <td class="text-end">
                                <span class="fw-bold text-danger">NT$ {{ "{:,.2f}".format(customer.total_receivables_twd) }}</span>
                            </td>
                            <td class="text-center">
                                <button class="btn btn-success btn-sm" 
                                        onclick="openSettlementModal('{{ customer.id }}', '{{ customer.name }}', {{ customer.total_receivables_twd }})">
                                    <i class="bi bi-cash-coin me-1"></i>éŠ·å¸³
                                </button>
                            </td>
                            <td class="pe-3">
                                <small class="text-muted">é»æ“Šå®¢æˆ¶åç¨±æŸ¥çœ‹äº¤æ˜“ç´€éŒ„</small>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center p-5 text-muted">
                <i class="bi bi-check-circle display-4 text-success"></i>
                <p class="mt-3">å¤ªæ£’äº†ï¼æ‰€æœ‰æ‡‰æ”¶å¸³æ¬¾éƒ½å·²çµæ¸…</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- å¼•ç”¨æ‰€æœ‰çš„æ“ä½œæ¨¡æ…‹æ¡† -->
{% include '_cash_management_modals.html' %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    console.log('ğŸš€ ç¾é‡‘ç®¡ç†é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
    
    // å¾å¾Œç«¯ç²å–æ•¸æ“š
    const accountsByHolder = {{ accounts_by_holder|tojson if accounts_by_holder is defined else '{}' }};
    const holders = {{ holders|tojson if holders is defined else '[]' }};
    
    console.log('ğŸ“Š æ•¸æ“šæª¢æŸ¥:');
    console.log('ğŸ“Š holders:', holders);
    console.log('ğŸ“Š accountsByHolder:', accountsByHolder);
    
    // ç²å– DOM å…ƒç´ 
    const accountsContainer = document.getElementById('accounts-container');
    
    // æ¸²æŸ“å¸³æˆ¶åˆ—è¡¨
    function renderAccounts() {
        console.log('ğŸ” é–‹å§‹æ¸²æŸ“å¸³æˆ¶åˆ—è¡¨...');
        
        if (!accountsContainer) {
            console.error('âŒ æ‰¾ä¸åˆ° accounts-container å…ƒç´ ');
            return;
        }
        
        accountsContainer.innerHTML = '';
        
        if (!holders || holders.length === 0) {
            console.log('âš ï¸ æ²’æœ‰æŒæœ‰äººæ•¸æ“š');
            accountsContainer.innerHTML = '<div class="col-12 text-center text-muted p-4">å°šç„¡è³‡é‡‘æŒæœ‰äººã€‚</div>';
            return;
        }
        
        console.log(`âœ… æ‰¾åˆ° ${holders.length} å€‹æŒæœ‰äººï¼Œé–‹å§‹æ¸²æŸ“...`);
        
        holders.forEach((holder, index) => {
            const holderId = holder.id;
            const holderName = holder.name;
            const holderData = accountsByHolder[holderId];
            
            console.log(`ğŸ“‹ æ¸²æŸ“æŒæœ‰äºº ${index + 1}: ${holderName} (ID: ${holderId})`);
            
            let accountsHtml = '';
            let totalTwd = 0;
            let totalRmb = 0;
            
            if (holderData && holderData.accounts && holderData.accounts.length > 0) {
                console.log(`ğŸ“‹ æŒæœ‰äºº ${holderName} æœ‰ ${holderData.accounts.length} å€‹å¸³æˆ¶`);
                holderData.accounts.forEach(acc => {
                    const currencyBadgeClass = acc.currency === 'TWD' ? 'bg-primary' : 'bg-success';
                    const currencyTextClass = acc.currency === 'TWD' ? 'text-primary' : 'text-success';
                    
                    accountsHtml += `
                        <li class="list-group-item py-2 d-flex justify-content-between align-items-center ps-3">
                            <div>
                                <i class="bi bi-caret-right-fill text-muted me-1"></i>
                                <span>${acc.name} <span class="badge ${currencyBadgeClass} rounded-pill">${acc.currency}</span></span>
                            </div>
                            <div class="d-flex align-items-center">
                                <strong class="me-2 ${currencyTextClass}">${acc.balance.toLocaleString('en-US', {minimumFractionDigits: 2})}</strong>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary btn-movement btn-sm" data-account-id="${acc.id}" data-account-name="${acc.name}" title="å­˜å…¥/æå‡º">
                                        <i class="bi bi-arrow-down-up"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm delete-account-btn" data-account-id="${acc.id}" data-account-name="${acc.name}" title="åˆªé™¤å¸³æˆ¶">
                                        &times;
                                    </button>
                                </div>
                            </div>
                        </li>
                    `;
                });
                totalTwd = holderData.total_twd || 0;
                totalRmb = holderData.total_rmb || 0;
            } else {
                console.log(`ğŸ“‹ æŒæœ‰äºº ${holderName} æ²’æœ‰å¸³æˆ¶`);
                accountsHtml = '<li class="list-group-item py-1 text-muted text-center small">-- å°šç„¡å¸³æˆ¶ --</li>';
                totalTwd = 0;
                totalRmb = 0;
            }
            
            const subtotalFooter = `
                <div class="card-footer bg-light d-flex justify-content-around py-1">
                    <div><small class="text-muted">TWD:</small> <strong class="text-primary">${totalTwd.toLocaleString('en-US', {minimumFractionDigits: 2})}</strong></div>
                    <div><small class="text-muted">RMB:</small> <strong class="text-success">${totalRmb.toLocaleString('en-US', {minimumFractionDigits: 2})}</strong></div>
                </div>
            `;
            
            const holderCard = `
                <div class="col-lg-4 col-md-6 mb-2">
                    <div class="card shadow-sm h-100">
                        <div class="card-header py-2 d-flex justify-content-between align-items-center">
                            <strong class="h6 mb-0">${holderName}</strong>
                            <button class="btn btn-danger btn-sm py-0 px-2 delete-holder-btn" 
                                    data-holder-id="${holderId}" 
                                    data-holder-name="${holderName}">åˆªé™¤</button>
                        </div>
                        <ul class="list-group list-group-flush">${accountsHtml}</ul>
                        ${subtotalFooter}
                    </div>
                </div>
            `;
            
            accountsContainer.innerHTML += holderCard;
        });
        
        console.log('âœ… å¸³æˆ¶åˆ—è¡¨æ¸²æŸ“å®Œæˆ');
    }
    
    // æ›´æ–°ç¸½è³‡ç”¢é¡¯ç¤º
    async function updateTotalAssets() {
        try {
            console.log('ğŸ”„ æ­£åœ¨æ›´æ–°ç¸½è³‡ç”¢é¡¯ç¤º...');
            
            const response = await fetch('/api/cash_management/totals', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('ğŸ“Š ç²å–åˆ°æœ€æ–°è³‡ç”¢æ•¸æ“š:', data);
            
            const totalTwdDisplay = document.getElementById('totalTwdDisplay');
            const totalRmbDisplay = document.getElementById('totalRmbDisplay');
            
            if (totalTwdDisplay) {
                totalTwdDisplay.textContent = `NT$ ${(data.total_twd || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            }
            
            if (totalRmbDisplay) {
                totalRmbDisplay.textContent = `Â¥ ${(data.total_rmb || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            }
            
            console.log('âœ… ç¸½è³‡ç”¢é¡¯ç¤ºæ›´æ–°å®Œæˆ');
            
        } catch (error) {
            console.error('âŒ æ›´æ–°ç¸½è³‡ç”¢é¡¯ç¤ºæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        }
    }
    
    // æª¢æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°æ•¸æ“š
    const urlParams = new URLSearchParams(window.location.search);
    const shouldRefresh = urlParams.get('refresh') === 'true';
    
    if (shouldRefresh) {
        console.log('ğŸ”„ æª¢æ¸¬åˆ°åˆ·æ–°åƒæ•¸ï¼Œè‡ªå‹•åˆ·æ–°æ•¸æ“š...');
        setTimeout(() => {
            updateTotalAssets();
            renderAccounts();
        }, 1000);
        
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
    }
    
    // æª¢æŸ¥æˆåŠŸè¨Šæ¯
    const successMessages = document.querySelectorAll('.alert-success');
    if (successMessages.length > 0) {
        console.log('ğŸ“¢ æª¢æ¸¬åˆ°æˆåŠŸè¨Šæ¯ï¼Œè‡ªå‹•åˆ·æ–°æ•¸æ“š...');
        setTimeout(() => {
            updateTotalAssets();
            renderAccounts();
        }, 1000);
    }
    
    // åˆå§‹åŒ–
    renderAccounts();
    updateTotalAssets();
    
    // è¨­ç½®å®šæœŸæ›´æ–°
    setInterval(updateTotalAssets, 30000);
    
    // é é¢å¯è¦‹æ€§è®ŠåŒ–ç›£è½å™¨
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            console.log('ğŸ‘ï¸ é é¢é‡æ–°å¯è¦‹ï¼Œæ›´æ–°ç¸½è³‡ç”¢æ•¸æ“š...');
            updateTotalAssets();
            renderAccounts();
        }
    });
    
    console.log('âœ… ç¾é‡‘ç®¡ç†é é¢åˆå§‹åŒ–å®Œæˆ');
});
</script>
{% endblock %}
