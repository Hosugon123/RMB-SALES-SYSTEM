{% extends "base.html" %}

{% block title %}採購與入庫操作台{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- ****** 左側：買入操作表單 ****** -->
    <div class="col-lg-5">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-primary text-white"><h5 class="mb-0"><i class="bi bi-keyboard-fill me-2"></i>建立一筆買入交易</h5></div>
            <div class="card-body p-4">
                <form id="purchaseForm">
                    <!-- 渠道區塊 -->
                    <div class="mb-3">
                        <label class="form-label"><strong>步驟 1:</strong> 選擇或輸入購買渠道</label>
                        
                        <!-- 常用渠道下拉選單 -->
                        <div class="mb-2">
                            <label for="channelSelect" class="form-label text-muted small">常用渠道快速選擇：</label>
                            <select class="form-select" id="channelSelect">
                                <option value="" selected>從常用列表選擇...</option>
                                {% for channel in channels %}
                                <option value="{{ channel.id }}">{{ channel.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- 手動輸入新渠道 -->
                        <div class="mb-2">
                            <label for="channelNameManual" class="form-label text-muted small">或輸入新渠道名稱：</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="channelNameManual" placeholder="輸入新渠道名稱...">
                                <button class="btn btn-outline-primary" type="button" id="addToFrequentBtn">
                                    <i class="bi bi-plus-circle"></i> 加入常用
                                </button>
                            </div>
                        </div>
                        
                        <!-- 渠道管理按鈕 -->
                        <div class="text-end">
                            <button class="btn btn-outline-secondary btn-sm" type="button" id="manageChannelsBtn">
                                <i class="bi bi-gear"></i> 管理常用渠道
                            </button>
                        </div>
                    </div>
                    <hr class="my-4">
                    
                    <!-- 【核心修正】付款與入庫區塊 -->
                    <div class="mb-3">
                        <label class="form-label"><strong>步驟 2:</strong> 選擇資金帳戶</label>
                        <!-- 付款區塊 -->
                        <div class="p-3 mb-3 border rounded bg-light">
                            <h6 class="text-danger"><i class="bi bi-box-arrow-up-right me-2"></i>從哪個 TWD 帳戶付款</h6>
                            <select class="form-select" id="paymentAccountSelect" name="payment_account_id" required>
                                <option value="" disabled selected>--- 請選擇付款帳戶 ---</option>
                                <!-- JavaScript 將會動態填充這裡 -->
                            </select>
                        </div>
                        <!-- 入庫區塊 -->
                        <div class="p-3 mb-3 border rounded bg-light">
                            <h6 class="text-success"><i class="bi bi-box-arrow-in-down-left me-2"></i>將 RMB 存入哪個帳戶</h6>
                            <select class="form-select" id="depositAccountSelect" name="deposit_account_id" required>
                                <option value="" disabled selected>--- 請選擇入庫帳戶 ---</option>
                                <!-- JavaScript 將會動態填充這裡 -->
                            </select>
                        </div>
                    </div>

                    <hr class="my-4">
                    <!-- 金額與匯率區塊 -->
                     <div class="mb-3">
                        <label class="form-label"><strong>步驟 3:</strong> 輸入交易金額</label>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="rmbAmount" name="rmb_amount" pattern="[0-9]*\.?[0-9]*" required placeholder="¥">
                                    <label for="rmbAmount">買入金額 (RMB)</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="exchangeRate" name="exchange_rate" pattern="[0-9]*\.?[0-9]*" required placeholder="NT$">
                                    <label for="exchangeRate">買入匯率</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info text-center mt-3">
                        預計花費成本 (TWD): <strong id="twdCostDisplay">NT$ 0.00</strong>
                    </div>
                    <div class="d-grid mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-check-circle-fill me-2"></i>確認執行交易
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- ****** 右側：近期買入紀錄 ****** -->
    <div class="col-lg-7">
        <div class="card border-0 shadow-sm h-100">
             <div class="card-header bg-light"><h5 class="mb-0 fw-normal"><i class="bi bi-clock-history me-2"></i>近期買入紀錄</h5></div>
            <div class="card-body p-2">
                <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle mb-0">
                        <thead><tr><th>日期</th><th>渠道</th><th>付款帳戶</th><th class="text-end">買入RMB</th><th class="text-end">匯率</th><th class="text-end">成本TWD</th><th class="text-center">操作</th></tr></thead>
                        <tbody>
                            {% for record in recent_purchases %}
                            <tr>
                                <td><small>{{ record.purchase_date.strftime('%Y-%m-%d') }}</small></td>
                                <td>{{ record.channel.name if record.channel else 'N/A' }}</td>
                                <td><small>{{ record.payment_account.name if record.payment_account else '刷卡' }}</small></td>
                                <td class="text-end text-success">¥ {{ "%.2f"|format(record.rmb_amount) }}</td>
                                <td class="text-end text-info">{{ "%.4f"|format(record.exchange_rate) }}</td>
                                <td class="text-end text-danger fw-bold">NT$ {{ "%.2f"|format(record.twd_cost) }}</td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-outline-danger" onclick="cancelPurchaseRecord({{ record.id }}, '{{ record.channel.name if record.channel else 'N/A' }}', {{ record.rmb_amount }})" title="取消此筆買入記錄">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="7" class="text-center p-4 text-muted">尚無買入紀錄。</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- ****** 渠道管理 Modal ****** -->
<div class="modal fade" id="channelsModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">管理常用渠道</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
        <div class="input-group mb-3">
            <input type="text" id="newChannelName" class="form-control" placeholder="輸入新渠道名稱..."><button class="btn btn-success" type="button" id="addChannelBtn">新增</button>
        </div>
        <ul class="list-group" id="channelListModal"></ul>
    </div>
</div></div></div>
{% endblock %}


{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM載入完成，開始初始化...');
    
    // === 1. 從後端獲取資料 ===
    const channelsData = {{ channels|tojson }};
    const twdAccountsGrouped = {{ owner_twd_accounts_grouped|tojson }};
    const rmbAccountsGrouped = {{ owner_rmb_accounts_grouped|tojson }};
    
    console.log('後端數據:', { channelsData, twdAccountsGrouped, rmbAccountsGrouped });
    
    // === 2. 獲取所有需要的 HTML 元件 ===
    const purchaseForm = document.getElementById('purchaseForm');
    const paymentAccountSelect = document.getElementById('paymentAccountSelect');
    const depositAccountSelect = document.getElementById('depositAccountSelect');
    const channelSelect = document.getElementById('channelSelect');
    const channelNameManual = document.getElementById('channelNameManual');
    const rmbAmountInput = document.getElementById('rmbAmount');
    const exchangeRateInput = document.getElementById('exchangeRate');
    const twdCostDisplay = document.getElementById('twdCostDisplay');
    const manageChannelsBtn = document.getElementById('manageChannelsBtn');
    const addToFrequentBtn = document.getElementById('addToFrequentBtn');
    const channelsModal = new bootstrap.Modal(document.getElementById('channelsModal'));
    const channelListModal = document.getElementById('channelListModal');
    const addChannelBtn = document.getElementById('addChannelBtn');
    const newChannelNameInput = document.getElementById('newChannelName');

    // === 3. 定義 API 地址 ===
    const BUY_IN_API_ENDPOINT = "{{ url_for('api_buy_in') }}";
    const CHANNEL_API_ENDPOINT = "{{ url_for('manage_channel') }}";
    const GET_CHANNELS_API_ENDPOINT = "{{ url_for('get_channels_public') }}";

    // === 4. 功能函式與事件監聽 ===

    // 【核心修正】填充帶有分組的下拉選單
    function populateGroupedSelect(selectElement, groupedData, currency) {
        selectElement.innerHTML = `<option value="" disabled selected>--- 請選擇${currency}帳戶 ---</option>`;
        
        // groupedData 現在是一個對象，鍵是持有人名稱，值是帳戶數組
        Object.keys(groupedData).forEach(holderName => {
            const accounts = groupedData[holderName];
            const optgroup = document.createElement('optgroup');
            optgroup.label = holderName;
            
            accounts.forEach(acc => {
                const optionText = `${acc.name} (餘額: ${acc.currency} ${acc.balance.toLocaleString()})`;
                optgroup.appendChild(new Option(optionText, acc.id));
            });
            selectElement.appendChild(optgroup);
        });
    }
    
    // 初始化填充 TWD 和 RMB 帳戶下拉選單
    populateGroupedSelect(paymentAccountSelect, twdAccountsGrouped, 'TWD');
    populateGroupedSelect(depositAccountSelect, rmbAccountsGrouped, 'RMB');

    // 其他事件監聽保持不變...
    function updateCost() {
        // 使用格式化後的實際數值進行計算
        const rmb = parseFloat(rmbAmountInput.getActualValue ? rmbAmountInput.getActualValue() : rmbAmountInput.value) || 0;
        const rate = parseFloat(exchangeRateInput.getActualValue ? exchangeRateInput.getActualValue() : exchangeRateInput.value) || 0;
        const twdCost = rmb * rate;
        
        // 無條件進位到整數，不顯示小數點
        const roundedCost = Math.ceil(twdCost);
        twdCostDisplay.textContent = `NT$ ${roundedCost.toLocaleString('en-US')}`;
    }
    [rmbAmountInput, exchangeRateInput].forEach(el => el.addEventListener('input', updateCost));

    channelSelect.addEventListener('change', function() {
        if (this.value) {
            // 當選擇下拉列表時，自動填寫渠道名稱
            const selectedChannel = channelsData.find(c => c.id == this.value || c.id === parseInt(this.value));
            if (selectedChannel) {
                channelNameManual.value = selectedChannel.name;
                channelNameManual.disabled = true;
            }
        } else {
            // 當清空選擇時，啟用手動輸入
            channelNameManual.value = '';
            channelNameManual.disabled = false;
        }
    });
    
    channelNameManual.addEventListener('input', function() {
        if (this.value) {
            // 當手動輸入時，清空下拉列表選擇
            channelSelect.value = '';
        }
    });

    // 表單提交邏輯
    purchaseForm.addEventListener('submit', async function(e) {
        console.log('表單提交事件觸發');
        e.preventDefault();
        
        // 驗證表單數據
        const paymentAccountId = paymentAccountSelect.value;
        const depositAccountId = depositAccountSelect.value;
        // 使用格式化後的實際數值
        const rmbAmount = parseFloat(rmbAmountInput.getActualValue ? rmbAmountInput.getActualValue() : rmbAmountInput.value);
        const exchangeRate = parseFloat(exchangeRateInput.getActualValue ? exchangeRateInput.getActualValue() : exchangeRateInput.value);
        const channelId = channelSelect.value;
        const channelNameManualValue = channelNameManual.value.trim();
        
        if (!paymentAccountId || !depositAccountId || !rmbAmount || !exchangeRate) {
            Swal.fire('錯誤', '請填寫所有必填欄位。', 'error');
            return;
        }
        
        // 簡化渠道驗證：只要有渠道名稱就可以
        if (!channelNameManualValue) {
            Swal.fire('錯誤', '請選擇或輸入購買渠道。', 'error');
            return;
        }
        
        // 顯示確認對話框
        const result = await Swal.fire({
            title: '確認執行買入交易',
            html: `
                <div class="text-start">
                    <p><strong>買入金額:</strong> ¥${rmbAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}</p>
                    <p><strong>匯率:</strong> ${exchangeRate.toFixed(4)}</p>
                    <p><strong>預計成本:</strong> NT$${(rmbAmount * exchangeRate).toLocaleString('en-US', {minimumFractionDigits: 2})}</p>
                    <p><strong>渠道:</strong> ${channelNameManualValue}</p>
                </div>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: '確認執行',
            cancelButtonText: '取消'
        });
        
        if (!result.isConfirmed) return;
        
        try {
            // 發送API請求 - 簡化數據結構
            const response = await fetch(BUY_IN_API_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'record_purchase',
                    payment_account_id: paymentAccountId,
                    deposit_account_id: depositAccountId,
                    rmb_amount: rmbAmount,
                    exchange_rate: exchangeRate,
                    channel_id: channelId || null,
                    channel_name_manual: channelNameManualValue
                })
            });
            
            const responseData = await response.json();
            
            if (responseData.status === 'success') {
                Swal.fire('成功', responseData.message, 'success');
                
                // 清空表單
                purchaseForm.reset();
                updateCost();
                
                // 重新載入頁面以顯示最新數據
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
                
                // 通知FIFO庫存頁面更新（如果存在）
                if (window.opener && window.opener.postMessage) {
                    window.opener.postMessage({ type: 'inventory_updated' }, '*');
                }
            } else {
                Swal.fire('錯誤', responseData.message, 'error');
            }
        } catch (error) {
            console.error('API請求失敗:', error);
            Swal.fire('錯誤', '網路請求失敗，請稍後再試。', 'error');
        }
    });

    // 渠道管理 Modal 邏輯 (也等待後端 API)
    manageChannelsBtn.addEventListener('click', () => {
        console.log('管理渠道按鈕點擊');
        loadChannelsList();
        channelsModal.show();
    });
    
    // 加入常用渠道按鈕邏輯
    addToFrequentBtn.addEventListener('click', async function() {
        const channelName = channelNameManual.value.trim();
        if (!channelName) {
            Swal.fire('錯誤', '請先輸入渠道名稱', 'error');
            return;
        }
        
        try {
            const response = await fetch(CHANNEL_API_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name: channelName })
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                Swal.fire('成功', result.message, 'success');
                
                // 清空手動輸入欄位
                channelNameManual.value = '';
                
                // 重新載入渠道列表
                await loadChannelsList();
                
                // 更新下拉選單
                await refreshChannelsDropdown();
                
            } else {
                Swal.fire('錯誤', result.message, 'error');
            }
        } catch (error) {
            console.error('新增渠道失敗:', error);
            Swal.fire('錯誤', '新增渠道失敗，請稍後再試', 'error');
        }
    });
    
    // 載入渠道列表到Modal
    async function loadChannelsList() {
        try {
            const response = await fetch(GET_CHANNELS_API_ENDPOINT);
            const channels = await response.json();
            
            channelListModal.innerHTML = '';
            channels.forEach(channel => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                    <span>${channel.name}</span>
                    <button class="btn btn-danger btn-sm" onclick="deleteChannel(${channel.id}, '${channel.name}')">
                        <i class="bi bi-trash"></i> 刪除
                    </button>
                `;
                channelListModal.appendChild(li);
            });
        } catch (error) {
            console.error('載入渠道列表失敗:', error);
            channelListModal.innerHTML = '<li class="list-group-item text-danger">載入失敗</li>';
        }
    }
    
    // 重新整理渠道下拉選單
    async function refreshChannelsDropdown() {
        try {
            const response = await fetch(GET_CHANNELS_API_ENDPOINT);
            const channels = await response.json();
            
            // 更新channelsData
            window.channelsData = channels;
            
            // 重新填充下拉選單
            channelSelect.innerHTML = '<option value="" selected>從常用列表選擇...</option>';
            channels.forEach(channel => {
                const option = document.createElement('option');
                option.value = channel.id;
                option.textContent = channel.name;
                channelSelect.appendChild(option);
            });
        } catch (error) {
            console.error('重新整理渠道列表失敗:', error);
        }
    }
    
    // 刪除渠道函數 (全域函數，供HTML調用)
    window.deleteChannel = async function(channelId, channelName) {
        const result = await Swal.fire({
            title: '確認刪除',
            text: `確定要刪除渠道 "${channelName}" 嗎？`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '確定刪除',
            cancelButtonText: '取消'
        });
        
        if (!result.isConfirmed) return;
        
        try {
            const response = await fetch(CHANNEL_API_ENDPOINT, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id: channelId })
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                Swal.fire('成功', result.message, 'success');
                
                // 重新載入渠道列表
                await loadChannelsList();
                
                // 更新下拉選單
                await refreshChannelsDropdown();
                
            } else {
                Swal.fire('錯誤', result.message, 'error');
            }
        } catch (error) {
            console.error('刪除渠道失敗:', error);
            Swal.fire('錯誤', '刪除渠道失敗，請稍後再試', 'error');
        }
    };
    
    // Modal中的新增渠道按鈕
    addChannelBtn.addEventListener('click', async function() {
        const channelName = newChannelNameInput.value.trim();
        if (!channelName) {
            Swal.fire('錯誤', '請輸入渠道名稱', 'error');
            return;
        }
        
        try {
            const response = await fetch(CHANNEL_API_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name: channelName })
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                Swal.fire('成功', result.message, 'success');
                
                // 清空輸入欄位
                newChannelNameInput.value = '';
                
                // 重新載入渠道列表
                await loadChannelsList();
                
                // 更新下拉選單
                await refreshChannelsDropdown();
                
            } else {
                Swal.fire('錯誤', result.message, 'error');
            }
        } catch (error) {
            console.error('新增渠道失敗:', error);
            Swal.fire('錯誤', '新增渠道失敗，請稍後再試', 'error');
        }
    });
    
    // ===================================================================
    // 取消買入記錄功能
    // ===================================================================
    
    // 取消買入記錄函數
    window.cancelPurchaseRecord = function(recordId, channelName, rmbAmount) {
        Swal.fire({
            title: '確認取消買入記錄',
            html: `
                <div class="text-start">
                    <p><strong>渠道:</strong> ${channelName}</p>
                    <p><strong>金額:</strong> ¥${rmbAmount.toFixed(2)}</p>
                    <p class="text-danger"><strong>⚠️ 警告:</strong> 此操作將：</p>
                    <ul class="text-start text-danger">
                        <li>完全刪除此筆買入記錄</li>
                        <li>刪除相關的FIFO庫存</li>
                        <li>此操作不可逆轉！</li>
                    </ul>
                    <p class="text-warning mt-2"><strong>注意:</strong> 如果此筆買入已有銷售分配，則無法取消</p>
                </div>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '確定取消記錄',
            cancelButtonText: '保留記錄',
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            width: '500px'
        }).then((result) => {
            if (result.isConfirmed) {
                executeCancelPurchase(recordId);
            }
        });
    };
    
    // 執行取消買入記錄
    async function executeCancelPurchase(recordId) {
        try {
            const response = await fetch(`/api/reverse-purchase-inventory/${recordId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                // 發送自定義事件，通知其他頁面更新數據
                window.dispatchEvent(new CustomEvent('purchaseDataChanged', {
                    detail: { action: 'cancel_purchase', recordId: recordId }
                }));
                
                Swal.fire({
                    icon: 'success',
                    title: '取消成功',
                    text: result.message,
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    // 重新載入頁面以更新數據
                    window.location.reload();
                });
            } else {
                Swal.fire('取消失敗', result.message, 'error');
            }
        } catch (error) {
            console.error('取消買入記錄失敗:', error);
            Swal.fire('取消失敗', '網路錯誤，請稍後再試', 'error');
        }
    }
    
    // 重置表單函數（用於清空輸入）
    function resetForm() {
        // 重置所有輸入欄位
        document.getElementById('channelSelect').value = '';
        document.getElementById('channelNameManual').value = '';
        document.getElementById('paymentAccountSelect').value = '';
        document.getElementById('depositAccountSelect').value = '';
        document.getElementById('rmbAmount').value = '';
        document.getElementById('exchangeRate').value = '';
        
        // 重置顯示
        document.getElementById('twdCostDisplay').textContent = 'NT$ 0.00';
        
        // 重置表單驗證狀態
        purchaseForm.classList.remove('was-validated');
        
        // 清除所有錯誤提示
        const invalidFeedback = document.querySelectorAll('.invalid-feedback');
        invalidFeedback.forEach(feedback => feedback.style.display = 'none');
        
        // 重置輸入框樣式
        const inputs = document.querySelectorAll('.form-control, .form-select');
        inputs.forEach(input => {
            input.classList.remove('is-valid', 'is-invalid');
        });
        
        console.log('✅ 表單已重置');
    }
    
    // 添加調試信息
    console.log('所有事件監聽器已設置完成');
    console.log('表單元素:', purchaseForm);
    console.log('按鈕元素:', document.querySelector('button[type="submit"]'));

    // --- 數字格式化工具函數 ---
    
    // 初始化數字輸入欄位的格式化
    function initializeNumberFormatting() {
        // 為買入金額和匯率欄位設置格式化
        setupNumberInputFormatting(rmbAmountInput, { maxDecimals: 2 });
        setupNumberInputFormatting(exchangeRateInput, { maxDecimals: 4 });
        
        console.log('✅ 買入頁面數字輸入欄位格式化已初始化');
    }

    // 初始化時調用數字格式化函數
    initializeNumberFormatting();
});
</script>
{% endblock %}