{% extends "base.html" %}

{% block title %}採購與入庫操作台{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- ****** 左側：買入操作表單 ****** -->
    <div class="col-lg-5">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-primary text-white"><h5 class="mb-0"><i class="bi bi-keyboard-fill me-2"></i>建立一筆買入交易</h5></div>
            <div class="card-body p-4">
                <form id="purchaseForm">
                    <!-- 渠道區塊 -->
                    <div class="mb-3">
                        <label class="form-label"><strong>步驟 1:</strong> 選擇或輸入購買渠道</label>
                        <div class="input-group">
                            <select class="form-select" id="channelSelect">
                                <option value="" selected>從常用列表選擇...</option>
                                {% for channel in channels %}<option value="{{ channel.id }}">{{ channel.name }}</option>{% endfor %}
                            </select>
                            <button class="btn btn-outline-secondary" type="button" id="manageChannelsBtn">管理</button>
                        </div>
                        <div class="form-text">或直接在下方手動輸入新渠道:</div>
                        <input type="text" class="form-control mt-1" id="channelNameManual" placeholder="手動輸入渠道名稱...">
                    </div>
                    <hr class="my-4">
                    
                    <!-- 【核心修正】付款與入庫區塊 -->
                    <div class="mb-3">
                        <label class="form-label"><strong>步驟 2:</strong> 選擇資金帳戶</label>
                        <!-- 付款區塊 -->
                        <div class="p-3 mb-3 border rounded bg-light">
                            <h6 class="text-danger"><i class="bi bi-box-arrow-up-right me-2"></i>從哪個 TWD 帳戶付款</h6>
                            <select class="form-select" id="paymentAccountSelect" name="payment_account_id" required>
                                <option value="" disabled selected>--- 請選擇付款帳戶 ---</option>
                                <!-- JavaScript 將會動態填充這裡 -->
                            </select>
                        </div>
                        <!-- 入庫區塊 -->
                        <div class="p-3 mb-3 border rounded bg-light">
                            <h6 class="text-success"><i class="bi bi-box-arrow-in-down-left me-2"></i>將 RMB 存入哪個帳戶</h6>
                            <select class="form-select" id="depositAccountSelect" name="deposit_account_id" required>
                                <option value="" disabled selected>--- 請選擇入庫帳戶 ---</option>
                                <!-- JavaScript 將會動態填充這裡 -->
                            </select>
                        </div>
                    </div>

                    <hr class="my-4">
                    <!-- 金額與匯率區塊 -->
                     <div class="mb-3">
                        <label class="form-label"><strong>步驟 3:</strong> 輸入交易金額</label>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="number" class="form-control" id="rmbAmount" name="rmb_amount" step="0.01" min="0.01" required placeholder="¥">
                                    <label for="rmbAmount">買入金額 (RMB)</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="number" class="form-control" id="exchangeRate" name="exchange_rate" step="0.0001" min="0.0001" required placeholder="NT$">
                                    <label for="exchangeRate">買入匯率</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info text-center mt-3">
                        預計花費成本 (TWD): <strong id="twdCostDisplay">NT$ 0.00</strong>
                    </div>
                    <div class="d-grid mt-4">
                        <button type="submit" class="btn btn-primary btn-lg"><i class="bi bi-check-circle-fill me-2"></i>確認執行交易</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- ****** 右側：近期買入紀錄 ****** -->
    <div class="col-lg-7">
        <div class="card border-0 shadow-sm h-100">
             <div class="card-header bg-light"><h5 class="mb-0 fw-normal"><i class="bi bi-clock-history me-2"></i>近期買入紀錄</h5></div>
            <div class="card-body p-2">
                <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle mb-0">
                        <thead><tr><th>日期</th><th>渠道</th><th>付款帳戶</th><th class="text-end">買入RMB</th><th class="text-end">成本TWD</th></tr></thead>
                        <tbody>
                            {% for record in recent_purchases %}
                            <tr>
                                <td><small>{{ record.purchase_date.strftime('%Y-%m-%d') }}</small></td>
                                <td>{{ record.channel.name if record.channel else 'N/A' }}</td>
                                <td><small>{{ record.payment_account.name if record.payment_account else '刷卡' }}</small></td>
                                <td class="text-end text-success">¥ {{ "%.2f"|format(record.rmb_amount) }}</td>
                                <td class="text-end text-danger fw-bold">NT$ {{ "%.2f"|format(record.twd_cost) }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="5" class="text-center p-4 text-muted">尚無買入紀錄。</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- ****** 渠道管理 Modal ****** -->
<div class="modal fade" id="channelsModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">管理常用渠道</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
        <div class="input-group mb-3">
            <input type="text" id="newChannelName" class="form-control" placeholder="輸入新渠道名稱..."><button class="btn btn-success" type="button" id="addChannelBtn">新增</button>
        </div>
        <ul class="list-group" id="channelListModal"></ul>
    </div>
</div></div></div>
{% endblock %}


{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // === 1. 從後端獲取資料 ===
    const channelsData = {{ channels|tojson }};
    const twdAccountsGrouped = {{ owner_twd_accounts_grouped|tojson }};
    const rmbAccountsGrouped = {{ owner_rmb_accounts_grouped|tojson }};
    
    // === 2. 獲取所有需要的 HTML 元件 ===
    const purchaseForm = document.getElementById('purchaseForm');
    const paymentAccountSelect = document.getElementById('paymentAccountSelect');
    const depositAccountSelect = document.getElementById('depositAccountSelect');
    // ... (其他元件獲取與您原版相同)
    const channelSelect = document.getElementById('channelSelect');
    const channelNameManual = document.getElementById('channelNameManual');
    const rmbAmountInput = document.getElementById('rmbAmount');
    const exchangeRateInput = document.getElementById('exchangeRate');
    const twdCostDisplay = document.getElementById('twdCostDisplay');
    const manageChannelsBtn = document.getElementById('manageChannelsBtn');
    const channelsModal = new bootstrap.Modal(document.getElementById('channelsModal'));
    const channelListModal = document.getElementById('channelListModal');
    const addChannelBtn = document.getElementById('addChannelBtn');
    const newChannelNameInput = document.getElementById('newChannelName');

    // === 3. 定義 API 地址 (我們將創建一個新的、更專屬的 API) ===
    const BUY_IN_API_ENDPOINT = "#"; // 稍後我們會定義一個新的 API
    const CHANNEL_API_ENDPOINT = "#"; // 渠道管理也用專屬 API

    // === 4. 功能函式與事件監聽 ===

    // 【核心修正】填充帶有分組的下拉選單
    function populateGroupedSelect(selectElement, groupedData, currency) {
        selectElement.innerHTML = `<option value="" disabled selected>--- 請選擇${currency}帳戶 ---</option>`;
        groupedData.forEach(group => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = group.holder_name;
            group.accounts.forEach(acc => {
                const optionText = `${acc.name} (餘額: ${acc.balance.toLocaleString()})`;
                optgroup.appendChild(new Option(optionText, acc.id));
            });
            selectElement.appendChild(optgroup);
        });
    }
    
    // 初始化填充 TWD 和 RMB 帳戶下拉選單
    populateGroupedSelect(paymentAccountSelect, twdAccountsGrouped, 'TWD');
    populateGroupedSelect(depositAccountSelect, rmbAccountsGrouped, 'RMB');

    // 其他事件監聽保持不變...
    function updateCost() {
        const rmb = parseFloat(rmbAmountInput.value) || 0;
        const rate = parseFloat(exchangeRateInput.value) || 0;
        twdCostDisplay.textContent = `NT$ ${(rmb * rate).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    }
    [rmbAmountInput, exchangeRateInput].forEach(el => el.addEventListener('input', updateCost));

    channelSelect.addEventListener('change', function() {
        if (this.value) {
            channelNameManual.value = '';
            channelNameManual.disabled = true;
        } else {
            channelNameManual.disabled = false;
        }
    });
    channelNameManual.addEventListener('input', function() {
        if (this.value) {
            channelSelect.value = '';
        }
    });

    // 表單提交邏輯 (稍後我們會為它創建一個新的 API)
    purchaseForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        // 此處的 API 呼叫邏輯暫時留空，等待後端 API 完成
        Swal.fire('功能開發中', '處理買入交易的後端 API 尚未完成。', 'info');
    });

    // 渠道管理 Modal 邏輯 (也等待後端 API)
    manageChannelsBtn.addEventListener('click', () => {
        // ...
        channelsModal.show();
    });
});
</script>
{% endblock %}