{% extends "base.html" %}

{% block title %}所有交易記錄{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="text-center mb-4">
                <h2 class="fw-light text-dark mb-1"><i class="bi bi-collection me-2"></i>所有交易記錄</h2>
                <p class="text-muted small">此處列出買賣、調撥與信用卡等所有類型的交易</p>
            </div>

            <div class="accordion" id="transactionsAccordion">
                
                <!-- ======================= 1. 買賣紀錄 ======================= -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingSales">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSales" aria-expanded="false" aria-controls="collapseSales">
                            <i class="bi bi-receipt-cutoff me-2"></i><strong>買賣紀錄</strong>
                        </button>
                    </h2>
                    <div id="collapseSales" class="accordion-collapse collapse" aria-labelledby="headingSales" data-bs-parent="#transactionsAccordion">
                        <div class="accordion-body">
                            <div class="d-flex justify-content-center mb-4">
                                <div id="status-filter" class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-secondary active" data-status="all">全部</button>
                                    <button type="button" class="btn btn-outline-secondary" data-status="待收款">待收款</button>
                                    <button type="button" class="btn btn-outline-secondary" data-status="已收款">已收款</button>
                                    <button type="button" class="btn btn-outline-secondary" data-status="已匯出">已匯出</button>
                                    <button type="button" class="btn btn-outline-secondary" data-status="已完成">已完成</button>
                                    <button type="button" class="btn btn-outline-secondary" data-status="已取消">已取消</button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table id="transactions-table" class="table table-hover align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>操作者</th><th>操作項目</th><th>人民幣(RMB)</th><th>台幣(TWD)</th><th>日期</th><th>來源/客戶</th><th>備註</th>
                                            <th class="text-end">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for tx in sales_transactions %}
                                        <tr data-id="{{ tx.id }}" data-status="{{ tx.status }}">
                                            <td>{{ tx.operator_name }}</td>
                                            <td class="status-cell"></td>
                                            <td>¥ {{ "%.2f"|format(tx.rmb_amount) }}</td>
                                            <td>$ {{ "%.2f"|format(tx.twd_amount) }}</td>
                                            <td><small>{{ tx.order_time.split(' ')[0] }}</small></td>
                                            <td>
                                                {% if tx.transaction_type == 'buy' %}{{ tx.source_channel_name or 'N/A' }}
                                                {% else %}{{ tx.customer_name or 'N/A' }}{% endif %}
                                            </td>
                                            <td class="note-cell"><span class="note-text">{{ tx.note or '...' }}</span></td>
                                            <td class="actions-cell text-end"></td>
                                        </tr>
                                        {% endfor %}
                                        {% if not sales_transactions %}
                                        <tr><td colspan="8" class="text-center text-muted p-5"><i class="bi bi-folder-x fs-2"></i><p class="mt-2">目前沒有買賣記錄。</p></td></tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- ########## 修正開始 ########## -->
                            {% if total_sales_pages > 1 %}
                            <nav>
                                <ul class="pagination justify-content-center">
                                    <li class="page-item {% if sales_page <= 1 %}disabled{% endif %}">
                                        <a class="page-link" href="{{ url_for('admin_transactions', sales_page=sales_page-1, movements_page=movements_page, cards_page=cards_page, show='sales') }}">上一頁</a>
                                    </li>
                                    {% for p in range(1, total_sales_pages + 1) %}
                                    <li class="page-item {% if p == sales_page %}active{% endif %}">
                                        <a class="page-link" href="{{ url_for('admin_transactions', sales_page=p, movements_page=movements_page, cards_page=cards_page, show='sales') }}">{{ p }}</a>
                                    </li>
                                    {% endfor %}
                                    <li class="page-item {% if sales_page >= total_sales_pages %}disabled{% endif %}">
                                        <a class="page-link" href="{{ url_for('admin_transactions', sales_page=sales_page+1, movements_page=movements_page, cards_page=cards_page, show='sales') }}">下一頁</a>
                                    </li>
                                </ul>
                            </nav>
                            {% endif %}
                            <!-- ########## 修正結束 ########## -->
                            
                        </div>
                    </div>
                </div>

                <!-- ======================= 2. 調撥紀錄 ======================= -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingMovements">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMovements" aria-expanded="false" aria-controls="collapseMovements">
                            <i class="bi bi-arrow-left-right me-2"></i><strong>調撥紀錄</strong>
                        </button>
                    </h2>
                    <div id="collapseMovements" class="accordion-collapse collapse" aria-labelledby="headingMovements" data-bs-parent="#transactionsAccordion">
                        <div class="accordion-body">
                            <div class="table-responsive">
                                <table id="movements-table" class="table table-hover align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>調撥者</th><th>調撥對象</th><th>人民幣(RMB)</th><th>台幣(TWD)</th><th>日期時間</th><th>備註</th><th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for move in fund_movements %}
                                        <tr data-move-id="{{ move.id }}">
                                            <td>{{ move.handled_by or '系統' }}</td>
                                            <td><small>{{ move.from_account_name }} → {{ move.to_account_name }}</small></td>
                                            {% if move.currency == 'RMB' %}<td class="fw-bold text-success">¥ {{ "%.2f"|format(move.amount) }}</td><td>-</td>
                                            {% else %}<td>-</td><td class="fw-bold text-primary">$ {{ "%.2f"|format(move.amount) }}</td>{% endif %}
                                            <td><small>{{ move.move_date }}</small></td>
                                            <td class="note-cell-movement"><span class="note-text-movement">{{ move.description or '...' }}</span></td>
                                            <td><button class="btn btn-sm btn-outline-info btn-edit-note-movement" title="編輯備註"><i class="bi bi-pencil-square"></i></button></td>
                                        </tr>
                                        {% endfor %}
                                        {% if not fund_movements %}
                                        <tr><td colspan="7" class="text-center text-muted p-5"><i class="bi bi-folder-x fs-2"></i><p class="mt-2">目前沒有調撥記錄。</p></td></tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                            {% if total_movements_pages > 1 %}
                            <nav>
                                <ul class="pagination justify-content-center">
                                    <li class="page-item {% if movements_page <= 1 %}disabled{% endif %}">
                                        <a class="page-link" href="{{ url_for('admin_transactions', sales_page=sales_page, movements_page=movements_page-1, cards_page=cards_page, show='movements') }}">上一頁</a>
                                    </li>
                                    {% for p in range(1, total_movements_pages + 1) %}
                                    <li class="page-item {% if p == movements_page %}active{% endif %}">
                                        <a class="page-link" href="{{ url_for('admin_transactions', sales_page=sales_page, movements_page=p, cards_page=cards_page, show='movements') }}">{{ p }}</a>
                                    </li>
                                    {% endfor %}
                                    <li class="page-item {% if movements_page >= total_movements_pages %}disabled{% endif %}">
                                        <a class="page-link" href="{{ url_for('admin_transactions', sales_page=sales_page, movements_page=movements_page+1, cards_page=cards_page, show='movements') }}">下一頁</a>
                                    </li>
                                </ul>
                            </nav>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- ======================= 3. 信用卡紀錄 ======================= -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingCards">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCards" aria-expanded="false" aria-controls="collapseCards">
                            <i class="bi bi-credit-card me-2"></i><strong>信用卡紀錄</strong>
                        </button>
                    </h2>
                    <div id="collapseCards" class="accordion-collapse collapse" aria-labelledby="headingCards" data-bs-parent="#transactionsAccordion">
                        <div class="accordion-body">
                           <div class="table-responsive">
                                <table class="table table-hover align-middle" style="font-size: 0.9em;">
                                    <thead class="table-light">
                                        <tr>
                                            <th>刷卡人</th><th>刷卡對象</th><th>含3%人民幣(RMB)</th><th>帳單(TWD)</th><th>匯率(含3%)</th>
                                            <th>海外手續費(1.5%)</th><th>售出匯率</th><th>回饋</th><th>利潤</th><th>刷卡日期</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for cp in card_purchases %}
                                        <tr>
                                            <td>{{ cp.handled_by or '系統' }}</td><td>{{ cp.supplier or 'N/A' }}</td>
                                            <td class="text-success">¥ {{ "%.2f"|format(cp.rmb_received * 1.03) }}</td>
                                            <td class="text-primary">$ {{ "%.2f"|format(cp.twd_amount) }}</td>
                                            <td>{{ "%.4f"|format(cp.twd_rate_effective) }}</td><td>$ {{ "%.2f"|format(cp.twd_amount * 0.015) }}</td>
                                            <td>{{ "%.4f"|format(current_sell_rate) }}</td><td>$ {{ "%.2f"|format(cp.cashback_amount) }}</td>
                                            <td class="fw-bold {% if cp.profit > 0 %}text-success{% else %}text-danger{% endif %}">$ {{ "%.2f"|format(cp.profit) }}</td>
                                            <td><small>{{ cp.purchase_date.split(' ')[0] }}</small></td>
                                        </tr>
                                        {% endfor %}
                                        {% if not card_purchases %}
                                        <tr><td colspan="10" class="text-center text-muted p-5"><i class="bi bi-folder-x fs-2"></i><p class="mt-2">目前沒有信用卡買入記錄。</p></td></tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                            {% if total_cards_pages > 1 %}
                            <nav>
                                <ul class="pagination justify-content-center">
                                    <li class="page-item {% if cards_page <= 1 %}disabled{% endif %}">
                                        <a class="page-link" href="{{ url_for('admin_transactions', sales_page=sales_page, movements_page=movements_page, cards_page=cards_page-1, show='cards') }}">上一頁</a>
                                    </li>
                                    {% for p in range(1, total_cards_pages + 1) %}
                                    <li class="page-item {% if p == cards_page %}active{% endif %}">
                                        <a class="page-link" href="{{ url_for('admin_transactions', sales_page=sales_page, movements_page=movements_page, cards_page=p, show='cards') }}">{{ p }}</a>
                                    </li>
                                    {% endfor %}
                                    <li class="page-item {% if cards_page >= total_cards_pages %}disabled{% endif %}">
                                        <a class="page-link" href="{{ url_for('admin_transactions', sales_page=sales_page, movements_page=movements_page, cards_page=cards_page+1, show='cards') }}">下一頁</a>
                                    </li>
                                </ul>
                            </nav>
                            {% endif %}
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Outward Confirmation Modal -->
{% if is_admin_view %}
<div class="modal fade" id="outwardModal" tabindex="-1" aria-labelledby="outwardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="outwardForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="outwardModalLabel">確認匯出</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="modalTxId" name="transaction_id">
                    <input type="hidden" name="action" value="confirm_outward">
                    <p>正在為交易 #<strong id="modalTxIdDisplay"></strong> 進行匯出操作。</p>
                    <div class="form-group mb-3">
                        <label for="outward_channel_id" class="form-label">選擇匯出管道</label>
                        <select class="form-select" id="outward_channel_id" name="outward_channel_id" required>
                            {% for c in outward_channels %}<option value="{{ c.id }}">{{ c.channel_name }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="actual_outward_rmb" class="form-label">實際匯出 RMB 金額</label>
                        <input type="number" step="0.01" class="form-control" id="actual_outward_rmb" name="actual_outward_rmb" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">確認匯出</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
    const isAdminView = {{ is_admin_view|tojson or 'false' }};
    if (!isAdminView) return;

    const allSalesTransactions = {{ sales_transactions|tojson or [] }};
    const accordion = document.getElementById('transactionsAccordion');
    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });

    const statusConfig = {
        '待收款': { badge: 'bg-warning text-dark', text: '客戶採購 (待收款)' }, '已收款': { badge: 'bg-primary', text: '客戶採購 (已收款)' },
        '待匯出': { badge: 'bg-info text-dark', text: '客戶採購 (待匯出)' }, '已匯出': { badge: 'bg-success', text: '客戶採購 (已匯出)' },
        '已完成': { badge: 'bg-secondary', text: '客戶採購 (已完成)' }, '已取消': { badge: 'bg-danger', text: '客戶採購 (已取消)' }
    };

    function renderSalesTable() {
        const salesTableBody = accordion.querySelector('#transactions-table tbody');
        if (!salesTableBody) return;
        
        salesTableBody.querySelectorAll('tr[data-id]').forEach(row => {
            const status = row.dataset.status;
            const config = statusConfig[status] || { badge: 'bg-light text-dark', text: status };
            row.querySelector('.status-cell').innerHTML = `<span class="badge ${config.badge}">${config.text}</span>`;
            
            let buttonsHTML = `<button class="btn btn-sm btn-outline-info btn-edit-note" title="編輯備註"><i class="bi bi-pencil-square"></i></button> `;
            
            if (status === '待收款') buttonsHTML += `<button class="btn btn-sm btn-success btn-action" data-action="confirm_receipt"><i class="bi bi-check-circle"></i> 收款</button>`;
            else if (status === '已收款' || status === '待匯出') buttonsHTML += `<button class="btn btn-sm btn-primary btn-action" data-action="confirm_outward"><i class="bi bi-box-arrow-up-right"></i> 匯出</button>`;
            else if (status === '已匯出') buttonsHTML += `<button class="btn btn-sm btn-dark btn-action" data-action="mark_completed"><i class="bi bi-check2-all"></i> 完成</button>`;
            
            if (status !== '已完成' && status !== '已取消') buttonsHTML += ` <button class="btn btn-sm btn-outline-danger btn-action" data-action="cancel_transaction" title="取消訂單"><i class="bi bi-x-circle"></i></button>`;
            
            row.querySelector('.actions-cell').innerHTML = buttonsHTML;
        });
    }

    accordion.querySelectorAll('#status-filter button').forEach(button => {
        button.addEventListener('click', function() {
            accordion.querySelectorAll('#status-filter button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            const statusToFilter = this.dataset.status;
            accordion.querySelectorAll('#transactions-table tbody tr[data-id]').forEach(row => {
                row.style.display = (statusToFilter === 'all' || row.dataset.status === statusToFilter) ? '' : 'none';
            });
        });
    });

    accordion.addEventListener('click', function(e) {
        const target = e.target;
        const actionButton = target.closest('.btn-action');
        const editSaleNoteButton = target.closest('.btn-edit-note');
        const editMovementNoteButton = target.closest('.btn-edit-note-movement');

        if (actionButton) {
            e.preventDefault();
            const action = actionButton.dataset.action;
            const txId = actionButton.closest('tr').dataset.id;
            const outwardModalEl = document.getElementById('outwardModal');
            const outwardModal = new bootstrap.Modal(outwardModalEl);

            if (action === 'confirm_outward') {
                const txData = allSalesTransactions.find(t => t.id == txId);
                document.getElementById('modalTxId').value = txId;
                document.getElementById('modalTxIdDisplay').textContent = txId;
                document.getElementById('actual_outward_rmb').value = txData ? parseFloat(txData.rmb_order_amount).toFixed(2) : '';
                outwardModal.show();
                return;
            }

            Swal.fire({
                title: '確定嗎?', text: `確定要執行此操作嗎？`, icon: 'question',
                showCancelButton: true, confirmButtonText: '確定', cancelButtonText: '取消'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch("{{ url_for('admin_update_transaction_status') }}", {
                        method: 'POST',
                        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                        body: new URLSearchParams({ transaction_id: txId, action: action })
                    })
                    .then(response => response.json()).then(res => {
                        if (res.status !== 'success') throw new Error(res.message);
                        Toast.fire({ icon: 'success', title: res.message });
                        const updatedTx = allSalesTransactions.find(t => t.id == txId);
                        if(updatedTx) updatedTx.status = res.new_status;
                        renderSalesTable();
                        document.querySelector('#status-filter button.active')?.click();
                    }).catch(error => Swal.fire('操作失敗', error.message, 'error'));
                }
            });
        }

        if (editSaleNoteButton) {
            e.preventDefault();
            const tr = editSaleNoteButton.closest('tr');
            const txId = tr.dataset.id;
            const noteSpan = tr.querySelector('.note-text');
            const currentNote = noteSpan.textContent === '...' ? '' : noteSpan.textContent;

            Swal.fire({
                title: `編輯買賣備註 #${txId}`, input: 'textarea', inputValue: currentNote,
                showCancelButton: true, confirmButtonText: '儲存', cancelButtonText: '取消',
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch("{{ url_for('admin_update_transaction_note') }}", {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ tx_id: txId, note: result.value })
                    }).then(r => r.json()).then(res => {
                        if (res.status !== 'success') throw new Error(res.message);
                        Toast.fire({ icon: 'success', title: res.message });
                        noteSpan.textContent = result.value || '...';
                    }).catch(err => Swal.fire('儲存失敗', err.message, 'error'));
                }
            });
        }

        if (editMovementNoteButton) {
            e.preventDefault();
            const tr = editMovementNoteButton.closest('tr');
            const moveId = tr.dataset.moveId;
            const noteSpan = tr.querySelector('.note-text-movement');
            const currentNote = noteSpan.textContent === '...' ? '' : noteSpan.textContent;

            Swal.fire({
                title: `編輯調撥備註 #${moveId}`, input: 'textarea', inputValue: currentNote,
                showCancelButton: true, confirmButtonText: '儲存', cancelButtonText: '取消',
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch("{{ url_for('admin_update_movement_note') }}", {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ move_id: moveId, note: result.value })
                    }).then(r => r.json()).then(res => {
                        if (res.status !== 'success') throw new Error(res.message);
                        Toast.fire({ icon: 'success', title: res.message });
                        noteSpan.textContent = result.value || '...';
                    }).catch(err => Swal.fire('儲存失敗', err.message, 'error'));
                }
            });
        }
    });
    
    const outwardForm = document.getElementById('outwardForm');
    if(outwardForm) {
        outwardForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const txId = document.getElementById('modalTxId').value;
            const outwardModalEl = document.getElementById('outwardModal');
            const outwardModal = bootstrap.Modal.getInstance(outwardModalEl);
            fetch("{{ url_for('admin_update_transaction_status') }}", {
                method: 'POST', body: new FormData(this)
            })
            .then(response => response.json()).then(res => {
                if (res.status !== 'success') throw new Error(res.message);
                if(outwardModal) outwardModal.hide();
                Toast.fire({ icon: 'success', title: res.message });
                const updatedTx = allSalesTransactions.find(t => t.id == txId);
                if(updatedTx) updatedTx.status = res.new_status;
                renderSalesTable();
                document.querySelector('#status-filter button.active')?.click();
            }).catch(error => Swal.fire('操作失敗', error.message, 'error'));
        });
    }

    // --- 初始執行 ---
    const urlParams = new URLSearchParams(window.location.search);
    let showSection = urlParams.get('show');
    // 從 localStorage 讀取上次展開的區塊
    const lastOpenAccordion = localStorage.getItem('lastOpenAccordion');
    
    // 優先使用 URL 參數，如果沒有，則使用 localStorage 的值
    if (!showSection && lastOpenAccordion) {
        showSection = lastOpenAccordion;
    }

    const allCollapseElements = accordion.querySelectorAll('.accordion-collapse');
    allCollapseElements.forEach(el => new bootstrap.Collapse(el, { toggle: false }).hide());

    let targetCollapseId = '#collapseSales'; // 默認展開買賣紀錄
    if (showSection === 'movements') targetCollapseId = '#collapseMovements';
    else if (showSection === 'cards') targetCollapseId = '#collapseCards';
    
    const targetCollapseElement = accordion.querySelector(targetCollapseId);
    if(targetCollapseElement) {
        new bootstrap.Collapse(targetCollapseElement, { toggle: false }).show();
    }

    // 監聽折疊面板的顯示事件，並將其ID存儲到 localStorage
    accordion.addEventListener('shown.bs.collapse', function (event) {
        const accordionId = event.target.id;
        if (accordionId === 'collapseSales') {
            localStorage.setItem('lastOpenAccordion', 'sales');
        } else if (accordionId === 'collapseMovements') {
            localStorage.setItem('lastOpenAccordion', 'movements');
        } else if (accordionId === 'collapseCards') {
            localStorage.setItem('lastOpenAccordion', 'cards');
        }
    });


    renderSalesTable();
});
</script>
{% endblock %}