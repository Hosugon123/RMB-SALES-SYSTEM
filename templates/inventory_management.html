{% extends "base.html" %}

{% block title %}åº«å­˜ç®¡ç†ç³»çµ±{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- é é¢æ¨™é¡Œ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><i class="bi bi-box-seam me-2"></i>åº«å­˜ç®¡ç†ç³»çµ±</h2>
            <p class="text-muted mb-0">ç®¡ç†RMBåº«å­˜ã€åŒ¯ç‡è®Šæ›´ã€åº«å­˜èª¿æ•´ç­‰æ“ä½œ</p>
        </div>
        <div class="btn-group">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addInventoryModal">
                <i class="bi bi-plus-circle me-1"></i>æ–°å¢åº«å­˜
            </button>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#adjustInventoryModal">
                <i class="bi bi-gear me-1"></i>åº«å­˜èª¿æ•´
            </button>
            <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#exchangeRateModal">
                <i class="bi bi-currency-exchange me-1"></i>åŒ¯ç‡ç®¡ç†
            </button>
        </div>
    </div>

    <!-- åº«å­˜æ¦‚æ³å¡ç‰‡ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <h5 class="card-title text-primary">ç¸½åº«å­˜RMB</h5>
                    <h3 class="text-primary" id="totalInventoryRmb">Â¥0.00</h3>
                    <small class="text-muted">ç•¶å‰å¯ç”¨åº«å­˜</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body text-center">
                    <h5 class="card-title text-success">åº«å­˜åƒ¹å€¼TWD</h5>
                    <h3 class="text-success" id="totalInventoryTwd">NT$0.00</h3>
                    <small class="text-muted">æŒ‰ç•¶å‰åŒ¯ç‡è¨ˆç®—</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-info">
                <div class="card-body text-center">
                    <h5 class="card-title text-info">å¹³å‡åŒ¯ç‡</h5>
                    <h3 class="text-info" id="averageExchangeRate">0.0000</h3>
                    <small class="text-muted">åŠ æ¬Šå¹³å‡æˆæœ¬</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <h5 class="card-title text-warning">åº«å­˜æ‰¹æ¬¡</h5>
                    <h3 class="text-warning" id="totalBatches">0</h3>
                    <small class="text-muted">æ´»èºåº«å­˜æ‰¹æ¬¡</small>
                </div>
            </div>
        </div>
    </div>

    <!-- åº«å­˜è©³ç´°è¡¨æ ¼ -->
    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-table me-2"></i>åº«å­˜è©³ç´° (FIFOé †åº)
            </h5>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" onclick="refreshInventoryData()">
                    <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                </button>
                <button class="btn btn-outline-info" onclick="exportInventoryData()">
                    <i class="bi bi-download"></i> åŒ¯å‡º
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-3">æ‰¹æ¬¡ID</th>
                            <th>è²·å…¥æ—¥æœŸ</th>
                            <th>æ¸ é“</th>
                            <th>åŸå§‹æ•¸é‡</th>
                            <th>å‰©é¤˜æ•¸é‡</th>
                            <th>å·²å‡ºå¸³æ•¸é‡</th>
                            <th>è²·å…¥åŒ¯ç‡</th>
                            <th>ç•¶å‰åŒ¯ç‡</th>
                            <th>åº«å­˜åƒ¹å€¼</th>
                            <th>ç‹€æ…‹</th>
                            <th class="text-center pe-3">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-tbody">
                        <!-- JavaScript å‹•æ…‹å¡«å…… -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- åº«å­˜æ“ä½œæ—¥èªŒ -->
    <div class="card shadow-sm mt-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-journal-text me-2"></i>åº«å­˜æ“ä½œæ—¥èªŒ
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-3">æ™‚é–“</th>
                            <th>æ“ä½œé¡å‹</th>
                            <th>æ“ä½œäººå“¡</th>
                            <th>æ‰¹æ¬¡ID</th>
                            <th>è®Šå‹•æ•¸é‡</th>
                            <th>è®Šå‹•å‰é¤˜é¡</th>
                            <th>è®Šå‹•å¾Œé¤˜é¡</th>
                            <th>ä¾†æº/æµå‘</th>
                            <th>åŒ¯ç‡</th>
                            <th>å‚™è¨»</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-logs-tbody">
                        <!-- JavaScript å‹•æ…‹å¡«å…… -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- æ–°å¢åº«å­˜æ¨¡æ…‹æ¡† -->
<div class="modal fade" id="addInventoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="addInventoryForm">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-plus-circle me-2"></i>æ–°å¢åº«å­˜
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="inventoryChannel" class="form-label">æ¸ é“ä¾†æº <span class="text-danger">*</span></label>
                                <select class="form-select" id="inventoryChannel" name="channel_id" required>
                                    <option value="">è«‹é¸æ“‡æ¸ é“</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="inventoryRmbAmount" class="form-label">RMBæ•¸é‡ <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text">Â¥</span>
                                    <input type="text" class="form-control" id="inventoryRmbAmount" 
                                           name="rmb_amount" pattern="[0-9]*\.?[0-9]*" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="inventoryExchangeRate" class="form-label">è²·å…¥åŒ¯ç‡ <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text">NT$</span>
                                    <input type="text" class="form-control" id="inventoryExchangeRate" 
                                           name="exchange_rate" pattern="[0-9]*\.?[0-9]*" required>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="inventoryPaymentAccount" class="form-label">ä»˜æ¬¾å¸³æˆ¶ <span class="text-danger">*</span></label>
                                <select class="form-select" id="inventoryPaymentAccount" name="payment_account_id" required>
                                    <option value="">è«‹é¸æ“‡ä»˜æ¬¾å¸³æˆ¶</option>
                                </select>
                                <div class="form-text">å¾æ­¤å¸³æˆ¶æ‰£é™¤å°å¹£æ¬¾é …</div>
                            </div>
                            <div class="mb-3">
                                <label for="inventoryDepositAccount" class="form-label">æ”¶æ¬¾å¸³æˆ¶ <span class="text-danger">*</span></label>
                                <select class="form-select" id="inventoryDepositAccount" name="deposit_account_id" required>
                                    <option value="">è«‹é¸æ“‡æ”¶æ¬¾å¸³æˆ¶</option>
                                </select>
                                <div class="form-text">RMBå°‡å­˜å…¥æ­¤å¸³æˆ¶</div>
                            </div>
                            <div class="mb-3">
                                <label for="inventoryNote" class="form-label">å‚™è¨»</label>
                                <textarea class="form-control" id="inventoryNote" name="note" rows="3" 
                                          placeholder="åº«å­˜ç›¸é—œèªªæ˜..."></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>é‡è¦æé†’ï¼š</strong>æ–°å¢åº«å­˜æ™‚ï¼Œç³»çµ±å°‡è‡ªå‹•å¾ä»˜æ¬¾å¸³æˆ¶æ‰£é™¤å°å¹£æ¬¾é …ï¼Œä¸¦å°‡RMBå­˜å…¥æ”¶æ¬¾å¸³æˆ¶ã€‚
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-1"></i>ç¢ºèªæ–°å¢
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- åº«å­˜èª¿æ•´æ¨¡æ…‹æ¡† -->
<div class="modal fade" id="adjustInventoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="adjustInventoryForm">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-gear me-2"></i>åº«å­˜èª¿æ•´
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="adjustInventoryBatch" class="form-label">é¸æ“‡æ‰¹æ¬¡ <span class="text-danger">*</span></label>
                                <select class="form-select" id="adjustInventoryBatch" name="batch_id" required>
                                    <option value="">è«‹é¸æ“‡è¦èª¿æ•´çš„åº«å­˜æ‰¹æ¬¡</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="adjustType" class="form-label">èª¿æ•´é¡å‹ <span class="text-danger">*</span></label>
                                <select class="form-select" id="adjustType" name="adjust_type" required>
                                    <option value="">è«‹é¸æ“‡èª¿æ•´é¡å‹</option>
                                    <option value="increase">å¢åŠ åº«å­˜</option>
                                    <option value="decrease">æ¸›å°‘åº«å­˜</option>
                                    <option value="write_off">åº«å­˜å ±éŠ·</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="adjustAmount" class="form-label">èª¿æ•´æ•¸é‡ <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text">Â¥</span>
                                    <input type="text" class="form-control" id="adjustAmount" 
                                           name="amount" pattern="[0-9]*\.?[0-9]*" required>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="adjustSourceAccount" class="form-label">ä¾†æºå¸³æˆ¶ <span class="text-danger">*</span></label>
                                <select class="form-select" id="adjustSourceAccount" name="source_account_id" required>
                                    <option value="">è«‹é¸æ“‡ä¾†æºå¸³æˆ¶</option>
                                </select>
                                <div class="form-text" id="sourceAccountHelp">å¢åŠ åº«å­˜æ™‚å¾æ­¤å¸³æˆ¶æ‰£é™¤RMB</div>
                            </div>
                            <div class="mb-3">
                                <label for="adjustTargetAccount" class="form-label">æµå‘å¸³æˆ¶ <span class="text-danger">*</span></label>
                                <select class="form-select" id="adjustTargetAccount" name="target_account_id" required>
                                    <option value="">è«‹é¸æ“‡æµå‘å¸³æˆ¶</option>
                                </select>
                                <div class="form-text" id="targetAccountHelp">æ¸›å°‘åº«å­˜æ™‚RMBå°‡è½‰å…¥æ­¤å¸³æˆ¶</div>
                            </div>
                            <div class="mb-3">
                                <label for="adjustExchangeRate" class="form-label">èª¿æ•´åŒ¯ç‡ <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text">NT$</span>
                                    <input type="text" class="form-control" id="adjustExchangeRate" 
                                           name="exchange_rate" pattern="[0-9]*\.?[0-9]*" required>
                                </div>
                                <div class="form-text">ç”¨æ–¼è¨ˆç®—å°å¹£åƒ¹å€¼è®Šå‹•</div>
                            </div>
                            <div class="mb-3">
                                <label for="adjustReason" class="form-label">èª¿æ•´åŸå›  <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="adjustReason" name="reason" rows="3" 
                                          placeholder="è«‹èªªæ˜èª¿æ•´åŸå› ..." required></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>æ³¨æ„ï¼š</strong>åº«å­˜èª¿æ•´å°‡åŒæ™‚å½±éŸ¿åº«å­˜æ•¸é‡å’Œç¾é‡‘å¸³æˆ¶é¤˜é¡ï¼Œè«‹è¬¹æ…æ“ä½œã€‚
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-check-circle me-1"></i>ç¢ºèªèª¿æ•´
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- åŒ¯ç‡ç®¡ç†æ¨¡æ…‹æ¡† -->
<div class="modal fade" id="exchangeRateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="exchangeRateForm">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-currency-exchange me-2"></i>åŒ¯ç‡ç®¡ç†
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="rateChangeType" class="form-label">åŒ¯ç‡è®Šæ›´é¡å‹</label>
                        <select class="form-select" id="rateChangeType" name="rate_change_type" required>
                            <option value="">è«‹é¸æ“‡åŒ¯ç‡è®Šæ›´é¡å‹</option>
                            <option value="global">å…¨å±€åŒ¯ç‡èª¿æ•´</option>
                            <option value="batch">æ‰¹æ¬¡åŒ¯ç‡èª¿æ•´</option>
                            <option value="market">å¸‚å ´åŒ¯ç‡æ›´æ–°</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="oldExchangeRate" class="form-label">åŸåŒ¯ç‡</label>
                        <div class="input-group">
                            <span class="input-group-text">NT$</span>
                            <input type="text" class="form-control" id="oldExchangeRate" 
                                   name="old_rate" pattern="[0-9]*\.?[0-9]*" readonly>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="newExchangeRate" class="form-label">æ–°åŒ¯ç‡</label>
                        <div class="input-group">
                            <span class="input-group-text">NT$</span>
                            <input type="text" class="form-control" id="newExchangeRate" 
                                   name="new_rate" pattern="[0-9]*\.?[0-9]*" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="rateChangeReason" class="form-label">è®Šæ›´åŸå› </label>
                        <textarea class="form-control" id="rateChangeReason" name="reason" rows="3" 
                                  placeholder="è«‹èªªæ˜åŒ¯ç‡è®Šæ›´åŸå› ..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-info">
                        <i class="bi bi-check-circle me-1"></i>ç¢ºèªè®Šæ›´
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    console.log('ğŸš€ åº«å­˜ç®¡ç†é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
    
    // åˆå§‹åŒ–é é¢
    initializeInventoryPage();
    
    // è¨­ç½®è¡¨å–®æäº¤äº‹ä»¶
    setupFormSubmissions();
    
    // è¨­ç½®äº‹ä»¶ç›£è½å™¨
    setupEventListeners();
});

// åˆå§‹åŒ–åº«å­˜ç®¡ç†é é¢
function initializeInventoryPage() {
    console.log('ğŸ”§ é–‹å§‹åˆå§‹åŒ–åº«å­˜ç®¡ç†é é¢...');
    
    // è¼‰å…¥åº«å­˜æ•¸æ“š
    loadInventoryData();
    
    // è¼‰å…¥æ“ä½œæ—¥èªŒ
    loadInventoryLogs();
    
    // å¡«å……ä¸‹æ‹‰é¸å–®
    populateDropdowns();
    
    console.log('âœ… åº«å­˜ç®¡ç†é é¢åˆå§‹åŒ–å®Œæˆ');
}

// è¼‰å…¥åº«å­˜æ•¸æ“š
async function loadInventoryData() {
    try {
        console.log('ğŸ“Š é–‹å§‹è¼‰å…¥åº«å­˜æ•¸æ“š...');
        
        const response = await fetch('/api/inventory/status');
        const data = await response.json();
        
        if (data.status === 'success') {
            console.log('âœ… åº«å­˜æ•¸æ“šè¼‰å…¥æˆåŠŸ:', data);
            
            // æ›´æ–°æ¦‚æ³å¡ç‰‡
            updateInventorySummary(data.summary);
            
            // æ¸²æŸ“åº«å­˜è¡¨æ ¼
            renderInventoryTable(data.inventory);
            
        } else {
            console.error('âŒ åº«å­˜æ•¸æ“šè¼‰å…¥å¤±æ•—:', data.message);
            showAlert('åº«å­˜æ•¸æ“šè¼‰å…¥å¤±æ•—: ' + data.message, 'danger');
        }
        
    } catch (error) {
        console.error('âŒ è¼‰å…¥åº«å­˜æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        showAlert('è¼‰å…¥åº«å­˜æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤', 'danger');
    }
}

// æ›´æ–°åº«å­˜æ¦‚æ³
function updateInventorySummary(summary) {
    if (!summary) return;
    
    document.getElementById('totalInventoryRmb').textContent = `Â¥${summary.total_rmb.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
    document.getElementById('totalInventoryTwd').textContent = `NT$${summary.total_twd.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
    document.getElementById('averageExchangeRate').textContent = summary.average_rate.toFixed(4);
    document.getElementById('totalBatches').textContent = summary.total_batches;
}

// æ¸²æŸ“åº«å­˜è¡¨æ ¼
function renderInventoryTable(inventory) {
    const tbody = document.getElementById('inventory-tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (!inventory || inventory.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center text-muted py-4">å°šç„¡åº«å­˜æ•¸æ“š</td></tr>';
        return;
    }
    
    inventory.forEach(item => {
        const row = createInventoryRow(item);
        tbody.appendChild(row);
    });
}

// å‰µå»ºåº«å­˜è¡Œ
function createInventoryRow(item) {
    const row = document.createElement('tr');
    
    // è¨ˆç®—åº«å­˜åƒ¹å€¼
    const inventoryValue = item.remaining_rmb * item.exchange_rate;
    
    // è¨­ç½®è¡Œå…§å®¹
    row.innerHTML = `
        <td class="ps-3">
            <span class="badge bg-secondary">#${item.id}</span>
        </td>
        <td>${formatDate(item.purchase_date)}</td>
        <td>${item.channel_name || 'N/A'}</td>
        <td class="text-end">Â¥${item.original_rmb.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
        <td class="text-end">
            <span class="text-success fw-bold">Â¥${item.remaining_rmb.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
        </td>
        <td class="text-end">Â¥${item.allocated_rmb.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
        <td class="text-end">NT$${item.exchange_rate.toFixed(4)}</td>
        <td class="text-end">NT$${item.current_rate.toFixed(4)}</td>
        <td class="text-end">
            <span class="text-primary fw-bold">NT$${inventoryValue.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
        </td>
        <td class="text-center">
            ${getInventoryStatusBadge(item)}
        </td>
        <td class="text-center pe-3">
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="viewInventoryDetails(${item.id})" title="æŸ¥çœ‹è©³æƒ…">
                    <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-outline-warning" onclick="editInventoryBatch(${item.id})" title="ç·¨è¼¯æ‰¹æ¬¡">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="deleteInventoryBatch(${item.id})" title="åˆªé™¤æ‰¹æ¬¡">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </td>
    `;
    
    return row;
}

// ç²å–åº«å­˜ç‹€æ…‹æ¨™ç±¤
function getInventoryStatusBadge(item) {
    if (item.remaining_rmb <= 0) {
        return '<span class="badge bg-danger">å·²è€—ç›¡</span>';
    } else if (item.remaining_rmb < item.original_rmb * 0.1) {
        return '<span class="badge bg-warning">åº«å­˜ä¸è¶³</span>';
    } else {
        return '<span class="badge bg-success">æ­£å¸¸</span>';
    }
}

// è¼‰å…¥æ“ä½œæ—¥èªŒ
async function loadInventoryLogs() {
    try {
        const response = await fetch('/api/inventory/logs');
        const data = await response.json();
        
        if (data.status === 'success') {
            renderInventoryLogs(data.logs);
        }
    } catch (error) {
        console.error('âŒ è¼‰å…¥æ“ä½œæ—¥èªŒå¤±æ•—:', error);
    }
}

// æ¸²æŸ“æ“ä½œæ—¥èªŒ
function renderInventoryLogs(logs) {
    const tbody = document.getElementById('inventory-logs-tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (!logs || logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-4">å°šç„¡æ“ä½œè¨˜éŒ„</td></tr>';
        return;
    }
    
    logs.forEach(log => {
        const row = createLogRow(log);
        tbody.appendChild(row);
    });
}

// å‰µå»ºæ—¥èªŒè¡Œ
function createLogRow(log) {
    const row = document.createElement('tr');
    
    row.innerHTML = `
        <td class="ps-3">${formatDateTime(log.created_at)}</td>
        <td>${getOperationTypeBadge(log.operation_type)}</td>
        <td>${log.operator_name}</td>
        <td><span class="badge bg-secondary">#${log.batch_id}</span></td>
        <td class="text-end">Â¥${log.change_amount.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
        <td class="text-end">Â¥${log.balance_before.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
        <td class="text-end">Â¥${log.balance_after.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
        <td>${log.source_account_name || 'N/A'}</td>
        <td>NT$${log.exchange_rate.toFixed(4)}</td>
        <td>${log.note || '-'}</td>
    `;
    
    return row;
}

// ç²å–æ“ä½œé¡å‹æ¨™ç±¤
function getOperationTypeBadge(type) {
    const badges = {
        'add': '<span class="badge bg-success">æ–°å¢</span>',
        'adjust': '<span class="badge bg-warning">èª¿æ•´</span>',
        'withdraw': '<span class="badge bg-info">ææ¬¾</span>',
        'delete': '<span class="badge bg-danger">åˆªé™¤</span>',
        'rate_change': '<span class="badge bg-primary">åŒ¯ç‡è®Šæ›´</span>'
    };
    
    return badges[type] || `<span class="badge bg-secondary">${type}</span>`;
}

// å¡«å……ä¸‹æ‹‰é¸å–®
async function populateDropdowns() {
    try {
        console.log('ğŸ”§ é–‹å§‹å¡«å……ä¸‹æ‹‰é¸å–®...');
        
        // è¼‰å…¥æ¸ é“æ•¸æ“š
        const channelsResponse = await fetch('/api/channels');
        if (channelsResponse.ok) {
            const channelsData = await channelsResponse.json();
            if (channelsData.status === 'success') {
                populateChannelDropdown(channelsData.channels);
            }
        }
        
        // è¼‰å…¥å¸³æˆ¶æ•¸æ“š
        const accountsResponse = await fetch('/api/cash_management/accounts');
        if (accountsResponse.ok) {
            const accountsData = await accountsResponse.json();
            if (accountsData.status === 'success') {
                populateAccountDropdowns(accountsData.accounts);
            }
        }
        
        console.log('âœ… ä¸‹æ‹‰é¸å–®å¡«å……å®Œæˆ');
        
    } catch (error) {
        console.error('âŒ å¡«å……ä¸‹æ‹‰é¸å–®å¤±æ•—:', error);
    }
}

// å¡«å……æ¸ é“ä¸‹æ‹‰é¸å–®
function populateChannelDropdown(channels) {
    const select = document.getElementById('inventoryChannel');
    if (!select) return;
    
    select.innerHTML = '<option value="">è«‹é¸æ“‡æ¸ é“</option>';
    channels.forEach(channel => {
        const option = document.createElement('option');
        option.value = channel.id;
        option.textContent = channel.name;
        select.appendChild(option);
    });
}

// å¡«å……å¸³æˆ¶ä¸‹æ‹‰é¸å–®
function populateAccountDropdowns(accounts) {
    // æ–°å¢åº«å­˜æ¨¡æ…‹æ¡†çš„å¸³æˆ¶é¸æ“‡
    const paymentAccountSelect = document.getElementById('inventoryPaymentAccount');
    const depositAccountSelect = document.getElementById('inventoryDepositAccount');
    
    if (paymentAccountSelect) {
        populateAccountSelect(paymentAccountSelect, accounts, 'TWD');
    }
    
    if (depositAccountSelect) {
        populateAccountSelect(depositAccountSelect, accounts, 'RMB');
    }
    
    // åº«å­˜èª¿æ•´æ¨¡æ…‹æ¡†çš„å¸³æˆ¶é¸æ“‡
    const sourceAccountSelect = document.getElementById('adjustSourceAccount');
    const targetAccountSelect = document.getElementById('adjustTargetAccount');
    
    if (sourceAccountSelect) {
        populateAccountSelect(sourceAccountSelect, accounts, 'RMB');
    }
    
    if (targetAccountSelect) {
        populateAccountSelect(targetAccountSelect, accounts, 'RMB');
    }
}

// å¡«å……å¸³æˆ¶é¸æ“‡ä¸‹æ‹‰é¸å–®
function populateAccountSelect(select, accounts, currency) {
    select.innerHTML = '<option value="">è«‹é¸æ“‡å¸³æˆ¶</option>';
    
    // æŒ‰æŒæœ‰äººåˆ†çµ„
    const groupedAccounts = {};
    accounts.forEach(account => {
        if (account.currency === currency) {
            if (!groupedAccounts[account.holder_name]) {
                groupedAccounts[account.holder_name] = [];
            }
            groupedAccounts[account.holder_name].push(account);
        }
    });
    
    // å‰µå»ºåˆ†çµ„é¸é …
    Object.keys(groupedAccounts).forEach(holderName => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = holderName;
        
        groupedAccounts[holderName].forEach(account => {
            const option = document.createElement('option');
            option.value = account.id;
            option.textContent = `${account.name} (é¤˜é¡: ${account.currency === 'TWD' ? 'NT$' : 'Â¥'}${account.balance.toLocaleString('en-US', {minimumFractionDigits: 2})})`;
            optgroup.appendChild(option);
        });
        
        select.appendChild(optgroup);
    });
}

// è¨­ç½®è¡¨å–®æäº¤äº‹ä»¶
function setupFormSubmissions() {
    // æ–°å¢åº«å­˜è¡¨å–®
    const addInventoryForm = document.getElementById('addInventoryForm');
    if (addInventoryForm) {
        addInventoryForm.addEventListener('submit', handleAddInventory);
    }
    
    // åº«å­˜èª¿æ•´è¡¨å–®
    const adjustInventoryForm = document.getElementById('adjustInventoryForm');
    if (adjustInventoryForm) {
        adjustInventoryForm.addEventListener('submit', handleAdjustInventory);
    }
    
    // åŒ¯ç‡ç®¡ç†è¡¨å–®
    const exchangeRateForm = document.getElementById('exchangeRateForm');
    if (exchangeRateForm) {
        exchangeRateForm.addEventListener('submit', handleExchangeRateChange);
    }
}

// è™•ç†æ–°å¢åº«å­˜
async function handleAddInventory(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData.entries());
    
    try {
        console.log('ğŸ“ æäº¤æ–°å¢åº«å­˜è¡¨å–®:', data);
        
        // é©—è­‰å¿…å¡«æ¬„ä½
        if (!validateRequiredFields(data, ['channel_id', 'rmb_amount', 'exchange_rate', 'payment_account_id', 'deposit_account_id'])) {
            return;
        }
        
        // é©—è­‰å¸³æˆ¶é¤˜é¡
        if (!await validateAccountBalances(data)) {
            return;
        }
        
        const response = await fetch('/api/inventory/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            showAlert('âœ… åº«å­˜æ–°å¢æˆåŠŸï¼', 'success');
            
            // é—œé–‰æ¨¡æ…‹æ¡†
            const modal = bootstrap.Modal.getInstance(document.getElementById('addInventoryModal'));
            modal.hide();
            
            // åˆ·æ–°æ•¸æ“š
            loadInventoryData();
            loadInventoryLogs();
            
            // é‡ç½®è¡¨å–®
            event.target.reset();
            
        } else {
            showAlert('âŒ åº«å­˜æ–°å¢å¤±æ•—: ' + result.message, 'danger');
        }
        
    } catch (error) {
        console.error('âŒ æ–°å¢åº«å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        showAlert('âŒ æ–°å¢åº«å­˜æ™‚ç™¼ç”ŸéŒ¯èª¤', 'danger');
    }
}

// è™•ç†åº«å­˜èª¿æ•´
async function handleAdjustInventory(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData.entries());
    
    try {
        console.log('ğŸ”§ æäº¤åº«å­˜èª¿æ•´è¡¨å–®:', data);
        
        // é©—è­‰å¿…å¡«æ¬„ä½
        if (!validateRequiredFields(data, ['batch_id', 'adjust_type', 'amount', 'source_account_id', 'target_account_id', 'exchange_rate', 'reason'])) {
            return;
        }
        
        // é©—è­‰å¸³æˆ¶é¤˜é¡
        if (!await validateAdjustmentAccountBalances(data)) {
            return;
        }
        
        const response = await fetch('/api/inventory/adjust', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            showAlert('âœ… åº«å­˜èª¿æ•´æˆåŠŸï¼', 'success');
            
            // é—œé–‰æ¨¡æ…‹æ¡†
            const modal = bootstrap.Modal.getInstance(document.getElementById('adjustInventoryModal'));
            modal.hide();
            
            // åˆ·æ–°æ•¸æ“š
            loadInventoryData();
            loadInventoryLogs();
            
            // é‡ç½®è¡¨å–®
            event.target.reset();
            
        } else {
            showAlert('âŒ åº«å­˜èª¿æ•´å¤±æ•—: ' + result.message, 'danger');
        }
        
    } catch (error) {
        console.error('âŒ åº«å­˜èª¿æ•´æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        showAlert('âŒ åº«å­˜èª¿æ•´æ™‚ç™¼ç”ŸéŒ¯èª¤', 'danger');
    }
}

// è™•ç†åŒ¯ç‡è®Šæ›´
async function handleExchangeRateChange(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData.entries());
    
    try {
        console.log('ğŸ’± æäº¤åŒ¯ç‡è®Šæ›´è¡¨å–®:', data);
        
        const response = await fetch('/api/inventory/exchange-rate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            showAlert('âœ… åŒ¯ç‡è®Šæ›´æˆåŠŸï¼', 'success');
            
            // é—œé–‰æ¨¡æ…‹æ¡†
            const modal = bootstrap.Modal.getInstance(document.getElementById('exchangeRateModal'));
            modal.hide();
            
            // åˆ·æ–°æ•¸æ“š
            loadInventoryData();
            loadInventoryLogs();
            
            // é‡ç½®è¡¨å–®
            event.target.reset();
            
        } else {
            showAlert('âŒ åŒ¯ç‡è®Šæ›´å¤±æ•—: ' + result.message, 'danger');
        }
        
    } catch (error) {
        console.error('âŒ åŒ¯ç‡è®Šæ›´æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        showAlert('âŒ åŒ¯ç‡è®Šæ›´æ™‚ç™¼ç”ŸéŒ¯èª¤', 'danger');
    }
}

// é©—è­‰å¿…å¡«æ¬„ä½
function validateRequiredFields(data, requiredFields) {
    for (const field of requiredFields) {
        if (!data[field] || data[field].trim() === '') {
            showAlert(`âŒ è«‹å¡«å¯«å¿…å¡«æ¬„ä½: ${getFieldDisplayName(field)}`, 'danger');
            return false;
        }
    }
    return true;
}

// ç²å–æ¬„ä½é¡¯ç¤ºåç¨±
function getFieldDisplayName(field) {
    const fieldNames = {
        'channel_id': 'æ¸ é“ä¾†æº',
        'rmb_amount': 'RMBæ•¸é‡',
        'exchange_rate': 'åŒ¯ç‡',
        'payment_account_id': 'ä»˜æ¬¾å¸³æˆ¶',
        'deposit_account_id': 'æ”¶æ¬¾å¸³æˆ¶',
        'batch_id': 'åº«å­˜æ‰¹æ¬¡',
        'adjust_type': 'èª¿æ•´é¡å‹',
        'amount': 'èª¿æ•´æ•¸é‡',
        'source_account_id': 'ä¾†æºå¸³æˆ¶',
        'target_account_id': 'æµå‘å¸³æˆ¶',
        'reason': 'èª¿æ•´åŸå› '
    };
    
    return fieldNames[field] || field;
}

// é©—è­‰å¸³æˆ¶é¤˜é¡ï¼ˆæ–°å¢åº«å­˜ï¼‰
async function validateAccountBalances(data) {
    try {
        const rmbAmount = parseFloat(data.rmb_amount);
        const exchangeRate = parseFloat(data.exchange_rate);
        const twdAmount = rmbAmount * exchangeRate;
        
        // æª¢æŸ¥ä»˜æ¬¾å¸³æˆ¶ï¼ˆå°å¹£ï¼‰é¤˜é¡
        const paymentAccount = await getAccountInfo(data.payment_account_id);
        if (paymentAccount.balance < twdAmount) {
            showAlert(`âŒ ä»˜æ¬¾å¸³æˆ¶é¤˜é¡ä¸è¶³ï¼éœ€è¦ NT$${twdAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}ï¼Œç•¶å‰é¤˜é¡ NT$${paymentAccount.balance.toLocaleString('en-US', {minimumFractionDigits: 2})}`, 'danger');
            return false;
        }
        
        return true;
        
    } catch (error) {
        console.error('âŒ é©—è­‰å¸³æˆ¶é¤˜é¡å¤±æ•—:', error);
        showAlert('âŒ é©—è­‰å¸³æˆ¶é¤˜é¡å¤±æ•—', 'danger');
        return false;
    }
}

// é©—è­‰èª¿æ•´å¸³æˆ¶é¤˜é¡
async function validateAdjustmentAccountBalances(data) {
    try {
        const amount = parseFloat(data.amount);
        const adjustType = data.adjust_type;
        
        if (adjustType === 'increase') {
            // å¢åŠ åº«å­˜ï¼šæª¢æŸ¥ä¾†æºå¸³æˆ¶ï¼ˆRMBï¼‰é¤˜é¡
            const sourceAccount = await getAccountInfo(data.source_account_id);
            if (sourceAccount.balance < amount) {
                showAlert(`âŒ ä¾†æºå¸³æˆ¶é¤˜é¡ä¸è¶³ï¼éœ€è¦ Â¥${amount.toLocaleString('en-US', {minimumFractionDigits: 2})}ï¼Œç•¶å‰é¤˜é¡ Â¥${sourceAccount.balance.toLocaleString('en-US', {minimumFractionDigits: 2})}`, 'danger');
                return false;
            }
        }
        
        return true;
        
    } catch (error) {
        console.error('âŒ é©—è­‰èª¿æ•´å¸³æˆ¶é¤˜é¡å¤±æ•—:', error);
        showAlert('âŒ é©—è­‰èª¿æ•´å¸³æˆ¶é¤˜é¡å¤±æ•—', 'danger');
        return false;
    }
}

// ç²å–å¸³æˆ¶ä¿¡æ¯
async function getAccountInfo(accountId) {
    try {
        const response = await fetch(`/api/cash_management/account/${accountId}`);
        const data = await response.json();
        
        if (data.status === 'success') {
            return data.account;
        } else {
            throw new Error(data.message);
        }
        
    } catch (error) {
        console.error('âŒ ç²å–å¸³æˆ¶ä¿¡æ¯å¤±æ•—:', error);
        throw error;
    }
}

// è¨­ç½®äº‹ä»¶ç›£è½å™¨
function setupEventListeners() {
    // æ¨¡æ…‹æ¡†é¡¯ç¤ºäº‹ä»¶
    const addInventoryModal = document.getElementById('addInventoryModal');
    if (addInventoryModal) {
        addInventoryModal.addEventListener('show.bs.modal', function () {
            console.log('ğŸ”§ æ–°å¢åº«å­˜æ¨¡æ…‹æ¡†é¡¯ç¤º');
            populateDropdowns();
        });
    }
    
    const adjustInventoryModal = document.getElementById('adjustInventoryModal');
    if (adjustInventoryModal) {
        adjustInventoryModal.addEventListener('show.bs.modal', function () {
            console.log('ğŸ”§ åº«å­˜èª¿æ•´æ¨¡æ…‹æ¡†é¡¯ç¤º');
            populateAdjustInventoryDropdowns();
        });
    }
    
    const exchangeRateModal = document.getElementById('exchangeRateModal');
    if (exchangeRateModal) {
        exchangeRateModal.addEventListener('show.bs.modal', function () {
            console.log('ğŸ”§ åŒ¯ç‡ç®¡ç†æ¨¡æ…‹æ¡†é¡¯ç¤º');
            populateExchangeRateModal();
        });
    }
    
    // åº«å­˜èª¿æ•´é¡å‹è®ŠåŒ–äº‹ä»¶
    const adjustTypeSelect = document.getElementById('adjustType');
    if (adjustTypeSelect) {
        adjustTypeSelect.addEventListener('change', function() {
            updateAdjustmentAccountHelp(this.value);
        });
    }
}

// å¡«å……åº«å­˜èª¿æ•´ä¸‹æ‹‰é¸å–®
async function populateAdjustInventoryDropdowns() {
    try {
        // è¼‰å…¥æœ‰åº«å­˜çš„æ‰¹æ¬¡
        const response = await fetch('/api/inventory/batches');
        if (response.ok) {
            const data = await response.json();
            if (data.status === 'success') {
                populateBatchDropdown(data.batches);
            }
        }
        
        // è¼‰å…¥å¸³æˆ¶æ•¸æ“š
        const accountsResponse = await fetch('/api/cash_management/accounts');
        if (accountsResponse.ok) {
            const accountsData = await accountsResponse.json();
            if (accountsData.status === 'success') {
                populateAdjustmentAccountDropdowns(accountsData.accounts);
            }
        }
        
    } catch (error) {
        console.error('âŒ å¡«å……åº«å­˜èª¿æ•´ä¸‹æ‹‰é¸å–®å¤±æ•—:', error);
    }
}

// å¡«å……æ‰¹æ¬¡ä¸‹æ‹‰é¸å–®
function populateBatchDropdown(batches) {
    const select = document.getElementById('adjustInventoryBatch');
    if (!select) return;
    
    select.innerHTML = '<option value="">è«‹é¸æ“‡è¦èª¿æ•´çš„åº«å­˜æ‰¹æ¬¡</option>';
    batches.forEach(batch => {
        const option = document.createElement('option');
        option.value = batch.id;
        option.textContent = `æ‰¹æ¬¡ #${batch.id} - å‰©é¤˜ Â¥${batch.remaining_rmb.toLocaleString('en-US', {minimumFractionDigits: 2})} (åŒ¯ç‡: ${batch.exchange_rate.toFixed(4)})`;
        select.appendChild(option);
    });
}

// å¡«å……èª¿æ•´å¸³æˆ¶ä¸‹æ‹‰é¸å–®
function populateAdjustmentAccountDropdowns(accounts) {
    const sourceSelect = document.getElementById('adjustSourceAccount');
    const targetSelect = document.getElementById('adjustTargetAccount');
    
    if (sourceSelect) {
        populateAccountSelect(sourceSelect, accounts, 'RMB');
    }
    
    if (targetSelect) {
        populateAccountSelect(targetSelect, accounts, 'RMB');
    }
}

// æ›´æ–°èª¿æ•´å¸³æˆ¶å¹«åŠ©æ–‡å­—
function updateAdjustmentAccountHelp(adjustType) {
    const sourceHelp = document.getElementById('sourceAccountHelp');
    const targetHelp = document.getElementById('targetAccountHelp');
    
    if (adjustType === 'increase') {
        if (sourceHelp) sourceHelp.textContent = 'å¢åŠ åº«å­˜æ™‚å¾æ­¤å¸³æˆ¶æ‰£é™¤RMB';
        if (targetHelp) targetHelp.textContent = 'å¢åŠ åº«å­˜æ™‚RMBå°‡è½‰å…¥åº«å­˜';
    } else if (adjustType === 'decrease') {
        if (sourceHelp) sourceHelp.textContent = 'æ¸›å°‘åº«å­˜æ™‚RMBå°‡å¾åº«å­˜è½‰å‡º';
        if (targetHelp) targetHelp.textContent = 'æ¸›å°‘åº«å­˜æ™‚RMBå°‡è½‰å…¥æ­¤å¸³æˆ¶';
    } else if (adjustType === 'write_off') {
        if (sourceHelp) sourceHelp.textContent = 'åº«å­˜å ±éŠ·æ™‚RMBå°‡å¾åº«å­˜è½‰å‡º';
        if (targetHelp) targetHelp.textContent = 'åº«å­˜å ±éŠ·æ™‚RMBå°‡è½‰å…¥æ­¤å¸³æˆ¶';
    }
}

// å¡«å……åŒ¯ç‡ç®¡ç†æ¨¡æ…‹æ¡†
async function populateExchangeRateModal() {
    try {
        // è¼‰å…¥ç•¶å‰åŒ¯ç‡ä¿¡æ¯
        const response = await fetch('/api/inventory/current-rates');
        if (response.ok) {
            const data = await response.json();
            if (data.status === 'success') {
                document.getElementById('oldExchangeRate').value = data.average_rate.toFixed(4);
            }
        }
    } catch (error) {
        console.error('âŒ å¡«å……åŒ¯ç‡ç®¡ç†æ¨¡æ…‹æ¡†å¤±æ•—:', error);
    }
}

// å…¶ä»–åŠŸèƒ½å‡½æ•¸
function viewInventoryDetails(batchId) {
    console.log('ğŸ‘ï¸ æŸ¥çœ‹åº«å­˜æ‰¹æ¬¡è©³æƒ…:', batchId);
    // å¯¦ç¾æŸ¥çœ‹è©³æƒ…åŠŸèƒ½
    showAlert('æŸ¥çœ‹è©³æƒ…åŠŸèƒ½é–‹ç™¼ä¸­...', 'info');
}

function editInventoryBatch(batchId) {
    console.log('âœï¸ ç·¨è¼¯åº«å­˜æ‰¹æ¬¡:', batchId);
    // å¯¦ç¾ç·¨è¼¯åŠŸèƒ½
    showAlert('ç·¨è¼¯åŠŸèƒ½é–‹ç™¼ä¸­...', 'info');
}

function deleteInventoryBatch(batchId) {
    console.log('ğŸ—‘ï¸ åˆªé™¤åº«å­˜æ‰¹æ¬¡:', batchId);
    
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤åº«å­˜æ‰¹æ¬¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†è½‰ï¼')) {
        return;
    }
    
    // å¯¦ç¾åˆªé™¤åŠŸèƒ½
    showAlert('åˆªé™¤åŠŸèƒ½é–‹ç™¼ä¸­...', 'info');
}

function refreshInventoryData() {
    console.log('ğŸ”„ åˆ·æ–°åº«å­˜æ•¸æ“š...');
    loadInventoryData();
    loadInventoryLogs();
}

function exportInventoryData() {
    console.log('ğŸ“¤ åŒ¯å‡ºåº«å­˜æ•¸æ“š...');
    // å¯¦ç¾åŒ¯å‡ºåŠŸèƒ½
    showAlert('åŒ¯å‡ºåŠŸèƒ½é–‹ç™¼ä¸­...', 'info');
}

// å·¥å…·å‡½æ•¸
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('zh-TW');
}

function formatDateTime(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleString('zh-TW');
}

function showAlert(message, type = 'info') {
    // å‰µå»º Bootstrap æç¤ºæ¡†
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // è‡ªå‹•é—œé–‰
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}

