{% extends "base.html" %}

{% block title %}å„€è¡¨æ¿{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .metric-card { border: none; border-radius: .75rem; box-shadow: 0 4px 15px rgba(0,0,0,.05); transition: all .2s ease-in-out; }
    .metric-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,.08); }
    .metric-card .card-body { display: flex; align-items: center; }
    .metric-card .icon-circle { display: inline-flex; align-items: center; justify-content: center; width: 50px; height: 50px; border-radius: 50%; margin-right: 1.25rem; }
    .metric-card .card-footer { background-color: #f8f9fa; border-top: 1px solid #dee2e6; font-weight: 500; }
    
    /* åº«å­˜ç‹€æ…‹æ¦‚è¦½çš„æ¨£å¼ */
    .inventory-stat-card {
        transition: all 0.3s ease;
        border-radius: 12px;
    }
    
    .inventory-stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .progress {
        border-radius: 10px;
        background-color: #f8f9fa;
    }
    
    .progress-bar {
        border-radius: 10px;
        transition: width 0.6s ease;
    }
    
    .inventory-table tr {
        transition: background-color 0.2s ease;
    }
    
    .inventory-table tr:hover {
        background-color: #f8f9fa;
    }
    
    .quick-action-btn {
        transition: all 0.2s ease;
        border-radius: 8px;
    }
    
    .quick-action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
</style>
{% endblock %}


{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 border-bottom">
    <h1 class="h2">å„€è¡¨æ¿ç¸½è¦½</h1>
</div>

<div class="row">
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card h-100 metric-card">
            <div class="card-body">
                <div class="icon-circle bg-primary-subtle text-primary"><i class="bi bi-wallet2 fs-3"></i></div>
                <div>
                    <p class="text-muted mb-1 small">å°å¹£è³‡ç”¢ (TWD)</p>
                    <h3 class="fw-bold mb-0">NT$ {{ "{:,.0f}".format(twd_assets or 0) }}</h3>
                </div>
            </div>
            <a href="{{ url_for('cash_management') }}" class="card-footer text-decoration-none text-muted d-block">æŸ¥çœ‹ç¾é‡‘ <i class="bi bi-arrow-right-circle float-end"></i></a>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card h-100 metric-card">
            <div class="card-body">
                <div class="icon-circle bg-success-subtle text-success"><i class="bi bi-currency-yen fs-3"></i></div>
                <div>
                    <p class="text-muted mb-1 small">äººæ°‘å¹£è³‡ç”¢ (RMB)</p>
                    <h3 class="fw-bold mb-0">Â¥ {{ "{:,.0f}".format(total_rmb_stock or 0) }}</h3>
                </div>
            </div>
            <a href="{{ url_for('fifo_inventory') }}" class="card-footer text-decoration-none text-muted d-block">ç®¡ç†åº«å­˜ <i class="bi bi-arrow-right-circle float-end"></i></a>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card h-100 metric-card">
            <div class="card-body">
                <div class="icon-circle bg-danger-subtle text-danger"><i class="bi bi-receipt-cutoff fs-3"></i></div>
                <div>
                    <p class="text-muted mb-1 small">ç¸½æ‡‰æ”¶å¸³æ¬¾ (TWD)</p>
                    <h3 class="fw-bold mb-0">NT$ {{ "{:,.0f}".format(total_unsettled_amount_twd or 0) }}</h3>
                </div>
            </div>
            <a href="{{ url_for('cash_management') }}" class="card-footer text-decoration-none text-muted d-block">æŸ¥çœ‹å¸³æ¬¾ <i class="bi bi-arrow-right-circle float-end"></i></a>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card h-100 metric-card">
            <div class="card-body">
                <div class="icon-circle bg-warning-subtle text-warning"><i class="bi bi-cash-stack fs-3"></i></div>
                <div>
                    <p class="text-muted mb-1 small">ç¸½åˆ©æ½¤ (TWD)</p>
                    <h3 class="fw-bold mb-0">NT$ {{ "{:,.0f}".format(total_profit_twd or 0) }}</h3>
                </div>
            </div>
            <a href="{{ url_for('fifo_inventory') }}" class="card-footer text-decoration-none text-muted d-block">æŸ¥çœ‹åˆ©æ½¤åˆ†æ <i class="bi bi-arrow-right-circle float-end"></i></a>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-lg-7 mb-4">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white border-0 pt-3">
                <h5 class="card-title fw-bold"><i class="bi bi-box-seam-fill me-2"></i>è¿‘30æ—¥åº«å­˜è®ŠåŒ–è¶¨å‹¢ (RMB)</h5>
                <small class="text-muted">é¡¯ç¤ºåº«å­˜æ•¸é‡çš„è®ŠåŒ–è¶¨å‹¢</small>
            </div>
            <div class="card-body">
                <canvas id="inventoryChart" style="min-height: 280px; height: 280px;"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-5 mb-4">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white border-0 pt-3">
                <h5 class="card-title fw-bold"><i class="bi bi-boxes me-2"></i>åº«å­˜ç‹€æ…‹æ¦‚è¦½</h5>
                <small class="text-muted">å³æ™‚åº«å­˜ç‹€æ…‹å’Œæ•ˆç‡æŒ‡æ¨™</small>
            </div>
            <div class="card-body">
                <!-- åº«å­˜çµ±è¨ˆå¡ç‰‡ -->
                <div class="row g-3 mb-4">
                    <div class="col-6">
                        <div class="text-center p-3 rounded inventory-stat-card" style="background-color: #e3f2fd;">
                            <div class="text-primary fw-bold fs-4">{{ "{:,.0f}".format(total_inventory_rmb or 0) }}</div>
                            <small class="text-muted">ç•¶å‰åº«å­˜ (RMB)</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-3 rounded inventory-stat-card" style="background-color: #f3e5f5;">
                            <div class="text-purple fw-bold fs-4">{{ "{:,.0f}".format(total_allocated_rmb or 0) }}</div>
                            <small class="text-muted">å·²åˆ†é… (RMB)</small>
                        </div>
                    </div>
                </div>
                
                <!-- åº«å­˜æ•ˆç‡æŒ‡æ¨™ -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted small">åº«å­˜å‘¨è½‰æ•ˆç‡</span>
                        <span class="fw-bold text-success">{{ "%.1f".format(inventory_efficiency or 0) }}%</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: {{ inventory_efficiency or 0 }}%" 
                             aria-valuenow="{{ inventory_efficiency or 0 }}" 
                             aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
                
                <!-- åº«å­˜ç‹€æ…‹è©³æƒ… -->
                <div class="table-responsive">
                    <table class="table table-sm mb-0 inventory-table">
                        <tbody>
                            <tr>
                                <td><i class="bi bi-check-circle-fill text-success me-2"></i>æ´»èºåº«å­˜æ‰¹æ¬¡</td>
                                <td class="text-end"><span class="badge bg-success-subtle text-success-emphasis">{{ active_inventory_count or 0 }}</span></td>
                            </tr>
                            <tr>
                                <td><i class="bi bi-x-circle-fill text-muted me-2"></i>å·²ç”¨å®Œæ‰¹æ¬¡</td>
                                <td class="text-end"><span class="badge bg-secondary-subtle text-secondary-emphasis">{{ exhausted_inventory_count or 0 }}</span></td>
                            </tr>
                            <tr>
                                <td><i class="bi bi-arrow-up-circle-fill text-info me-2"></i>ç¸½åº«å­˜æ‰¹æ¬¡</td>
                                <td class="text-end"><span class="badge bg-info-subtle text-info-emphasis">{{ (active_inventory_count or 0) + (exhausted_inventory_count or 0) }}</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- å¿«é€Ÿæ“ä½œæŒ‰éˆ• -->
                <div class="mt-3 pt-3 border-top">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('fifo_inventory') }}" class="btn btn-outline-primary btn-sm quick-action-btn">
                            <i class="bi bi-box-seam me-1"></i>è©³ç´°åº«å­˜ç®¡ç†
                        </a>
                        <a href="{{ url_for('buy_in') }}" class="btn btn-outline-success btn-sm quick-action-btn">
                            <i class="bi bi-plus-circle me-1"></i>æ–°å¢åº«å­˜
                        </a>
                    </div>
                </div>
                
                <!-- ç³»çµ±ç®¡ç†åŠŸèƒ½ -->
                <div class="mt-3 pt-3 border-top">
                    <h6 class="text-muted mb-2">
                        <i class="bi bi-gear me-1"></i>ç³»çµ±ç®¡ç†
                    </h6>
                    <div class="d-grid gap-2">
                        <button id="clearAllDataBtn" class="btn btn-outline-danger btn-sm quick-action-btn">
                            <i class="bi bi-trash3 me-1"></i>æ¸…ç©ºæ¸¬è©¦æ•¸æ“š
                        </button>
                    </div>
                    <small class="text-muted d-block mt-1">
                        <i class="bi bi-exclamation-triangle me-1"></i>åƒ…ä¾›å…¬æ¸¬ä½¿ç”¨ï¼Œå°‡æ¸…ç©ºæ‰€æœ‰äº¤æ˜“å’Œå¸³å‹™æ•¸æ“š
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    'use strict';
    const inventoryChartCanvas = document.getElementById('inventoryChart');
    if (!inventoryChartCanvas) { return; }
    const ctx = inventoryChartCanvas.getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, 0, 280);
    gradient.addColorStop(0, 'rgba(76, 175, 80, 0.6)');
    gradient.addColorStop(1, 'rgba(76, 175, 80, 0)');
    
    // åº«å­˜è®ŠåŒ–è¶¨å‹¢åœ–è¡¨
    const inventoryChartData = {
        labels: {{ chart_data['labels']|tojson }},
        datasets: [{
            label: 'åº«å­˜æ•¸é‡ (RMB)',
            backgroundColor: gradient,
            borderColor: 'rgba(76, 175, 80, 1)',
            borderWidth: 2,
            fill: true,
            pointRadius: 3,
            pointBackgroundColor: 'rgba(76, 175, 80, 1)',
            tension: 0.3,
            data: {{ chart_data['values']|tojson }}
        }]
    };

    const inventoryChartOptions = {
        maintainAspectRatio: false,
        responsive: true,
        plugins: { 
            legend: { display: false },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return `åº«å­˜: Â¥${context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 0})}`;
                    }
                }
            }
        },
        scales: {
            x: { 
                grid: { display: false },
                ticks: {
                    maxTicksLimit: 10,
                    maxRotation: 45
                }
            },
            y: { 
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return 'Â¥' + value.toLocaleString('en-US', {minimumFractionDigits: 0});
                    }
                }
            }
        }
    };

    new Chart(inventoryChartCanvas, { type: 'line', data: inventoryChartData, options: inventoryChartOptions });
    
    // æ¸…ç©ºæ¸¬è©¦æ•¸æ“šåŠŸèƒ½
    const clearAllDataBtn = document.getElementById('clearAllDataBtn');
    if (clearAllDataBtn) {
        clearAllDataBtn.addEventListener('click', async function() {
            console.log('ğŸ§¹ é»æ“Šæ¸…ç©ºæ¸¬è©¦æ•¸æ“šæŒ‰éˆ•');
            
            // ç¬¬ä¸€å±¤ç¢ºèª
            const firstConfirm = await Swal.fire({
                title: 'âš ï¸ å±éšªæ“ä½œè­¦å‘Š',
                html: `
                    <div class="text-start">
                        <p class="mb-3"><strong>å³å°‡æ¸…ç©ºä»¥ä¸‹æ‰€æœ‰æ•¸æ“šï¼š</strong></p>
                        <ul class="text-muted">
                            <li>æ‰€æœ‰è²·å…¥è¨‚å–®è¨˜éŒ„</li>
                            <li>æ‰€æœ‰å”®å‡ºè¨‚å–®è¨˜éŒ„</li>
                            <li>æ‰€æœ‰å¸³æˆ¶é¤˜é¡ï¼ˆè¨­ç‚º0ï¼‰</li>
                            <li>æ‰€æœ‰ç¾é‡‘æµæ°´è¨˜éŒ„</li>
                            <li>æ‰€æœ‰æ‡‰æ”¶å¸³æ¬¾</li>
                            <li>æ‰€æœ‰FIFOåº«å­˜è¨˜éŒ„</li>
                            <li>æ‰€æœ‰åˆ·å¡è¨˜éŒ„</li>
                        </ul>
                        <div class="alert alert-danger mt-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>æ­¤æ“ä½œä¸å¯é€†ï¼</strong>æ‰€æœ‰äº¤æ˜“æ•¸æ“šå°‡æ°¸ä¹…åˆªé™¤ã€‚
                        </div>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'ç¹¼çºŒæ“ä½œ',
                cancelButtonText: 'å–æ¶ˆ',
                width: '600px'
            });
            
            if (!firstConfirm.isConfirmed) {
                return;
            }
            
            // ç¬¬äºŒå±¤ç¢ºèª - éœ€è¦è¼¸å…¥ç¢ºèªç¢¼
            const { value: confirmationCode } = await Swal.fire({
                title: 'æœ€çµ‚ç¢ºèª',
                html: `
                    <div class="text-start">
                        <p class="mb-3">è«‹è¼¸å…¥ç¢ºèªç¢¼ä»¥å®Œæˆæ¸…ç©ºæ“ä½œï¼š</p>
                        <div class="alert alert-info">
                            <strong>ç¢ºèªç¢¼ï¼š</strong> <code>CLEAR_ALL_DATA</code>
                        </div>
                        <p class="text-muted small">
                            <i class="bi bi-info-circle me-1"></i>
                            æ­¤æ“ä½œåƒ…é©ç”¨æ–¼å…¬æ¸¬éšæ®µï¼Œæ­£å¼ç’°å¢ƒä¸­è«‹å‹¿ä½¿ç”¨ã€‚
                        </p>
                    </div>
                `,
                input: 'text',
                inputPlaceholder: 'è«‹è¼¸å…¥ç¢ºèªç¢¼',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'ç¢ºèªæ¸…ç©º',
                cancelButtonText: 'å–æ¶ˆ',
                inputValidator: (value) => {
                    if (!value) {
                        return 'è«‹è¼¸å…¥ç¢ºèªç¢¼ï¼';
                    }
                    if (value !== 'CLEAR_ALL_DATA') {
                        return 'ç¢ºèªç¢¼éŒ¯èª¤ï¼';
                    }
                },
                width: '500px'
            });
            
            if (!confirmationCode) {
                return;
            }
            
            try {
                // é¡¯ç¤ºè™•ç†ä¸­
                Swal.fire({
                    title: 'æ­£åœ¨æ¸…ç©ºæ•¸æ“š...',
                    html: 'è«‹ç¨å€™ï¼Œæ­£åœ¨åŸ·è¡Œæ¸…ç©ºæ“ä½œ',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // ç™¼é€æ¸…ç©ºè«‹æ±‚
                const response = await fetch('/api/clear-all-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        confirmation: 'CONFIRM_CLEAR_ALL_DATA'
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.status === 'success') {
                    await Swal.fire({
                        title: 'âœ… æ¸…ç©ºå®Œæˆ',
                        html: `
                            <div class="text-start">
                                <p class="mb-3">${result.message}</p>
                                <div class="alert alert-success">
                                    <strong>è©³ç´°çµ±è¨ˆï¼š</strong>
                                    <ul class="mb-0 mt-2">
                                        <li>è²·å…¥è¨˜éŒ„ï¼š${result.details.purchases_cleared} ç­†</li>
                                        <li>å”®å‡ºè¨˜éŒ„ï¼š${result.details.sales_cleared} ç­†</li>
                                        <li>å¸³æˆ¶é¤˜é¡ï¼š${result.details.accounts_cleared} å€‹</li>
                                        <li>æµæ°´è¨˜éŒ„ï¼š${result.details.ledger_entries_cleared} ç­†</li>
                                        <li>ç¾é‡‘æ—¥èªŒï¼š${result.details.cash_logs_cleared} ç­†</li>
                                        <li>æ‡‰æ”¶å¸³æ¬¾ï¼š${result.details.receivables_cleared} ä½å®¢æˆ¶</li>
                                        <li>FIFOåº«å­˜ï¼š${result.details.fifo_cleared} ç­†</li>
                                        <li>åˆ·å¡è¨˜éŒ„ï¼š${result.details.card_purchases_cleared} ç­†</li>
                                    </ul>
                                </div>
                            </div>
                        `,
                        icon: 'success',
                        confirmButtonText: 'åˆ·æ–°é é¢',
                        width: '500px'
                    });
                    
                    // åˆ·æ–°é é¢ä»¥é¡¯ç¤ºæ›´æ–°å¾Œçš„æ•¸æ“š
                    window.location.reload();
                } else {
                    Swal.fire({
                        title: 'âŒ æ¸…ç©ºå¤±æ•—',
                        text: result.message || 'æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦',
                        icon: 'error',
                        confirmButtonText: 'ç¢ºå®š'
                    });
                }
            } catch (error) {
                console.error('âŒ æ¸…ç©ºæ•¸æ“šè«‹æ±‚å¤±æ•—:', error);
                Swal.fire({
                    title: 'âŒ ç¶²è·¯éŒ¯èª¤',
                    text: 'è«‹æ±‚å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥å¾Œé‡è©¦',
                    icon: 'error',
                    confirmButtonText: 'ç¢ºå®š'
                });
            }
        });
    }
});
</script>
{% endblock %}