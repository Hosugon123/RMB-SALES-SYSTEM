{% extends "base.html" %}

{% block title %}儀表板{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .metric-card { border: none; border-radius: .75rem; box-shadow: 0 4px 15px rgba(0,0,0,.05); transition: all .2s ease-in-out; }
    .metric-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,.08); }
    .metric-card .card-body { display: flex; align-items: center; }
    .metric-card .icon-circle { display: inline-flex; align-items: center; justify-content: center; width: 50px; height: 50px; border-radius: 50%; margin-right: 1.25rem; }
    .metric-card .card-footer { background-color: #f8f9fa; border-top: 1px solid #dee2e6; font-weight: 500; }
    
    /* 庫存狀態概覽的樣式 */
    .inventory-stat-card {
        transition: all 0.3s ease;
        border-radius: 12px;
    }
    
    .inventory-stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .progress {
        border-radius: 10px;
        background-color: #f8f9fa;
    }
    
    .progress-bar {
        border-radius: 10px;
        transition: width 0.6s ease;
    }
    
    .inventory-table tr {
        transition: background-color 0.2s ease;
    }
    
    .inventory-table tr:hover {
        background-color: #f8f9fa;
    }
    
    .quick-action-btn {
        transition: all 0.2s ease;
        border-radius: 8px;
    }
    
    .quick-action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
</style>
{% endblock %}


{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 border-bottom">
    <h1 class="h2">儀表板總覽</h1>
</div>

<div class="row">
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card h-100 metric-card">
            <div class="card-body">
                <div class="icon-circle bg-primary-subtle text-primary"><i class="bi bi-wallet2 fs-3"></i></div>
                <div>
                    <p class="text-muted mb-1 small">台幣資產 (TWD)</p>
                    <h3 class="fw-bold mb-0">NT$ {{ "{:,.0f}".format(twd_assets or 0) }}</h3>
                </div>
            </div>
            <a href="{{ url_for('cash_management') }}" class="card-footer text-decoration-none text-muted d-block">查看現金 <i class="bi bi-arrow-right-circle float-end"></i></a>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card h-100 metric-card">
            <div class="card-body">
                <div class="icon-circle bg-success-subtle text-success"><i class="bi bi-currency-yen fs-3"></i></div>
                <div>
                    <p class="text-muted mb-1 small">人民幣資產 (RMB)</p>
                    <h3 class="fw-bold mb-0">¥ {{ "{:,.0f}".format(total_rmb_stock or 0) }}</h3>
                </div>
            </div>
            <a href="{{ url_for('fifo_inventory') }}" class="card-footer text-decoration-none text-muted d-block">管理庫存 <i class="bi bi-arrow-right-circle float-end"></i></a>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card h-100 metric-card">
            <div class="card-body">
                <div class="icon-circle bg-danger-subtle text-danger"><i class="bi bi-receipt-cutoff fs-3"></i></div>
                <div>
                    <p class="text-muted mb-1 small">總應收帳款 (TWD)</p>
                    <h3 class="fw-bold mb-0">NT$ {{ "{:,.0f}".format(total_unsettled_amount_twd or 0) }}</h3>
                </div>
            </div>
            <a href="{{ url_for('cash_management') }}" class="card-footer text-decoration-none text-muted d-block">查看帳款 <i class="bi bi-arrow-right-circle float-end"></i></a>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card h-100 metric-card">
            <div class="card-body">
                <div class="icon-circle bg-warning-subtle text-warning"><i class="bi bi-cash-stack fs-3"></i></div>
                <div>
                    <p class="text-muted mb-1 small">總利潤 (TWD)</p>
                    <h3 class="fw-bold mb-0">NT$ {{ "{:,.0f}".format(total_profit_twd or 0) }}</h3>
                </div>
            </div>
            <a href="{{ url_for('fifo_inventory') }}" class="card-footer text-decoration-none text-muted d-block">查看利潤分析 <i class="bi bi-arrow-right-circle float-end"></i></a>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-lg-7 mb-4">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white border-0 pt-3">
                <h5 class="card-title fw-bold"><i class="bi bi-box-seam-fill me-2"></i>近30日庫存變化趨勢 (RMB)</h5>
                <small class="text-muted">顯示庫存數量的變化趨勢</small>
            </div>
            <div class="card-body">
                <canvas id="inventoryChart" style="min-height: 280px; height: 280px;"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-5 mb-4">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white border-0 pt-3">
                <h5 class="card-title fw-bold"><i class="bi bi-boxes me-2"></i>庫存狀態概覽</h5>
                <small class="text-muted">即時庫存狀態和效率指標</small>
            </div>
            <div class="card-body">
                <!-- 庫存統計卡片 -->
                <div class="row g-3 mb-4">
                    <div class="col-6">
                        <div class="text-center p-3 rounded inventory-stat-card" style="background-color: #e3f2fd;">
                            <div class="text-primary fw-bold fs-4">{{ "{:,.0f}".format(total_inventory_rmb or 0) }}</div>
                            <small class="text-muted">當前庫存 (RMB)</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-3 rounded inventory-stat-card" style="background-color: #f3e5f5;">
                            <div class="text-purple fw-bold fs-4">{{ "{:,.0f}".format(total_allocated_rmb or 0) }}</div>
                            <small class="text-muted">已分配 (RMB)</small>
                        </div>
                    </div>
                </div>
                
                <!-- 庫存效率指標 -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted small">庫存周轉效率</span>
                        <span class="fw-bold text-success">{{ "%.1f".format(inventory_efficiency or 0) }}%</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: {{ inventory_efficiency or 0 }}%" 
                             aria-valuenow="{{ inventory_efficiency or 0 }}" 
                             aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
                
                <!-- 庫存狀態詳情 -->
                <div class="table-responsive">
                    <table class="table table-sm mb-0 inventory-table">
                        <tbody>
                            <tr>
                                <td><i class="bi bi-check-circle-fill text-success me-2"></i>活躍庫存批次</td>
                                <td class="text-end"><span class="badge bg-success-subtle text-success-emphasis">{{ active_inventory_count or 0 }}</span></td>
                            </tr>
                            <tr>
                                <td><i class="bi bi-x-circle-fill text-muted me-2"></i>已用完批次</td>
                                <td class="text-end"><span class="badge bg-secondary-subtle text-secondary-emphasis">{{ exhausted_inventory_count or 0 }}</span></td>
                            </tr>
                            <tr>
                                <td><i class="bi bi-arrow-up-circle-fill text-info me-2"></i>總庫存批次</td>
                                <td class="text-end"><span class="badge bg-info-subtle text-info-emphasis">{{ (active_inventory_count or 0) + (exhausted_inventory_count or 0) }}</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- 快速操作按鈕 -->
                <div class="mt-3 pt-3 border-top">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('fifo_inventory') }}" class="btn btn-outline-primary btn-sm quick-action-btn">
                            <i class="bi bi-box-seam me-1"></i>詳細庫存管理
                        </a>
                        <a href="{{ url_for('buy_in') }}" class="btn btn-outline-success btn-sm quick-action-btn">
                            <i class="bi bi-plus-circle me-1"></i>新增庫存
                        </a>
                    </div>
                </div>
                
                <!-- 系統管理功能 -->
                <div class="mt-3 pt-3 border-top">
                    <h6 class="text-muted mb-2">
                        <i class="bi bi-gear me-1"></i>系統管理
                    </h6>
                    <div class="d-grid gap-2">
                        <button id="clearAllDataBtn" class="btn btn-outline-danger btn-sm quick-action-btn">
                            <i class="bi bi-trash3 me-1"></i>清空測試數據
                        </button>
                    </div>
                    <small class="text-muted d-block mt-1">
                        <i class="bi bi-exclamation-triangle me-1"></i>僅供公測使用，將清空所有交易和帳務數據
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    'use strict';
    const inventoryChartCanvas = document.getElementById('inventoryChart');
    if (!inventoryChartCanvas) { return; }
    const ctx = inventoryChartCanvas.getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, 0, 280);
    gradient.addColorStop(0, 'rgba(76, 175, 80, 0.6)');
    gradient.addColorStop(1, 'rgba(76, 175, 80, 0)');
    
    // 庫存變化趨勢圖表
    const inventoryChartData = {
        labels: {{ chart_data['labels']|tojson }},
        datasets: [{
            label: '庫存數量 (RMB)',
            backgroundColor: gradient,
            borderColor: 'rgba(76, 175, 80, 1)',
            borderWidth: 2,
            fill: true,
            pointRadius: 3,
            pointBackgroundColor: 'rgba(76, 175, 80, 1)',
            tension: 0.3,
            data: {{ chart_data['values']|tojson }}
        }]
    };

    const inventoryChartOptions = {
        maintainAspectRatio: false,
        responsive: true,
        plugins: { 
            legend: { display: false },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return `庫存: ¥${context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 0})}`;
                    }
                }
            }
        },
        scales: {
            x: { 
                grid: { display: false },
                ticks: {
                    maxTicksLimit: 10,
                    maxRotation: 45
                }
            },
            y: { 
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '¥' + value.toLocaleString('en-US', {minimumFractionDigits: 0});
                    }
                }
            }
        }
    };

    new Chart(inventoryChartCanvas, { type: 'line', data: inventoryChartData, options: inventoryChartOptions });
    
    // 清空測試數據功能
    const clearAllDataBtn = document.getElementById('clearAllDataBtn');
    if (clearAllDataBtn) {
        clearAllDataBtn.addEventListener('click', async function() {
            console.log('🧹 點擊清空測試數據按鈕');
            
            // 第一層確認
            const firstConfirm = await Swal.fire({
                title: '⚠️ 危險操作警告',
                html: `
                    <div class="text-start">
                        <p class="mb-3"><strong>即將清空以下所有數據：</strong></p>
                        <ul class="text-muted">
                            <li>所有買入訂單記錄</li>
                            <li>所有售出訂單記錄</li>
                            <li>所有帳戶餘額（設為0）</li>
                            <li>所有現金流水記錄</li>
                            <li>所有應收帳款</li>
                            <li>所有FIFO庫存記錄</li>
                            <li>所有刷卡記錄</li>
                        </ul>
                        <div class="alert alert-danger mt-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>此操作不可逆！</strong>所有交易數據將永久刪除。
                        </div>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '繼續操作',
                cancelButtonText: '取消',
                width: '600px'
            });
            
            if (!firstConfirm.isConfirmed) {
                return;
            }
            
            // 第二層確認 - 需要輸入確認碼
            const { value: confirmationCode } = await Swal.fire({
                title: '最終確認',
                html: `
                    <div class="text-start">
                        <p class="mb-3">請輸入確認碼以完成清空操作：</p>
                        <div class="alert alert-info">
                            <strong>確認碼：</strong> <code>CLEAR_ALL_DATA</code>
                        </div>
                        <p class="text-muted small">
                            <i class="bi bi-info-circle me-1"></i>
                            此操作僅適用於公測階段，正式環境中請勿使用。
                        </p>
                    </div>
                `,
                input: 'text',
                inputPlaceholder: '請輸入確認碼',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '確認清空',
                cancelButtonText: '取消',
                inputValidator: (value) => {
                    if (!value) {
                        return '請輸入確認碼！';
                    }
                    if (value !== 'CLEAR_ALL_DATA') {
                        return '確認碼錯誤！';
                    }
                },
                width: '500px'
            });
            
            if (!confirmationCode) {
                return;
            }
            
            try {
                // 顯示處理中
                Swal.fire({
                    title: '正在清空數據...',
                    html: '請稍候，正在執行清空操作',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // 發送清空請求
                const response = await fetch('/api/clear-all-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        confirmation: 'CONFIRM_CLEAR_ALL_DATA'
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.status === 'success') {
                    await Swal.fire({
                        title: '✅ 清空完成',
                        html: `
                            <div class="text-start">
                                <p class="mb-3">${result.message}</p>
                                <div class="alert alert-success">
                                    <strong>詳細統計：</strong>
                                    <ul class="mb-0 mt-2">
                                        <li>買入記錄：${result.details.purchases_cleared} 筆</li>
                                        <li>售出記錄：${result.details.sales_cleared} 筆</li>
                                        <li>帳戶餘額：${result.details.accounts_cleared} 個</li>
                                        <li>流水記錄：${result.details.ledger_entries_cleared} 筆</li>
                                        <li>現金日誌：${result.details.cash_logs_cleared} 筆</li>
                                        <li>應收帳款：${result.details.receivables_cleared} 位客戶</li>
                                        <li>FIFO庫存：${result.details.fifo_cleared} 筆</li>
                                        <li>刷卡記錄：${result.details.card_purchases_cleared} 筆</li>
                                    </ul>
                                </div>
                            </div>
                        `,
                        icon: 'success',
                        confirmButtonText: '刷新頁面',
                        width: '500px'
                    });
                    
                    // 刷新頁面以顯示更新後的數據
                    window.location.reload();
                } else {
                    Swal.fire({
                        title: '❌ 清空失敗',
                        text: result.message || '操作失敗，請稍後重試',
                        icon: 'error',
                        confirmButtonText: '確定'
                    });
                }
            } catch (error) {
                console.error('❌ 清空數據請求失敗:', error);
                Swal.fire({
                    title: '❌ 網路錯誤',
                    text: '請求失敗，請檢查網路連接後重試',
                    icon: 'error',
                    confirmButtonText: '確定'
                });
            }
        });
    }
});
</script>
{% endblock %}