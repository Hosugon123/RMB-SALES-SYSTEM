{% extends "base.html" %}

{% block title %}買入成本計算{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-center" style="min-height: 75vh;">
    <div class="col-md-8 col-lg-6">
        <div class="card border-0 shadow-lg">
            <div class="card-body p-4 p-md-5">
                <div class="text-center mb-4">
                    <i class="bi bi-currency-exchange fs-1 text-primary"></i>
                    <h2 class="card-title fw-light text-dark mt-2">買入成本計算</h2>
                    <p class="text-muted small">即時換算人民幣買入成本</p>
                </div>
                
                <div class="mb-3">
                    <label for="customer_select" class="form-label">常用買入渠道</label>
                    <div class="input-group">
                        <select id="customer_select" class="form-select">
                            <option value="">從常用渠道選擇...</option>
                            {% for customer in customers %}<option value="{{ customer.id }}">{{ customer.username }}</option>{% endfor %}
                        </select>
                        <button class="btn btn-outline-primary" type="button" id="confirmCustomerBtn" title="確認使用此渠道">
                            <i class="bi bi-check-lg"></i> 確認
                        </button>
                        <button class="btn btn-outline-danger" type="button" id="deleteCustomerBtn" title="從常用列表中移除">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="customer_name_input" class="form-label">買入渠道</label>
                    <div class="input-group">
                        <input type="text" id="customer_name_input" class="form-control" placeholder="手動輸入或從上方帶入" required>
                        <button class="btn btn-outline-secondary" type="button" id="addCustomerBtn" title="新增至常用渠道">
                            <i class="bi bi-person-plus"></i> 新增至常用
                        </button>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="rmb_amount" class="form-label">買入金額 (RMB)</label>
                    <div class="input-group input-group-lg">
                        <span class="input-group-text">¥</span>
                        <input type="number" class="form-control" id="rmb_amount" step="0.01" placeholder="例如: 2000">
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="buy_rate" class="form-label">買入匯率</label>
                    <div class="input-group input-group-lg">
                        <span class="input-group-text">NT$</span>
                        <input type="number" class="form-control" id="buy_rate" step="0.0001" placeholder="例如: 4.35">
                    </div>
                </div>

                <div class="text-center bg-light rounded p-3 mb-4">
                    <h6 class="text-muted fw-normal mb-1">換算台幣成本</h6>
                    <h1 class="display-5 fw-bold text-primary" id="twd_result">NT$ 0.00</h1>
                </div>

                <div class="d-grid">
                    <button type="button" class="btn btn-primary btn-lg" id="confirm_purchase_btn">
                        <i class="bi bi-check-circle me-2"></i>確認買入
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const rmbInput = document.getElementById('rmb_amount');
    const rateInput = document.getElementById('buy_rate');
    const twdResult = document.getElementById('twd_result');
    const customerSelect = document.getElementById('customer_select');
    const customerNameInput = document.getElementById('customer_name_input');
    const confirmCustomerBtn = document.getElementById('confirmCustomerBtn');
    const deleteCustomerBtn = document.getElementById('deleteCustomerBtn');
    const addCustomerBtn = document.getElementById('addCustomerBtn');
    const confirmPurchaseBtn = document.getElementById('confirm_purchase_btn');
    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });

    // 函數：計算並顯示台幣成本
    function calculateTWD() {
        const rmb = parseFloat(rmbInput.value) || 0;
        const rate = parseFloat(rateInput.value) || 0;
        const result = rmb * rate;
        twdResult.textContent = 'NT$ ' + result.toFixed(2);
    }

    // 事件監聽：即時計算
    rmbInput.addEventListener('input', calculateTWD);
    rateInput.addEventListener('input', calculateTWD);

    // 事件監聽：從下拉選單確認渠道
    confirmCustomerBtn.addEventListener('click', function() {
        const selectedOption = customerSelect.options[customerSelect.selectedIndex];
        if (selectedOption && selectedOption.value) {
            customerNameInput.value = selectedOption.text;
        } else {
            Toast.fire({ icon: 'info', title: '請先選擇一個渠道' });
        }
    });

    // 事件監聽：新增常用渠道
    addCustomerBtn.addEventListener('click', function() {
        const newName = customerNameInput.value.trim();
        if (!newName) {
            Swal.fire('名稱不能為空', '請輸入要新增的渠道名稱', 'warning');
            return;
        }
        
        fetch("{{ url_for('add_purchase_channel_ajax') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ customer_name: newName })
        })
        .then(response => response.json())
        .then(res => {
            if (res.status !== 'success') throw new Error(res.message);
            
            const newOption = new Option(res.customer.username, res.customer.id);
            customerSelect.add(newOption);
            customerSelect.value = res.customer.id; // 自動選中新增的項
            Swal.fire('新增成功', `渠道 "${res.customer.username}" 已新增至常用列表`, 'success');
        })
        .catch(error => Swal.fire('新增失敗', error.message, 'error'));
    });

    // 事件監聽：刪除常用渠道
    deleteCustomerBtn.addEventListener('click', function() {
        const selectedId = customerSelect.value;
        if (!selectedId) {
            Swal.fire('尚未選擇', '請從下拉選單中選擇要刪除的渠道', 'warning');
            return;
        }

        Swal.fire({
            title: '確定要刪除嗎?',
            text: `您將從常用列表中移除 "${customerSelect.options[customerSelect.selectedIndex].text}"`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: '是的，刪除它！',
            cancelButtonText: '取消'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch("{{ url_for('delete_purchase_channel_ajax') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customer_id: selectedId })
                })
                .then(response => response.json())
                .then(res => {
                    if (res.status !== 'success') throw new Error(res.message);
                    
                    customerSelect.remove(customerSelect.selectedIndex);
                    if (customerNameInput.value === res.deleted_name) {
                         customerNameInput.value = ''; // 如果下方輸入框是剛被刪除的，就清空
                    }
                    Swal.fire('已刪除', `渠道 "${res.deleted_name}" 已被移除`, 'success');
                })
                .catch(error => Swal.fire('刪除失敗', error.message, 'error'));
            }
        });
    });

    // 事件監聽：確認買入
    confirmPurchaseBtn.addEventListener('click', function() {
        const channelName = customerNameInput.value.trim();
        const rmbAmount = parseFloat(rmbInput.value);
        const buyRate = parseFloat(rateInput.value);

        if (!channelName || !rmbAmount || !buyRate || rmbAmount <= 0 || buyRate <= 0) {
            Swal.fire('資料不完整或無效', '請填寫所有欄位，並確保金額與匯率大於0', 'warning');
            return;
        }

        const data = {
            channel_name: channelName,
            rmb_amount: rmbAmount,
            buy_rate: buyRate,
            twd_amount: rmbAmount * buyRate
        };

        fetch("{{ url_for('record_purchase_ajax') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(res => {
            if (res.status !== 'success') throw new Error(res.message);
            
            Swal.fire({
                icon: 'success',
                title: '紀錄成功！',
                text: res.message,
                showConfirmButton: false,
                timer: 2000
            });

            // 成功後清空表單
            customerNameInput.value = '';
            rmbInput.value = '';
            rateInput.value = '';
            twdResult.textContent = 'NT$ 0.00';
            customerSelect.value = '';

        })
        .catch(error => {
            Swal.fire('操作失敗', error.message || '伺服器發生錯誤', 'error');
        });
    });
});
</script>
{% endblock %}