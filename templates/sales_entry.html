{% extends "base.html" %}

{% block title %}å”®å‡ºéŒ„å…¥èˆ‡ç®¡ç†{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- å·¦å´ï¼šæ“ä½œé¢æ¿ -->
    <div class="col-lg-5">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0 fw-light"><i class="bi bi-pencil-square me-2"></i>å‰µå»ºæ–°è¨‚å–®</h4>
            </div>
            <div class="card-body p-4">
                <form id="create-order-form">
                    <!-- 1. å®¢æˆ¶é¸æ“‡ -->
                    <div class="mb-3">
                        <label for="customer-select" class="form-label fw-bold">å®¢æˆ¶</label>
                        <div class="row g-2">
                            <!-- å¸¸ç”¨å®¢æˆ¶ä¸‹æ‹‰é¸å–® -->
                            <div class="col-md-6">
                                <select id="customer-select" name="customer_id" class="form-select">
                                    <option value="">--- é¸æ“‡å¸¸ç”¨å®¢æˆ¶ ---</option>
                                </select>
                            </div>
                            <!-- æ‰‹å‹•è¼¸å…¥å®¢æˆ¶åç¨± -->
                            <div class="col-md-4">
                                <input type="text" id="customer-name-manual" name="customer_name_manual" class="form-control" placeholder="è¼¸å…¥å®¢æˆ¶åç¨±">
                            </div>
                            <!-- ç®¡ç†å¸¸ç”¨å®¢æˆ¶æŒ‰éˆ•çµ„ -->
                            <div class="col-md-2">
                                <div class="btn-group w-100">
                                    <button type="button" class="btn btn-outline-primary" id="add-to-frequent-btn" title="æ–°å¢åˆ°å¸¸ç”¨å®¢æˆ¶">
                                        <i class="bi bi-plus-circle"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="manage-customers-btn" title="ç®¡ç†å¸¸ç”¨å®¢æˆ¶" data-bs-toggle="modal" data-bs-target="#customersManageModal">
                                        <i class="bi bi-gear"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <small class="text-muted">æ‚¨å¯ä»¥å¾ä¸‹æ‹‰é¸å–®é¸æ“‡å¸¸ç”¨å®¢æˆ¶ï¼Œæˆ–ç›´æ¥è¼¸å…¥æ–°å®¢æˆ¶åç¨±</small>
                    </div>

                    <!-- 2. å‡ºè²¨åº«å­˜å¸³æˆ¶ -->
                    <div class="mb-3">
                        <label for="rmb-account-select" class="form-label fw-bold">RMB å‡ºè²¨å¸³æˆ¶</label>
                        <select id="rmb-account-select" name="rmb_account_id" class="form-select" required>
                            <option value="" disabled selected>--- è«‹é¸æ“‡å‡ºè²¨åº«å­˜ ---</option>
                            <!-- ã€æ ¸å¿ƒä¿®æ­£ã€‘ä½¿ç”¨å¾Œç«¯å‚³ä¾†çš„æ–°è³‡æ–™çµæ§‹ä¾†æ¸²æŸ“é¸é … -->
                            {% for group in owner_rmb_accounts_grouped %}
                            <optgroup label="{{ group.holder_name }}">
                                {% for account in group.accounts %}
                                <option value="{{ account.id }}">{{ account.name }} (åº«å­˜: {{ "%.2f"|format(account.balance) }})</option>
                                {% endfor %}
                            </optgroup>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- 3. é‡‘é¡èˆ‡åŒ¯ç‡ -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="rmb-amount" class="form-label fw-bold">å”®å‡ºé‡‘é¡ (RMB)</label>
                            <input type="text" id="rmb-amount" name="rmb_amount" class="form-control" pattern="[0-9]*\.?[0-9]*" placeholder="Â¥" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="exchange-rate" class="form-label fw-bold">å”®å‡ºåŒ¯ç‡</label>
                            <input type="text" id="exchange-rate" name="exchange_rate" class="form-control" pattern="[0-9]*\.?[0-9]*" placeholder="è«‹è¼¸å…¥åŒ¯ç‡" required>
                        </div>
                    </div>

                    <!-- 4. è‡ªå‹•è¨ˆç®—çš„æ‡‰æ”¶å°å¹£ -->
                    <div class="alert alert-info text-center py-3">
                        <h6 class="text-info-emphasis mb-1">æ‡‰æ”¶å¸³æ¬¾ (TWD)</h6>
                        <h2 id="twd-receivable-display" class="fw-bold mb-0">NT$ 0.00</h2>
                    </div>
                    
                    <!-- 5. åˆ©æ½¤é è¦½ -->
                    <div id="profit-preview-section" class="d-none">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>åˆ©æ½¤é è¦½</h6>
                            </div>
                            <div class="card-body p-3">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <small class="text-muted d-block">åº«å­˜æˆæœ¬</small>
                                        <span id="cost-display" class="fw-bold text-danger">NT$ 0.00</span>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted d-block">é ä¼°åˆ©æ½¤</small>
                                        <span id="profit-display" class="fw-bold text-success">NT$ 0.00</span>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted d-block">åˆ©æ½¤ç‡</small>
                                        <span id="margin-display" class="fw-bold text-primary">0.0%</span>
                                    </div>
                                </div>
                                <div id="cost-breakdown" class="mt-3">
                                    <small class="text-muted">æˆæœ¬åˆ†è§£ï¼š</small>
                                    <div id="breakdown-details" class="small"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 6. æäº¤æŒ‰éˆ• -->
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-plus-circle me-2"></i>ç¢ºèªå‰µå»ºè¨‚å–®
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- å³å´ï¼šå¾…æ”¶æ¬¾åˆ—è¡¨ -->
    <div class="col-lg-7">

        <div class="card shadow-sm">
            <div class="card-header bg-warning-subtle">
                <h4 class="mb-0 fw-light"><i class="bi bi-hourglass-split me-2"></i>è¿‘æœŸè¨‚å–®</h4>
            </div>
            <div class="card-body p-2">
                <div class="table-responsive">
                    <table class="table table-hover table-sm align-middle mb-0">
                        <thead>
                            <tr>
                                <th>å®¢æˆ¶</th>
                                <th>å”®å‡º (RMB)</th>
                                <th class="text-end">æ‡‰æ”¶ (TWD)</th>
                                <th class="text-end">é ä¼°åˆ©æ½¤ (TWD)</th>
                                <th>æ—¥æœŸ</th>
                                <th class="text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="pending-sales-table-body">
                            <!-- ã€æ ¸å¿ƒä¿®æ­£ã€‘ä½¿ç”¨æ–°çš„å¾Œç«¯è®Šæ•¸å’Œæ¬„ä½ -->
                            {% for sale in recent_unsettled_sales %}
                            <tr id="sale-row-{{ sale.id }}">
                                <td>{{ sale.customer.name }}</td>
                                <td class="text-success">Â¥ {{ "%.2f"|format(sale.rmb_amount) }}</td>
                                <td class="fw-bold text-end text-danger">NT$ {{ "%.2f"|format(sale.twd_amount) }}</td>
                                <td class="text-end">
                                    {% if sale.profit_info %}
                                        <span class="fw-bold {% if sale.profit_info.profit_twd >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            NT$ {{ "%.2f"|format(sale.profit_info.profit_twd) }}
                                        </span>
                                        <br><small class="text-muted">{{ "%.1f"|format(sale.profit_info.profit_margin) }}%</small>
                                    {% else %}
                                        <span class="text-muted">è¨ˆç®—ä¸­...</span>
                                    {% endif %}
                                </td>
                                <td><small>{{ sale.created_at.strftime('%Y-%m-%d') }}</small></td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-outline-danger cancel-sale-btn" 
                                            data-sale-id="{{ sale.id }}" 
                                            data-customer-name="{{ sale.customer.name }}" 
                                            data-rmb-amount="{{ sale.rmb_amount }}" 
                                            data-twd-amount="{{ sale.twd_amount }}" 
                                            title="å–æ¶ˆæ­¤ç­†éŠ·å”®è¨˜éŒ„">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center text-muted py-5">å¤ªæ£’äº†ï¼æ‰€æœ‰è¨‚å–®éƒ½å·²çµæ¸…ï¼</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- åˆ†é å°èˆª -->
                {% if pagination and pagination.pages > 1 %}
                <div class="card-footer bg-light">
                    <nav aria-label="è¨‚å–®åˆ†é å°èˆª">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-muted small">
                                ç¬¬ {{ (pagination.page - 1) * pagination.per_page + 1 }}-{{ pagination.page * pagination.per_page if pagination.page * pagination.per_page < pagination.total else pagination.total }} ç­†ï¼Œå…± {{ pagination.total }} ç­†è¨˜éŒ„
                            </div>
                            <ul class="pagination pagination-sm mb-0">
                                <!-- ä¸Šä¸€é  -->
                                {% if pagination.has_prev %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('sales_entry', page=pagination.prev_num) }}" aria-label="ä¸Šä¸€é ">
                                        <i class="bi bi-chevron-left"></i>
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">
                                        <i class="bi bi-chevron-left"></i>
                                    </span>
                                </li>
                                {% endif %}
                                
                                <!-- é ç¢¼ -->
                                {% for page_num in range(1, pagination.pages + 1) %}
                                    {% if page_num == pagination.page %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                    {% elif page_num <= 3 or page_num > pagination.pages - 3 or (page_num >= pagination.page - 1 and page_num <= pagination.page + 1) %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('sales_entry', page=page_num) }}">{{ page_num }}</a>
                                    </li>
                                    {% elif page_num == 4 and pagination.page > 6 %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                    {% elif page_num == pagination.pages - 3 and pagination.page < pagination.pages - 5 %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                    {% endif %}
                                {% endfor %}
                                
                                <!-- ä¸‹ä¸€é  -->
                                {% if pagination.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('sales_entry', page=pagination.next_num) }}" aria-label="ä¸‹ä¸€é ">
                                        <i class="bi bi-chevron-right"></i>
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">
                                        <i class="bi bi-chevron-right"></i>
                                    </span>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                    </nav>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- å…ƒç´ ç²å– ---
    const createOrderForm = document.getElementById('create-order-form');
    const customerSelect = document.getElementById('customer-select');
    const customerNameManual = document.getElementById('customer-name-manual');
    const addToFrequentBtn = document.getElementById('add-to-frequent-btn');
    const rmbAmountInput = document.getElementById('rmb-amount');
    const exchangeRateInput = document.getElementById('exchange-rate');
    const twdDisplay = document.getElementById('twd-receivable-display');
    
    // --- API ç«¯é» ---
    const FREQUENT_CUSTOMERS_API = "/api/frequent_customers";
    const ADD_CUSTOMER_API = "/api/add_customer";
    
    // --- å…¨å±€è®Šæ•¸ ---
    let customersData = [];
    
    // --- åˆå§‹åŒ– ---
    console.log('ğŸš€ sales_entry.html JavaScript å·²è¼‰å…¥');
    console.log('ğŸŒ APIç«¯é»:', FREQUENT_CUSTOMERS_API);
    loadFrequentCustomers();
    initializeNumberFormatting(); // åˆå§‹åŒ–æ•¸å­—è¼¸å…¥æ¬„ä½æ ¼å¼åŒ–
    
    // --- äº‹ä»¶ç›£è½å™¨ ---
    
    // 1. è¼‰å…¥å¸¸ç”¨å®¢æˆ¶åˆ—è¡¨
    async function loadFrequentCustomers() {
        try {
            console.log('ğŸ” é–‹å§‹è¼‰å…¥å¸¸ç”¨å®¢æˆ¶...', FREQUENT_CUSTOMERS_API);
            const response = await fetch(FREQUENT_CUSTOMERS_API);
            console.log('ğŸ“¡ APIå›æ‡‰ç‹€æ…‹:', response.status);
            
            const result = await response.json();
            console.log('ğŸ“Š APIå›æ‡‰æ•¸æ“š:', result);
            
            if (result.status === 'success') {
                customersData = result.customers;
                console.log('âœ… è¼‰å…¥å®¢æˆ¶æ•¸æ“šæˆåŠŸ:', customersData);
                refreshCustomersDropdown();
            } else {
                console.error('âŒ è¼‰å…¥å¸¸ç”¨å®¢æˆ¶å¤±æ•—:', result.message);
            }
        } catch (error) {
            console.error('âŒ è¼‰å…¥å¸¸ç”¨å®¢æˆ¶æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        }
    }
    
    // 2. åˆ·æ–°å®¢æˆ¶ä¸‹æ‹‰é¸å–®
    function refreshCustomersDropdown() {
        console.log('ğŸ”„ é–‹å§‹åˆ·æ–°å®¢æˆ¶ä¸‹æ‹‰é¸å–®...', customersData);
        customerSelect.innerHTML = '<option value="">--- é¸æ“‡å¸¸ç”¨å®¢æˆ¶ ---</option>';
        
        if (!customersData || customersData.length === 0) {
            console.log('âš ï¸ æ²’æœ‰å®¢æˆ¶æ•¸æ“šå¯é¡¯ç¤º');
            return;
        }
        
        customersData.forEach(customer => {
            const option = document.createElement('option');
            option.value = customer.id;
            option.textContent = customer.name;
            customerSelect.appendChild(option);
            console.log('â• æ·»åŠ å®¢æˆ¶é¸é …:', customer.name);
        });
        
        console.log('âœ… å®¢æˆ¶ä¸‹æ‹‰é¸å–®åˆ·æ–°å®Œæˆ');
    }
    

    // 3. å®¢æˆ¶é¸æ“‡è®Šæ›´äº‹ä»¶
    customerSelect.addEventListener('change', function() {
        if (this.value) {
            // ç•¶é¸æ“‡ä¸‹æ‹‰åˆ—è¡¨æ™‚ï¼Œè‡ªå‹•å¡«å¯«å®¢æˆ¶åç¨±
            const selectedCustomer = customersData.find(c => c.id == this.value);
            if (selectedCustomer) {
                customerNameManual.value = selectedCustomer.name;
                customerNameManual.disabled = true;
            }
        } else {
            // ç•¶æ¸…ç©ºé¸æ“‡æ™‚ï¼Œå•Ÿç”¨æ‰‹å‹•è¼¸å…¥
            customerNameManual.value = '';
            customerNameManual.disabled = false;
        }
    });
    
    // 4. æ‰‹å‹•è¼¸å…¥å®¢æˆ¶åç¨±äº‹ä»¶
    customerNameManual.addEventListener('input', function() {
        if (this.value) {
            // ç•¶æ‰‹å‹•è¼¸å…¥æ™‚ï¼Œæ¸…ç©ºä¸‹æ‹‰åˆ—è¡¨é¸æ“‡
            customerSelect.value = '';
        }
    });
    
    // 5. æ–°å¢åˆ°å¸¸ç”¨å®¢æˆ¶æŒ‰éˆ•äº‹ä»¶
    addToFrequentBtn.addEventListener('click', async function() {
        const customerName = customerNameManual.value.trim();
        
        if (!customerName) {
            Swal.fire('éŒ¯èª¤', 'è«‹å…ˆè¼¸å…¥å®¢æˆ¶åç¨±ã€‚', 'error');
            return;
        }
        
        try {
            // ä½¿ç”¨èˆ‡è²·å…¥é é¢ç›¸åŒçš„é‚è¼¯
            const response = await fetch('/api/customer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: customerName })
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                console.log('âœ… æ–°å¢å®¢æˆ¶æˆåŠŸ:', result);
                
                Swal.fire('æˆåŠŸ', 'å®¢æˆ¶å·²æ–°å¢åˆ°å¸¸ç”¨åˆ—è¡¨ï¼', 'success');
                
                // æ¸…ç©ºè¼¸å…¥æ¬„ä½
                customerNameManual.value = '';
                customerSelect.value = '';
                customerNameManual.disabled = false;
                
                // é‡æ–°è¼‰å…¥å®¢æˆ¶åˆ—è¡¨
                await loadFrequentCustomers();
                
            } else {
                console.error('âŒ æ–°å¢å®¢æˆ¶å¤±æ•—:', result);
                Swal.fire('éŒ¯èª¤', result.message, 'error');
            }
        } catch (error) {
            Swal.fire('éŒ¯èª¤', 'æ–°å¢å®¢æˆ¶æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            console.error('æ–°å¢å®¢æˆ¶éŒ¯èª¤:', error);
        }
    });
    
    // 6. å‹•æ…‹è¨ˆç®—æ‡‰æ”¶å°å¹£ï¼ˆç„¡æ¢ä»¶é€²ä½åˆ°æ•´æ•¸ï¼‰
    function calculateReceivable() {
        // ç›´æ¥ä½¿ç”¨åŸå§‹è¼¸å…¥å€¼é€²è¡Œè¨ˆç®—ï¼Œé¿å…æ ¼å¼åŒ–å•é¡Œ
        const rate = parseFloat(exchangeRateInput.value) || 0;
        const rmb = parseFloat(rmbAmountInput.value) || 0;
        const twd = rate * rmb;
        
        // ä½¿ç”¨ç„¡æ¢ä»¶é€²ä½ï¼Œä¸é¡¯ç¤ºå°æ•¸é»
        twdDisplay.textContent = formatIntegerCurrency(twd);
        
        // å¦‚æœé‡‘é¡å’ŒåŒ¯ç‡éƒ½æœ‰æ•ˆï¼Œè¨ˆç®—åˆ©æ½¤é è¦½
        if (rate > 0 && rmb > 0) {
            calculateProfitPreview(rmb, rate);
        } else {
            hideProfitPreview();
        }
    }
    rmbAmountInput.addEventListener('input', calculateReceivable);
    exchangeRateInput.addEventListener('input', calculateReceivable);
    calculateReceivable(); // é é¢è¼‰å…¥æ™‚å…ˆè¨ˆç®—ä¸€æ¬¡
    
    // 7. åˆ©æ½¤é è¦½è¨ˆç®—
    async function calculateProfitPreview(rmbAmount, exchangeRate) {
        try {
            // æ·»åŠ èª¿è©¦ä¿¡æ¯
            console.log('ğŸ” è¨ˆç®—åˆ©æ½¤é è¦½:', { rmbAmount, exchangeRate });
            
            const response = await fetch('/api/calculate_profit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    rmb_amount: rmbAmount,
                    exchange_rate: exchangeRate
                })
            });
            
            const result = await response.json();
            console.log('ğŸ“Š åˆ©æ½¤è¨ˆç®—APIå›æ‡‰:', result);
            
            if (result.status === 'success') {
                showProfitPreview(result.data);
            } else {
                hideProfitPreview();
                if (result.message.includes('åº«å­˜ä¸è¶³')) {
                    // é¡¯ç¤ºåº«å­˜ä¸è¶³çš„æç¤º
                    document.getElementById('profit-preview-section').classList.remove('d-none');
                    document.getElementById('profit-preview-section').querySelector('.card').classList.remove('border-success');
                    document.getElementById('profit-preview-section').querySelector('.card').classList.add('border-warning');
                    document.getElementById('profit-preview-section').querySelector('.card-header').classList.remove('bg-success', 'text-white');
                    document.getElementById('profit-preview-section').querySelector('.card-header').classList.add('bg-warning', 'text-dark');
                    document.getElementById('profit-preview-section').querySelector('.card-header h6').innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>åº«å­˜ä¸è¶³';
                    document.getElementById('profit-preview-section').querySelector('.card-body').innerHTML = '<div class="text-center text-warning"><i class="bi bi-boxes display-6"></i><p class="mt-2">ç•¶å‰åº«å­˜ç„¡æ³•æ»¿è¶³æ­¤ç­†å”®å‡º</p></div>';
                }
            }
        } catch (error) {
            console.error('è¨ˆç®—åˆ©æ½¤é è¦½æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            hideProfitPreview();
        }
    }
    
    // 8. é¡¯ç¤ºåˆ©æ½¤é è¦½
    function showProfitPreview(data) {
        const profitSection = document.getElementById('profit-preview-section');
        const costDisplay = document.getElementById('cost-display');
        const profitDisplay = document.getElementById('profit-display');
        const marginDisplay = document.getElementById('margin-display');
        const breakdownDetails = document.getElementById('breakdown-details');
        
        // æ›´æ–°æ•¸å€¼é¡¯ç¤º
        costDisplay.textContent = `NT$ ${data.total_cost_twd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        profitDisplay.textContent = `NT$ ${data.profit_twd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        marginDisplay.textContent = `${data.profit_margin.toFixed(1)}%`;
        
        // æ›´æ–°æˆæœ¬åˆ†è§£
        let breakdownHtml = '';
        data.cost_breakdown.forEach(item => {
            breakdownHtml += `
                <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                    <span class="text-muted">${item.purchase_date} (${item.channel})</span>
                    <span class="fw-bold">Â¥${item.rmb_amount.toFixed(2)} Ã— NT$${item.unit_cost_twd.toFixed(4)} = NT$${item.batch_cost_twd.toFixed(2)}</span>
                </div>
            `;
        });
        breakdownDetails.innerHTML = breakdownHtml;
        
        // é¡¯ç¤ºåˆ©æ½¤é è¦½å€åŸŸ
        profitSection.classList.remove('d-none');
        
        // æ ¹æ“šåˆ©æ½¤è¨­ç½®é¡è‰²
        const card = profitSection.querySelector('.card');
        const header = profitSection.querySelector('.card-header');
        
        if (data.profit_twd >= 0) {
            card.classList.remove('border-warning', 'border-danger');
            card.classList.add('border-success');
            header.classList.remove('bg-warning', 'bg-danger', 'text-dark');
            header.classList.add('bg-success', 'text-white');
        } else {
            card.classList.remove('border-success', 'border-warning');
            card.classList.add('border-danger');
            header.classList.remove('bg-success', 'bg-warning', 'text-white');
            header.classList.add('bg-danger', 'text-white');
        }
    }
    
    // 9. éš±è—åˆ©æ½¤é è¦½
    function hideProfitPreview() {
        document.getElementById('profit-preview-section').classList.add('d-none');
    }

    // ===================================================================
    // å–æ¶ˆéŠ·å”®è¨˜éŒ„åŠŸèƒ½
    // ===================================================================
    
    // å–æ¶ˆéŠ·å”®è¨˜éŒ„å‡½æ•¸
    window.cancelSalesRecord = function(recordId, customerName, rmbAmount, twdAmount) {
        // ç¢ºä¿æ•¸å€¼é¡å‹æ­£ç¢º
        const rmb = parseFloat(rmbAmount) || 0;
        const twd = parseFloat(twdAmount) || 0;
        
        Swal.fire({
            title: 'ç¢ºèªå–æ¶ˆéŠ·å”®è¨˜éŒ„',
            html: `
                <div class="text-start">
                    <p><strong>å®¢æˆ¶:</strong> ${customerName}</p>
                    <p><strong>å”®å‡ºé‡‘é¡:</strong> Â¥${rmb.toFixed(2)}</p>
                    <p><strong>æ‡‰æ”¶å¸³æ¬¾:</strong> NT$${twd.toFixed(2)}</p>
                    <p class="text-danger"><strong>âš ï¸ è­¦å‘Š:</strong> æ­¤æ“ä½œå°‡ï¼š</p>
                    <ul class="text-start text-danger">
                        <li>å®Œå…¨åˆªé™¤æ­¤ç­†éŠ·å”®è¨˜éŒ„</li>
                        <li>å›æ»¾FIFOåº«å­˜åˆ†é…</li>
                        <li>æ¢å¾©åº«å­˜æ•¸é‡</li>
                        <li>æ­¤æ“ä½œä¸å¯é€†è½‰ï¼</li>
                    </ul>
                </div>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'ç¢ºå®šå–æ¶ˆè¨˜éŒ„',
            cancelButtonText: 'ä¿ç•™è¨˜éŒ„',
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            width: '500px'
        }).then((result) => {
            if (result.isConfirmed) {
                executeCancelSales(recordId);
            }
        });
    };
    
    // åŸ·è¡Œå–æ¶ˆéŠ·å”®è¨˜éŒ„
    async function executeCancelSales(recordId) {
        try {
            const response = await fetch(`/api/user-reverse-sale/${recordId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                // ç™¼é€è‡ªå®šç¾©äº‹ä»¶ï¼Œé€šçŸ¥å…¶ä»–é é¢æ›´æ–°æ•¸æ“š
                window.dispatchEvent(new CustomEvent('salesDataChanged', {
                    detail: { action: 'cancel_sale', recordId: recordId }
                }));
                
                Swal.fire({
                    icon: 'success',
                    title: 'å–æ¶ˆæˆåŠŸ',
                    text: result.message,
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    // é‡æ–°è¼‰å…¥é é¢ä»¥æ›´æ–°æ•¸æ“š
                    window.location.reload();
                });
            } else {
                Swal.fire('å–æ¶ˆå¤±æ•—', result.message, 'error');
            }
        } catch (error) {
            console.error('å–æ¶ˆéŠ·å”®è¨˜éŒ„å¤±æ•—:', error);
            Swal.fire('å–æ¶ˆå¤±æ•—', 'ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        }
    }
    
    // é‡ç½®è¡¨å–®å‡½æ•¸ï¼ˆç”¨æ–¼æ¸…ç©ºè¼¸å…¥ï¼‰
    function resetForm() {
        // é‡ç½®æ‰€æœ‰è¼¸å…¥æ¬„ä½
        document.getElementById('customer-select').value = '';
        document.getElementById('customer-name-manual').value = '';
        document.getElementById('rmb-account-select').value = '';
        document.getElementById('rmb-amount').value = '';
        document.getElementById('exchange-rate').value = ''; // æ¸…ç©ºåŒ¯ç‡
        
        // é‡ç½®é¡¯ç¤º
        document.getElementById('twd-receivable-display').textContent = 'NT$ 0.00';
        
        // éš±è—åˆ©æ½¤é è¦½
        hideProfitPreview();
        
        // é‡ç½®è¡¨å–®é©—è­‰ç‹€æ…‹
        createOrderForm.classList.remove('was-validated');
        
        // æ¸…é™¤æ‰€æœ‰éŒ¯èª¤æç¤º
        const invalidFeedback = document.querySelectorAll('.invalid-feedback');
        invalidFeedback.forEach(feedback => feedback.style.display = 'none');
        
        // é‡ç½®è¼¸å…¥æ¡†æ¨£å¼
        const inputs = document.querySelectorAll('.form-control, .form-select');
        inputs.forEach(input => {
            input.classList.remove('is-valid', 'is-invalid');
        });
        
        console.log('âœ… éŠ·å”®éŒ„å…¥è¡¨å–®å·²é‡ç½®');
    }
    
    // 10. è™•ç†ã€Œå‰µå»ºè¨‚å–®ã€è¡¨å–®æäº¤
    createOrderForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(createOrderForm);
        const customerId = formData.get('customer_id');
        const customerNameManual = formData.get('customer_name_manual');
        
        // é©—è­‰å®¢æˆ¶ä¿¡æ¯
        if (!customerId && !customerNameManual) {
            Swal.fire('è³‡æ–™ä¸å®Œæ•´', 'è«‹é¸æ“‡å¸¸ç”¨å®¢æˆ¶æˆ–è¼¸å…¥å®¢æˆ¶åç¨±ã€‚', 'warning');
            return;
        }
        
        const dataToSend = {
            customer_id: customerId || null,
            customer_name_manual: customerNameManual || null,
            rmb_account_id: formData.get('rmb_account_id'),
            rmb_amount: formData.get('rmb_amount'),
            exchange_rate: formData.get('exchange_rate')
        };
        
        if (!dataToSend.rmb_account_id) {
            Swal.fire('è³‡æ–™ä¸å®Œæ•´', 'è«‹é¸æ“‡RMBå‡ºè²¨å¸³æˆ¶ã€‚', 'warning');
            return;
        }

        // æ·»åŠ äºŒæ¬¡ç¢ºèªå½ˆçª—
        const confirmResult = await Swal.fire({
            title: 'ç¢ºèªå‰µå»ºè¨‚å–®',
            text: `ç¢ºå®šè¦ç‚ºå®¢æˆ¶ã€Œ${customerNameManual || (customerId ? customersData.find(c => c.id == customerId)?.name : 'æœªçŸ¥')}ã€å‰µå»ºè¨‚å–®å—ï¼Ÿ`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'æ˜¯çš„ï¼Œå‰µå»ºè¨‚å–®',
            cancelButtonText: 'å–æ¶ˆ',
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33'
        });

        if (!confirmResult.isConfirmed) {
            return; // ç”¨æˆ¶å–æ¶ˆæ“ä½œ
        }

        try {
            const response = await fetch("{{ url_for('api_sales_entry') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataToSend)
            });
            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.message || 'ä¼ºæœå™¨ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤');
            }

            await Swal.fire({
                icon: 'success',
                title: 'è¨‚å–®å‰µå»ºæˆåŠŸï¼',
                text: result.message,
                timer: 2500,
                showConfirmButton: false
            });
            window.location.reload();
            
            // é€šçŸ¥FIFOåº«å­˜é é¢æ›´æ–°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (window.opener && window.opener.postMessage) {
                window.opener.postMessage({ type: 'inventory_updated' }, '*');
            }

        } catch (error) {
            Swal.fire('å‰µå»ºå¤±æ•—', error.message, 'error');
        }
    });
    
    // ç®¡ç†å¸¸ç”¨å®¢æˆ¶æŒ‰éˆ•äº‹ä»¶
    document.getElementById('manage-customers-btn').addEventListener('click', function() {
        loadCustomersManagement();
    });

    // è¼‰å…¥å®¢æˆ¶ç®¡ç†æ•¸æ“š
    function loadCustomersManagement() {
        fetch('/api/customers/manage')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    displayCustomersManagement(data.customers);
                } else {
                    console.error('è¼‰å…¥å®¢æˆ¶ç®¡ç†æ•¸æ“šå¤±æ•—:', data.message);
                    Swal.fire('éŒ¯èª¤', 'è¼‰å…¥å®¢æˆ¶æ•¸æ“šå¤±æ•—: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('ç¶²è·¯éŒ¯èª¤:', error);
                Swal.fire('éŒ¯èª¤', 'ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            });
    }

    // é¡¯ç¤ºå®¢æˆ¶ç®¡ç†æ•¸æ“š
    function displayCustomersManagement(customers) {
        const tableBody = document.getElementById('customersManageTable');
        const emptyState = document.getElementById('customersManageEmpty');
        
        if (!customers || customers.length === 0) {
            if (tableBody) {
                tableBody.innerHTML = '';
            }
            if (emptyState) {
                emptyState.style.display = 'block';
            }
            return;
        }
        
        if (emptyState) {
            emptyState.style.display = 'none';
        }
        
        if (tableBody) {
            let html = '';
            customers.forEach(function(customer) {
                const customerNumber = `#${String(customer.id).padStart(3, '0')}`;
                const statusBadge = customer.is_active 
                    ? '<span class="badge bg-success">æ´»èº</span>'
                    : '<span class="badge bg-secondary">å·²åœç”¨</span>';
                
                html += `
                    <tr>
                        <td>${customer.name}</td>
                        <td>${customerNumber}</td>
                        <td>${statusBadge}</td>
                        <td class="text-center">
                            ${customer.is_active ? 
                                `<button class="btn btn-danger btn-sm delete-customer-btn" 
                                    data-customer-id="${customer.id}" 
                                    data-customer-name="${customer.name}"
                                    title="åˆªé™¤å®¢æˆ¶">
                                    <i class="bi bi-trash"></i> åˆªé™¤
                                </button>` : 
                                `<button class="btn btn-success btn-sm restore-customer-btn" 
                                    data-customer-id="${customer.id}" 
                                    data-customer-name="${customer.name}"
                                    title="æ¢å¾©å®¢æˆ¶">
                                    <i class="bi bi-arrow-clockwise"></i> æ¢å¾©
                                </button>`
                            }
                        </td>
                    </tr>
                `;
            });
            tableBody.innerHTML = html;
        }
    }

    // åˆªé™¤å®¢æˆ¶åŠŸèƒ½
    function deleteCustomer(customerId, customerName) {
        Swal.fire({
            title: 'ç¢ºèªåˆªé™¤',
            text: `ç¢ºå®šè¦åˆªé™¤å®¢æˆ¶ã€Œ${customerName}ã€å—ï¼Ÿé€™å°‡æœƒå°‡å®¢æˆ¶è¨­ç‚ºåœç”¨ç‹€æ…‹ã€‚`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'ç¢ºå®šåˆªé™¤',
            cancelButtonText: 'å–æ¶ˆ'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/api/customers/${customerId}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        Swal.fire('æˆåŠŸ', data.message, 'success');
                        loadCustomersManagement(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
                        loadCustomersDropdown(); // æ›´æ–°ä¸‹æ‹‰é¸å–®
                    } else {
                        Swal.fire('éŒ¯èª¤', data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('åˆªé™¤å®¢æˆ¶å¤±æ•—:', error);
                    Swal.fire('éŒ¯èª¤', 'ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                });
            }
        });
    }

    // æ¢å¾©å®¢æˆ¶åŠŸèƒ½
    function restoreCustomer(customerId, customerName) {
        fetch(`/api/customers/${customerId}/restore`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                Swal.fire('æˆåŠŸ', data.message, 'success');
                loadCustomersManagement(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
                loadCustomersDropdown(); // æ›´æ–°ä¸‹æ‹‰é¸å–®
            } else {
                Swal.fire('éŒ¯èª¤', data.message, 'error');
            }
        })
        .catch(error => {
            console.error('æ¢å¾©å®¢æˆ¶å¤±æ•—:', error);
            Swal.fire('éŒ¯èª¤', 'ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        });
    }

    // ç‚ºå®¢æˆ¶ç®¡ç†è¡¨æ ¼æ·»åŠ äº‹ä»¶å§”è¨—
    document.addEventListener('click', function(e) {
        if (e.target.closest('.delete-customer-btn')) {
            const btn = e.target.closest('.delete-customer-btn');
            const customerId = btn.dataset.customerId;
            const customerName = btn.dataset.customerName;
            deleteCustomer(customerId, customerName);
        } else if (e.target.closest('.restore-customer-btn')) {
            const btn = e.target.closest('.restore-customer-btn');
            const customerId = btn.dataset.customerId;
            const customerName = btn.dataset.customerName;
            restoreCustomer(customerId, customerName);
        }
    });

    // å–æ¶ˆéŠ·å”®è¨˜éŒ„äº‹ä»¶ç›£è½å™¨
    document.addEventListener('click', function(e) {
        if (e.target.closest('.cancel-sale-btn')) {
            const btn = e.target.closest('.cancel-sale-btn');
            const saleId = btn.dataset.saleId;
            const customerName = btn.dataset.customerName;
            const rmbAmount = btn.dataset.rmbAmount;
            const twdAmount = btn.dataset.twdAmount;
            
            cancelSalesRecord(saleId, customerName, rmbAmount, twdAmount);
        }
    });

    // --- æ•¸å­—æ ¼å¼åŒ–å·¥å…·å‡½æ•¸ ---
    
    // ç„¡æ¢ä»¶é€²ä½åˆ°æ•´æ•¸ï¼Œä¸é¡¯ç¤ºå°æ•¸é»
    function roundUpToInteger(value) {
        if (isNaN(value) || value === null || value === undefined) return 0;
        return Math.ceil(parseFloat(value));
    }
    
    // æ ¼å¼åŒ–æ•¸å­—é¡¯ç¤ºï¼Œç„¡æ¢ä»¶é€²ä½åˆ°æ•´æ•¸
    function formatIntegerCurrency(value, currency = 'NT$') {
        const roundedValue = roundUpToInteger(value);
        return `${currency} ${roundedValue.toLocaleString('en-US')}`;
    }
    
    // åˆå§‹åŒ–æ•¸å­—è¼¸å…¥æ¬„ä½çš„æ ¼å¼åŒ–
    function initializeNumberFormatting() {
        // ç‚ºå”®å‡ºé‡‘é¡å’ŒåŒ¯ç‡æ¬„ä½è¨­ç½®æ ¼å¼åŒ–
        setupNumberInputFormatting(rmbAmountInput, { maxDecimals: 2 });
        setupNumberInputFormatting(exchangeRateInput, { maxDecimals: 4 });
        
        console.log('âœ… æ•¸å­—è¼¸å…¥æ¬„ä½æ ¼å¼åŒ–å·²åˆå§‹åŒ–');
    }
});
</script>

<!-- ç®¡ç†å¸¸ç”¨å®¢æˆ¶æ¨¡æ…‹æ¡† -->
<div class="modal fade" id="customersManageModal" tabindex="-1" aria-labelledby="customersManageTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customersManageTitle">
                    <i class="bi bi-people me-2"></i>ç®¡ç†å¸¸ç”¨å®¢æˆ¶
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é—œé–‰"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>å®¢æˆ¶åç¨±</th>
                                <th>å®¢æˆ¶ç·¨è™Ÿ</th>
                                <th>ç‹€æ…‹</th>
                                <th class="text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="customersManageTable">
                            <!-- JavaScript å°‡å‹•æ…‹å¡«å……é€™è£¡ -->
                        </tbody>
                    </table>
                </div>
                
                <div id="customersManageEmpty" class="text-center p-4 text-muted" style="display: none;">
                    <i class="bi bi-inbox display-6"></i>
                    <p class="mt-2">å°šç„¡å¸¸ç”¨å®¢æˆ¶</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}