{% extends "base.html" %}

{% block title %}售出錄入與管理{% endblock %}

{% block content %}
<div class="container-fluid pt-3">
    <div class="row">
        <!-- 左側：操作面板 -->
        <div class="col-lg-5">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0 fw-light"><i class="bi bi-pencil-square me-2"></i>創建新訂單</h4>
                </div>
                <div class="card-body p-4">
                    <!-- 表單：用於創建訂單 -->
                    <form id="create-order-form">
                        
                        <!-- 1. 客戶選擇 -->
                        <div class="mb-3">
                            <label for="customer-select" class="form-label fw-bold">客戶</label>
                            <div class="input-group">
                                <select id="customer-select" name="holder_id" class="form-select" required>
                                    <option value="" disabled selected>--- 請選擇客戶 ---</option>
                                    {% for customer in customers %}
                                    <option value="{{ customer.id }}">{{ customer.name }}</option>
                                    {% endfor %}
                                </select>
                                <button class="btn btn-outline-danger" type="button" id="delete-customer-btn" title="刪除常用客戶">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>

                        <!-- 2. 出貨庫存帳戶 -->
                        <div class="mb-3">
                            <label for="rmb-account-select" class="form-label fw-bold">RMB 出貨帳戶</label>
                            <select id="rmb-account-select" name="rmb_account_id" class="form-select" required>
                                <option value="" disabled selected>--- 請選擇出貨庫存 ---</option>
                                {% for account in rmb_accounts %}
                                <option value="{{ account.id }}">{{ account.name }} (庫存: {{ "%.2f"|format(account.balance) }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- 3. 金額與匯率 -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="rmb-amount" class="form-label fw-bold">售出金額 (RMB)</label>
                                <input type="number" id="rmb-amount" name="rmb_amount" class="form-control" step="0.01" placeholder="¥" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="exchange-rate" class="form-label fw-bold">售出匯率</label>
                                <input type="number" id="exchange-rate" name="exchange_rate" class="form-control" step="0.0001" value="{{ sell_rate | default(4.5, true) }}" required>
                            </div>
                        </div>

                        <!-- 4. 自動計算的應收台幣 -->
                        <div class="alert alert-info text-center py-3">
                            <h6 class="text-info-emphasis mb-1">應收帳款 (TWD)</h6>
                            <h2 id="twd-receivable-display" class="fw-bold mb-0">NT$ 0.00</h2>
                        </div>
                        
                        <!-- 5. 提交按鈕 -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-plus-circle me-2"></i>確認創建訂單
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- 新增客戶面板 -->
            <div class="card shadow-sm">
                 <div class="card-header">
                    <h5 class="mb-0 fw-light"><i class="bi bi-person-plus me-2"></i>新增常用客戶</h5>
                </div>
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" id="new-customer-name-input" class="form-control" placeholder="輸入新客戶的名稱">
                        <button class="btn btn-outline-success" type="button" id="add-customer-btn">
                            <i class="bi bi-check-lg"></i> 新增
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右側：待收款列表 -->
        <div class="col-lg-7">
            <div class="card shadow-sm">
                <div class="card-header bg-warning-subtle">
                    <h4 class="mb-0 fw-light"><i class="bi bi-hourglass-split me-2"></i>待收款訂單列表</h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>客戶</th>
                                    <th>售出 (RMB)</th>
                                    <th>應收 (TWD)</th>
                                    <th>狀態</th>
                                    <th>日期</th>
                                    <!-- 刪除訂單功能暫時移除，應改為"取消訂單"或"作廢"，直接刪除會影響帳務 -->
                                </tr>
                            </thead>
                            <tbody id="pending-sales-table-body">
                                {% for sale in pending_sales %}
                                <tr id="sale-row-{{ sale.id }}">
                                    <td>{{ sale.customer.name }}</td>
                                    <td>¥ {{ "%.2f"|format(sale.rmb_amount) }}</td>
                                    <td class="fw-bold">NT$ {{ "%.2f"|format(sale.due_amount_twd) }}</td>
                                    <td><span class="badge bg-danger">{{ sale.status }}</span></td>
                                    <td>{{ sale.created_at.strftime('%Y-%m-%d') }}</td>
                                </tr>
                                {% endfor %}
                                {% if not pending_sales %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">目前沒有待收款的訂單。</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- 全局工具 ---
    const Toast = Swal.mixin({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true
    });

    // --- 元素獲取 ---
    const createOrderForm = document.getElementById('create-order-form');
    const rmbAmountInput = document.getElementById('rmb-amount');
    const exchangeRateInput = document.getElementById('exchange-rate');
    const twdDisplay = document.getElementById('twd-receivable-display');
    
    const addCustomerBtn = document.getElementById('add-customer-btn');
    const newCustomerNameInput = document.getElementById('new-customer-name-input');
    const customerSelect = document.getElementById('customer-select');
    const deleteCustomerBtn = document.getElementById('delete-customer-btn');

    const apiEndpoint = "{{ url_for('sales_operations_api') }}";

    // --- 核心 API 呼叫函式 ---
    async function callSalesApi(data) {
        try {
            const response = await fetch(apiEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.message || '伺服器發生錯誤');
            }
            
            return result;

        } catch (error) {
            // 捕獲網路錯誤或 JSON 解析錯誤
            console.error('API Call Error:', error);
            throw new Error(error.message || '無法連接到伺服器');
        }
    }

    // --- 事件監聽器 ---

    // 1. 動態計算應收台幣
    function calculateReceivable() {
        const rate = parseFloat(exchangeRateInput.value) || 0;
        const rmb = parseFloat(rmbAmountInput.value) || 0;
        const twd = rate * rmb;
        twdDisplay.textContent = `NT$ ${twd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }
    rmbAmountInput.addEventListener('input', calculateReceivable);
    exchangeRateInput.addEventListener('input', calculateReceivable);

    // 2. 處理「創建訂單」表單提交
    createOrderForm.addEventListener('submit', async function(e) {
        e.preventDefault(); // 阻止表單的傳統提交行為
        
        const formData = new FormData(createOrderForm);
        const dataToSend = {
            action: 'create_order',
            holder_id: formData.get('holder_id'),
            rmb_account_id: formData.get('rmb_account_id'),
            rmb_amount: formData.get('rmb_amount'),
            exchange_rate: formData.get('exchange_rate')
        };
        
        // 前端驗證
        if (!dataToSend.holder_id || !dataToSend.rmb_account_id) {
            Swal.fire('資料不完整', '請務必選擇「客戶」和「RMB出貨帳戶」。', 'warning');
            return;
        }

        try {
            const result = await callSalesApi(dataToSend);
            await Swal.fire({
                icon: 'success',
                title: '訂單創建成功！',
                text: result.message,
            });
            window.location.reload(); // 成功後刷新頁面
        } catch (error) {
            Swal.fire('創建失敗', error.message, 'error');
        }
    });

    // 3. 處理「新增客戶」
    addCustomerBtn.addEventListener('click', async function () {
        const newName = newCustomerNameInput.value.trim();
        if (!newName) {
            Swal.fire('錯誤', '請輸入要新增的客戶名稱。', 'warning');
            return;
        }

        try {
            const result = await callSalesApi({ action: 'add_customer', name: newName });
            Toast.fire({ icon: 'success', title: result.message });
            
            // 動態新增選項到下拉選單並選中它
            const newOption = new Option(result.customer.name, result.customer.id, true, true);
            customerSelect.appendChild(newOption);
            newCustomerNameInput.value = ''; // 清空輸入框

        } catch (error) {
            Swal.fire('新增失敗', error.message, 'error');
        }
    });

    // 4. 處理「刪除客戶」
    deleteCustomerBtn.addEventListener('click', async function () {
        const customerId = customerSelect.value;
        const selectedOption = customerSelect.options[customerSelect.selectedIndex];
        
        if (!customerId) {
            Swal.fire('提示', '請先從下拉選單中選擇要刪除的客戶。', 'info');
            return;
        }

        const confirmResult = await Swal.fire({
            title: `確定要刪除常用客戶 "${selectedOption.text}" 嗎?`,
            text: "只有在該客戶無任何欠款時才能刪除。",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '是的，刪除',
            cancelButtonText: '取消',
            confirmButtonColor: '#d33'
        });

        if (confirmResult.isConfirmed) {
            try {
                const result = await callSalesApi({ action: 'delete_customer', holder_id: customerId });
                Toast.fire({ icon: 'success', title: result.message });
                selectedOption.remove(); // 從下拉選單中移除
            } catch (error) {
                Swal.fire('刪除失敗', error.message, 'error');
            }
        }
    });
});
</script>
{% endblock %}