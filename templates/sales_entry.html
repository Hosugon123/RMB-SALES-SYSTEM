{% extends "base.html" %}

{% block title %}售出錄入與管理{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- 左側：操作面板 -->
    <div class="col-lg-5">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0 fw-light"><i class="bi bi-pencil-square me-2"></i>創建新訂單</h4>
            </div>
            <div class="card-body p-4">
                <form id="create-order-form">
                    <!-- 1. 客戶選擇 -->
                    <div class="mb-3">
                        <label for="customer-select" class="form-label fw-bold">客戶</label>
                        <div class="input-group">
                            <select id="customer-select" name="customer_id" class="form-select" required>
                                <option value="" disabled selected>--- 請選擇客戶 ---</option>
                                {% for customer in customers %}
                                <option value="{{ customer.id }}">{{ customer.name }}</option>
                                {% endfor %}
                            </select>
                            <button class="btn btn-outline-secondary" type="button" id="manage-customers-btn" title="管理常用客戶">
                                <i class="bi bi-people"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 2. 出貨庫存帳戶 -->
                    <div class="mb-3">
                        <label for="rmb-account-select" class="form-label fw-bold">RMB 出貨帳戶</label>
                        <select id="rmb-account-select" name="rmb_account_id" class="form-select" required>
                            <option value="" disabled selected>--- 請選擇出貨庫存 ---</option>
                            <!-- 【核心修正】使用後端傳來的新資料結構來渲染選項 -->
                            {% for group in owner_rmb_accounts_grouped %}
                            <optgroup label="{{ group.holder_name }}">
                                {% for account in group.accounts %}
                                <option value="{{ account.id }}">{{ account.name }} (庫存: {{ "%.2f"|format(account.balance) }})</option>
                                {% endfor %}
                            </optgroup>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- 3. 金額與匯率 -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="rmb-amount" class="form-label fw-bold">售出金額 (RMB)</label>
                            <input type="number" id="rmb-amount" name="rmb_amount" class="form-control" step="0.01" placeholder="¥" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="exchange-rate" class="form-label fw-bold">售出匯率</label>
                            <input type="number" id="exchange-rate" name="exchange_rate" class="form-control" step="0.0001" value="4.5" required>
                        </div>
                    </div>

                    <!-- 4. 自動計算的應收台幣 -->
                    <div class="alert alert-info text-center py-3">
                        <h6 class="text-info-emphasis mb-1">應收帳款 (TWD)</h6>
                        <h2 id="twd-receivable-display" class="fw-bold mb-0">NT$ 0.00</h2>
                    </div>
                    
                    <!-- 5. 提交按鈕 -->
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-plus-circle me-2"></i>確認創建訂單
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 右側：待收款列表 -->
    <div class="col-lg-7">
        <div class="card shadow-sm">
            <div class="card-header bg-warning-subtle">
                <h4 class="mb-0 fw-light"><i class="bi bi-hourglass-split me-2"></i>近期未結清訂單</h4>
            </div>
            <div class="card-body p-2">
                <div class="table-responsive">
                    <table class="table table-hover table-sm align-middle mb-0">
                        <thead>
                            <tr>
                                <th>客戶</th>
                                <th>售出 (RMB)</th>
                                <th class="text-end">應收 (TWD)</th>
                                <th>日期</th>
                            </tr>
                        </thead>
                        <tbody id="pending-sales-table-body">
                            <!-- 【核心修正】使用新的後端變數和欄位 -->
                            {% for sale in recent_unsettled_sales %}
                            <tr id="sale-row-{{ sale.id }}">
                                <td>{{ sale.customer.name }}</td>
                                <td class="text-success">¥ {{ "%.2f"|format(sale.rmb_amount) }}</td>
                                <td class="fw-bold text-end text-danger">NT$ {{ "%.2f"|format(sale.twd_amount) }}</td>
                                <td><small>{{ sale.created_at.strftime('%Y-%m-%d') }}</small></td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center text-muted py-5">太棒了！所有訂單都已結清！</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 我們將在下一步驟中，為客戶管理創建一個專屬的 Modal -->
{% endblock %}


{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- 元素獲取 ---
    const createOrderForm = document.getElementById('create-order-form');
    const rmbAmountInput = document.getElementById('rmb-amount');
    const exchangeRateInput = document.getElementById('exchange-rate');
    const twdDisplay = document.getElementById('twd-receivable-display');
    
    // --- API 端點 (我們稍後會在 app.py 中創建這些) ---
    const CREATE_ORDER_API = "#"; 
    
    // --- 事件監聽器 ---

    // 1. 動態計算應收台幣
    function calculateReceivable() {
        const rate = parseFloat(exchangeRateInput.value) || 0;
        const rmb = parseFloat(rmbAmountInput.value) || 0;
        const twd = rate * rmb;
        twdDisplay.textContent = `NT$ ${twd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }
    rmbAmountInput.addEventListener('input', calculateReceivable);
    exchangeRateInput.addEventListener('input', calculateReceivable);
    calculateReceivable(); // 頁面載入時先計算一次

    // 2. 處理「創建訂單」表單提交
    createOrderForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(createOrderForm);
        const dataToSend = {
            customer_id: formData.get('customer_id'),
            rmb_account_id: formData.get('rmb_account_id'),
            rmb_amount: formData.get('rmb_amount'),
            exchange_rate: formData.get('exchange_rate')
        };
        
        if (!dataToSend.customer_id || !dataToSend.rmb_account_id) {
            Swal.fire('資料不完整', '請務必選擇「客戶」和「RMB出貨帳戶」。', 'warning');
            return;
        }

        // API 呼叫邏輯暫時留空，等待後端 API 完成
        Swal.fire('功能開發中', '處理訂單創建的後端 API 尚未完成。', 'info');
    });
createOrderForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(createOrderForm);
    const dataToSend = {
        customer_id: formData.get('customer_id'),
        rmb_account_id: formData.get('rmb_account_id'),
        rmb_amount: formData.get('rmb_amount'),
        exchange_rate: formData.get('exchange_rate')
    };
    
    if (!dataToSend.customer_id || !dataToSend.rmb_account_id) {
        Swal.fire('資料不完整', '請務必選擇「客戶」和「RMB出貨帳戶」。', 'warning');
        return;
    }

    try {
        const response = await fetch("{{ url_for('api_sales_entry') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dataToSend)
        });
        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.message || '伺服器發生未知錯誤');
        }

        await Swal.fire({
            icon: 'success',
            title: '訂單創建成功！',
            text: result.message,
            timer: 2500,
            showConfirmButton: false
        });
        window.location.reload();

    } catch (error) {
        Swal.fire('創建失敗', error.message, 'error');
    }
});
});
</script>
{% endblock %}