{% extends "base.html" %}

{% block title %}售出錄入與管理{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- 左側：操作面板 -->
    <div class="col-lg-5">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0 fw-light"><i class="bi bi-pencil-square me-2"></i>創建新訂單</h4>
            </div>
            <div class="card-body p-4">
                <form id="create-order-form">
                    <!-- 1. 客戶選擇 -->
                    <div class="mb-3">
                        <label for="customer-select" class="form-label fw-bold">客戶</label>
                        <div class="row g-2">
                            <!-- 常用客戶下拉選單 -->
                            <div class="col-md-6">
                                <select id="customer-select" name="customer_id" class="form-select">
                                    <option value="">--- 選擇常用客戶 ---</option>
                                </select>
                            </div>
                            <!-- 手動輸入客戶名稱 -->
                            <div class="col-md-4">
                                <input type="text" id="customer-name-manual" name="customer_name_manual" class="form-control" placeholder="輸入客戶名稱">
                            </div>
                            <!-- 新增到常用客戶按鈕 -->
                            <div class="col-md-2">
                                <button type="button" class="btn btn-outline-primary" id="add-to-frequent-btn" title="新增到常用客戶">
                                    <i class="bi bi-plus-circle"></i>
                                </button>
                            </div>
                        </div>
                        <small class="text-muted">您可以從下拉選單選擇常用客戶，或直接輸入新客戶名稱</small>
                    </div>

                    <!-- 2. 出貨庫存帳戶 -->
                    <div class="mb-3">
                        <label for="rmb-account-select" class="form-label fw-bold">RMB 出貨帳戶</label>
                        <select id="rmb-account-select" name="rmb_account_id" class="form-select" required>
                            <option value="" disabled selected>--- 請選擇出貨庫存 ---</option>
                            <!-- 【核心修正】使用後端傳來的新資料結構來渲染選項 -->
                            {% for group in owner_rmb_accounts_grouped %}
                            <optgroup label="{{ group.holder_name }}">
                                {% for account in group.accounts %}
                                <option value="{{ account.id }}">{{ account.name }} (庫存: {{ "%.2f"|format(account.balance) }})</option>
                                {% endfor %}
                            </optgroup>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- 3. 金額與匯率 -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="rmb-amount" class="form-label fw-bold">售出金額 (RMB)</label>
                            <input type="number" id="rmb-amount" name="rmb_amount" class="form-control" step="0.01" placeholder="¥" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="exchange-rate" class="form-label fw-bold">售出匯率</label>
                            <input type="number" id="exchange-rate" name="exchange_rate" class="form-control" step="0.0001" value="4.5" required>
                        </div>
                    </div>

                    <!-- 4. 自動計算的應收台幣 -->
                    <div class="alert alert-info text-center py-3">
                        <h6 class="text-info-emphasis mb-1">應收帳款 (TWD)</h6>
                        <h2 id="twd-receivable-display" class="fw-bold mb-0">NT$ 0.00</h2>
                    </div>
                    
                    <!-- 5. 利潤預覽 -->
                    <div id="profit-preview-section" class="d-none">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>利潤預覽</h6>
                            </div>
                            <div class="card-body p-3">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <small class="text-muted d-block">庫存成本</small>
                                        <span id="cost-display" class="fw-bold text-danger">NT$ 0.00</span>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted d-block">預估利潤</small>
                                        <span id="profit-display" class="fw-bold text-success">NT$ 0.00</span>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted d-block">利潤率</small>
                                        <span id="margin-display" class="fw-bold text-primary">0.0%</span>
                                    </div>
                                </div>
                                <div id="cost-breakdown" class="mt-3">
                                    <small class="text-muted">成本分解：</small>
                                    <div id="breakdown-details" class="small"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 6. 提交按鈕 -->
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-plus-circle me-2"></i>確認創建訂單
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 右側：待收款列表 -->
    <div class="col-lg-7">
        <div class="card shadow-sm">
            <div class="card-header bg-warning-subtle">
                <h4 class="mb-0 fw-light"><i class="bi bi-hourglass-split me-2"></i>近期未結清訂單</h4>
            </div>
            <div class="card-body p-2">
                <div class="table-responsive">
                    <table class="table table-hover table-sm align-middle mb-0">
                        <thead>
                            <tr>
                                <th>客戶</th>
                                <th>售出 (RMB)</th>
                                <th class="text-end">應收 (TWD)</th>
                                <th class="text-end">預估利潤 (TWD)</th>
                                <th>日期</th>
                                <th class="text-center">操作</th>
                            </tr>
                        </thead>
                        <tbody id="pending-sales-table-body">
                            <!-- 【核心修正】使用新的後端變數和欄位 -->
                            {% for sale in recent_unsettled_sales %}
                            <tr id="sale-row-{{ sale.id }}">
                                <td>{{ sale.customer.name }}</td>
                                <td class="text-success">¥ {{ "%.2f"|format(sale.rmb_amount) }}</td>
                                <td class="fw-bold text-end text-danger">NT$ {{ "%.2f"|format(sale.twd_amount) }}</td>
                                <td class="text-end">
                                    {% if sale.profit_info %}
                                        <span class="fw-bold {% if sale.profit_info.profit_twd >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            NT$ {{ "%.2f"|format(sale.profit_info.profit_twd) }}
                                        </span>
                                        <br><small class="text-muted">{{ "%.1f"|format(sale.profit_info.profit_margin) }}%</small>
                                    {% else %}
                                        <span class="text-muted">計算中...</span>
                                    {% endif %}
                                </td>
                                <td><small>{{ sale.created_at.strftime('%Y-%m-%d') }}</small></td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-outline-danger cancel-sale-btn" 
                                            data-sale-id="{{ sale.id }}" 
                                            data-customer-name="{{ sale.customer.name }}" 
                                            data-rmb-amount="{{ sale.rmb_amount }}" 
                                            data-twd-amount="{{ sale.twd_amount }}" 
                                            title="取消此筆銷售記錄">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center text-muted py-5">太棒了！所有訂單都已結清！</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- 元素獲取 ---
    const createOrderForm = document.getElementById('create-order-form');
    const customerSelect = document.getElementById('customer-select');
    const customerNameManual = document.getElementById('customer-name-manual');
    const addToFrequentBtn = document.getElementById('add-to-frequent-btn');
    const rmbAmountInput = document.getElementById('rmb-amount');
    const exchangeRateInput = document.getElementById('exchange-rate');
    const twdDisplay = document.getElementById('twd-receivable-display');
    
    // --- API 端點 ---
    const FREQUENT_CUSTOMERS_API = "/api/frequent_customers";
    const ADD_CUSTOMER_API = "/api/add_customer";
    
    // --- 全局變數 ---
    let customersData = [];
    
    // --- 初始化 ---
    console.log('🚀 sales_entry.html JavaScript 已載入');
    console.log('🌐 API端點:', FREQUENT_CUSTOMERS_API);
    loadFrequentCustomers();
    
    // --- 事件監聽器 ---
    
    // 1. 載入常用客戶列表
    async function loadFrequentCustomers() {
        try {
            console.log('🔍 開始載入常用客戶...', FREQUENT_CUSTOMERS_API);
            const response = await fetch(FREQUENT_CUSTOMERS_API);
            console.log('📡 API回應狀態:', response.status);
            
            const result = await response.json();
            console.log('📊 API回應數據:', result);
            
            if (result.status === 'success') {
                customersData = result.customers;
                console.log('✅ 載入客戶數據成功:', customersData);
                refreshCustomersDropdown();
            } else {
                console.error('❌ 載入常用客戶失敗:', result.message);
            }
        } catch (error) {
            console.error('❌ 載入常用客戶時發生錯誤:', error);
        }
    }
    
    // 2. 刷新客戶下拉選單
    function refreshCustomersDropdown() {
        console.log('🔄 開始刷新客戶下拉選單...', customersData);
        customerSelect.innerHTML = '<option value="">--- 選擇常用客戶 ---</option>';
        
        if (!customersData || customersData.length === 0) {
            console.log('⚠️ 沒有客戶數據可顯示');
            return;
        }
        
        customersData.forEach(customer => {
            const option = document.createElement('option');
            option.value = customer.id;
            option.textContent = customer.name;
            customerSelect.appendChild(option);
            console.log('➕ 添加客戶選項:', customer.name);
        });
        
        console.log('✅ 客戶下拉選單刷新完成');
    }
    
    // 3. 客戶選擇變更事件
    customerSelect.addEventListener('change', function() {
        if (this.value) {
            // 當選擇下拉列表時，自動填寫客戶名稱
            const selectedCustomer = customersData.find(c => c.id == this.value);
            if (selectedCustomer) {
                customerNameManual.value = selectedCustomer.name;
                customerNameManual.disabled = true;
            }
        } else {
            // 當清空選擇時，啟用手動輸入
            customerNameManual.value = '';
            customerNameManual.disabled = false;
        }
    });
    
    // 4. 手動輸入客戶名稱事件
    customerNameManual.addEventListener('input', function() {
        if (this.value) {
            // 當手動輸入時，清空下拉列表選擇
            customerSelect.value = '';
        }
    });
    
    // 5. 新增到常用客戶按鈕事件
    addToFrequentBtn.addEventListener('click', async function() {
        const customerName = customerNameManual.value.trim();
        
        if (!customerName) {
            Swal.fire('錯誤', '請先輸入客戶名稱。', 'error');
            return;
        }
        
        try {
            // 使用與買入頁面相同的邏輯
            const response = await fetch('/api/customer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: customerName })
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                console.log('✅ 新增客戶成功:', result);
                
                Swal.fire('成功', '客戶已新增到常用列表！', 'success');
                
                // 清空輸入欄位
                customerNameManual.value = '';
                customerSelect.value = '';
                customerNameManual.disabled = false;
                
                // 重新載入客戶列表
                await loadFrequentCustomers();
                
            } else {
                console.error('❌ 新增客戶失敗:', result);
                Swal.fire('錯誤', result.message, 'error');
            }
        } catch (error) {
            Swal.fire('錯誤', '新增客戶時發生錯誤', 'error');
            console.error('新增客戶錯誤:', error);
        }
    });
    
    // 6. 動態計算應收台幣
    function calculateReceivable() {
        const rate = parseFloat(exchangeRateInput.value) || 0;
        const rmb = parseFloat(rmbAmountInput.value) || 0;
        const twd = rate * rmb;
        twdDisplay.textContent = `NT$ ${twd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        
        // 如果金額和匯率都有效，計算利潤預覽
        if (rate > 0 && rmb > 0) {
            calculateProfitPreview(rmb, rate);
        } else {
            hideProfitPreview();
        }
    }
    rmbAmountInput.addEventListener('input', calculateReceivable);
    exchangeRateInput.addEventListener('input', calculateReceivable);
    calculateReceivable(); // 頁面載入時先計算一次
    
    // 7. 利潤預覽計算
    async function calculateProfitPreview(rmbAmount, exchangeRate) {
        try {
            const response = await fetch('/api/calculate_profit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    rmb_amount: rmbAmount,
                    exchange_rate: exchangeRate
                })
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                showProfitPreview(result.data);
            } else {
                hideProfitPreview();
                if (result.message.includes('庫存不足')) {
                    // 顯示庫存不足的提示
                    document.getElementById('profit-preview-section').classList.remove('d-none');
                    document.getElementById('profit-preview-section').querySelector('.card').classList.remove('border-success');
                    document.getElementById('profit-preview-section').querySelector('.card').classList.add('border-warning');
                    document.getElementById('profit-preview-section').querySelector('.card-header').classList.remove('bg-success', 'text-white');
                    document.getElementById('profit-preview-section').querySelector('.card-header').classList.add('bg-warning', 'text-dark');
                    document.getElementById('profit-preview-section').querySelector('.card-header h6').innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>庫存不足';
                    document.getElementById('profit-preview-section').querySelector('.card-body').innerHTML = '<div class="text-center text-warning"><i class="bi bi-boxes display-6"></i><p class="mt-2">當前庫存無法滿足此筆售出</p></div>';
                }
            }
        } catch (error) {
            console.error('計算利潤預覽時發生錯誤:', error);
            hideProfitPreview();
        }
    }
    
    // 8. 顯示利潤預覽
    function showProfitPreview(data) {
        const profitSection = document.getElementById('profit-preview-section');
        const costDisplay = document.getElementById('cost-display');
        const profitDisplay = document.getElementById('profit-display');
        const marginDisplay = document.getElementById('margin-display');
        const breakdownDetails = document.getElementById('breakdown-details');
        
        // 更新數值顯示
        costDisplay.textContent = `NT$ ${data.total_cost_twd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        profitDisplay.textContent = `NT$ ${data.profit_twd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        marginDisplay.textContent = `${data.profit_margin.toFixed(1)}%`;
        
        // 更新成本分解
        let breakdownHtml = '';
        data.cost_breakdown.forEach(item => {
            breakdownHtml += `
                <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                    <span class="text-muted">${item.purchase_date} (${item.channel})</span>
                    <span class="fw-bold">¥${item.rmb_amount.toFixed(2)} × NT$${item.unit_cost_twd.toFixed(4)} = NT$${item.batch_cost_twd.toFixed(2)}</span>
                </div>
            `;
        });
        breakdownDetails.innerHTML = breakdownHtml;
        
        // 顯示利潤預覽區域
        profitSection.classList.remove('d-none');
        
        // 根據利潤設置顏色
        const card = profitSection.querySelector('.card');
        const header = profitSection.querySelector('.card-header');
        
        if (data.profit_twd >= 0) {
            card.classList.remove('border-warning', 'border-danger');
            card.classList.add('border-success');
            header.classList.remove('bg-warning', 'bg-danger', 'text-dark');
            header.classList.add('bg-success', 'text-white');
        } else {
            card.classList.remove('border-success', 'border-warning');
            card.classList.add('border-danger');
            header.classList.remove('bg-success', 'bg-warning', 'text-white');
            header.classList.add('bg-danger', 'text-white');
        }
    }
    
    // 9. 隱藏利潤預覽
    function hideProfitPreview() {
        document.getElementById('profit-preview-section').classList.add('d-none');
    }

    // ===================================================================
    // 取消銷售記錄功能
    // ===================================================================
    
    // 取消銷售記錄函數
    window.cancelSalesRecord = function(recordId, customerName, rmbAmount, twdAmount) {
        Swal.fire({
            title: '確認取消銷售記錄',
            html: `
                <div class="text-start">
                    <p><strong>客戶:</strong> ${customerName}</p>
                    <p><strong>售出金額:</strong> ¥${rmbAmount.toFixed(2)}</p>
                    <p><strong>應收帳款:</strong> NT$${twdAmount.toFixed(2)}</p>
                    <p class="text-danger"><strong>⚠️ 警告:</strong> 此操作將：</p>
                    <ul class="text-start text-danger">
                        <li>完全刪除此筆銷售記錄</li>
                        <li>回滾FIFO庫存分配</li>
                        <li>恢復庫存數量</li>
                        <li>此操作不可逆轉！</li>
                    </ul>
                </div>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '確定取消記錄',
            cancelButtonText: '保留記錄',
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            width: '500px'
        }).then((result) => {
            if (result.isConfirmed) {
                executeCancelSales(recordId);
            }
        });
    };
    
    // 執行取消銷售記錄
    async function executeCancelSales(recordId) {
        try {
            const response = await fetch(`/api/reverse-sale-allocation/${recordId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                // 發送自定義事件，通知其他頁面更新數據
                window.dispatchEvent(new CustomEvent('salesDataChanged', {
                    detail: { action: 'cancel_sale', recordId: recordId }
                }));
                
                Swal.fire({
                    icon: 'success',
                    title: '取消成功',
                    text: result.message,
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    // 重新載入頁面以更新數據
                    window.location.reload();
                });
            } else {
                Swal.fire('取消失敗', result.message, 'error');
            }
        } catch (error) {
            console.error('取消銷售記錄失敗:', error);
            Swal.fire('取消失敗', '網路錯誤，請稍後再試', 'error');
        }
    }
    
    // 重置表單函數（用於清空輸入）
    function resetForm() {
        // 重置所有輸入欄位
        document.getElementById('customer-select').value = '';
        document.getElementById('customer-name-manual').value = '';
        document.getElementById('rmb-account-select').value = '';
        document.getElementById('rmb-amount').value = '';
        document.getElementById('exchange-rate').value = '4.5'; // 恢復預設匯率
        
        // 重置顯示
        document.getElementById('twd-receivable-display').textContent = 'NT$ 0.00';
        
        // 隱藏利潤預覽
        hideProfitPreview();
        
        // 重置表單驗證狀態
        createOrderForm.classList.remove('was-validated');
        
        // 清除所有錯誤提示
        const invalidFeedback = document.querySelectorAll('.invalid-feedback');
        invalidFeedback.forEach(feedback => feedback.style.display = 'none');
        
        // 重置輸入框樣式
        const inputs = document.querySelectorAll('.form-control, .form-select');
        inputs.forEach(input => {
            input.classList.remove('is-valid', 'is-invalid');
        });
        
        console.log('✅ 銷售錄入表單已重置');
    }
    
    // 10. 處理「創建訂單」表單提交
    createOrderForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(createOrderForm);
        const customerId = formData.get('customer_id');
        const customerNameManual = formData.get('customer_name_manual');
        
        // 驗證客戶信息
        if (!customerId && !customerNameManual) {
            Swal.fire('資料不完整', '請選擇常用客戶或輸入客戶名稱。', 'warning');
            return;
        }
        
        const dataToSend = {
            customer_id: customerId || null,
            customer_name_manual: customerNameManual || null,
            rmb_account_id: formData.get('rmb_account_id'),
            rmb_amount: formData.get('rmb_amount'),
            exchange_rate: formData.get('exchange_rate')
        };
        
        if (!dataToSend.rmb_account_id) {
            Swal.fire('資料不完整', '請選擇RMB出貨帳戶。', 'warning');
            return;
        }

        try {
            const response = await fetch("{{ url_for('api_sales_entry') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataToSend)
            });
            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.message || '伺服器發生未知錯誤');
            }

            await Swal.fire({
                icon: 'success',
                title: '訂單創建成功！',
                text: result.message,
                timer: 2500,
                showConfirmButton: false
            });
            window.location.reload();
            
            // 通知FIFO庫存頁面更新（如果存在）
            if (window.opener && window.opener.postMessage) {
                window.opener.postMessage({ type: 'inventory_updated' }, '*');
            }

        } catch (error) {
            Swal.fire('創建失敗', error.message, 'error');
        }
    });
    
    // 取消銷售記錄事件監聽器
    document.addEventListener('click', function(e) {
        if (e.target.closest('.cancel-sale-btn')) {
            const btn = e.target.closest('.cancel-sale-btn');
            const saleId = btn.dataset.saleId;
            const customerName = btn.dataset.customerName;
            const rmbAmount = btn.dataset.rmbAmount;
            const twdAmount = btn.dataset.twdAmount;
            
            cancelSalesRecord(saleId, customerName, rmbAmount, twdAmount);
        }
    });
});
</script>
{% endblock %}