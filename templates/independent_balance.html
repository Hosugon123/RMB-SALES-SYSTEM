{% extends 'base.html' %}
{% block title %}儲值客戶與餘額{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12 col-xl-10 mx-auto">
            <!-- 頁面標題區 -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="mb-1 text-primary"><i class="bi bi-wallet2 me-2"></i>儲值客戶與餘額</h2>
                            <p class="text-muted mb-0">獨立儲值管理系統</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 主要功能區 -->
            <div class="row g-4">
                <!-- 左側：輸入與預覽區 -->
                <div class="col-12 col-lg-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-gradient bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-calculator me-2"></i>儲值換算</h5>
                        </div>
                        <div class="card-body">
                            <!-- 輸入區域 -->
                            <div class="row g-3 mb-4">
                                <div class="col-12 col-md-6">
                                    <label class="form-label fw-semibold">
                                        <i class="bi bi-currency-dollar me-1"></i>美金金額 (USD)
                                    </label>
                                    <input type="text" inputmode="decimal" class="form-control form-control-lg" id="usdAmount" placeholder="例如 1000">
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label fw-semibold">
                                        <i class="bi bi-arrow-left-right me-1"></i>匯率 (USD → RMB)
                                    </label>
                                    <input type="text" inputmode="decimal" class="form-control form-control-lg" id="usdToRmbRate" placeholder="例如 7.25">
                                </div>
                            </div>

                            <!-- 利潤入庫帳戶選擇 -->
                            <div class="row g-3 mb-3">
                                <div class="col-12">
                                    <label class="form-label fw-semibold">
                                        <i class="bi bi-cash-stack me-1"></i>利潤入庫帳戶（RMB）<span class="text-danger">*</span>
                                    </label>
                                    <select id="profitAccount" class="form-select form-select-lg" required>
                                        <option value="" selected>請選擇儲值利潤入庫帳戶</option>
                                        {% for acc in rmb_accounts %}
                                        <option value="{{ acc.id }}">{{ acc.holder.name }} - {{ acc.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <div class="form-text">手續費將以「純利潤庫存」形式入庫，售出時額外計算利潤絕對值，不影響原有庫存利潤率。<strong class="text-danger">必須先選擇入庫帳戶才能進行換算。</strong></div>
                                </div>
                            </div>

                            <!-- 換算按鈕 -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <button class="btn btn-success btn-lg w-100" id="btnConvert">
                                        <i class="bi bi-calculator me-2"></i>換算並入帳
                                    </button>
                                </div>
                            </div>

                            <!-- 預覽區域 -->
                            <div class="row g-3 mb-4">
                                <div class="col-12 col-md-6">
                                    <div id="convertedCard" class="card border-0 bg-light">
                                        <div class="card-body text-center">
                                            <div class="text-muted small mb-2">換算人民幣</div>
                                            <div class="fs-2 fw-bold text-primary" id="rmbConverted">0.00</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 col-md-6">
                                    <div class="card border-0 bg-light">
                                        <div class="card-body text-center">
                                            <div class="text-muted small mb-2">手續費 1% 扣除</div>
                                            <div class="fs-2 fw-bold text-warning" id="feeDeducted">0.00</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 支出區域 -->
                            <div class="border-top pt-4">
                                <h6 class="text-muted mb-3">
                                    <i class="bi bi-dash-circle me-1"></i>支出管理
                                </h6>
                                <div class="row g-3">
                                    <div class="col-12 col-md-8">
                                        <label class="form-label fw-semibold">支出金額 (RMB)</label>
                                        <input type="text" inputmode="decimal" class="form-control form-control-lg" id="expenseAmount" placeholder="例如 100">
                                    </div>
                                    <div class="col-12 col-md-4 d-flex align-items-end">
                                        <button class="btn btn-outline-danger btn-lg w-100" id="btnSpend">
                                            <i class="bi bi-dash-circle me-1"></i>扣除支出
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右側：統計資訊區 -->
                <div class="col-12 col-lg-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-gradient bg-success text-white">
                            <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>帳戶統計</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex flex-column gap-4 stat-col h-100">
                                <!-- 帳戶餘額 -->
                                <div class="card border-0 bg-success text-white stat-card flex-fill">
                                    <div class="card-body text-center d-flex flex-column justify-content-center">
                                        <div class="text-white-50 small mb-2">
                                            <i class="bi bi-wallet2 me-1"></i>帳戶人民幣餘額
                                        </div>
                                        <div class="fs-1 fw-bold" id="rmbBalance">0.00</div>
                                    </div>
                                </div>

                                <!-- 手續費利潤 -->
                                <div class="card border-0 bg-warning text-dark stat-card flex-fill">
                                    <div class="card-body text-center d-flex flex-column justify-content-center">
                                        <div class="text-dark-50 small mb-2">
                                            <i class="bi bi-currency-exchange me-1"></i>手續費利潤總計
                                        </div>
                                        <div class="fs-1 fw-bold" id="totalFees">0.00</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 歷史紀錄區 -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-header bg-gradient bg-info text-white">
                            <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>交易歷史</h5>
                        </div>
                        <div class="card-body p-0">

                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0" id="historyTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="white-space: nowrap;" class="px-3">
                                                <i class="bi bi-clock me-1"></i>時間
                                            </th>
                                            <th class="px-3">
                                                <i class="bi bi-tag me-1"></i>類型
                                            </th>
                                            <th class="px-3 text-end">
                                                <i class="bi bi-currency-dollar me-1"></i>USD
                                            </th>
                                            <th class="px-3 text-end">
                                                <i class="bi bi-arrow-left-right me-1"></i>匯率
                                            </th>
                                            <th class="px-3 text-end">
                                                <i class="bi bi-currency-yen me-1"></i>RMB
                                            </th>
                                            <th class="px-3 text-end">
                                                <i class="bi bi-percent me-1"></i>手續費
                                            </th>
                                            <th class="px-3 text-end">
                                                <i class="bi bi-wallet2 me-1"></i>變動後餘額
                                            </th>
                                            <th class="px-3 text-center">
                                                <i class="bi bi-gear me-1"></i>操作
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 頁面底部說明 -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const KEY = 'independent_balance_v1';
    const state = {
        rmbBalance: 0,
        totalFees: 0,
        history: []
    };

    function load() {
        try {
            const raw = localStorage.getItem(KEY);
            if (!raw) return;
            const saved = JSON.parse(raw);
            if (typeof saved.rmbBalance === 'number') state.rmbBalance = saved.rmbBalance;
            if (typeof saved.totalFees === 'number') state.totalFees = saved.totalFees;
            if (Array.isArray(saved.history)) {
                state.history = saved.history;
                // 為舊記錄添加缺失的欄位
                state.history.forEach(item => {
                    if (item.type === '儲值入帳') {
                        if (!item.creditedRaw && item.rmb) {
                            // 從顯示的 rmb 金額推算 creditedRaw（扣除手續費後的金額）
                            const rmbAmount = parseNumber(item.rmb);
                            if (isFinite(rmbAmount)) {
                                item.creditedRaw = rmbAmount;
                            }
                        }
                        if (!item.feeRaw && item.fee) {
                            // 從顯示的手續費推算 feeRaw
                            const feeAmount = parseNumber(item.fee);
                            if (isFinite(feeAmount)) {
                                item.feeRaw = feeAmount;
                            }
                        }
                    } else if (item.type === '支出') {
                        if (!item.expenseRaw && item.rmb) {
                            // 從顯示的 rmb 金額推算 expenseRaw（支出金額）
                            const expenseAmount = Math.abs(parseNumber(item.rmb));
                            if (isFinite(expenseAmount)) {
                                item.expenseRaw = expenseAmount;
                            }
                        }
                    }
                });
            }
        } catch (e) { console.warn('load failed', e); }
    }

    function save() {
        try {
            localStorage.setItem(KEY, JSON.stringify(state));
        } catch (e) { console.warn('save failed', e); }
    }

    function recalculateStats() {
        // 重新計算統計數據，確保一致性
        let totalBalance = 0;
        let totalFees = 0;
        
        for (const item of state.history) {
            if (item.type === '儲值入帳') {
                totalBalance += (item.creditedRaw || 0);
                totalFees += (item.feeRaw || 0);
            } else if (item.type === '支出') {
                totalBalance -= (item.expenseRaw || 0);
            }
        }
        
        state.rmbBalance = Math.max(0, totalBalance);
        state.totalFees = Math.max(0, totalFees);
        
        console.log('重新計算統計數據:', { rmbBalance: state.rmbBalance, totalFees: state.totalFees });
    }

    function parseNumber(str) {
        if (str == null) return NaN;
        const cleaned = String(str).replace(/[,\s]/g, '');
        const val = Number(cleaned);
        return isFinite(val) ? val : NaN;
    }

    function format(n) {
        return (Number(n) || 0).toLocaleString('zh-Hant', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function render() {
        document.getElementById('rmbBalance').textContent = format(state.rmbBalance);
        document.getElementById('totalFees').textContent = format(state.totalFees);
        const tbody = document.querySelector('#historyTable tbody');
        tbody.innerHTML = '';
        for (const item of state.history.slice().reverse()) {
            // 為舊記錄生成 ID（如果沒有）
            if (!item.id) {
                item.id = `${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
            }
            
            const tr = document.createElement('tr');
            const deleteBtn = `<button class="btn btn-sm btn-outline-danger" data-action="delete-record" data-id="${item.id}"><i class="bi bi-trash"></i></button>`;
            tr.innerHTML = `
                <td style="white-space: nowrap;">${item.time}</td>
                <td>${item.type}</td>
                <td class="text-end">${item.usd ?? '-'}</td>
                <td class="text-end">${item.rate ?? '-'}</td>
                <td class="text-end">${item.rmb}</td>
                <td class="text-end">${item.fee ?? '-'}</td>
                <td class="text-end">${item.after}</td>
                <td class="text-center">${deleteBtn}</td>
            `;
            tbody.appendChild(tr);
        }

        // 讓右側兩張卡片平均分配高度，確保內容可見
        try {
            const col = document.querySelector('.stat-col');
            const cards = Array.from(col.querySelectorAll('.stat-card'));
            if (col && cards.length > 0) {
                const MIN_CARD_HEIGHT = 120; // 確保內容可見的最小高度
                const containerHeight = col.offsetHeight;
                const gap = 16; // Bootstrap gap-4 = 1rem = 16px
                const totalGaps = gap * (cards.length - 1);
                const available = Math.max(containerHeight - totalGaps, 0);
                let each = Math.floor(available / cards.length);

                // 若平均高度過小，則設定最小高度
                if (each < MIN_CARD_HEIGHT) {
                    each = MIN_CARD_HEIGHT;
                }

                cards.forEach(card => {
                    card.style.minHeight = each + 'px';
                });
            }
        } catch (e) { /* ignore */ }
    }

    function now() {
        const d = new Date();
        const pad = n => String(n).padStart(2, '0');
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function updatePreview() {
        const usd = parseNumber(document.getElementById('usdAmount').value);
        const rate = parseNumber(document.getElementById('usdToRmbRate').value);
        const profitAccountId = document.getElementById('profitAccount')?.value;
        
        if (isFinite(usd) && isFinite(rate) && usd > 0 && rate > 0 && profitAccountId) {
            const rmbConverted = usd * rate;
            const fee = rmbConverted * 0.01;
            const credited = rmbConverted - fee;
            
            document.getElementById('rmbConverted').textContent = format(rmbConverted);
            document.getElementById('feeDeducted').textContent = format(credited);
        } else {
            document.getElementById('rmbConverted').textContent = '0.00';
            document.getElementById('feeDeducted').textContent = '0.00';
        }
    }

    function convertAndDeposit() {
        const usd = parseNumber(document.getElementById('usdAmount').value);
        const rate = parseNumber(document.getElementById('usdToRmbRate').value);
        const profitAccountId = document.getElementById('profitAccount')?.value;
        
        if (!isFinite(usd) || usd <= 0) { Swal.fire('提示', '請輸入正確的美金金額', 'warning'); return; }
        if (!isFinite(rate) || rate <= 0) { Swal.fire('提示', '請輸入正確的匯率', 'warning'); return; }
        if (!profitAccountId) { Swal.fire('提示', '請先選擇入庫帳戶', 'warning'); return; }
        
        const rmbConverted = usd * rate;
        const fee = rmbConverted * 0.01;
        const credited = rmbConverted - fee;
        
        // 顯示確認彈窗
        Swal.fire({
            title: '確認儲值入帳？',
            html: `
                <div class="text-start">
                    <p><strong>美金金額：</strong> ${format(usd)} USD</p>
                    <p><strong>匯率：</strong> ${format(rate)}</p>
                    <p><strong>換算人民幣：</strong> ${format(rmbConverted)} RMB</p>
                    <p><strong>手續費 (1%)：</strong> ${format(fee)} RMB</p>
                    <p><strong>實際入帳：</strong> ${format(credited)} RMB</p>
                    <hr>
                    <p><strong>入帳後餘額：</strong> ${format(state.rmbBalance + credited)} RMB</p>
                </div>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: '確認入帳',
            cancelButtonText: '取消',
            confirmButtonColor: '#198754',
            cancelButtonColor: '#6c757d'
        }).then(result => {
            if (result.isConfirmed) {
                state.rmbBalance += credited;
                state.totalFees += fee;
                const recordId = `${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
                const profitAccountIdSelected = document.getElementById('profitAccount')?.value || '';
                state.history.push({
                    id: recordId,
                    time: now(),
                    type: '儲值入帳',
                    usd: format(usd),
                    rate: format(rate),
                    rmb: format(rmbConverted),
                    fee: format(fee),
                    after: format(state.rmbBalance),
                    // 供刪除回退使用的原始資料
                    rmbRaw: rmbConverted,
                    feeRaw: fee,
                    creditedRaw: credited,
                    profitAccountId: profitAccountIdSelected,
                    purchaseRecordId: null,
                    inventoryId: null
                });
                save();
                render();

                // 將手續費以「純利潤庫存」形式入庫到選定的RMB帳戶
                const profitAccountId2 = document.getElementById('profitAccount')?.value;
                if (profitAccountId2 && isFinite(fee) && fee > 0) {
                    const formData = new FormData();
                    formData.append('action', 'add_movement');
                    formData.append('account_id', profitAccountId2);
                    formData.append('amount', fee.toString());
                    formData.append('is_decrease', 'false');
                    formData.append('note', '獨立儲值頁面：手續費利潤入庫（純利潤庫存）');
                    formData.append('rmb_cost_rate', '0');
                    formData.append('is_pure_profit', 'true'); // 標記為純利潤庫存

                    fetch('/admin/update_cash_account', {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    }).then(async (resp) => {
                        let data = null;
                        try { data = await resp.json(); } catch(_) {}
                        const rec = state.history.find(r => r.id === recordId);
                        if (data && data.status === 'success' && rec) {
                            rec.purchaseRecordId = data.purchase_record_id || null;
                            rec.inventoryId = data.inventory_id || null;
                            save();
                        }
                    }).catch(() => {})
                }
                
                // 清空輸入框
                document.getElementById('usdAmount').value = '';
                document.getElementById('usdToRmbRate').value = '';
                updatePreview();
                
                Swal.fire('成功', '儲值已入帳', 'success');
            }
        });
    }

    function spend() {
        const expense = parseNumber(document.getElementById('expenseAmount').value);
        if (!isFinite(expense) || expense <= 0) { Swal.fire('提示', '請輸入正確的支出金額', 'warning'); return; }
        if (expense > state.rmbBalance) {
            Swal.fire('餘額不足', '支出金額大於目前餘額', 'error');
            return;
        }
        
        // 顯示確認彈窗
        Swal.fire({
            title: '確認扣除支出？',
            html: `
                <div class="text-start">
                    <p><strong>支出金額：</strong> ${format(expense)} RMB</p>
                    <p><strong>目前餘額：</strong> ${format(state.rmbBalance)} RMB</p>
                    <hr>
                    <p><strong>扣除後餘額：</strong> ${format(state.rmbBalance - expense)} RMB</p>
                </div>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: '確認扣除',
            cancelButtonText: '取消',
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d'
        }).then(result => {
            if (result.isConfirmed) {
                state.rmbBalance -= expense;
                const recordId = `${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
                state.history.push({
                    id: recordId,
                    time: now(),
                    type: '支出',
                    usd: '-',
                    rate: '-',
                    rmb: `-${format(expense)}`,
                    fee: '-',
                    after: format(state.rmbBalance),
                    // 供刪除回退使用的原始資料
                    expenseRaw: expense
                });
                save();
                render();
                document.getElementById('expenseAmount').value = '';
                
                Swal.fire('成功', '支出已扣除', 'success');
            }
        });
    }


    document.getElementById('btnConvert').addEventListener('click', convertAndDeposit);
    document.getElementById('btnSpend').addEventListener('click', spend);
    
    // 列表刪除（事件委派）
    document.getElementById('historyTable').addEventListener('click', async (e) => {
        const target = e.target.closest('[data-action="delete-record"]');
        if (!target) return;
        const id = target.getAttribute('data-id');
        const record = state.history.find(r => r.id === id);
        if (!record) return;
        
        let confirmTitle = '';
        let confirmHtml = '';
        
        if (record.type === '儲值入帳') {
            confirmTitle = '確認刪除此筆儲值入帳？';
            confirmHtml = `<div class="text-start"><p><strong>入帳人民幣：</strong> ${record.rmb}</p><p><strong>手續費：</strong> ${record.fee}</p></div>`;
        } else if (record.type === '支出') {
            confirmTitle = '確認刪除此筆支出？';
            confirmHtml = `<div class="text-start"><p><strong>支出金額：</strong> ${record.rmb}</p></div>`;
        } else {
            return; // 不支援的類型
        }
        
        const confirm = await Swal.fire({
            title: confirmTitle,
            html: confirmHtml,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '是，刪除並回退',
            cancelButtonText: '取消'
        });
        if (!confirm.isConfirmed) return;
        
        // 若為儲值入帳且涉及後端帳戶，先請求後端回退；若後端拒絕（例如已售出），則阻止刪除
        if (record.type === '儲值入帳' && record.profitAccountId && record.feeRaw > 0) {
            console.log('準備回退後端手續費:', { 
                profitAccountId: record.profitAccountId, 
                feeRaw: record.feeRaw, 
                purchaseRecordId: record.purchaseRecordId 
            });
            
            try {
                // 若有後端產生的對應入庫批次，優先走專用回滾API（可阻擋已分配/已售出）
                if (record.purchaseRecordId) {
                    console.log('使用專用回滾API:', record.purchaseRecordId);
                    const fd = new FormData();
                    fd.append('action', 'reverse_pure_profit');
                    fd.append('purchase_record_id', String(record.purchaseRecordId));
                    const resp = await fetch('/admin/update_cash_account', { method: 'POST', body: fd, credentials: 'same-origin', headers:{'X-Requested-With':'XMLHttpRequest'} });
                    const data = await resp.json();
                    console.log('專用回滾API回應:', data);
                    if (data.status !== 'success') {
                        await Swal.fire('無法刪除', data.message || '純利潤庫存已售出或被占用，無法回滾。', 'error');
                        return;
                    }
                } else {
                    // 舊資料無ID時，退而求其次：以提款方式回退帳戶與庫存
                    console.log('使用提款方式回退:', { accountId: record.profitAccountId, amount: record.feeRaw });
                    const formData = new FormData();
                    formData.append('action', 'add_movement');
                    formData.append('account_id', record.profitAccountId);
                    formData.append('amount', String(record.feeRaw));
                    formData.append('is_decrease', 'true');
                    formData.append('note', '獨立儲值頁面：刪除儲值紀錄回退純利潤庫存');
                    const resp = await fetch('/admin/update_cash_account', { method: 'POST', body: formData, credentials: 'same-origin' });
                    console.log('提款API回應狀態:', resp.status, resp.statusText);
                    // 有些後端回應是 redirect/html，盡量嘗試 json；若失敗就以文字解析
                    let ok = false;
                    try {
                        const data = await resp.clone().json();
                        console.log('提款API JSON回應:', data);
                        ok = data?.status === 'success';
                    } catch { 
                        console.log('提款API無法解析JSON，使用狀態碼判斷');
                        ok = resp.ok; 
                    }
                    if (!ok) {
                        await Swal.fire('無法刪除', '後端回退失敗，可能該筆庫存已售出或被占用。', 'error');
                        return; // 阻止本地刪除
                    }
                }
            } catch (err) {
                console.error('後端回退請求失敗:', err);
                await Swal.fire('無法刪除', `後端回退請求失敗：${err?.message ?? err}`, 'error');
                return;
            }
        } else {
            console.log('跳過後端回退:', { 
                type: record.type, 
                hasProfitAccountId: !!record.profitAccountId, 
                feeRaw: record.feeRaw 
            });
        }

        // 後端允許或不涉及後端 → 執行本地回退
        if (record.type === '儲值入帳') {
            const creditedAmount = record.creditedRaw || 0;
            const feeAmount = record.feeRaw || 0;
            
            console.log('刪除儲值入帳:', { creditedAmount, feeAmount, currentBalance: state.rmbBalance, currentFees: state.totalFees });
            
            state.rmbBalance = Math.max(0, state.rmbBalance - creditedAmount);
            state.totalFees = Math.max(0, state.totalFees - feeAmount);
            
            console.log('刪除後餘額:', { newBalance: state.rmbBalance, newFees: state.totalFees });
        } else if (record.type === '支出') {
            const expenseAmount = record.expenseRaw || 0;
            
            console.log('刪除支出:', { expenseAmount, currentBalance: state.rmbBalance });
            
            state.rmbBalance = state.rmbBalance + expenseAmount;
            
            console.log('刪除後餘額:', { newBalance: state.rmbBalance });
        }

        state.history = state.history.filter(r => r.id !== id);
        
        // 重新計算統計數據確保一致性
        recalculateStats();
        
        save();
        render();

        Swal.fire('已刪除', '紀錄已刪除並回退相關數據。', 'success');
    });
    
    // 即時換算功能
    document.getElementById('usdAmount').addEventListener('input', updatePreview);
    document.getElementById('usdToRmbRate').addEventListener('input', updatePreview);
    document.getElementById('profitAccount').addEventListener('change', updatePreview);

    load();
    recalculateStats(); // 載入後重新計算統計數據
    render();
    // 在窗口尺寸變更時也同步高度
    window.addEventListener('resize', () => {
        render();
    });
})();
</script>
{% endblock %}
