<div class="modal fade" id="addHolderModal" tabindex="-1" aria-labelledby="addHolderModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="{{ url_for('admin_update_cash_account') }}" method="POST">
        <input type="hidden" name="action" value="add_holder">
        <div class="modal-header">
          <h5 class="modal-title" id="addHolderModalLabel">新增資金持有人</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="mb-3">
                <label for="holderName" class="form-label">持有人名稱</label>
                <input type="text" class="form-control" id="holderName" name="name" required>
            </div>
            <!-- 我們已經將「持有人類型」的下拉選單徹底移除 -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="submit" class="btn btn-success">確認新增</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- 2. 新增現金帳戶 Modal -->
<div class="modal fade" id="addAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('admin_update_cash_account') }}" method="POST"><input type="hidden" name="action"
                    value="add_account">
                <div class="modal-header">
                    <h5 class="modal-title">新增現金帳戶</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3"><label for="accountHolder" class="form-label">歸屬於哪個持有人？</label><select
                            class="form-select" id="accountHolder" name="holder_id" required></select></div>
                    <div class="mb-3"><label for="accountName" class="form-label">帳戶名稱</label><input type="text"
                            class="form-control" id="accountName" name="name" required></div>
                    <div class="mb-3"><label for="accountCurrency" class="form-label">幣別</label><select
                            class="form-select" id="accountCurrency" name="currency" required>
                            <option value="TWD">台幣 (TWD)</option>
                            <option value="RMB">人民幣 (RMB)</option>
                        </select></div>
                    <div class="mb-3"><label for="initialBalance" class="form-label">初始餘額</label><input type="text"
                            pattern="[0-9]*\.?[0-9]*" class="form-control" id="initialBalance" name="initial_balance" value="0.00"
                            required></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">取消</button><button type="submit" class="btn btn-primary">確認新增</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 3. 內部轉帳 Modal -->
<div class="modal fade" id="transferModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('admin_update_cash_account') }}" method="POST"><input type="hidden" name="action"
                    value="transfer_funds">
                <div class="modal-header">
                    <h5 class="modal-title">內部資金轉帳</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3"><label for="fromAccount" class="form-label">從哪個帳戶轉出？</label><select
                            class="form-select" id="fromAccount" name="from_account_id" required></select></div>
                    <div class="mb-3"><label for="toAccount" class="form-label">轉入哪個帳戶？</label><select
                            class="form-select" id="toAccount" name="to_account_id" required></select></div>
                    <div class="mb-3"><label for="transferAmount" class="form-label">轉帳金額</label><input type="text"
                            pattern="[0-9]*\.?[0-9]*" class="form-control" id="transferAmount" name="transfer_amount" required></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">取消</button><button type="submit" class="btn btn-warning">確認轉帳</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 4. 存入/提出 Modal -->
<div class="modal fade" id="addMovementModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('admin_update_cash_account') }}" method="POST"><input type="hidden" name="action"
                    value="add_movement"><input type="hidden" id="movementAccountId" name="account_id">
                <div class="modal-header">
                    <h5 class="modal-title" id="movementModalTitle">資金操作</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3"><label class="form-label d-block">操作類型</label>
                        <div class="form-check form-check-inline"><input class="form-check-input" type="radio"
                                name="is_decrease" id="movementDeposit" value="false" checked><label
                                class="form-check-label" for="movementDeposit">存入 (+)</label></div>
                        <div class="form-check form-check-inline"><input class="form-check-input" type="radio"
                                name="is_decrease" id="movementWithdraw" value="true"><label class="form-check-label"
                                for="movementWithdraw">提出 (-)</label></div>
                    </div>
                    
                    <!-- 提款類型選擇 -->
                    <div class="mb-3" id="withdrawTypeDiv" style="display: none;">
                        <label class="form-label d-block">提款類型</label>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="withdraw_type" id="withdrawProfit" value="profit" checked>
                            <label class="form-check-label text-warning" for="withdrawProfit">
                                <i class="bi bi-arrow-up-circle me-1"></i>利潤提款
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="withdraw_type" id="withdrawAsset" value="asset">
                            <label class="form-check-label text-primary" for="withdrawAsset">
                                <i class="bi bi-arrow-down-circle me-1"></i>資產提款
                            </label>
                        </div>
                    </div>
                    <div class="mb-3"><label for="movementAmount" class="form-label">金額</label><input type="text"
                            pattern="[0-9]*\.?[0-9]*" class="form-control" id="movementAmount" name="amount" required></div>
                    
                    <!-- RMB存款時的成本匯率欄位 -->
                    <div class="mb-3" id="rmbCostRateDiv" style="display: none;">
                        <label for="rmbCostRate" class="form-label">成本匯率 <span class="text-danger">*</span></label>
                        <input type="text" pattern="[0-9]*\.?[0-9]*" class="form-control" id="rmbCostRate" name="rmb_cost_rate" placeholder="例如: 4.5000">
                        <small class="text-muted">RMB存款需要輸入成本匯率以正確計算庫存成本</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="movementNote" class="form-label">備註</label>
                        <textarea class="form-control" id="movementNote" name="note" rows="2" placeholder="可選：記錄資金操作相關信息"></textarea>
                    </div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">取消</button><button type="submit" class="btn btn-info">確認執行</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 5. 應收帳款銷帳 Modal -->
<div class="modal fade" id="settlementModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="settlementForm">
                <div class="modal-header">
                    <h5 class="modal-title">應收帳款銷帳</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- 隱藏欄位：客戶ID -->
                    <input type="hidden" id="settlementCustomerId" name="customer_id">
                    
                    <div class="mb-3">
                        <label class="form-label">客戶名稱</label>
                        <input type="text" class="form-control" id="settlementCustomerName" readonly>
                    </div>
                    
                    <!-- 應收帳款資訊區塊 -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">銷帳前應收總額</label>
                            <input type="text" class="form-control bg-light" id="settlementTotalReceivable" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">本次銷帳金額</label>
                            <input type="text" class="form-control bg-primary text-white" id="settlementAmountDisplay" readonly>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">銷帳後剩餘應收</label>
                        <input type="text" class="form-control bg-warning" id="settlementRemainingReceivable" readonly>
                        <small class="text-muted">銷帳後客戶的應收帳款餘額</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="settlementAmount" class="form-label">銷帳金額 (TWD) <span class="text-danger">*</span></label>
                        <input type="text" pattern="[0-9]*\.?[0-9]*" class="form-control" id="settlementAmount" name="settlement_amount" required>
                        <small class="text-muted">請輸入實際收到的金額</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="settlementAccount" class="form-label">入庫帳戶 <span class="text-danger">*</span></label>
                        <select class="form-select" id="settlementAccount" name="settlement_account" required>
                            <option value="">--- 請選擇收款入庫帳戶 ---</option>
                        </select>
                        <small class="text-muted">選擇收款後資金將存入的帳戶</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="settlementNote" class="form-label">備註</label>
                        <textarea class="form-control" id="settlementNote" name="settlement_note" rows="2" placeholder="可選：記錄收款相關信息"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">確認銷帳</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 6. 客戶交易紀錄 Modal -->
<div class="modal fade" id="customerTransactionsModal" tabindex="-1" aria-labelledby="customerTransactionsTitle" aria-hidden="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customerTransactionsTitle">
                    <i class="bi bi-person-lines-fill me-2"></i>
                    客戶交易紀錄
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body py-2">
                                <small class="text-muted">客戶名稱</small>
                                <div class="fw-bold" id="customerTransactionsName">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body py-2">
                                <small class="text-muted">當前應收帳款</small>
                                <div class="fw-bold text-danger" id="customerTransactionsReceivable">NT$ 0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>日期時間</th>
                                <th>類型</th>
                                <th>描述</th>
                                <th class="text-end text-success">RMB</th>
                                <th class="text-end text-primary">TWD</th>
                                <th class="text-end text-info">應收帳款餘額變化</th>
                            </tr>
                        </thead>
                        <tbody id="customerTransactionsTable">
                            <!-- JavaScript 將動態填充這裡 -->
                        </tbody>
                    </table>
                </div>
                
                <div id="customerTransactionsEmpty" class="text-center p-4 text-muted" style="display: none;">
                    <i class="bi bi-inbox display-6"></i>
                    <p class="mt-2">該客戶尚無交易紀錄</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="關閉模態框">關閉</button>
            </div>
        </div>
    </div>
</div>