# 修復客戶「蕭」重複扣款問題指南

## 問題描述

客戶「蕭」在 2025/10/30 的銷帳交易（NT$ 180,000）因為系統 Bug 被重複扣減了兩次（實際扣了 360,000），導致：
- 客戶應收帳款被多扣 NT$ 180,000
- 可能導致應收帳款變成負數或被設為 0
- 客戶記錄可能在前端不可見

## 修復方法

### 方法 1：使用自動修復腳本（推薦）

最簡單的方法，會自動計算並修復：

```bash
python fix_customer_xiao_auto.py
```

這個腳本會：
1. 自動找到客戶「蕭」的記錄
2. 計算正確的應收帳款（總銷售 - 總銷帳）
3. 修復應收帳款
4. 確保客戶記錄是啟用狀態

### 方法 2：使用互動式修復腳本

如果需要先查看詳細分析再決定是否修復：

```bash
python fix_customer_xiao_receivables.py
```

這個腳本會：
1. 詳細分析客戶數據
2. 顯示銷售記錄、銷帳記錄等詳細資訊
3. 詢問是否要修復
4. 執行修復並創建審計記錄

### 方法 3：使用 Flask CLI 重建所有客戶應收帳款

如果多個客戶都有問題，可以使用這個命令重建所有客戶的應收帳款：

```bash
flask rebuild-customer-ar
```

這個命令會：
- 對所有客戶重新計算應收帳款
- 使用公式：`應收帳款 = 總銷售金額 - 總銷帳金額`
- 基於實際的 `SalesRecord` 和 `LedgerEntry` 數據

### 方法 4：使用 Flask CLI 手動設置應收帳款

如果知道正確的應收帳款數字，可以直接設置：

```bash
# 首先需要找到客戶 ID
# 然後執行：
flask fix-ar --id <客戶ID> --amount <正確金額>
```

例如：
```bash
flask fix-ar --id 1 --amount 50000.00
```

## 修復原理

### 為什麼會發生重複扣款？

原始代碼在銷帳 API 中對客戶應收帳款執行了兩次扣減：
1. 第 7739 行：`customer.total_receivables_twd -= amount`
2. 第 7794 行：`customer.total_receivables_twd -= amount` （已修復）

### 為什麼修復腳本能解決問題？

修復腳本使用**實際的銷售記錄和銷帳記錄**來重新計算應收帳款：

- **總銷售金額**：從 `SalesRecord` 表中查詢該客戶所有銷售記錄的總和
- **總銷帳金額**：從 `LedgerEntry` 表中查詢該客戶所有 `SETTLEMENT` 類型記錄的總和（這只會有一筆 180,000）
- **正確應收帳款** = 總銷售金額 - 總銷帳金額

因為 `LedgerEntry` 中的銷帳記錄只記錄了一次（180,000），所以重新計算後會得到正確的應收帳款。

## 驗證修復結果

修復後，請檢查：

1. **客戶記錄是否可見**：
   - 登入系統，查看客戶列表
   - 確認客戶「蕭」出現在列表中

2. **應收帳款是否正確**：
   - 查看客戶「蕭」的應收帳款數字
   - 應該等於：總銷售金額 - 180,000（銷帳金額）

3. **交易記錄**：
   - 檢查流水記錄，應該只有一筆 NT$ 180,000 的銷帳記錄
   - 帳戶餘額應該正確（0107現 帳戶應該只增加 180,000）

## 如果客戶記錄完全消失了

如果執行修復腳本時提示「找不到客戶記錄」，可能的原因：

1. **客戶記錄被刪除**：需要從備份恢復
2. **客戶名稱不完全匹配**：可能需要使用模糊搜索
3. **資料庫連線問題**：確認連線到正確的資料庫

### 解決方法：

1. **檢查資料庫**：
   ```sql
   SELECT * FROM customers WHERE name LIKE '%蕭%';
   ```

2. **如果找到記錄但 is_active = False**：
   ```sql
   UPDATE customers SET is_active = TRUE WHERE name LIKE '%蕭%';
   ```

3. **如果記錄真的被刪除**：
   - 需要從備份恢復
   - 或手動創建新記錄並設置正確的應收帳款

## 預防措施

1. **已修復程式碼**：`app.py` 中的重複扣減問題已經修復
2. **建議執行**：如果有多個客戶受影響，建議執行 `flask rebuild-customer-ar` 重建所有客戶應收帳款

## 聯繫與支援

如果修復過程中遇到問題，請：
1. 檢查資料庫連線
2. 確認資料庫備份存在
3. 查看錯誤日誌
4. 如有需要，聯繫系統管理員

